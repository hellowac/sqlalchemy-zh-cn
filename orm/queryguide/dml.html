<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="../../genindex.html" /><link rel="search" title="搜索" href="../../search.html" /><link rel="copyright" title="版权所有" href="../../copyright.html" /><link rel="next" title="列加载选项" href="columns.html" /><link rel="prev" title="为继承映射编写 SELECT 语句" href="inheritance.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.08.06 -->
        <title>启用 ORM 的 INSERT、UPDATE 和 DELETE 语句 - SQLAlchemy 2.1 Documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/changelog.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx_paramlinks.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/docs.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../../index.html"><div class="brand">SQLAlchemy 2.1 Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../../index.html">
  
  
  <span class="sidebar-brand-text">SQLAlchemy 2.1 Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../intro.html">概述</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../tutorial/index.html">SQLAlchemy 统一教程</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of SQLAlchemy 统一教程</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/engine.html">建立连接 - Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/dbapi_transactions.html">使用事务和DBAPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/metadata.html">使用数据库元数据</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../tutorial/data.html">处理数据</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of 处理数据</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/data_insert.html">使用 INSERT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/data_select.html">使用 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../tutorial/data_update.html">使用 UPDATE 和 DELETE 语句</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/orm_data_manipulation.html">使用 ORM 进行数据操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/orm_related_objects.html">使用 ORM 相关对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../tutorial/further_reading.html">进一步阅读</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="../index.html">SQLAlchemy ORM</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of SQLAlchemy ORM</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../quickstart.html">ORM 快速入门</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../mapper_config.html">ORM 映射类配置</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of ORM 映射类配置</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../mapping_styles.html">ORM 映射类概述</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../declarative_mapping.html">使用声明式映射类</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of 使用声明式映射类</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../declarative_styles.html">声明式映射风格</a></li>
<li class="toctree-l4"><a class="reference internal" href="../declarative_tables.html">声明式的表配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../declarative_config.html">使用声明式映射器配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../declarative_mixins.html">使用 Mixins 组合映射层次结构</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../dataclasses.html">与dataclass和attrs的集成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mapped_sql_expr.html">SQL 表达式作为映射属性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mapped_attributes.html">更改Attribute的行为</a></li>
<li class="toctree-l3"><a class="reference internal" href="../composites.html">复合列类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../inheritance.html">映射类继承层次结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../nonstandard_mappings.html">非传统映射</a></li>
<li class="toctree-l3"><a class="reference internal" href="../versioning.html">配置版本计数器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../mapping_api.html">类映射 API</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../scalar_mapping.html">映射 SQL 表达式</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of 映射 SQL 表达式</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../mapping_columns.html">映射表格列</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../relationships.html">关系配置</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of 关系配置</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../basic_relationships.html">基本关系模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../self_referential.html">邻接表关系</a></li>
<li class="toctree-l3"><a class="reference internal" href="../join_conditions.html">配置关系连接方式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../large_collections.html">使用大型集合</a></li>
<li class="toctree-l3"><a class="reference internal" href="../collection_api.html">集合自定义和 API 详细信息</a></li>
<li class="toctree-l3"><a class="reference internal" href="../relationship_persistence.html">特殊关系的持久化模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../backref.html">使用旧版“backref”关系参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../relationship_api.html">关系 API</a></li>
</ul>
</li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="index.html">ORM 查询指南</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of ORM 查询指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="select.html">为 ORM 映射类编写 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="inheritance.html">为继承映射编写 SELECT 语句</a></li>
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">启用 ORM 的 INSERT、UPDATE 和 DELETE 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="columns.html">列加载选项</a></li>
<li class="toctree-l3"><a class="reference internal" href="relationships.html">关系加载技术</a></li>
<li class="toctree-l3"><a class="reference internal" href="api.html">用于查询的 ORM API 功能</a></li>
<li class="toctree-l3"><a class="reference internal" href="query.html">旧式查询 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../session.html">使用会话</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of 使用会话</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../session_basics.html">会话基础知识</a></li>
<li class="toctree-l3"><a class="reference internal" href="../session_state_management.html">状态管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../cascades.html">级联</a></li>
<li class="toctree-l3"><a class="reference internal" href="../session_transaction.html">事务和连接管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../persistence_techniques.html">附加持久性技术</a></li>
<li class="toctree-l3"><a class="reference internal" href="../contextual.html">上下文/线程本地会话</a></li>
<li class="toctree-l3"><a class="reference internal" href="../session_events.html">使用事件跟踪查询、对象和会话更改</a></li>
<li class="toctree-l3"><a class="reference internal" href="../session_api.html">会话 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../extending.html">事件和内部</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of 事件和内部</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../events.html">ORM 事件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../internals.html">ORM 内部</a></li>
<li class="toctree-l3"><a class="reference internal" href="../exceptions.html">ORM 异常</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../extensions/index.html">ORM 扩展</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of ORM 扩展</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../extensions/asyncio.html">异步 I/O (asyncio)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../extensions/associationproxy.html">关联代理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../extensions/automap.html">自动映射</a></li>
<li class="toctree-l3"><a class="reference internal" href="../extensions/baked.html">烘焙查询</a></li>
<li class="toctree-l3"><a class="reference internal" href="../extensions/declarative/index.html">声明式扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../extensions/mutable.html">突变追踪</a></li>
<li class="toctree-l3"><a class="reference internal" href="../extensions/orderinglist.html">排序列表</a></li>
<li class="toctree-l3"><a class="reference internal" href="../extensions/horizontal_shard.html">水平分片</a></li>
<li class="toctree-l3"><a class="reference internal" href="../extensions/hybrid.html">混合属性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../extensions/indexable.html">Indexable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../extensions/instrumentation.html">替代类检测</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../examples.html">核心和 ORM 示例</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../core/index.html">SQLAlchemy Core</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of SQLAlchemy Core</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../core/expression_api.html">SQL 语句和表达式 API</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of SQL 语句和表达式 API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../core/sqlelement.html">列元素和表达式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/operators.html">操作符参考</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/selectable.html">SELECT 和相关构造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/dml.html">插入,更新,删除</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/functions.html">SQL 和 范型函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/compiler.html">自定义 SQL 构造和编译扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/serializer.html">表达式序列化器扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/foundation.html">SQL 表达式语言基础构造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/visitors.html">访问者和遍历实用程序</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../core/schema.html">Schema 定义语言</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of Schema 定义语言</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../core/metadata.html">使用元数据描述数据库</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/reflection.html">反映数据库对象</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/defaults.html">列 INSERT/UPDATE 默认值</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/constraints.html">定义约束和索引</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/ddl.html">自定义 DDL</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../core/types.html">SQL 数据类型对象</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of SQL 数据类型对象</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../core/type_basics.html">类型层次结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/custom_types.html">自定义类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/type_api.html">基本类型 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../core/engines_connections.html">Engine和Connection的使用</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of Engine和Connection的使用</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../core/engines.html">Engine 配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/connections.html">使用Engines和Connection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/pooling.html">连接池</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/events.html">核心事件</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../../core/api_basics.html">Core API 基础</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of Core API 基础</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../../core/event.html">事件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/inspection.html">运行时审查 API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/exceptions.html">Core 异常</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../core/internals.html">Core 内部</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../dialects/index.html">Dialects</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of Dialects</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../dialects/postgresql.html">PostgreSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dialects/mysql.html">MySQL 和 MariaDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dialects/sqlite.html">SQLite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dialects/oracle.html">Oracle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../dialects/mssql.html">Microsoft SQL Server</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../faq/index.html">常见问题</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of 常见问题</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../faq/installation.html">安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/connections.html">连接 / 引擎</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/metadata_schema.html">元数据 / Schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/sqlexpressions.html">SQL 表达式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/ormconfiguration.html">ORM 配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/performance.html">性能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/sessions.html">会话 / 查询</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../faq/thirdparty.html">第三方包集成问题</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../errors.html">错误消息</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../changelog/index.html">变更和迁移</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of 变更和迁移</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/migration_21.html">SQLAlchemy 2.1 有什么新功能？</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_21.html">2.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_20.html">2.0 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_14.html">1.4 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_13.html">1.3 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_12.html">1.2 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_11.html">1.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_10.html">1.0 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_09.html">0.9 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_08.html">0.8 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_07.html">0.7 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_06.html">0.6 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_05.html">0.5 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_04.html">0.4 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_03.html">0.3 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_02.html">0.2 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/changelog_01.html">0.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/migration_20.html">SQLAlchemy 2.0 - Major Migration Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/whatsnew_20.html">What’s New in SQLAlchemy 2.0?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/migration_14.html">What’s New in SQLAlchemy 1.4?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/migration_13.html">What’s New in SQLAlchemy 1.3?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/migration_12.html">What’s New in SQLAlchemy 1.2?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/migration_11.html">What’s New in SQLAlchemy 1.1?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/migration_10.html">What’s New in SQLAlchemy 1.0?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/migration_09.html">What’s New in SQLAlchemy 0.9?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/migration_08.html">What’s New in SQLAlchemy 0.8?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/migration_07.html">What’s New in SQLAlchemy 0.7?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/migration_06.html">What’s New in SQLAlchemy 0.6?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/migration_05.html">What’s new in SQLAlchemy 0.5?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../changelog/migration_04.html">What’s new in SQLAlchemy 0.4?</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <aside class="topic">
<p class="topic-title">ORM Querying Guide</p>
<p>This page is part of the <a class="reference internal" href="index.html"><span class="doc">ORM 查询指南</span></a>.</p>
<p>Previous: <a class="reference internal" href="inheritance.html"><span class="doc">为继承映射编写 SELECT 语句</span></a>   |   Next: <a class="reference internal" href="columns.html"><span class="doc">列加载选项</span></a></p>
</aside>
<section id="orm-insertupdate-delete">
<span id="orm-expression-update-delete"></span><h1>启用 ORM 的 INSERT、UPDATE 和 DELETE 语句<a class="headerlink" href="#orm-insertupdate-delete" title="Link to this heading">¶</a></h1>
<p>ORM-Enabled INSERT, UPDATE, and DELETE statements</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">中文</label><div class="tab-content docutils container">
<div class="admonition- admonition">
<p class="admonition-title">关于本文档</p>
<p>本节使用了在 <a class="reference internal" href="../../tutorial/index.html#unified-tutorial"><span class="std std-ref">SQLAlchemy 统一教程</span></a> 中首次介绍的 ORM 映射，展示在 <a class="reference internal" href="../../tutorial/metadata.html#tutorial-declaring-mapped-classes"><span class="std std-ref">声明映射类</span></a> 部分，以及在 <a class="reference internal" href="../inheritance.html#inheritance-toplevel"><span class="std std-ref">映射类继承层次结构</span></a> 部分展示的继承映射。</p>
<p><a class="reference internal" href="_dml_setup.html"><span class="doc">查看本页的 ORM 设置</span></a>。</p>
</div>
<p><a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> 方法除了处理启用 ORM 的 <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> 对象外，还可以以各种方式处理启用 ORM 的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>、<a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> 和 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.expression.Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a> 对象，这些方式都用于一次性 INSERT、UPDATE 或 DELETE 多个数据库行。还支持方言特定的启用 ORM 的 “upserts”，即自动使用 UPDATE 的 INSERT 语句，用于已存在的行。</p>
<p>下表总结了本文档中讨论的调用形式：</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>ORM 用例</p></th>
<th class="head"><p>使用的 DML</p></th>
<th class="head"><p>数据通过  … 传递</p></th>
<th class="head"><p>支持     RETURNING?</p></th>
<th class="head"><p>支持多表映射?</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference internal" href="#orm-queryguide-bulk-insert"><span class="std std-ref">ORM 批量 INSERT 语句</span></a></p></td>
<td><p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a></p></td>
<td><p>List of dictionaries to <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.params" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.params</span></code></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-bulk-insert-returning"><span class="std std-ref">yes</span></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-insert-joined-table-inheritance"><span class="std std-ref">yes</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#orm-queryguide-bulk-insert-w-sql"><span class="std std-ref">使用 SQL 表达式的 ORM 批量插入</span></a></p></td>
<td><p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a></p></td>
<td><p><a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.params" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.params</span></code></a> with <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-bulk-insert-w-sql"><span class="std std-ref">yes</span></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-insert-joined-table-inheritance"><span class="std std-ref">yes</span></a></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#orm-queryguide-insert-values"><span class="std std-ref">使用每行 SQL 表达式的 ORM 批量插入</span></a></p></td>
<td><p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a></p></td>
<td><p>List of dictionaries to <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-insert-values"><span class="std std-ref">yes</span></a></p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#orm-queryguide-upsert"><span class="std std-ref">ORM“upsert”语句</span></a></p></td>
<td><p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a></p></td>
<td><p>List of dictionaries to <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-upsert-returning"><span class="std std-ref">yes</span></a></p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#orm-queryguide-bulk-update"><span class="std std-ref">ORM 按主键批量 UPDATE</span></a></p></td>
<td><p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a></p></td>
<td><p>List of dictionaries to <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.params" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.params</span></code></a></p></td>
<td><p>no</p></td>
<td><p><a class="reference internal" href="#orm-queryguide-bulk-update-joined-inh"><span class="std std-ref">yes</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#orm-queryguide-update-delete-where"><span class="std std-ref">使用自定义 WHERE 条件的 ORM UPDATE 和 DELETE</span></a></p></td>
<td><p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a>, <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.delete" title="sqlalchemy.sql.expression.delete"><code class="xref py py-func docutils literal notranslate"><span class="pre">delete()</span></code></a></p></td>
<td><p>keywords to <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update.values" title="sqlalchemy.sql.expression.Update.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Update.values()</span></code></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-update-delete-where-returning"><span class="std std-ref">yes</span></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-update-delete-joined-inh"><span class="std std-ref">部分，采用手动步骤</span></a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">英文</label><div class="tab-content docutils container">
<div class="admonition-about-this-document admonition">
<p class="admonition-title">About this Document</p>
<p>This section makes use of ORM mappings first illustrated in the
<a class="reference internal" href="../../tutorial/index.html#unified-tutorial"><span class="std std-ref">SQLAlchemy 统一教程</span></a>, shown in the section
<a class="reference internal" href="../../tutorial/metadata.html#tutorial-declaring-mapped-classes"><span class="std std-ref">声明映射类</span></a>, as well as inheritance
mappings shown in the section <a class="reference internal" href="../inheritance.html#inheritance-toplevel"><span class="std std-ref">映射类继承层次结构</span></a>.</p>
<p><a class="reference internal" href="_dml_setup.html"><span class="doc">View the ORM setup for this page</span></a>.</p>
</div>
<p>The <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> method, in addition to handling ORM-enabled
<a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> objects, can also accommodate ORM-enabled
<a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>, <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> and <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.expression.Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a> objects,
in various ways which are each used to INSERT, UPDATE, or DELETE
many database rows at once.  There is also dialect-specific support
for ORM-enabled “upserts”, which are INSERT statements that automatically
make use of UPDATE for rows that already exist.</p>
<p>The following table summarizes the calling forms that are discussed in this
document:</p>
<div class="table-wrapper docutils container">
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>ORM Use Case</p></th>
<th class="head"><p>DML Construct Used</p></th>
<th class="head"><p>Data is passed using …</p></th>
<th class="head"><p>Supports RETURNING?</p></th>
<th class="head"><p>Supports Multi-Table Mappings?</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference internal" href="#orm-queryguide-bulk-insert"><span class="std std-ref">ORM 批量 INSERT 语句</span></a></p></td>
<td><p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a></p></td>
<td><p>List of dictionaries to <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.params" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.params</span></code></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-bulk-insert-returning"><span class="std std-ref">yes</span></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-insert-joined-table-inheritance"><span class="std std-ref">yes</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#orm-queryguide-bulk-insert-w-sql"><span class="std std-ref">使用 SQL 表达式的 ORM 批量插入</span></a></p></td>
<td><p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a></p></td>
<td><p><a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.params" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.params</span></code></a> with <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-bulk-insert-w-sql"><span class="std std-ref">yes</span></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-insert-joined-table-inheritance"><span class="std std-ref">yes</span></a></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#orm-queryguide-insert-values"><span class="std std-ref">使用每行 SQL 表达式的 ORM 批量插入</span></a></p></td>
<td><p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a></p></td>
<td><p>List of dictionaries to <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-insert-values"><span class="std std-ref">yes</span></a></p></td>
<td><p>no</p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#orm-queryguide-upsert"><span class="std std-ref">ORM“upsert”语句</span></a></p></td>
<td><p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a></p></td>
<td><p>List of dictionaries to <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-upsert-returning"><span class="std std-ref">yes</span></a></p></td>
<td><p>no</p></td>
</tr>
<tr class="row-even"><td><p><a class="reference internal" href="#orm-queryguide-bulk-update"><span class="std std-ref">ORM 按主键批量 UPDATE</span></a></p></td>
<td><p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a></p></td>
<td><p>List of dictionaries to <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.params" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.params</span></code></a></p></td>
<td><p>no</p></td>
<td><p><a class="reference internal" href="#orm-queryguide-bulk-update-joined-inh"><span class="std std-ref">yes</span></a></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference internal" href="#orm-queryguide-update-delete-where"><span class="std std-ref">使用自定义 WHERE 条件的 ORM UPDATE 和 DELETE</span></a></p></td>
<td><p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a>, <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.delete" title="sqlalchemy.sql.expression.delete"><code class="xref py py-func docutils literal notranslate"><span class="pre">delete()</span></code></a></p></td>
<td><p>keywords to <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update.values" title="sqlalchemy.sql.expression.Update.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Update.values()</span></code></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-update-delete-where-returning"><span class="std std-ref">yes</span></a></p></td>
<td><p><a class="reference internal" href="#orm-queryguide-update-delete-joined-inh"><span class="std std-ref">partial, with manual steps</span></a></p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<section id="orm-insert">
<span id="orm-queryguide-bulk-insert"></span><h2>ORM 批量 INSERT 语句<a class="headerlink" href="#orm-insert" title="Link to this heading">¶</a></h2>
<p>ORM Bulk INSERT Statements</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">中文</label><div class="tab-content docutils container">
<p>可以使用一个以 ORM 类为基础构造的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a> 构造，并将其传递给 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> 方法。如果将参数字典列表作为 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.params" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.params</span></code></a> 参数传入（该参数独立于 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 对象本身），则该语句将启用 <strong>批量插入模式</strong>，即尽可能对多行插入进行优化:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">insert</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     insert(User),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;name&quot;: &quot;spongebob&quot;, &quot;fullname&quot;: &quot;Spongebob Squarepants&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;sandy&quot;, &quot;fullname&quot;: &quot;Sandy Cheeks&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;patrick&quot;, &quot;fullname&quot;: &quot;Patrick Star&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;squidward&quot;, &quot;fullname&quot;: &quot;Squidward Tentacles&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;ehkrabs&quot;, &quot;fullname&quot;: &quot;Eugene H. Krabs&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;patrick&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Patrick Star&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;ehkrabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">)]</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>参数字典包含的键值对应于 ORM 映射的属性，它们应与映射的 <a class="reference internal" href="../../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 或 <a class="reference internal" href="../mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 声明一致，也可以对应于 <a class="reference internal" href="../composites.html#mapper-composite"><span class="std std-ref">composite</span></a> 声明。键应使用 <strong>ORM 映射属性的名称</strong>，而不是数据库中实际列的名称（如果两者不同的话）。</p>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0 版本发生变更: </span>将一个 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 构造传递给 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> 方法时，现在会启用“批量插入”模式，该模式使用了与旧版 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.bulk_insert_mappings" title="sqlalchemy.orm.Session.bulk_insert_mappings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bulk_insert_mappings()</span></code></a> 方法相同的机制。这一行为相比 1.x 版本有所变更：在旧版中，<a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 会以 Core 方式解释，使用列名作为键；而现在则接受 ORM 属性名作为键。如需使用 Core 风格的功能，可在调用 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> 时，通过 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.params.execution_options" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execution_options</span></code></a> 参数传入执行选项 <code class="docutils literal notranslate"><span class="pre">{&quot;dml_strategy&quot;:&quot;raw&quot;}</span></code> 。</p>
</div>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">英文</label><div class="tab-content docutils container">
<p>A <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.insert" title="sqlalchemy.sql.expression.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a> construct can be constructed in terms of an ORM class and passed to the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> method.   A list of parameter dictionaries sent to the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.params" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.params</span></code></a> parameter, separate from the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> object itself, will invoke <strong>bulk INSERT mode</strong> for the statement, which essentially means the operation will optimize as much as possible for many rows:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">insert</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     insert(User),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;name&quot;: &quot;spongebob&quot;, &quot;fullname&quot;: &quot;Spongebob Squarepants&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;sandy&quot;, &quot;fullname&quot;: &quot;Sandy Cheeks&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;patrick&quot;, &quot;fullname&quot;: &quot;Patrick Star&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;squidward&quot;, &quot;fullname&quot;: &quot;Squidward Tentacles&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;ehkrabs&quot;, &quot;fullname&quot;: &quot;Eugene H. Krabs&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;patrick&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Patrick Star&#39;</span><span class="p">),</span>
<span class="p">(</span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;ehkrabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">)]</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>The parameter dictionaries contain key/value pairs which may correspond to ORM mapped attributes that line up with mapped <a class="reference internal" href="../../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> or <a class="reference internal" href="../mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> declarations, as well as with <a class="reference internal" href="../composites.html#mapper-composite"><span class="std std-ref">composite</span></a> declarations.   The keys should match the <strong>ORM mapped attribute name</strong> and <strong>not</strong> the actual database column name, if these two names happen to be different.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0 版本发生变更: </span>Passing an <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> construct to the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> method now invokes a “bulk insert”, which makes use of the same functionality as the legacy <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.bulk_insert_mappings" title="sqlalchemy.orm.Session.bulk_insert_mappings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bulk_insert_mappings()</span></code></a> method.  This is a behavior change compared to the 1.x series where the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> would be interpreted in a Core-centric way, using column names for value keys; ORM attribute keys are now accepted.   Core-style functionality is available by passing the execution option <code class="docutils literal notranslate"><span class="pre">{&quot;dml_strategy&quot;:&quot;raw&quot;}</span></code> to the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.params.execution_options" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execution_options</span></code></a> parameter of <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>.</p>
</div>
</div>
</div>
<section id="returning">
<span id="orm-queryguide-bulk-insert-returning"></span><h3>使用 RETURNING 获取新对象<a class="headerlink" href="#returning" title="Link to this heading">¶</a></h3>
<p>Getting new objects with RETURNING</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">中文</label><div class="tab-content docutils container">
<p>批量 ORM 插入功能支持在部分后端使用 INSERT..RETURNING，这种形式可以返回一个 <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> 对象，该对象既可以返回单独的列值，也可以返回与新插入记录对应的完整 ORM 实体对象。INSERT..RETURNING 要求所用的数据库后端支持 SQL RETURNING 语法，并支持在 <a class="reference internal" href="../../glossary.html#term-executemany"><span class="xref std std-term">executemany</span></a> 模式下使用 RETURNING；这个功能适用于所有 <a class="reference internal" href="../../dialects/index.html#included-dialects"><span class="std std-ref">SQLAlchemy 内置</span></a> 的数据库后端， <strong>但不包括 MySQL（MariaDB 是支持的）</strong>。</p>
<p>举个例子，我们可以运行与之前相同的语句，不过这次加入对 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.UpdateBase.returning" title="sqlalchemy.sql.expression.UpdateBase.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">UpdateBase.returning()</span></code></a> 方法的调用，并传入完整的 <code class="docutils literal notranslate"><span class="pre">User</span></code> 实体以指定希望返回什么。使用 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.scalars" title="sqlalchemy.orm.Session.scalars"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.scalars()</span></code></a> 可以按 ORM 对象的方式遍历结果:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">users</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     insert(User).returning(User),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;name&quot;: &quot;spongebob&quot;, &quot;fullname&quot;: &quot;Spongebob Squarepants&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;sandy&quot;, &quot;fullname&quot;: &quot;Sandy Cheeks&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;patrick&quot;, &quot;fullname&quot;: &quot;Patrick Star&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;squidward&quot;, &quot;fullname&quot;: &quot;Squidward Tentacles&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;ehkrabs&quot;, &quot;fullname&quot;: &quot;Eugene H. Krabs&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">,</span>
<span class="s1">&#39;patrick&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Patrick Star&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span>
<span class="s1">&#39;ehkrabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="go">[User(name=&#39;spongebob&#39;, fullname=&#39;Spongebob Squarepants&#39;),</span>
<span class="go">User(name=&#39;sandy&#39;, fullname=&#39;Sandy Cheeks&#39;),</span>
<span class="go">User(name=&#39;patrick&#39;, fullname=&#39;Patrick Star&#39;),</span>
<span class="go">User(name=&#39;squidward&#39;, fullname=&#39;Squidward Tentacles&#39;),</span>
<span class="go">User(name=&#39;ehkrabs&#39;, fullname=&#39;Eugene H. Krabs&#39;)]</span></pre></div>
</div>
<p>在上面的例子中，所生成的 SQL 使用了 SQLite 后端请求的 <a class="reference internal" href="../../core/connections.html#engine-insertmanyvalues"><span class="std std-ref">insertmanyvalues</span></a> 特性形式，也就是将多个参数字典内联到一个单独的 INSERT 语句中，从而实现 RETURNING 支持。</p>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0 版本发生变更: </span>ORM 的 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> 现在可以在 ORM 上下文中解析 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>、<a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a>，甚至是 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.expression.Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a> 构造中的 RETURNING 子句。这意味着可以将列表达式与 ORM 映射实体混合传递给 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.returning()</span></code></a> 方法，ORM 将以与 <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a> 等构造返回 ORM 结果的方式来交付结果，其中映射实体会作为 ORM 映射对象返回。该特性还有限支持 ORM 的加载选项，比如 <a class="reference internal" href="columns.html#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a> 和 <a class="reference internal" href="relationships.html#sqlalchemy.orm.selectinload" title="sqlalchemy.orm.selectinload"><code class="xref py py-func docutils literal notranslate"><span class="pre">selectinload()</span></code></a>。</p>
</div>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">英文</label><div class="tab-content docutils container">
<p>The bulk ORM insert feature supports INSERT..RETURNING for selected backends, which can return a <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> object that may yield individual columns back as well as fully constructed ORM objects corresponding to the newly generated records.    INSERT..RETURNING requires the use of a backend that supports SQL RETURNING syntax as well as support for <a class="reference internal" href="../../glossary.html#term-executemany"><span class="xref std std-term">executemany</span></a> with RETURNING; this feature is available with all <a class="reference internal" href="../../dialects/index.html#included-dialects"><span class="std std-ref">SQLAlchemy-included</span></a> backends with the exception of MySQL (MariaDB is included).</p>
<p>As an example, we can run the same statement as before, adding use of the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.UpdateBase.returning" title="sqlalchemy.sql.expression.UpdateBase.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">UpdateBase.returning()</span></code></a> method, passing the full <code class="docutils literal notranslate"><span class="pre">User</span></code> entity as what we’d like to return.  <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.scalars" title="sqlalchemy.orm.Session.scalars"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.scalars()</span></code></a> is used to allow iteration of <code class="docutils literal notranslate"><span class="pre">User</span></code> objects:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">users</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     insert(User).returning(User),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;name&quot;: &quot;spongebob&quot;, &quot;fullname&quot;: &quot;Spongebob Squarepants&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;sandy&quot;, &quot;fullname&quot;: &quot;Sandy Cheeks&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;patrick&quot;, &quot;fullname&quot;: &quot;Patrick Star&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;squidward&quot;, &quot;fullname&quot;: &quot;Squidward Tentacles&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;ehkrabs&quot;, &quot;fullname&quot;: &quot;Eugene H. Krabs&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">,</span>
<span class="s1">&#39;patrick&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Patrick Star&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span>
<span class="s1">&#39;ehkrabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="go">[User(name=&#39;spongebob&#39;, fullname=&#39;Spongebob Squarepants&#39;),</span>
<span class="go">User(name=&#39;sandy&#39;, fullname=&#39;Sandy Cheeks&#39;),</span>
<span class="go">User(name=&#39;patrick&#39;, fullname=&#39;Patrick Star&#39;),</span>
<span class="go">User(name=&#39;squidward&#39;, fullname=&#39;Squidward Tentacles&#39;),</span>
<span class="go">User(name=&#39;ehkrabs&#39;, fullname=&#39;Eugene H. Krabs&#39;)]</span></pre></div>
</div>
<p>In the above example, the rendered SQL takes on the form used by the <a class="reference internal" href="../../core/connections.html#engine-insertmanyvalues"><span class="std std-ref">insertmanyvalues</span></a> feature as requested by the SQLite backend, where individual parameter dictionaries are inlined into a single INSERT statement so that RETURNING may be used.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0 版本发生变更: </span>The ORM <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> now interprets RETURNING clauses from <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>, <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a>, and even <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.expression.Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a> constructs in an ORM context, meaning a mixture of column expressions and ORM mapped entities may be passed to the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.returning()</span></code></a> method which will then be delivered in the way that ORM results are delivered from constructs such as <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Select" title="sqlalchemy.sql.expression.Select"><code class="xref py py-class docutils literal notranslate"><span class="pre">Select</span></code></a>, including that mapped entities will be delivered in the result as ORM mapped objects.  Limited support for ORM loader options such as <a class="reference internal" href="columns.html#sqlalchemy.orm.load_only" title="sqlalchemy.orm.load_only"><code class="xref py py-func docutils literal notranslate"><span class="pre">load_only()</span></code></a> and <a class="reference internal" href="relationships.html#sqlalchemy.orm.selectinload" title="sqlalchemy.orm.selectinload"><code class="xref py py-func docutils literal notranslate"><span class="pre">selectinload()</span></code></a> is also present.</p>
</div>
</div>
</div>
<section id="orm-queryguide-bulk-insert-returning-ordered">
<span id="id1"></span><h4>将 RETURNING 记录与输入数据顺序关联<a class="headerlink" href="#orm-queryguide-bulk-insert-returning-ordered" title="Link to this heading">¶</a></h4>
<p>Correlating RETURNING records with input data order</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--1">中文</label><div class="tab-content docutils container">
<p>在使用带 RETURNING 的批量 INSERT 时，需要注意大多数数据库后端 <strong>不保证</strong> RETURNING 返回结果的记录顺序，包括其顺序是否与输入记录相对应。在某些应用场景中，如果需要确保 RETURNING 返回的记录能与输入数据正确对应，可以使用额外的参数 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning.params.sort_by_parameter_order" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Insert.returning.sort_by_parameter_order</span></code></a>。这个参数在一些数据库后端下会启用特殊的 INSERT 语法，该语法会使用令牌来正确重排返回的记录；或者在某些情况下，例如下面以 SQLite 为例的场景中，操作会以 <strong>逐行插入</strong> 的方式执行:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
<span class="go">...     {&quot;name&quot;: &quot;pearl&quot;, &quot;fullname&quot;: &quot;Pearl Krabs&quot;},</span>
<span class="go">...     {&quot;name&quot;: &quot;plankton&quot;, &quot;fullname&quot;: &quot;Plankton&quot;},</span>
<span class="go">...     {&quot;name&quot;: &quot;gary&quot;, &quot;fullname&quot;: &quot;Gary&quot;},</span>
<span class="go">... ]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user_ids</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     insert(User).returning(User.id, sort_by_parameter_order=True), data</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pearl&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Pearl Krabs&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span>
<span class="p">[</span><span class="n">insertmanyvalues</span><span class="w"> </span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;plankton&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Plankton&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span>
<span class="p">[</span><span class="n">insertmanyvalues</span><span class="w"> </span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;gary&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Gary&#39;</span><span class="p">)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">input_record</span> <span class="ow">in</span> <span class="n">zip</span><span class="p">(</span><span class="n">user_ids</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="go">...     input_record[&quot;id&quot;] = user_id</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="go">[{&#39;name&#39;: &#39;pearl&#39;, &#39;fullname&#39;: &#39;Pearl Krabs&#39;, &#39;id&#39;: 6},</span>
<span class="go">{&#39;name&#39;: &#39;plankton&#39;, &#39;fullname&#39;: &#39;Plankton&#39;, &#39;id&#39;: 7},</span>
<span class="go">{&#39;name&#39;: &#39;gary&#39;, &#39;fullname&#39;: &#39;Gary&#39;, &#39;id&#39;: 8}]</span></pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">在 2.0.10 版本加入: </span>添加了 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning.params.sort_by_parameter_order" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Insert.returning.sort_by_parameter_order</span></code></a>，该参数在 <a class="reference internal" href="../../glossary.html#term-insertmanyvalues"><span class="xref std std-term">insertmanyvalues</span></a> 架构中实现。</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../../core/connections.html#engine-insertmanyvalues-returning-order"><span class="std std-ref">将 RETURNING 行关联到参数集</span></a> - 关于在不显著降低性能的前提下，确保输入数据与结果行一一对应的方法背景说明</p>
</div>
</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--2">英文</label><div class="tab-content docutils container">
<p>When using bulk INSERT with RETURNING, it’s important to note that most database backends provide no formal guarantee of the order in which the records from RETURNING are returned, including that there is no guarantee that their order will correspond to that of the input records.  For applications that need to ensure RETURNING records can be correlated with input data, the additional parameter <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning.params.sort_by_parameter_order" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Insert.returning.sort_by_parameter_order</span></code></a> may be specified, which depending on backend may use special INSERT forms that maintain a token which is used to reorder the returned rows appropriately, or in some cases, such as in the example below using the SQLite backend, the operation will INSERT one row at a time:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">data</span> <span class="o">=</span> <span class="p">[</span>
<span class="go">...     {&quot;name&quot;: &quot;pearl&quot;, &quot;fullname&quot;: &quot;Pearl Krabs&quot;},</span>
<span class="go">...     {&quot;name&quot;: &quot;plankton&quot;, &quot;fullname&quot;: &quot;Plankton&quot;},</span>
<span class="go">...     {&quot;name&quot;: &quot;gary&quot;, &quot;fullname&quot;: &quot;Gary&quot;},</span>
<span class="go">... ]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user_ids</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     insert(User).returning(User.id, sort_by_parameter_order=True), data</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;pearl&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Pearl Krabs&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span>
<span class="p">[</span><span class="n">insertmanyvalues</span><span class="w"> </span><span class="mi">2</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;plankton&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Plankton&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span>
<span class="p">[</span><span class="n">insertmanyvalues</span><span class="w"> </span><span class="mi">3</span><span class="o">/</span><span class="mi">3</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;gary&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Gary&#39;</span><span class="p">)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">input_record</span> <span class="ow">in</span> <span class="n">zip</span><span class="p">(</span><span class="n">user_ids</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
<span class="go">...     input_record[&quot;id&quot;] = user_id</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="go">[{&#39;name&#39;: &#39;pearl&#39;, &#39;fullname&#39;: &#39;Pearl Krabs&#39;, &#39;id&#39;: 6},</span>
<span class="go">{&#39;name&#39;: &#39;plankton&#39;, &#39;fullname&#39;: &#39;Plankton&#39;, &#39;id&#39;: 7},</span>
<span class="go">{&#39;name&#39;: &#39;gary&#39;, &#39;fullname&#39;: &#39;Gary&#39;, &#39;id&#39;: 8}]</span></pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified added">在 2.0.10 版本加入: </span>Added <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning.params.sort_by_parameter_order" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Insert.returning.sort_by_parameter_order</span></code></a> which is implemented within the <a class="reference internal" href="../../glossary.html#term-insertmanyvalues"><span class="xref std std-term">insertmanyvalues</span></a> architecture.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../../core/connections.html#engine-insertmanyvalues-returning-order"><span class="std std-ref">将 RETURNING 行关联到参数集</span></a> - background on approaches taken to guarantee correspondence between input data and result rows without significant loss of performance</p>
</div>
</div>
</div>
</section>
</section>
<section id="orm-queryguide-insert-heterogeneous-params">
<span id="id2"></span><h3>使用异构参数字典<a class="headerlink" href="#orm-queryguide-insert-heterogeneous-params" title="Link to this heading">¶</a></h3>
<p>Using Heterogeneous Parameter Dictionaries</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--4-input--1" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--1">中文</label><div class="tab-content docutils container">
<p>ORM 的批量插入功能支持所谓“ <strong>异构</strong> ”的参数字典列表，这意味着—— <strong>每个字典可以拥有不同的键</strong> 。当 ORM 检测到这种情况时，会将这些参数字典按键的组合进行分组，然后分别批量生成不同的 INSERT 语句:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">users</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     insert(User).returning(User),</span>
<span class="go">...     [</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;spongebob&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Spongebob Squarepants&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Sea Sponge&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {&quot;name&quot;: &quot;sandy&quot;, &quot;fullname&quot;: &quot;Sandy Cheeks&quot;, &quot;species&quot;: &quot;Squirrel&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;patrick&quot;, &quot;species&quot;: &quot;Starfish&quot;},</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;squidward&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Squidward Tentacles&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Squid&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {&quot;name&quot;: &quot;ehkrabs&quot;, &quot;fullname&quot;: &quot;Eugene H. Krabs&quot;, &quot;species&quot;: &quot;Crab&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">unordered</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sea Sponge&#39;</span><span class="p">,</span>
<span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squirrel&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">species</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;patrick&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Starfish&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">unordered</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span>
<span class="s1">&#39;Squid&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ehkrabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Crab&#39;</span><span class="p">)</span>
</div></pre></div>
</div>
<p>在上面的例子中，传入的五个参数字典被转换为了三个 INSERT 语句，这些语句是基于字典中键的组合方式分组生成的，同时仍保持了 <strong>行的顺序</strong>，即： <code class="docutils literal notranslate"><span class="pre">(&quot;name&quot;,</span> <span class="pre">&quot;fullname&quot;,</span> <span class="pre">&quot;species&quot;)</span></code> 、 <code class="docutils literal notranslate"><span class="pre">(&quot;name&quot;,</span> <span class="pre">&quot;species&quot;)</span></code> 、 <code class="docutils literal notranslate"><span class="pre">(&quot;name&quot;,&quot;fullname&quot;,</span> <span class="pre">&quot;species&quot;)</span></code>。</p>
</div>
<input class="tab-input" id="tab-set--4-input--2" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--2">英文</label><div class="tab-content docutils container">
<p>The ORM bulk insert feature supports lists of parameter dictionaries that are “heterogeneous”, which basically means “individual dictionaries can have different keys”.   When this condition is detected, the ORM will break up the parameter dictionaries into groups corresponding to each set of keys and batch accordingly into separate INSERT statements:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">users</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     insert(User).returning(User),</span>
<span class="go">...     [</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;spongebob&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Spongebob Squarepants&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Sea Sponge&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {&quot;name&quot;: &quot;sandy&quot;, &quot;fullname&quot;: &quot;Sandy Cheeks&quot;, &quot;species&quot;: &quot;Squirrel&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;patrick&quot;, &quot;species&quot;: &quot;Starfish&quot;},</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;squidward&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Squidward Tentacles&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Squid&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {&quot;name&quot;: &quot;ehkrabs&quot;, &quot;fullname&quot;: &quot;Eugene H. Krabs&quot;, &quot;species&quot;: &quot;Crab&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">unordered</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sea Sponge&#39;</span><span class="p">,</span>
<span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squirrel&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">species</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;patrick&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Starfish&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">unordered</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span>
<span class="s1">&#39;Squid&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;ehkrabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Crab&#39;</span><span class="p">)</span>
</div></pre></div>
</div>
<p>In the above example, the five parameter dictionaries passed translated into three INSERT statements, grouped along the specific sets of keys in each dictionary while still maintaining row order, i.e. <code class="docutils literal notranslate"><span class="pre">(&quot;name&quot;,</span> <span class="pre">&quot;fullname&quot;,</span> <span class="pre">&quot;species&quot;)</span></code>, <code class="docutils literal notranslate"><span class="pre">(&quot;name&quot;,</span> <span class="pre">&quot;species&quot;)</span></code>, <code class="docutils literal notranslate"><span class="pre">(&quot;name&quot;,&quot;fullname&quot;,</span> <span class="pre">&quot;species&quot;)</span></code>.</p>
</div>
</div>
</section>
<section id="orm-insert-null">
<span id="orm-queryguide-insert-null-params"></span><h3>在 ORM 批量 INSERT 语句中发送 NULL 值<a class="headerlink" href="#orm-insert-null" title="Link to this heading">¶</a></h3>
<p>Sending NULL values in ORM bulk INSERT statements</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--5-input--1" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--1">中文</label><div class="tab-content docutils container">
<p>ORM 的批量插入功能依赖于一种行为，这种行为在旧版的 “bulk” 插入机制中也存在，并且在 ORM 的整体工作单元（unit of work）中同样适用，即： <strong>当某一行包含 NULL 值时，该行会使用一个不引用这些列的 INSERT 语句来插入</strong> ；这样做的理由是，为了让数据库后端及其架构中存在的服务端 INSERT 默认值（这些默认值可能对“是 NULL”与“未提供值”有区别）能够按预期工作。该默认行为会导致批量插入的批次被拆分为多个较小的批次:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     insert(User),</span>
<span class="go">...     [</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_a&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee A&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Squid&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_b&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee B&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Squirrel&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_c&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee C&quot;,</span>
<span class="go">...             &quot;species&quot;: None,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_d&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee D&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Bluefish&quot;,</span>
<span class="go">...         },</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;name_a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee A&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squid&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;name_b&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee B&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squirrel&#39;</span><span class="p">)]</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;name_c&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee C&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;name_d&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee D&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bluefish&#39;</span><span class="p">)</span>
<span class="p">...</span>
</div></pre></div>
</div>
<p>如上所示，对四行数据的批量 INSERT 被拆分为了三个独立语句，其中第二个语句被格式化为不引用包含 <code class="docutils literal notranslate"><span class="pre">None</span></code> 值的列。
当数据集中包含大量随机 NULL 值时，这种默认行为可能是 <strong>不理想的</strong>，因为这会导致 <cite>executemany</cite> 操作被拆分为更多更小的操作；尤其当依赖 <a class="reference internal" href="../../core/connections.html#engine-insertmanyvalues"><span class="std std-ref">insertmanyvalues</span></a> 功能来减少语句总数时，性能影响可能更大。</p>
<p>若希望禁用上述 NULL 值的特殊处理行为，可传递执行选项 <code class="docutils literal notranslate"><span class="pre">render_nulls=True</span></code>；这样所有参数字典会被视为具有相同的键集合，从而统一批处理:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     insert(User).execution_options(render_nulls=True),</span>
<span class="go">...     [</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_a&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee A&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Squid&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_b&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee B&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Squirrel&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_c&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee C&quot;,</span>
<span class="go">...             &quot;species&quot;: None,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_d&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee D&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Bluefish&quot;,</span>
<span class="go">...         },</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;name_a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee A&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squid&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;name_b&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee B&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squirrel&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;name_c&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee C&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">None</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;name_d&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee D&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bluefish&#39;</span><span class="p">)]</span>
<span class="p">...</span>
</div></pre></div>
</div>
<p>在上述代码中，所有的参数字典被统一为单个 INSERT 批次发送，包括第三个字典中包含的 <code class="docutils literal notranslate"><span class="pre">None</span></code> 值。</p>
<div class="versionadded">
<p><span class="versionmodified added">在 2.0.23 版本加入: </span>添加了 <code class="docutils literal notranslate"><span class="pre">render_nulls</span></code> 执行选项，它与旧版 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.bulk_insert_mappings.params.render_nulls" title="sqlalchemy.orm.Session.bulk_insert_mappings"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.bulk_insert_mappings.render_nulls</span></code></a> 参数行为一致。</p>
</div>
</div>
<input class="tab-input" id="tab-set--5-input--2" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--2">英文</label><div class="tab-content docutils container">
<p>The bulk ORM insert feature draws upon a behavior that is also present in the legacy “bulk” insert behavior, as well as in the ORM unit of work overall, which is that rows which contain NULL values are INSERTed using a statement that does not refer to those columns; the rationale here is so that backends and schemas which contain server-side INSERT defaults that may be sensitive to the presence of a NULL value vs. no value present will produce a server side value as expected.  This default behavior has the effect of breaking up the bulk inserted batches into more batches of fewer rows:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     insert(User),</span>
<span class="go">...     [</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_a&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee A&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Squid&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_b&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee B&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Squirrel&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_c&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee C&quot;,</span>
<span class="go">...             &quot;species&quot;: None,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_d&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee D&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Bluefish&quot;,</span>
<span class="go">...         },</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;name_a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee A&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squid&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;name_b&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee B&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squirrel&#39;</span><span class="p">)]</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;name_c&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee C&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;name_d&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee D&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bluefish&#39;</span><span class="p">)</span>
<span class="p">...</span>
</div></pre></div>
</div>
<p>Above, the bulk INSERT of four rows is broken into three separate statements, the second statement reformatted to not refer to the NULL column for the single parameter dictionary that contains a <code class="docutils literal notranslate"><span class="pre">None</span></code> value.    This default behavior may be undesirable when many rows in the dataset contain random NULL values, as it causes the “executemany” operation to be broken into a larger number of smaller operations; particularly when relying upon <a class="reference internal" href="../../core/connections.html#engine-insertmanyvalues"><span class="std std-ref">insertmanyvalues</span></a> to reduce the overall number of statements, this can have a bigger performance impact.</p>
<p>To disable the handling of <code class="docutils literal notranslate"><span class="pre">None</span></code> values in the parameters into separate batches, pass the execution option <code class="docutils literal notranslate"><span class="pre">render_nulls=True</span></code>; this will cause all parameter dictionaries to be treated equivalently, assuming the same set of keys in each dictionary:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     insert(User).execution_options(render_nulls=True),</span>
<span class="go">...     [</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_a&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee A&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Squid&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_b&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee B&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Squirrel&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_c&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee C&quot;,</span>
<span class="go">...             &quot;species&quot;: None,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;name&quot;: &quot;name_d&quot;,</span>
<span class="go">...             &quot;fullname&quot;: &quot;Employee D&quot;,</span>
<span class="go">...             &quot;species&quot;: &quot;Bluefish&quot;,</span>
<span class="go">...         },</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;name_a&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee A&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squid&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;name_b&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee B&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squirrel&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;name_c&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee C&#39;</span><span class="p">,</span><span class="w"> </span><span class="k">None</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;name_d&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Employee D&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Bluefish&#39;</span><span class="p">)]</span>
<span class="p">...</span>
</div></pre></div>
</div>
<p>Above, all parameter dictionaries are sent in a single INSERT batch, including the <code class="docutils literal notranslate"><span class="pre">None</span></code> value present in the third parameter dictionary.</p>
<div class="versionadded">
<p><span class="versionmodified added">在 2.0.23 版本加入: </span>Added the <code class="docutils literal notranslate"><span class="pre">render_nulls</span></code> execution option which mirrors the behavior of the legacy <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.bulk_insert_mappings.params.render_nulls" title="sqlalchemy.orm.Session.bulk_insert_mappings"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.bulk_insert_mappings.render_nulls</span></code></a> parameter.</p>
</div>
</div>
</div>
</section>
<section id="insert">
<span id="orm-queryguide-insert-joined-table-inheritance"></span><h3>用于连接表继承的批量 INSERT<a class="headerlink" href="#insert" title="Link to this heading">¶</a></h3>
<p>Bulk INSERT for Joined Table Inheritance</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--6-input--1" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--1">中文</label><div class="tab-content docutils container">
<p>ORM 批量插入功能构建在传统 <a class="reference internal" href="../../glossary.html#term-unit-of-work"><span class="xref std std-term">unit of work</span></a> 系统所使用的内部机制之上，用于生成 INSERT 语句。
这意味着对于一个映射到多个表的 ORM 实体（通常是使用 <a class="reference internal" href="../inheritance.html#joined-inheritance"><span class="std std-ref">joined table inheritance</span></a> 方式映射的实体）， <strong>批量 INSERT 操作会为映射中涉及的每一个表分别生成 INSERT 语句</strong> ，并正确地将服务端生成的主键值传递给依赖这些主键的行。
此场景下也支持 RETURNING 功能，ORM 会为每个执行的 INSERT 语句接收一个 <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> 对象，之后再将这些结果“水平拼接（horizontally splice）”在一起，使得最终返回的行包含所有被插入的列的值:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">managers</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     insert(Manager).returning(Manager),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;name&quot;: &quot;sandy&quot;, &quot;manager_name&quot;: &quot;Sandy Cheeks&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;ehkrabs&quot;, &quot;manager_name&quot;: &quot;Eugene H. Krabs&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">type</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;manager&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">type</span>
<span class="p">[</span><span class="n">insertmanyvalues</span><span class="w"> </span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;ehkrabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;manager&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">manager_name</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">manager_name</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id__1</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">)</span>
</div></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>对使用 joined inheritance 映射的类进行批量 INSERT 时，ORM <strong>内部必须使用</strong> <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning.params.sort_by_parameter_order" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Insert.returning.sort_by_parameter_order</span></code></a> 参数，以便能够将基类表中 RETURNING 返回的主键值与用于插入子表的参数集合进行匹配。</p>
<p>这也是为什么在上例中，SQLite 后端会自动降级为非批处理（non-batched）语句的原因。
关于此机制的背景可参见 <a class="reference internal" href="../../core/connections.html#engine-insertmanyvalues-returning-order"><span class="std std-ref">将 RETURNING 行关联到参数集</span></a>。</p>
</div>
</div>
<input class="tab-input" id="tab-set--6-input--2" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--2">英文</label><div class="tab-content docutils container">
<p>ORM bulk insert builds upon the internal system that is used by the traditional <a class="reference internal" href="../../glossary.html#term-unit-of-work"><span class="xref std std-term">unit of work</span></a> system in order to emit INSERT statements.  This means that for an ORM entity that is mapped to multiple tables, typically one which is mapped using <a class="reference internal" href="../inheritance.html#joined-inheritance"><span class="std std-ref">joined table inheritance</span></a>, the bulk INSERT operation will emit an INSERT statement for each table represented by the mapping, correctly transferring server-generated primary key values to the table rows that depend upon them.  The RETURNING feature is also supported here, where the ORM will receive <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> objects for each INSERT statement executed, and will then “horizontally splice” them together so that the returned rows include values for all columns inserted:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">managers</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     insert(Manager).returning(Manager),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;name&quot;: &quot;sandy&quot;, &quot;manager_name&quot;: &quot;Sandy Cheeks&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;ehkrabs&quot;, &quot;manager_name&quot;: &quot;Eugene H. Krabs&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">type</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;manager&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">type</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="k">type</span>
<span class="p">[</span><span class="n">insertmanyvalues</span><span class="w"> </span><span class="mi">2</span><span class="o">/</span><span class="mi">2</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">;</span><span class="w"> </span><span class="n">batch</span><span class="w"> </span><span class="k">not</span><span class="w"> </span><span class="n">supported</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;ehkrabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;manager&#39;</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">manager_name</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">manager_name</span><span class="p">,</span><span class="w"> </span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id__1</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">ordered</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">)</span>
</div></pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>Bulk INSERT of joined inheritance mappings requires that the ORM make use of the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning.params.sort_by_parameter_order" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Insert.returning.sort_by_parameter_order</span></code></a> parameter internally, so that it can correlate primary key values from RETURNING rows from the base table into the parameter sets being used to INSERT into the “sub” table, which is why the SQLite backend illustrated above transparently degrades to using non-batched statements. Background on this feature is at <a class="reference internal" href="../../core/connections.html#engine-insertmanyvalues-returning-order"><span class="std std-ref">将 RETURNING 行关联到参数集</span></a>.</p>
</div>
</div>
</div>
</section>
<section id="sql-orm">
<span id="orm-queryguide-bulk-insert-w-sql"></span><h3>使用 SQL 表达式的 ORM 批量插入<a class="headerlink" href="#sql-orm" title="Link to this heading">¶</a></h3>
<p>ORM Bulk Insert with SQL Expressions</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--7-input--1" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--1">中文</label><div class="tab-content docutils container">
<p>ORM 的批量插入功能支持添加一组 <strong>固定参数</strong> ，这些参数可以包括要应用于每一行的 SQL 表达式。
实现方式是结合使用 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> 方法传入一个将应用于所有行的参数字典，同时在调用 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> 时以通常的“批量”方式传入单独行的参数字典列表。</p>
<p>例如，假设有一个 ORM 映射包含一个 “timestamp” 时间戳列：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LogRecord</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;log_record&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">message</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">code</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>如果我们想要插入一系列具有唯一 <code class="docutils literal notranslate"><span class="pre">message</span></code> 字段的 <code class="docutils literal notranslate"><span class="pre">LogRecord</span></code> 元素，并希望对所有行应用 SQL 函数 <code class="docutils literal notranslate"><span class="pre">now()</span></code>，那么可以通过 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> 指定 <code class="docutils literal notranslate"><span class="pre">timestamp</span></code>，然后以批量模式传入各个记录的值:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">log_record_result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     insert(LogRecord).values(code=&quot;SQLA&quot;, timestamp=func.now()).returning(LogRecord),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;message&quot;: &quot;log message #1&quot;},</span>
<span class="go">...         {&quot;message&quot;: &quot;log message #2&quot;},</span>
<span class="go">...         {&quot;message&quot;: &quot;log message #3&quot;},</span>
<span class="go">...         {&quot;message&quot;: &quot;log message #4&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">log_record</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">),</span>
<span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">)</span>
<span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">unordered</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;log message #1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SQLA&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;log message #2&#39;</span><span class="p">,</span>
<span class="s1">&#39;SQLA&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;log message #3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SQLA&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;log message #4&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SQLA&#39;</span><span class="p">)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">log_record_result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="go">[LogRecord(&#39;log message #1&#39;, &#39;SQLA&#39;, datetime.datetime(...)),</span>
<span class="go">LogRecord(&#39;log message #2&#39;, &#39;SQLA&#39;, datetime.datetime(...)),</span>
<span class="go">LogRecord(&#39;log message #3&#39;, &#39;SQLA&#39;, datetime.datetime(...)),</span>
<span class="go">LogRecord(&#39;log message #4&#39;, &#39;SQLA&#39;, datetime.datetime(...))]</span></pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--7-input--2" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--2">英文</label><div class="tab-content docutils container">
<p>The ORM bulk insert feature supports the addition of a fixed set of parameters which may include SQL expressions to be applied to every target row. To achieve this, combine the use of the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> method, passing a dictionary of parameters that will be applied to all rows, with the usual bulk calling form by including a list of parameter dictionaries that contain individual row values when invoking <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>.</p>
<p>As an example, given an ORM mapping that includes a “timestamp” column:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LogRecord</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;log_record&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">message</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">code</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">timestamp</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>If we wanted to INSERT a series of <code class="docutils literal notranslate"><span class="pre">LogRecord</span></code> elements, each with a unique <code class="docutils literal notranslate"><span class="pre">message</span></code> field, however we would like to apply the SQL function <code class="docutils literal notranslate"><span class="pre">now()</span></code> to all rows, we can pass <code class="docutils literal notranslate"><span class="pre">timestamp</span></code> within <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> and then pass the additional records using “bulk” mode:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">log_record_result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     insert(LogRecord).values(code=&quot;SQLA&quot;, timestamp=func.now()).returning(LogRecord),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;message&quot;: &quot;log message #1&quot;},</span>
<span class="go">...         {&quot;message&quot;: &quot;log message #2&quot;},</span>
<span class="go">...         {&quot;message&quot;: &quot;log message #3&quot;},</span>
<span class="go">...         {&quot;message&quot;: &quot;log message #4&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">log_record</span><span class="w"> </span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">),</span>
<span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="p">)</span>
<span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">,</span><span class="w"> </span><span class="k">timestamp</span>
<span class="p">[...</span><span class="w"> </span><span class="p">(</span><span class="n">insertmanyvalues</span><span class="p">)</span><span class="w"> </span><span class="mi">1</span><span class="o">/</span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">unordered</span><span class="p">)]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;log message #1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SQLA&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;log message #2&#39;</span><span class="p">,</span>
<span class="s1">&#39;SQLA&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;log message #3&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SQLA&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;log message #4&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;SQLA&#39;</span><span class="p">)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">log_record_result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="go">[LogRecord(&#39;log message #1&#39;, &#39;SQLA&#39;, datetime.datetime(...)),</span>
<span class="go">LogRecord(&#39;log message #2&#39;, &#39;SQLA&#39;, datetime.datetime(...)),</span>
<span class="go">LogRecord(&#39;log message #3&#39;, &#39;SQLA&#39;, datetime.datetime(...)),</span>
<span class="go">LogRecord(&#39;log message #4&#39;, &#39;SQLA&#39;, datetime.datetime(...))]</span></pre></div>
</div>
</div>
</div>
<section id="orm-queryguide-insert-values">
<span id="id3"></span><h4>使用每行 SQL 表达式的 ORM 批量插入<a class="headerlink" href="#orm-queryguide-insert-values" title="Link to this heading">¶</a></h4>
<p>ORM Bulk Insert with Per Row SQL Expressions</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--8-input--1" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--1">中文</label><div class="tab-content docutils container">
<p><cite>:meth:_dml.Insert.values</cite> 方法本身直接支持一个参数字典的列表。当以这种方式使用 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 构造函数时，如果没有将任何参数字典列表传递给 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.params" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.params</span></code></a> 参数，则不会使用批量 ORM 插入模式，而是将 INSERT 语句按给定形式渲染，并仅执行一次。这种操作模式对于按行传递 SQL 表达式的情况非常有用，也可用于 ORM 中的 “upsert” 语句，后者将在本章稍后介绍 <a class="reference internal" href="#orm-queryguide-upsert"><span class="std std-ref">ORM“upsert”语句</span></a>。</p>
<p>下面是一个例子，演示了嵌入每行 SQL 表达式的 INSERT，同时展示了这种形式的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.returning()</span></code></a>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">address_result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     insert(Address)</span>
<span class="go">...     .values(</span>
<span class="go">...         [</span>
<span class="go">...             {</span>
<span class="go">...                 &quot;user_id&quot;: select(User.id).where(User.name == &quot;sandy&quot;),</span>
<span class="go">...                 &quot;email_address&quot;: &quot;sandy@company.com&quot;,</span>
<span class="go">...             },</span>
<span class="go">...             {</span>
<span class="go">...                 &quot;user_id&quot;: select(User.id).where(User.name == &quot;spongebob&quot;),</span>
<span class="go">...                 &quot;email_address&quot;: &quot;spongebob@company.com&quot;,</span>
<span class="go">...             },</span>
<span class="go">...             {</span>
<span class="go">...                 &quot;user_id&quot;: select(User.id).where(User.name == &quot;patrick&quot;),</span>
<span class="go">...                 &quot;email_address&quot;: &quot;patrick@company.com&quot;,</span>
<span class="go">...             },</span>
<span class="go">...         ]</span>
<span class="go">...     )</span>
<span class="go">...     .returning(Address),</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">email_address</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span>
<span class="p">((</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">((</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">((</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">email_address</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy@company.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;spongebob@company.com&#39;</span><span class="p">,</span>
<span class="s1">&#39;patrick&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;patrick@company.com&#39;</span><span class="p">)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">address_result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="go">[Address(email_address=&#39;sandy@company.com&#39;),</span>
<span class="go">Address(email_address=&#39;spongebob@company.com&#39;),</span>
<span class="go">Address(email_address=&#39;patrick@company.com&#39;)]</span></pre></div>
</div>
<p>由于上面没有使用批量 ORM 插入模式，因此以下特性没有被启用：</p>
<ul class="simple">
<li><p><a class="reference internal" href="#orm-queryguide-insert-joined-table-inheritance"><span class="std std-ref">联合表继承</span></a> 或其他多表映射不受支持，因为这需要多个 INSERT 语句。</p></li>
<li><p><a class="reference internal" href="#orm-queryguide-insert-heterogeneous-params"><span class="std std-ref">异构参数集</span></a> 不受支持 - 每个 VALUES 集中的元素必须包含相同的列。</p></li>
<li><p>核心级别的优化（例如由 <a class="reference internal" href="../../core/connections.html#engine-insertmanyvalues"><span class="std std-ref">insertmanyvalues</span></a> 提供的批处理）不可用；语句需要确保总参数数不超过数据库的限制。</p></li>
</ul>
<p>由于上述原因，通常不建议在 ORM INSERT 语句中使用多个参数集与 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a>，除非有明确的理由，即正在使用 “upsert” 或者需要在每个参数集内嵌入按行的 SQL 表达式。</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-queryguide-upsert"><span class="std std-ref">ORM“upsert”语句</span></a></p>
</div>
</div>
<input class="tab-input" id="tab-set--8-input--2" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> method itself accommodates a list of parameter dictionaries directly. When using the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> construct in this way, without passing any list of parameter dictionaries to the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.params" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.params</span></code></a> parameter, bulk ORM insert mode is not used, and instead the INSERT statement is rendered exactly as given and invoked exactly once. This mode of operation may be useful both for the case of passing SQL expressions on a per-row basis, and is also used when using “upsert” statements with the ORM, documented later in this chapter at <a class="reference internal" href="#orm-queryguide-upsert"><span class="std std-ref">ORM“upsert”语句</span></a>.</p>
<p>A contrived example of an INSERT that embeds per-row SQL expressions, and also demonstrates <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.returning()</span></code></a> in this form, is below:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">address_result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     insert(Address)</span>
<span class="go">...     .values(</span>
<span class="go">...         [</span>
<span class="go">...             {</span>
<span class="go">...                 &quot;user_id&quot;: select(User.id).where(User.name == &quot;sandy&quot;),</span>
<span class="go">...                 &quot;email_address&quot;: &quot;sandy@company.com&quot;,</span>
<span class="go">...             },</span>
<span class="go">...             {</span>
<span class="go">...                 &quot;user_id&quot;: select(User.id).where(User.name == &quot;spongebob&quot;),</span>
<span class="go">...                 &quot;email_address&quot;: &quot;spongebob@company.com&quot;,</span>
<span class="go">...             },</span>
<span class="go">...             {</span>
<span class="go">...                 &quot;user_id&quot;: select(User.id).where(User.name == &quot;patrick&quot;),</span>
<span class="go">...                 &quot;email_address&quot;: &quot;patrick@company.com&quot;,</span>
<span class="go">...             },</span>
<span class="go">...         ]</span>
<span class="go">...     )</span>
<span class="go">...     .returning(Address),</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">address</span><span class="w"> </span><span class="p">(</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">email_address</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span>
<span class="p">((</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">((</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">((</span><span class="k">SELECT</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="n">email_address</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy@company.com&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;spongebob@company.com&#39;</span><span class="p">,</span>
<span class="s1">&#39;patrick&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;patrick@company.com&#39;</span><span class="p">)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">address_result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="go">[Address(email_address=&#39;sandy@company.com&#39;),</span>
<span class="go">Address(email_address=&#39;spongebob@company.com&#39;),</span>
<span class="go">Address(email_address=&#39;patrick@company.com&#39;)]</span></pre></div>
</div>
<p>Because bulk ORM insert mode is not used above, the following features are not present:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#orm-queryguide-insert-joined-table-inheritance"><span class="std std-ref">Joined table inheritance</span></a> or other multi-table mappings are not supported, since that would require multiple INSERT statements.</p></li>
<li><p><a class="reference internal" href="#orm-queryguide-insert-heterogeneous-params"><span class="std std-ref">Heterogeneous parameter sets</span></a> are not supported - each element in the VALUES set must have the same columns.</p></li>
<li><p>Core-level scale optimizations such as the batching provided by <a class="reference internal" href="../../core/connections.html#engine-insertmanyvalues"><span class="std std-ref">insertmanyvalues</span></a> are not available; statements will need to ensure the total number of parameters does not exceed limits imposed by the backing database.</p></li>
</ul>
<p>For the above reasons, it is generally not recommended to use multiple parameter sets with <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> with ORM INSERT statements unless there is a clear rationale, which is either that “upsert” is being used or there is a need to embed per-row SQL expressions in each parameter set.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-queryguide-upsert"><span class="std std-ref">ORM“upsert”语句</span></a></p>
</div>
</div>
</div>
</section>
</section>
<section id="orm-queryguide-legacy-bulk-insert">
<span id="id4"></span><h3>旧会话批量 INSERT 方法<a class="headerlink" href="#orm-queryguide-legacy-bulk-insert" title="Link to this heading">¶</a></h3>
<p>Legacy Session Bulk INSERT Methods</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--9-input--1" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--1">中文</label><div class="tab-content docutils container">
<p><cite>:class:_orm.Session</cite> 包含用于执行 “批量” INSERT 和 UPDATE 语句的遗留方法。这些方法与 SQLAlchemy 2.0 版本中的相应特性共享实现，具体描述见 <a class="reference internal" href="#orm-queryguide-bulk-insert"><span class="std std-ref">ORM 批量 INSERT 语句</span></a> 和 <a class="reference internal" href="#orm-queryguide-bulk-update"><span class="std std-ref">ORM 按主键批量 UPDATE</span></a>，但缺少许多功能，特别是缺乏 RETURNING 支持以及对会话同步的支持。</p>
<p>例如，使用 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.bulk_insert_mappings" title="sqlalchemy.orm.Session.bulk_insert_mappings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bulk_insert_mappings()</span></code></a> 的代码可以按如下方式迁移，首先是这个映射示例:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">session.bulk_insert_mappings(User, [{&quot;name&quot;: &quot;u1&quot;}, {&quot;name&quot;: &quot;u2&quot;}, {&quot;name&quot;: &quot;u3&quot;}])</span></pre></div>
</div>
<p>上述代码使用新的 API 表达为:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">from sqlalchemy import insert</span>

<span class="go">session.execute(insert(User), [{&quot;name&quot;: &quot;u1&quot;}, {&quot;name&quot;: &quot;u2&quot;}, {&quot;name&quot;: &quot;u3&quot;}])</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-queryguide-legacy-bulk-update"><span class="std std-ref">旧会话批量 UPDATE 方法</span></a></p>
</div>
</div>
<input class="tab-input" id="tab-set--9-input--2" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> includes legacy methods for performing “bulk” INSERT and UPDATE statements.  These methods share implementations with the SQLAlchemy 2.0 versions of these features, described at <a class="reference internal" href="#orm-queryguide-bulk-insert"><span class="std std-ref">ORM 批量 INSERT 语句</span></a> and <a class="reference internal" href="#orm-queryguide-bulk-update"><span class="std std-ref">ORM 按主键批量 UPDATE</span></a>, however lack many features, namely RETURNING support as well as support for session-synchronization.</p>
<p>Code which makes use of <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.bulk_insert_mappings" title="sqlalchemy.orm.Session.bulk_insert_mappings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bulk_insert_mappings()</span></code></a> for example can port code as follows, starting with this mappings example:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">session.bulk_insert_mappings(User, [{&quot;name&quot;: &quot;u1&quot;}, {&quot;name&quot;: &quot;u2&quot;}, {&quot;name&quot;: &quot;u3&quot;}])</span></pre></div>
</div>
<p>The above is expressed using the new API as:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">from sqlalchemy import insert</span>

<span class="go">session.execute(insert(User), [{&quot;name&quot;: &quot;u1&quot;}, {&quot;name&quot;: &quot;u2&quot;}, {&quot;name&quot;: &quot;u3&quot;}])</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-queryguide-legacy-bulk-update"><span class="std std-ref">旧会话批量 UPDATE 方法</span></a></p>
</div>
</div>
</div>
</section>
<section id="ormupsert">
<span id="orm-queryguide-upsert"></span><h3>ORM“upsert”语句<a class="headerlink" href="#ormupsert" title="Link to this heading">¶</a></h3>
<p>ORM “upsert” Statements</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--10-input--1" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--1">中文</label><div class="tab-content docutils container">
<p>SQLAlchemy 中的选定后端可能包含特定于方言的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 构造函数，这些构造函数额外具备执行 “upsert”（或插入现有行，并将其转化为近似 UPDATE 语句）功能。所谓的 “现有行”，可能是指具有相同主键值的行，或者是指其他被认为是唯一的索引列；这一点取决于所使用的后端的能力。</p>
<p>SQLAlchemy 中包含特定于方言的 “upsert” API 功能的方言有：</p>
<ul class="simple">
<li><p>SQLite - 使用 <a class="reference internal" href="../../dialects/sqlite.html#sqlalchemy.dialects.sqlite.Insert" title="sqlalchemy.dialects.sqlite.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>，具体文档见 <a class="reference internal" href="../../dialects/sqlite.html#sqlite-on-conflict-insert"><span class="std std-ref">INSERT…ON CONFLICT (Upsert)</span></a></p></li>
<li><p>PostgreSQL - 使用 <a class="reference internal" href="../../dialects/postgresql.html#sqlalchemy.dialects.postgresql.Insert" title="sqlalchemy.dialects.postgresql.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>，具体文档见 <a class="reference internal" href="../../dialects/postgresql.html#postgresql-insert-on-conflict"><span class="std std-ref">INSERT…ON CONFLICT (Upsert)</span></a></p></li>
<li><p>MySQL/MariaDB - 使用 <a class="reference internal" href="../../dialects/mysql.html#sqlalchemy.dialects.mysql.Insert" title="sqlalchemy.dialects.mysql.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a>，具体文档见 <a class="reference internal" href="../../dialects/mysql.html#mysql-insert-on-duplicate-key-update"><span class="std std-ref">INSERT…ON DUPLICATE KEY UPDATE (Upsert)</span></a></p></li>
</ul>
<p>用户应查看上述章节，了解如何正确构造这些对象；特别是，”upsert” 方法通常需要引用原始语句，因此该语句通常需要分两步构造。</p>
<p>如 <a class="reference internal" href="../../dialects/index.html#external-toplevel"><span class="std std-ref">External Dialects</span></a> 中提到的第三方后端也可能具有类似的构造。</p>
<p>虽然 SQLAlchemy 目前尚未提供一个与后端无关的 upsert 构造，但上述 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 变体仍然是 ORM 兼容的，意味着它们可以像文档中描述的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 构造那样使用，具体见 <a class="reference internal" href="#orm-queryguide-insert-values"><span class="std std-ref">使用每行 SQL 表达式的 ORM 批量插入</span></a>，即通过将要插入的行嵌入到 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> 方法中。以下示例中，使用 SQLite 的 <a class="reference internal" href="../../dialects/sqlite.html#sqlalchemy.dialects.sqlite.insert" title="sqlalchemy.dialects.sqlite.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a> 函数生成一个支持 “ON CONFLICT DO UPDATE” 的 <a class="reference internal" href="../../dialects/sqlite.html#sqlalchemy.dialects.sqlite.Insert" title="sqlalchemy.dialects.sqlite.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 构造。然后该语句被传递给 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>，正常执行，唯一的不同是，传递给 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> 的参数字典被解释为 ORM 映射的属性键，而不是列名：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects.sqlite</span><span class="w"> </span><span class="kn">import</span> <span class="n">insert</span> <span class="k">as</span> <span class="n">sqlite_upsert</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">sqlite_upsert</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;name&quot;: &quot;spongebob&quot;, &quot;fullname&quot;: &quot;Spongebob Squarepants&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;sandy&quot;, &quot;fullname&quot;: &quot;Sandy Cheeks&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;patrick&quot;, &quot;fullname&quot;: &quot;Patrick Star&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;squidward&quot;, &quot;fullname&quot;: &quot;Squidward Tentacles&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;ehkrabs&quot;, &quot;fullname&quot;: &quot;Eugene H. Krabs&quot;},</span>
<span class="go">...     ]</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">on_conflict_do_update</span><span class="p">(</span>
<span class="go">...     index_elements=[User.name], set_=dict(fullname=stmt.excluded.fullname)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="k">ON</span><span class="w"> </span><span class="n">CONFLICT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">DO</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">excluded</span><span class="p">.</span><span class="n">fullname</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">,</span>
<span class="s1">&#39;patrick&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Patrick Star&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span>
<span class="s1">&#39;ehkrabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--10-input--2" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--2">英文</label><div class="tab-content docutils container">
<p>Selected backends with SQLAlchemy may include dialect-specific <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> constructs which additionally have the ability to perform “upserts”, or INSERTs where an existing row in the parameter set is turned into an approximation of an UPDATE statement instead. By “existing row” , this may mean rows which share the same primary key value, or may refer to other indexed columns within the row that are considered to be unique; this is dependent on the capabilities of the backend in use.</p>
<p>The dialects included with SQLAlchemy that include dialect-specific “upsert” API features are:</p>
<ul class="simple">
<li><p>SQLite - using <a class="reference internal" href="../../dialects/sqlite.html#sqlalchemy.dialects.sqlite.Insert" title="sqlalchemy.dialects.sqlite.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> documented at <a class="reference internal" href="../../dialects/sqlite.html#sqlite-on-conflict-insert"><span class="std std-ref">INSERT…ON CONFLICT (Upsert)</span></a></p></li>
<li><p>PostgreSQL - using <a class="reference internal" href="../../dialects/postgresql.html#sqlalchemy.dialects.postgresql.Insert" title="sqlalchemy.dialects.postgresql.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> documented at <a class="reference internal" href="../../dialects/postgresql.html#postgresql-insert-on-conflict"><span class="std std-ref">INSERT…ON CONFLICT (Upsert)</span></a></p></li>
<li><p>MySQL/MariaDB - using <a class="reference internal" href="../../dialects/mysql.html#sqlalchemy.dialects.mysql.Insert" title="sqlalchemy.dialects.mysql.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> documented at <a class="reference internal" href="../../dialects/mysql.html#mysql-insert-on-duplicate-key-update"><span class="std std-ref">INSERT…ON DUPLICATE KEY UPDATE (Upsert)</span></a></p></li>
</ul>
<p>Users should review the above sections for background on proper construction of these objects; in particular, the “upsert” method typically needs to refer back to the original statement, so the statement is usually constructed in two separate steps.</p>
<p>Third party backends such as those mentioned at <a class="reference internal" href="../../dialects/index.html#external-toplevel"><span class="std std-ref">External Dialects</span></a> may
also feature similar constructs.</p>
<p>While SQLAlchemy does not yet have a backend-agnostic upsert construct, the above <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> variants are nonetheless ORM compatible in that they may be used in the same way as the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> construct itself as documented at <a class="reference internal" href="#orm-queryguide-insert-values"><span class="std std-ref">使用每行 SQL 表达式的 ORM 批量插入</span></a>, that is, by embedding the desired rows to INSERT within the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> method.   In the example below, the SQLite <a class="reference internal" href="../../dialects/sqlite.html#sqlalchemy.dialects.sqlite.insert" title="sqlalchemy.dialects.sqlite.insert"><code class="xref py py-func docutils literal notranslate"><span class="pre">insert()</span></code></a> function is used to generate an <a class="reference internal" href="../../dialects/sqlite.html#sqlalchemy.dialects.sqlite.Insert" title="sqlalchemy.dialects.sqlite.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> construct that includes “ON CONFLICT DO UPDATE” support.   The statement is then passed to <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> where it proceeds normally, with the additional characteristic that the parameter dictionaries passed to <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> are interpreted as ORM mapped attribute keys, rather than column names:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects.sqlite</span><span class="w"> </span><span class="kn">import</span> <span class="n">insert</span> <span class="k">as</span> <span class="n">sqlite_upsert</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">sqlite_upsert</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;name&quot;: &quot;spongebob&quot;, &quot;fullname&quot;: &quot;Spongebob Squarepants&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;sandy&quot;, &quot;fullname&quot;: &quot;Sandy Cheeks&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;patrick&quot;, &quot;fullname&quot;: &quot;Patrick Star&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;squidward&quot;, &quot;fullname&quot;: &quot;Squidward Tentacles&quot;},</span>
<span class="go">...         {&quot;name&quot;: &quot;ehkrabs&quot;, &quot;fullname&quot;: &quot;Eugene H. Krabs&quot;},</span>
<span class="go">...     ]</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">on_conflict_do_update</span><span class="p">(</span>
<span class="go">...     index_elements=[User.name], set_=dict(fullname=stmt.excluded.fullname)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="k">ON</span><span class="w"> </span><span class="n">CONFLICT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">DO</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">excluded</span><span class="p">.</span><span class="n">fullname</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">,</span>
<span class="s1">&#39;patrick&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Patrick Star&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span>
<span class="s1">&#39;ehkrabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
</div>
</div>
<section id="returning-upsert">
<span id="orm-queryguide-upsert-returning"></span><h4>将 RETURNING 与 upsert 语句结合使用<a class="headerlink" href="#returning-upsert" title="Link to this heading">¶</a></h4>
<p>Using RETURNING with upsert statements</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--11-input--1" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--1">中文</label><div class="tab-content docutils container">
<p>从 SQLAlchemy ORM 的角度来看，upsert 语句与常规的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 构造类似，这意味着 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.returning()</span></code></a> 在 upsert 语句中也能正常工作，就像在 <a class="reference internal" href="#orm-queryguide-insert-values"><span class="std std-ref">使用每行 SQL 表达式的 ORM 批量插入</span></a> 中演示的那样，因此可以传递任何列表达式或相关的 ORM 实体类。继续上一节的示例:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     stmt.returning(User), execution_options={&quot;populate_existing&quot;: True}</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="k">ON</span><span class="w"> </span><span class="n">CONFLICT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">DO</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">excluded</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">,</span>
<span class="s1">&#39;patrick&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Patrick Star&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span>
<span class="s1">&#39;ehkrabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="go">[User(name=&#39;spongebob&#39;, fullname=&#39;Spongebob Squarepants&#39;),</span>
<span class="go">User(name=&#39;sandy&#39;, fullname=&#39;Sandy Cheeks&#39;),</span>
<span class="go">User(name=&#39;patrick&#39;, fullname=&#39;Patrick Star&#39;),</span>
<span class="go">User(name=&#39;squidward&#39;, fullname=&#39;Squidward Tentacles&#39;),</span>
<span class="go">User(name=&#39;ehkrabs&#39;, fullname=&#39;Eugene H. Krabs&#39;)]</span></pre></div>
</div>
<p>上面的示例使用了 RETURNING 来返回每一行插入或 upsert 的 ORM 对象。该示例还使用了 <a class="reference internal" href="api.html#orm-queryguide-populate-existing"><span class="std std-ref">填充现有</span></a> 执行选项。此选项表示对于已经存在的行（在 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> 中已经有的 <code class="docutils literal notranslate"><span class="pre">User</span></code> 对象），应该使用新行中的数据进行 <strong>刷新</strong>。对于纯粹的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 语句，此选项并不重要，因为每一行生成的都是全新的主键身份。然而，当 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 语句也包含 “upsert” 选项时，它可能会返回已经存在的行的结果，因此这些行可能已经在 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> 对象的 <a class="reference internal" href="../../glossary.html#term-28"><span class="xref std std-term">身份映射</span></a> 中有主键身份表示。</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="api.html#orm-queryguide-populate-existing"><span class="std std-ref">填充现有</span></a></p>
</div>
</div>
<input class="tab-input" id="tab-set--11-input--2" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--2">英文</label><div class="tab-content docutils container">
<p>From the SQLAlchemy ORM’s point of view, upsert statements look like regular <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> constructs, which includes that <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert.returning" title="sqlalchemy.sql.expression.Insert.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.returning()</span></code></a> works with upsert statements in the same way as was demonstrated at <a class="reference internal" href="#orm-queryguide-insert-values"><span class="std std-ref">使用每行 SQL 表达式的 ORM 批量插入</span></a>, so that any column expression or relevant ORM entity class may be passed.  Continuing from the example in the previous section:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
<span class="go">...     stmt.returning(User), execution_options={&quot;populate_existing&quot;: True}</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="k">ON</span><span class="w"> </span><span class="n">CONFLICT</span><span class="w"> </span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="w"> </span><span class="k">DO</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">excluded</span><span class="p">.</span><span class="n">fullname</span>
<span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;spongebob&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Sandy Cheeks&#39;</span><span class="p">,</span>
<span class="s1">&#39;patrick&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Patrick Star&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span>
<span class="s1">&#39;ehkrabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="go">[User(name=&#39;spongebob&#39;, fullname=&#39;Spongebob Squarepants&#39;),</span>
<span class="go">User(name=&#39;sandy&#39;, fullname=&#39;Sandy Cheeks&#39;),</span>
<span class="go">User(name=&#39;patrick&#39;, fullname=&#39;Patrick Star&#39;),</span>
<span class="go">User(name=&#39;squidward&#39;, fullname=&#39;Squidward Tentacles&#39;),</span>
<span class="go">User(name=&#39;ehkrabs&#39;, fullname=&#39;Eugene H. Krabs&#39;)]</span></pre></div>
</div>
<p>The example above uses RETURNING to return ORM objects for each row inserted or upserted by the statement. The example also adds use of the <a class="reference internal" href="api.html#orm-queryguide-populate-existing"><span class="std std-ref">填充现有</span></a> execution option. This option indicates that <code class="docutils literal notranslate"><span class="pre">User</span></code> objects which are already present in the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> for rows that already exist should be <strong>refreshed</strong> with the data from the new row. For a pure <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> statement, this option is not significant, because every row produced is a brand new primary key identity. However when the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> also includes “upsert” options, it may also be yielding results from rows that already exist and therefore may already have a primary key identity represented in the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> object’s <a class="reference internal" href="../../glossary.html#term-identity-map"><span class="xref std std-term">identity map</span></a>.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="api.html#orm-queryguide-populate-existing"><span class="std std-ref">填充现有</span></a></p>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="orm-update">
<span id="orm-queryguide-bulk-update"></span><h2>ORM 按主键批量 UPDATE<a class="headerlink" href="#orm-update" title="Link to this heading">¶</a></h2>
<p>ORM Bulk UPDATE by Primary Key</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--12-input--1" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> 构造可以像 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> 语句那样与 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> 一起使用，传递多个参数字典的列表，每个字典表示一个对应单个主键值的行。需要注意的是，这种用法不应与使用显式 WHERE 子句的更常见的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> 语句用法混淆，这种用法在 <a class="reference internal" href="#orm-queryguide-update-delete-where"><span class="std std-ref">使用自定义 WHERE 条件的 ORM UPDATE 和 DELETE</span></a> 中有详细说明。</p>
<p>对于“批量”版本的 UPDATE，首先创建一个基于 ORM 类的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a> 构造，并将其传递给 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> 方法；生成的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> 对象通常 <strong>不包含值，并且通常不包含 WHERE 条件</strong> ，也就是说，通常不使用 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update.values" title="sqlalchemy.sql.expression.Update.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Update.values()</span></code></a> 方法，且 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update.where" title="sqlalchemy.sql.expression.Update.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Update.where()</span></code></a> <strong>通常不使用</strong>，但在某些特殊情况下可以使用，以添加额外的过滤条件。</p>
<p>传递 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> 构造及其参数字典列表（每个字典包含完整的主键值）将启动 <strong>按主键批量更新模式</strong>，为每一行生成相应的 WHERE 条件，并使用 <a class="reference internal" href="../../glossary.html#term-executemany"><span class="xref std std-term">executemany</span></a> 将每个参数集应用于 UPDATE 语句:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     update(User),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;id&quot;: 1, &quot;fullname&quot;: &quot;Spongebob Squarepants&quot;},</span>
<span class="go">...         {&quot;id&quot;: 3, &quot;fullname&quot;: &quot;Patrick Star&quot;},</span>
<span class="go">...         {&quot;id&quot;: 5, &quot;fullname&quot;: &quot;Eugene H. Krabs&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Patrick Star&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)]</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>请注意，每个参数字典 <strong>必须包含每条记录的完整主键</strong>，否则会引发错误。</p>
<p>与批量 INSERT 功能类似，这里也支持异构参数列表，其中参数将被分成 UPDATE 运行的子批次。</p>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0.11 版本发生变更: </span>通过使用 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update.where" title="sqlalchemy.sql.expression.Update.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Update.where()</span></code></a> 方法添加额外的条件，可以将额外的 WHERE 条件与 <a class="reference internal" href="#orm-queryguide-bulk-update"><span class="std std-ref">ORM 按主键批量 UPDATE</span></a> 结合使用。然而，这些条件始终是与已经存在的 WHERE 条件一起使用的，后者包括主键值。</p>
</div>
<p>当使用“按主键批量更新”功能时，RETURNING 功能不可用；多个参数字典的列表必然使用 DBAPI <a class="reference internal" href="../../glossary.html#term-executemany"><span class="xref std std-term">executemany</span></a>，而通常这种形式不支持返回结果行。</p>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0 版本发生变更: </span>将 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> 构造传递给 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> 方法，并与参数字典列表一起使用时，现在会调用“批量更新”，其功能与旧版的 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.bulk_update_mappings" title="sqlalchemy.orm.Session.bulk_update_mappings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bulk_update_mappings()</span></code></a> 方法相同。这与 1.x 系列的行为有所不同，1.x 系列中 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> 仅支持显式的 WHERE 条件和内联 VALUES。</p>
</div>
</div>
<input class="tab-input" id="tab-set--12-input--2" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> construct may be used with <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> in a similar way as the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> statement is used as described at <a class="reference internal" href="#orm-queryguide-bulk-insert"><span class="std std-ref">ORM 批量 INSERT 语句</span></a>, passing a list of many parameter dictionaries, each dictionary representing an individual row that corresponds to a single primary key value. This use should not be confused with a more common way to use <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> statements with the ORM, using an explicit WHERE clause, which is documented at <a class="reference internal" href="#orm-queryguide-update-delete-where"><span class="std std-ref">使用自定义 WHERE 条件的 ORM UPDATE 和 DELETE</span></a>.</p>
<p>For the “bulk” version of UPDATE, a <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a> construct is made in terms of an ORM class and passed to the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> method; the resulting <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> object should have <strong>no values and typically no WHERE criteria</strong>, that is, the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update.values" title="sqlalchemy.sql.expression.Update.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Update.values()</span></code></a> method is not used, and the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update.where" title="sqlalchemy.sql.expression.Update.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Update.where()</span></code></a> is <strong>usually</strong> not used, but may be used in the unusual case that additional filtering criteria would be added.</p>
<p>Passing the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> construct along with a list of parameter dictionaries which each include a full primary key value will invoke <strong>bulk UPDATE by primary key mode</strong> for the statement, generating the appropriate WHERE criteria to match each row by primary key, and using <a class="reference internal" href="../../glossary.html#term-executemany"><span class="xref std std-term">executemany</span></a> to run each parameter set against the UPDATE statement:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     update(User),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;id&quot;: 1, &quot;fullname&quot;: &quot;Spongebob Squarepants&quot;},</span>
<span class="go">...         {&quot;id&quot;: 3, &quot;fullname&quot;: &quot;Patrick Star&quot;},</span>
<span class="go">...         {&quot;id&quot;: 5, &quot;fullname&quot;: &quot;Eugene H. Krabs&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Patrick Star&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Eugene H. Krabs&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)]</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>Note that each parameter dictionary <strong>must include a full primary key for each record</strong>, else an error is raised.</p>
<p>Like the bulk INSERT feature, heterogeneous parameter lists are supported here as well, where the parameters will be grouped into sub-batches of UPDATE runs.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0.11 版本发生变更: </span>Additional WHERE criteria can be combined with <a class="reference internal" href="#orm-queryguide-bulk-update"><span class="std std-ref">ORM 按主键批量 UPDATE</span></a> by using the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update.where" title="sqlalchemy.sql.expression.Update.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Update.where()</span></code></a> method to add additional criteria.  However this criteria is always in addition to the WHERE criteria that’s already made present which includes primary key values.</p>
</div>
<p>The RETURNING feature is not available when using the “bulk UPDATE by primary key” feature; the list of multiple parameter dictionaries necessarily makes use of DBAPI <a class="reference internal" href="../../glossary.html#term-executemany"><span class="xref std std-term">executemany</span></a>, which in its usual form does not typically support result rows.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0 版本发生变更: </span>Passing an <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> construct to the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> method along with a list of parameter dictionaries now invokes a “bulk update”, which makes use of the same functionality as the legacy <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.bulk_update_mappings" title="sqlalchemy.orm.Session.bulk_update_mappings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bulk_update_mappings()</span></code></a> method.  This is a behavior change compared to the 1.x series where the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> would only be supported with explicit WHERE criteria and inline VALUES.</p>
</div>
</div>
</div>
<section id="update-orm">
<span id="orm-queryguide-bulk-update-disabling"></span><h3>禁用具有多个参数集的 UPDATE 语句的按主键批量 ORM 更新<a class="headerlink" href="#update-orm" title="Link to this heading">¶</a></h3>
<p>Disabling Bulk ORM Update by Primary Key for an UPDATE statement with multiple parameter sets</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--13-input--1" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--1">中文</label><div class="tab-content docutils container">
<p>ORM 按主键批量更新功能会针对每条记录运行一个 UPDATE 语句，并为每个主键值添加 WHERE 条件，当满足以下条件时会自动启用此功能：</p>
<ol class="arabic simple">
<li><p>给定的 UPDATE 语句是针对 ORM 实体的</p></li>
<li><p>使用 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> 执行语句，而不是 Core 的 <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a></p></li>
<li><p>传递的参数是一个 <strong>字典列表</strong>。</p></li>
</ol>
<p>若要在不使用“ORM 按主键批量更新”的情况下调用 UPDATE 语句，可以直接通过 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.connection" title="sqlalchemy.orm.Session.connection"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.connection()</span></code></a> 方法获取当前的 <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a>，然后在事务中执行该语句:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">bindparam</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     update(User).where(User.name == bindparam(&quot;u_name&quot;)),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;u_name&quot;: &quot;spongebob&quot;, &quot;fullname&quot;: &quot;Spongebob Squarepants&quot;},</span>
<span class="go">...         {&quot;u_name&quot;: &quot;patrick&quot;, &quot;fullname&quot;: &quot;Patrick Star&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;spongebob&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Patrick Star&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;patrick&#39;</span><span class="p">)]</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../../errors.html#error-bupq"><span class="std std-ref">每行 ORM 按主键批量更新要求记录包含主键值</span></a></p>
</div>
</div>
<input class="tab-input" id="tab-set--13-input--2" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--2">英文</label><div class="tab-content docutils container">
<p>The ORM Bulk Update by Primary Key feature, which runs an UPDATE statement per record which includes WHERE criteria for each primary key value, is automatically used when:</p>
<ol class="arabic simple">
<li><p>the UPDATE statement given is against an ORM entity</p></li>
<li><p>the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> is used to execute the statement, and not a Core <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a></p></li>
<li><p>The parameters passed are a <strong>list of dictionaries</strong>.</p></li>
</ol>
<p>In order to invoke an UPDATE statement without using “ORM Bulk Update by Primary Key”, invoke the statement against the <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> directly using the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.connection" title="sqlalchemy.orm.Session.connection"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.connection()</span></code></a> method to acquire the current <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> for the transaction:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">bindparam</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">connection</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     update(User).where(User.name == bindparam(&quot;u_name&quot;)),</span>
<span class="go">...     [</span>
<span class="go">...         {&quot;u_name&quot;: &quot;spongebob&quot;, &quot;fullname&quot;: &quot;Spongebob Squarepants&quot;},</span>
<span class="go">...         {&quot;u_name&quot;: &quot;patrick&quot;, &quot;fullname&quot;: &quot;Patrick Star&quot;},</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;Spongebob Squarepants&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;spongebob&#39;</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Patrick Star&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;patrick&#39;</span><span class="p">)]</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../../errors.html#error-bupq"><span class="std std-ref">每行 ORM 按主键批量更新要求记录包含主键值</span></a></p>
</div>
</div>
</div>
</section>
<section id="update">
<span id="orm-queryguide-bulk-update-joined-inh"></span><h3>用于连接表继承的按主键批量 UPDATE<a class="headerlink" href="#update" title="Link to this heading">¶</a></h3>
<p>Bulk UPDATE by Primary Key for Joined Table Inheritance</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--14-input--1" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--1">中文</label><div class="tab-content docutils container">
<p>ORM 批量更新在使用带有联合表继承的映射时，行为与 ORM 批量插入类似；如 <a class="reference internal" href="#orm-queryguide-insert-joined-table-inheritance"><span class="std std-ref">用于连接表继承的批量 INSERT</span></a> 中所述，批量 UPDATE 操作会为映射中每个表发出一个 UPDATE 语句，其中给定的参数包括需要更新的值（未受影响的表会被跳过）。</p>
<p>示例:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     update(Manager),</span>
<span class="go">...     [</span>
<span class="go">...         {</span>
<span class="go">...             &quot;id&quot;: 1,</span>
<span class="go">...             &quot;name&quot;: &quot;scheeks&quot;,</span>
<span class="go">...             &quot;manager_name&quot;: &quot;Sandy Cheeks, President&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;id&quot;: 2,</span>
<span class="go">...             &quot;name&quot;: &quot;eugene&quot;,</span>
<span class="go">...             &quot;manager_name&quot;: &quot;Eugene H. Krabs, VP Marketing&quot;,</span>
<span class="go">...         },</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">name</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;scheeks&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;eugene&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)]</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">manager_name</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;Sandy Cheeks, President&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Eugene H. Krabs, VP Marketing&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)]</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--14-input--2" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--2">英文</label><div class="tab-content docutils container">
<p>ORM bulk update has similar behavior to ORM bulk insert when using mappings with joined table inheritance; as described at <a class="reference internal" href="#orm-queryguide-insert-joined-table-inheritance"><span class="std std-ref">用于连接表继承的批量 INSERT</span></a>, the bulk UPDATE operation will emit an UPDATE statement for each table represented in the mapping, for which the given parameters include values to be updated (non-affected tables are skipped).</p>
<p>Example:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="go">...     update(Manager),</span>
<span class="go">...     [</span>
<span class="go">...         {</span>
<span class="go">...             &quot;id&quot;: 1,</span>
<span class="go">...             &quot;name&quot;: &quot;scheeks&quot;,</span>
<span class="go">...             &quot;manager_name&quot;: &quot;Sandy Cheeks, President&quot;,</span>
<span class="go">...         },</span>
<span class="go">...         {</span>
<span class="go">...             &quot;id&quot;: 2,</span>
<span class="go">...             &quot;name&quot;: &quot;eugene&quot;,</span>
<span class="go">...             &quot;manager_name&quot;: &quot;Eugene H. Krabs, VP Marketing&quot;,</span>
<span class="go">...         },</span>
<span class="go">...     ],</span>
<span class="go">... )</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">name</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;scheeks&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;eugene&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)]</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">manager_name</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">[(</span><span class="s1">&#39;Sandy Cheeks, President&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Eugene H. Krabs, VP Marketing&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)]</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
</div>
</div>
</section>
<section id="orm-queryguide-legacy-bulk-update">
<span id="id5"></span><h3>旧会话批量 UPDATE 方法<a class="headerlink" href="#orm-queryguide-legacy-bulk-update" title="Link to this heading">¶</a></h3>
<p>Legacy Session Bulk UPDATE Methods</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--15-input--1" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--1">中文</label><div class="tab-content docutils container">
<p>如 <a class="reference internal" href="#orm-queryguide-legacy-bulk-insert"><span class="std std-ref">旧会话批量 INSERT 方法</span></a> 中所述，<cite>:meth:`_orm.Session.bulk_update_mappings</cite> 方法是 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> 的遗留批量更新形式，ORM 在解释带有主键参数的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a> 语句时会在内部使用该方法；然而，在使用遗留版本时，诸如会话同步支持等功能是不可用的。</p>
<p>下面的示例：</p>
<blockquote>
<div><dl>
<dt>session.bulk_update_mappings(</dt><dd><p>User,
[</p>
<blockquote>
<div><p>{“id”: 1, “name”: “scheeks”, “manager_name”: “Sandy Cheeks, President”},
{“id”: 2, “name”: “eugene”, “manager_name”: “Eugene H. Krabs, VP Marketing”},</p>
</div></blockquote>
<p>],</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<p>使用新 API 表示如下：</p>
<blockquote>
<div><p>from sqlalchemy import update</p>
<dl>
<dt>session.execute(</dt><dd><p>update(User),
[</p>
<blockquote>
<div><p>{“id”: 1, “name”: “scheeks”, “manager_name”: “Sandy Cheeks, President”},
{“id”: 2, “name”: “eugene”, “manager_name”: “Eugene H. Krabs, VP Marketing”},</p>
</div></blockquote>
<p>],</p>
</dd>
</dl>
<p>)</p>
</div></blockquote>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-queryguide-legacy-bulk-insert"><span class="std std-ref">旧会话批量 INSERT 方法</span></a></p>
</div>
</div>
<input class="tab-input" id="tab-set--15-input--2" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--2">英文</label><div class="tab-content docutils container">
<p>As discussed at <a class="reference internal" href="#orm-queryguide-legacy-bulk-insert"><span class="std std-ref">旧会话批量 INSERT 方法</span></a>, the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.bulk_update_mappings" title="sqlalchemy.orm.Session.bulk_update_mappings"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.bulk_update_mappings()</span></code></a> method of <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> is the legacy form of bulk update, which the ORM makes use of internally when interpreting a <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a> statement with primary key parameters given; however, when using the legacy version, features such as support for session-synchronization are not included.</p>
<p>The example below:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">session.bulk_update_mappings(</span>
<span class="go">    User,</span>
<span class="go">    [</span>
<span class="go">        {&quot;id&quot;: 1, &quot;name&quot;: &quot;scheeks&quot;, &quot;manager_name&quot;: &quot;Sandy Cheeks, President&quot;},</span>
<span class="go">        {&quot;id&quot;: 2, &quot;name&quot;: &quot;eugene&quot;, &quot;manager_name&quot;: &quot;Eugene H. Krabs, VP Marketing&quot;},</span>
<span class="go">    ],</span>
<span class="go">)</span></pre></div>
</div>
<p>Is expressed using the new API as:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="go">from sqlalchemy import update</span>

<span class="go">session.execute(</span>
<span class="go">    update(User),</span>
<span class="go">    [</span>
<span class="go">        {&quot;id&quot;: 1, &quot;name&quot;: &quot;scheeks&quot;, &quot;manager_name&quot;: &quot;Sandy Cheeks, President&quot;},</span>
<span class="go">        {&quot;id&quot;: 2, &quot;name&quot;: &quot;eugene&quot;, &quot;manager_name&quot;: &quot;Eugene H. Krabs, VP Marketing&quot;},</span>
<span class="go">    ],</span>
<span class="go">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-queryguide-legacy-bulk-insert"><span class="std std-ref">旧会话批量 INSERT 方法</span></a></p>
</div>
</div>
</div>
</section>
</section>
<section id="where-orm-update-delete">
<span id="orm-queryguide-update-delete-where"></span><h2>使用自定义 WHERE 条件的 ORM UPDATE 和 DELETE<a class="headerlink" href="#where-orm-update-delete" title="Link to this heading">¶</a></h2>
<p>ORM UPDATE and DELETE with Custom WHERE Criteria</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--16-input--1" name="tab-set--16" type="radio"><label class="tab-label" for="tab-set--16-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> 和 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.expression.Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a> 构造体在使用自定义 WHERE 条件（即使用 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update.where" title="sqlalchemy.sql.expression.Update.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Update.where()</span></code></a> 和 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Delete.where" title="sqlalchemy.sql.expression.Delete.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Delete.where()</span></code></a> 方法）时，可以通过将其传递给 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> 来在 ORM 环境中调用，而无需使用 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.params" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.params</span></code></a> 参数。对于 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a>，要更新的值应通过 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update.values" title="sqlalchemy.sql.expression.Update.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Update.values()</span></code></a> 传递。</p>
<p>这种用法与之前在 <a class="reference internal" href="#orm-queryguide-bulk-update"><span class="std std-ref">ORM 按主键批量 UPDATE</span></a> 中描述的功能不同，因为 ORM 使用给定的 WHERE 子句，而不是将 WHERE 子句固定为主键。这意味着单个 UPDATE 或 DELETE 语句可以一次影响多行数据。</p>
<p>以下是一个示例，演示了一个 UPDATE 操作影响多个行的 “fullname” 字段:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(User)</span>
<span class="go">...     .where(User.name.in_([&quot;squidward&quot;, &quot;sandy&quot;]))</span>
<span class="go">...     .values(fullname=&quot;Name starts with S&quot;)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Name starts with S&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>对于 DELETE，下面是基于条件删除行的示例:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">delete</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">delete</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="s2">&quot;squidward&quot;</span><span class="p">,</span> <span class="s2">&quot;sandy&quot;</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>请阅读以下章节 <a class="reference internal" href="#orm-queryguide-update-delete-caveats"><span class="std std-ref">启用 ORM 的更新和删除的重要说明和注意事项</span></a>，以了解关于 ORM 启用的 UPDATE 和 DELETE 如何与 ORM <a class="reference internal" href="../../glossary.html#term-39"><span class="xref std std-term">工作单元</span></a> 特性（如使用 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.delete" title="sqlalchemy.orm.Session.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.delete()</span></code></a> 方法删除单个对象）有所不同的相关重要说明。</p>
</div>
</div>
<input class="tab-input" id="tab-set--16-input--2" name="tab-set--16" type="radio"><label class="tab-label" for="tab-set--16-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a> and <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.expression.Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a> constructs, when constructed with custom WHERE criteria (that is, using the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update.where" title="sqlalchemy.sql.expression.Update.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Update.where()</span></code></a> and <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Delete.where" title="sqlalchemy.sql.expression.Delete.where"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Delete.where()</span></code></a> methods), may be invoked in an ORM context by passing them to <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>, without using the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.params" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.params</span></code></a> parameter. For <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-class docutils literal notranslate"><span class="pre">Update</span></code></a>, the values to be updated should be passed using <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update.values" title="sqlalchemy.sql.expression.Update.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Update.values()</span></code></a>.</p>
<p>This mode of use differs from the feature described previously at <a class="reference internal" href="#orm-queryguide-bulk-update"><span class="std std-ref">ORM 按主键批量 UPDATE</span></a> in that the ORM uses the given WHERE clause as is, rather than fixing the WHERE clause to be by primary key.   This means that the single UPDATE or DELETE statement can affect many rows at once.</p>
<p>As an example, below an UPDATE is emitted that affects the “fullname” field of multiple rows:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(User)</span>
<span class="go">...     .where(User.name.in_([&quot;squidward&quot;, &quot;sandy&quot;]))</span>
<span class="go">...     .values(fullname=&quot;Name starts with S&quot;)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Name starts with S&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>For a DELETE, an example of deleting rows based on criteria:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">delete</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">delete</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="s2">&quot;squidward&quot;</span><span class="p">,</span> <span class="s2">&quot;sandy&quot;</span><span class="p">]))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;squidward&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>Please read the following section <a class="reference internal" href="#orm-queryguide-update-delete-caveats"><span class="std std-ref">启用 ORM 的更新和删除的重要说明和注意事项</span></a> for important notes regarding how the functionality of ORM-Enabled UPDATE and DELETE diverges from that of ORM <a class="reference internal" href="../../glossary.html#term-unit-of-work"><span class="xref std std-term">unit of work</span></a> features, such as using the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.delete" title="sqlalchemy.orm.Session.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.delete()</span></code></a> method to delete individual objects.</p>
</div>
</div>
</div>
<section id="orm">
<span id="orm-queryguide-update-delete-caveats"></span><h3>启用 ORM 的更新和删除的重要说明和注意事项<a class="headerlink" href="#orm" title="Link to this heading">¶</a></h3>
<p>Important Notes and Caveats for ORM-Enabled Update and Delete</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--17-input--1" name="tab-set--17" type="radio"><label class="tab-label" for="tab-set--17-input--1">中文</label><div class="tab-content docutils container">
<p>ORM 启用的 UPDATE 和 DELETE 特性绕过了 ORM <a class="reference internal" href="../../glossary.html#term-39"><span class="xref std std-term">工作单元</span></a> 自动化，而是能够发出单个 UPDATE 或 DELETE 语句，这样可以一次匹配多个行且不增加复杂性。</p>
<ul class="simple">
<li><p>这些操作不提供 Python 内部的关系级联操作 - 假设对于需要的外键引用，已经配置了 ON UPDATE CASCADE 和/或 ON DELETE CASCADE，否则如果外键约束被强制执行，数据库可能会发出完整性违反的错误。有关示例，请参阅 <a class="reference internal" href="../cascades.html#passive-deletes"><span class="std std-ref">使用具有 ORM 关系的外键 ON DELETE 级联</span></a>。</p></li>
<li><p>在 UPDATE 或 DELETE 后，受 ON UPDATE CASCADE 或 ON DELETE CASCADE 影响的、与相关表格相关的依赖对象，尤其是那些指向已删除行的对象，可能仍然引用这些对象。 这个问题在 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> 过期后得到解决，通常是在 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.commit" title="sqlalchemy.orm.Session.commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code></a> 时发生，或者通过使用 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.expire_all" title="sqlalchemy.orm.Session.expire_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.expire_all()</span></code></a> 强制过期。</p></li>
<li><p>ORM 启用的 UPDATE 和 DELETE 不会自动处理连接表继承。有关如何处理连接继承映射的说明，请参阅 <a class="reference internal" href="#orm-queryguide-update-delete-joined-inh"><span class="std std-ref">使用 UPDATE/DELETE 和自定义 WHERE 条件进行连接表继承</span></a>。</p></li>
<li><p>为了将多态性身份限制为特定子类，单表继承映射中所需的 WHERE 条件 <strong>会自动包含</strong>。这仅适用于没有自己表的子类映射器。</p></li>
<li><p><a class="reference internal" href="api.html#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> 选项 <strong>被支持</strong> 用于 ORM 更新和删除操作；在这里的条件将添加到要发出的 UPDATE 或 DELETE 语句中，并在 “同步” 过程中被考虑。</p></li>
<li><p>要拦截 ORM 启用的 UPDATE 和 DELETE 操作并使用事件处理程序，请使用 <a class="reference internal" href="../events.html#sqlalchemy.orm.SessionEvents.do_orm_execute" title="sqlalchemy.orm.SessionEvents.do_orm_execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SessionEvents.do_orm_execute()</span></code></a> 事件。</p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--17-input--2" name="tab-set--17" type="radio"><label class="tab-label" for="tab-set--17-input--2">英文</label><div class="tab-content docutils container">
<p>The ORM-enabled UPDATE and DELETE features bypass ORM <a class="reference internal" href="../../glossary.html#term-unit-of-work"><span class="xref std std-term">unit of work</span></a> automation in favor of being able to emit a single UPDATE or DELETE statement that matches multiple rows at once without complexity.</p>
<ul class="simple">
<li><p>The operations do not offer in-Python cascading of relationships - it is assumed that ON UPDATE CASCADE and/or ON DELETE CASCADE is configured for any foreign key references which require it, otherwise the database may emit an integrity violation if foreign key references are being enforced. See the notes at <a class="reference internal" href="../cascades.html#passive-deletes"><span class="std std-ref">使用具有 ORM 关系的外键 ON DELETE 级联</span></a> for some examples.</p></li>
<li><p>After the UPDATE or DELETE, dependent objects in the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> which were impacted by an ON UPDATE CASCADE or ON DELETE CASCADE on related tables, particularly objects that refer to rows that have now been deleted, may still reference those objects.  This issue is resolved once the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> is expired, which normally occurs upon <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.commit" title="sqlalchemy.orm.Session.commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code></a> or can be forced by using <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.expire_all" title="sqlalchemy.orm.Session.expire_all"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.expire_all()</span></code></a>.</p></li>
<li><p>ORM-enabled UPDATEs and DELETEs do not handle joined table inheritance automatically.   See the section <a class="reference internal" href="#orm-queryguide-update-delete-joined-inh"><span class="std std-ref">使用 UPDATE/DELETE 和自定义 WHERE 条件进行连接表继承</span></a> for notes on how to work with joined-inheritance mappings.</p></li>
<li><p>The WHERE criteria needed in order to limit the polymorphic identity to specific subclasses for single-table-inheritance mappings <strong>is included automatically</strong> .   This only applies to a subclass mapper that has no table of its own.</p></li>
<li><p>The <a class="reference internal" href="api.html#sqlalchemy.orm.with_loader_criteria" title="sqlalchemy.orm.with_loader_criteria"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_loader_criteria()</span></code></a> option <strong>is supported</strong> by ORM update and delete operations; criteria here will be added to that of the UPDATE or DELETE statement being emitted, as well as taken into account during the “synchronize” process.</p></li>
<li><p>In order to intercept ORM-enabled UPDATE and DELETE operations with event handlers, use the <a class="reference internal" href="../events.html#sqlalchemy.orm.SessionEvents.do_orm_execute" title="sqlalchemy.orm.SessionEvents.do_orm_execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SessionEvents.do_orm_execute()</span></code></a> event.</p></li>
</ul>
</div>
</div>
</section>
<section id="orm-queryguide-update-delete-sync">
<span id="id6"></span><h3>选择同步策略<a class="headerlink" href="#orm-queryguide-update-delete-sync" title="Link to this heading">¶</a></h3>
<p>Selecting a Synchronization Strategy</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--18-input--1" name="tab-set--18" type="radio"><label class="tab-label" for="tab-set--18-input--1">中文</label><div class="tab-content docutils container">
<p>当使用 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a> 或 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.delete" title="sqlalchemy.sql.expression.delete"><code class="xref py py-func docutils literal notranslate"><span class="pre">delete()</span></code></a> 配合通过 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> 执行时，SQLAlchemy 提供了额外的 ORM 特定功能，能够 <strong>同步</strong> 由语句更改的状态与当前 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> 中的对象状态。这里的“同步”是指：UPDATE 的属性将被刷新为新值，或者至少被 <strong>过期</strong>，以便下次访问时重新填充新值；而被 DELETE 的对象将被标记为已删除状态。</p>
<p>同步行为可以通过 “同步策略” 来控制，该策略作为字符串 ORM 执行选项传递，通常通过使用 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.execution_options" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.execution_options</span></code></a> 字典:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(User).where(User.name == &quot;squidward&quot;).values(fullname=&quot;Squidward Tentacles&quot;)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">execution_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;synchronize_session&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>执行选项也可以通过 <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Executable.execution_options" title="sqlalchemy.sql.expression.Executable.execution_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Executable.execution_options()</span></code></a> 方法与语句一起传递:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(User)</span>
<span class="go">...     .where(User.name == &quot;squidward&quot;)</span>
<span class="go">...     .values(fullname=&quot;Squidward Tentacles&quot;)</span>
<span class="go">...     .execution_options(synchronize_session=False)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">synchronize_session</span></code> 支持以下值：</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">'auto'</span></code> - 默认值。若后端支持 RETURNING（包括除 MySQL 之外的所有 SQLAlchemy 原生驱动程序），则使用 <code class="docutils literal notranslate"><span class="pre">&quot;fetch&quot;</span></code> 策略。如果不支持 RETURNING，则使用 <cite>evaluate</cite> 策略。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'fetch'</span></code> - 通过执行 SELECT 语句或使用数据库支持的 RETURNING 来检索受影响行的主键，以便在内存中的对象能够刷新更新的值（更新操作）或从 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> 中移除已删除的对象（删除操作）。即使给定的 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a> 或 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.delete" title="sqlalchemy.sql.expression.delete"><code class="xref py py-func docutils literal notranslate"><span class="pre">delete()</span></code></a> 语句显式指定了返回值或列，也可以使用此同步策略。</p>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0 版本发生变更.</span></p>
</div>
<p>在使用带有 WHERE 条件的 ORM 启用的 UPDATE 和 DELETE 时，显式使用 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.UpdateBase.returning" title="sqlalchemy.sql.expression.UpdateBase.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">UpdateBase.returning()</span></code></a> 可以与 <code class="docutils literal notranslate"><span class="pre">&quot;fetch&quot;</span></code> 同步策略结合使用。实际语句将包含 <cite>fetch</cite> 策略所需的列与请求的列的联合。</p>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">'evaluate'</span></code> - 该策略指示在 Python 中评估 UPDATE 或 DELETE 语句中的 WHERE 条件，以在 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> 中找到匹配的对象。此方法不会增加 SQL 的往返次数，并且在没有 RETURNING 支持时可能更高效。但对于复杂的 UPDATE 或 DELETE 条件，<cite>’evaluate’</cite> 策略可能无法在 Python 中评估表达式，从而抛出错误。如果发生此情况，建议使用 <code class="docutils literal notranslate"><span class="pre">&quot;fetch&quot;</span></code> 策略。</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>如果 SQL 表达式使用了自定义操作符（使用 <a class="reference internal" href="../../core/sqlelement.html#sqlalchemy.sql.expression.Operators.op" title="sqlalchemy.sql.expression.Operators.op"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.op()</span></code></a> 或 <a class="reference internal" href="../../core/sqlelement.html#sqlalchemy.sql.expression.custom_op" title="sqlalchemy.sql.expression.custom_op"><code class="xref py py-class docutils literal notranslate"><span class="pre">custom_op</span></code></a> 特性），则可以通过 <a class="reference internal" href="../../core/sqlelement.html#sqlalchemy.sql.expression.Operators.op.params.python_impl" title="sqlalchemy.sql.expression.Operators.op"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Operators.op.python_impl</span></code></a> 参数指定一个 Python 函数，该函数将在 <code class="docutils literal notranslate"><span class="pre">&quot;evaluate&quot;</span></code> 同步策略中使用。</p>
<div class="versionadded">
<p><span class="versionmodified added">在 2.0 版本加入.</span></p>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>如果 UPDATE 操作要在一个已过期许多对象的 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> 上运行，建议避免使用 <code class="docutils literal notranslate"><span class="pre">&quot;evaluate&quot;</span></code> 策略，因为它必须刷新对象以测试其是否符合给定的 WHERE 条件，这将导致为每个对象发出一个 SELECT。在这种情况下，尤其是后端支持 RETURNING 时，应该更倾向于使用 <code class="docutils literal notranslate"><span class="pre">&quot;fetch&quot;</span></code> 策略。</p>
</div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code> - 不同步会话。对于不支持 RETURNING 的后端，如果 <code class="docutils literal notranslate"><span class="pre">&quot;evaluate&quot;</span></code> 策略无法使用，则此选项非常有用。在这种情况下，<cite>_orm.Session</cite> 中的对象状态不会自动与发出的 UPDATE 或 DELETE 语句对应，如果存在那些本应对应匹配行的对象，状态将保持不变。</p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--18-input--2" name="tab-set--18" type="radio"><label class="tab-label" for="tab-set--18-input--2">英文</label><div class="tab-content docutils container">
<p>When making use of <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a> or <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.delete" title="sqlalchemy.sql.expression.delete"><code class="xref py py-func docutils literal notranslate"><span class="pre">delete()</span></code></a> in conjunction with ORM-enabled execution using <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>, additional ORM-specific functionality is present which will <strong>synchronize</strong> the state being changed by the statement with that of the objects that are currently present within the <a class="reference internal" href="../../glossary.html#term-identity-map"><span class="xref std std-term">identity map</span></a> of the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a>. By “synchronize” we mean that UPDATEd attributes will be refreshed with the new value, or at the very least <a class="reference internal" href="../../glossary.html#term-expired"><span class="xref std std-term">expired</span></a> so that they will re-populate with their new value on next access, and DELETEd objects will be moved into the <a class="reference internal" href="../../glossary.html#term-deleted"><span class="xref std std-term">deleted</span></a> state.</p>
<p>This synchronization is controllable as the “synchronization strategy”, which is passed as an string ORM execution option, typically by using the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute.params.execution_options" title="sqlalchemy.orm.Session.execute"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.execute.execution_options</span></code></a> dictionary:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(User).where(User.name == &quot;squidward&quot;).values(fullname=&quot;Squidward Tentacles&quot;)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">execution_options</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;synchronize_session&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>The execution option may also be bundled with the statement itself using the <a class="reference internal" href="../../core/selectable.html#sqlalchemy.sql.expression.Executable.execution_options" title="sqlalchemy.sql.expression.Executable.execution_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Executable.execution_options()</span></code></a> method:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(User)</span>
<span class="go">...     .where(User.name == &quot;squidward&quot;)</span>
<span class="go">...     .values(fullname=&quot;Squidward Tentacles&quot;)</span>
<span class="go">...     .execution_options(synchronize_session=False)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>The following values for <code class="docutils literal notranslate"><span class="pre">synchronize_session</span></code> are supported:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">'auto'</span></code> - this is the default.   The <code class="docutils literal notranslate"><span class="pre">'fetch'</span></code> strategy will be used on backends that support RETURNING, which includes all SQLAlchemy-native drivers except for MySQL.   If RETURNING is not supported, the <code class="docutils literal notranslate"><span class="pre">'evaluate'</span></code> strategy will be used instead.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">'fetch'</span></code> - Retrieves the primary key identity of affected rows by either performing a SELECT before the UPDATE or DELETE, or by using RETURNING if the database supports it, so that in-memory objects which are affected by the operation can be refreshed with new values (updates) or expunged from the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> (deletes). This synchronization strategy may be used even if the given <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a> or <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.delete" title="sqlalchemy.sql.expression.delete"><code class="xref py py-func docutils literal notranslate"><span class="pre">delete()</span></code></a> construct explicitly specifies entities or columns using <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.UpdateBase.returning" title="sqlalchemy.sql.expression.UpdateBase.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">UpdateBase.returning()</span></code></a>.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0 版本发生变更: </span>Explicit <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.UpdateBase.returning" title="sqlalchemy.sql.expression.UpdateBase.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">UpdateBase.returning()</span></code></a> may be combined with the <code class="docutils literal notranslate"><span class="pre">'fetch'</span></code> synchronization strategy when using ORM-enabled UPDATE and DELETE with WHERE criteria.  The actual statement will contain the union of columns between that which the <code class="docutils literal notranslate"><span class="pre">'fetch'</span></code> strategy requires and those which were requested.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">'evaluate'</span></code> - This indicates to evaluate the WHERE criteria given in the UPDATE or DELETE statement in Python, to locate matching objects within the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a>. This approach does not add any SQL round trips to the operation, and in the absence of RETURNING support, may be more efficient. For UPDATE or DELETE statements with complex criteria, the <code class="docutils literal notranslate"><span class="pre">'evaluate'</span></code> strategy may not be able to evaluate the expression in Python and will raise an error. If this occurs, use the <code class="docutils literal notranslate"><span class="pre">'fetch'</span></code> strategy for the operation instead.</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>If a SQL expression makes use of custom operators using the <a class="reference internal" href="../../core/sqlelement.html#sqlalchemy.sql.expression.Operators.op" title="sqlalchemy.sql.expression.Operators.op"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.op()</span></code></a> or <a class="reference internal" href="../../core/sqlelement.html#sqlalchemy.sql.expression.custom_op" title="sqlalchemy.sql.expression.custom_op"><code class="xref py py-class docutils literal notranslate"><span class="pre">custom_op</span></code></a> feature, the <a class="reference internal" href="../../core/sqlelement.html#sqlalchemy.sql.expression.Operators.op.params.python_impl" title="sqlalchemy.sql.expression.Operators.op"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Operators.op.python_impl</span></code></a> parameter may be used to indicate a Python function that will be used by the <code class="docutils literal notranslate"><span class="pre">&quot;evaluate&quot;</span></code> synchronization strategy.</p>
<div class="versionadded">
<p><span class="versionmodified added">在 2.0 版本加入.</span></p>
</div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>The <code class="docutils literal notranslate"><span class="pre">&quot;evaluate&quot;</span></code> strategy should be avoided if an UPDATE operation is to run on a <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> that has many objects which have been expired, because it will necessarily need to refresh objects in order to test them against the given WHERE criteria, which will emit a SELECT for each one.   In this case, and particularly if the backend supports RETURNING, the <code class="docutils literal notranslate"><span class="pre">&quot;fetch&quot;</span></code> strategy should be preferred.</p>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">False</span></code> - don’t synchronize the session. This option may be useful for backends that don’t support RETURNING where the <code class="docutils literal notranslate"><span class="pre">&quot;evaluate&quot;</span></code> strategy is not able to be used.  In this case, the state of objects in the <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> is unchanged and will not automatically correspond to the UPDATE or DELETE statement that was emitted, if such objects that would normally correspond to the rows matched are present.</p></li>
</ul>
</div>
</div>
</section>
<section id="returning-update-delete-where">
<span id="orm-queryguide-update-delete-where-returning"></span><h3>使用 RETURNING 和 UPDATE/DELETE 以及自定义 WHERE 条件<a class="headerlink" href="#returning-update-delete-where" title="Link to this heading">¶</a></h3>
<p>Using RETURNING with UPDATE/DELETE and Custom WHERE Criteria</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--19-input--1" name="tab-set--19" type="radio"><label class="tab-label" for="tab-set--19-input--1">中文</label><div class="tab-content docutils container">
<p><cite>:meth:</cite>.UpdateBase.returning` 方法与带有 WHERE 条件的 ORM 启用的 UPDATE 和 DELETE 操作完全兼容。可以指定完整的 ORM 对象和/或列进行 RETURNING 操作:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(User)</span>
<span class="go">...     .where(User.name == &quot;squidward&quot;)</span>
<span class="go">...     .values(fullname=&quot;Squidward Tentacles&quot;)</span>
<span class="go">...     .returning(User)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="go">[User(name=&#39;squidward&#39;, fullname=&#39;Squidward Tentacles&#39;)]</span></pre></div>
</div>
<p>RETURNING 的支持与 <code class="docutils literal notranslate"><span class="pre">fetch</span></code> 同步策略兼容，后者也使用 RETURNING。ORM 会适当地组织 RETURNING 中的列，以确保同步过程顺利进行，同时返回的 <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> 将包含按请求顺序排列的实体和 SQL 列。</p>
<div class="versionadded">
<p><span class="versionmodified added">在 2.0 版本加入: </span><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.UpdateBase.returning" title="sqlalchemy.sql.expression.UpdateBase.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">UpdateBase.returning()</span></code></a> 可用于 ORM 启用的 UPDATE 和 DELETE，同时仍然与 <code class="docutils literal notranslate"><span class="pre">fetch</span></code> 同步策略完全兼容。</p>
</div>
</div>
<input class="tab-input" id="tab-set--19-input--2" name="tab-set--19" type="radio"><label class="tab-label" for="tab-set--19-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.UpdateBase.returning" title="sqlalchemy.sql.expression.UpdateBase.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">UpdateBase.returning()</span></code></a> method is fully compatible with ORM-enabled UPDATE and DELETE with WHERE criteria.   Full ORM objects and/or columns may be indicated for RETURNING:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">update</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(User)</span>
<span class="go">...     .where(User.name == &quot;squidward&quot;)</span>
<span class="go">...     .values(fullname=&quot;Squidward Tentacles&quot;)</span>
<span class="go">...     .returning(User)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">user_account</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">fullname</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">user_account</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">fullname</span><span class="p">,</span><span class="w"> </span><span class="n">species</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Squidward Tentacles&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;squidward&#39;</span><span class="p">)</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">all</span><span class="p">())</span>
<span class="go">[User(name=&#39;squidward&#39;, fullname=&#39;Squidward Tentacles&#39;)]</span></pre></div>
</div>
<p>The support for RETURNING is also compatible with the <code class="docutils literal notranslate"><span class="pre">fetch</span></code> synchronization strategy, which also uses RETURNING.  The ORM will organize the columns in RETURNING appropriately so that the synchronization proceeds as well as that the returned <a class="reference internal" href="../../core/connections.html#sqlalchemy.engine.Result" title="sqlalchemy.engine.Result"><code class="xref py py-class docutils literal notranslate"><span class="pre">Result</span></code></a> will contain the requested entities and SQL columns in their requested order.</p>
<div class="versionadded">
<p><span class="versionmodified added">在 2.0 版本加入: </span><a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.UpdateBase.returning" title="sqlalchemy.sql.expression.UpdateBase.returning"><code class="xref py py-meth docutils literal notranslate"><span class="pre">UpdateBase.returning()</span></code></a> may be used for ORM enabled UPDATE and DELETE while still retaining full compatibility with the <code class="docutils literal notranslate"><span class="pre">fetch</span></code> synchronization strategy.</p>
</div>
</div>
</div>
</section>
<section id="update-delete-where">
<span id="orm-queryguide-update-delete-joined-inh"></span><h3>使用 UPDATE/DELETE 和自定义 WHERE 条件进行连接表继承<a class="headerlink" href="#update-delete-where" title="Link to this heading">¶</a></h3>
<p>UPDATE/DELETE with Custom WHERE Criteria for Joined Table Inheritance</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--20-input--1" name="tab-set--20" type="radio"><label class="tab-label" for="tab-set--20-input--1">中文</label><div class="tab-content docutils container">
<p>UPDATE/DELETE 语句与 WHERE 条件的特性，与 <a class="reference internal" href="#orm-queryguide-bulk-update"><span class="std std-ref">ORM 按主键批量 UPDATE</span></a> 不同，每次调用 <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a> 时只会发出单个 UPDATE 或 DELETE 语句。这意味着，当对多表映射（例如，连接表继承映射中的子类）运行 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a> 或 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.delete" title="sqlalchemy.sql.expression.delete"><code class="xref py py-func docutils literal notranslate"><span class="pre">delete()</span></code></a> 语句时，必须遵循后端当前的能力，这可能包括后端不支持涉及多个表的 UPDATE 或 DELETE 语句，或者仅有限支持。这意味着对于像连接继承子类这样的映射，ORM 版本的 UPDATE/DELETE 语句在使用 WHERE 条件时只能在一定程度上使用，或者完全不能使用，具体取决于后端的特性。</p>
<p>对于连接表继承子类，发出多行 UPDATE 语句的最直接方法是仅引用子表。这意味着 <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-func docutils literal notranslate"><span class="pre">Update()</span></code></a> 构造应仅引用本地子类表中的属性，如下所示:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(Manager)</span>
<span class="go">...     .where(Manager.id == 1)</span>
<span class="go">...     .values(manager_name=&quot;Sandy Cheeks, President&quot;)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">manager_name</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Sandy Cheeks, President&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>
</div></pre></div>
</div>
<p>对于上述形式，一种基本的方法是使用子查询来引用基础表，以便在任何 SQL 后端上工作:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(Manager)</span>
<span class="go">...     .where(</span>
<span class="go">...         Manager.id</span>
<span class="go">...         == select(Employee.id).where(Employee.name == &quot;sandy&quot;).scalar_subquery()</span>
<span class="go">...     )</span>
<span class="go">...     .values(manager_name=&quot;Sandy Cheeks, President&quot;)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">manager_name</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">employee</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Sandy Cheeks, President&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>对于支持 <cite>UPDATE…FROM</cite> 的后端，子查询可以作为额外的简单 WHERE 条件表示，然而两个表之间的条件必须明确声明:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(Manager)</span>
<span class="go">...     .where(Manager.id == Employee.id, Employee.name == &quot;sandy&quot;)</span>
<span class="go">...     .values(manager_name=&quot;Sandy Cheeks, President&quot;)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">manager_name</span><span class="o">=?</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employee</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Sandy Cheeks, President&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>对于 DELETE，预计基础表和子表中的行会同时被删除。为了 <strong>不使用</strong> 外键级联删除多个连接继承对象的行，应单独为每个表发出 DELETE 语句:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">delete</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">Manager</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Manager</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<div class='show_sql'><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
</div><span class="go">&lt;...&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">Employee</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<div class='show_sql'><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>总体而言，正常的 <a class="reference internal" href="../../glossary.html#term-unit-of-work"><span class="xref std std-term">unit of work</span></a> 过程应 <strong>优先</strong> 用于更新和删除连接继承和其他多表映射中的行，除非有使用自定义 WHERE 条件的性能理由。</p>
</div>
<input class="tab-input" id="tab-set--20-input--2" name="tab-set--20" type="radio"><label class="tab-label" for="tab-set--20-input--2">英文</label><div class="tab-content docutils container">
<p>The UPDATE/DELETE with WHERE criteria feature, unlike the <a class="reference internal" href="#orm-queryguide-bulk-update"><span class="std std-ref">ORM 按主键批量 UPDATE</span></a>, only emits a single UPDATE or DELETE statement per call to <a class="reference internal" href="../session_api.html#sqlalchemy.orm.Session.execute" title="sqlalchemy.orm.Session.execute"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.execute()</span></code></a>. This means that when running an <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.update" title="sqlalchemy.sql.expression.update"><code class="xref py py-func docutils literal notranslate"><span class="pre">update()</span></code></a> or <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.delete" title="sqlalchemy.sql.expression.delete"><code class="xref py py-func docutils literal notranslate"><span class="pre">delete()</span></code></a> statement against a multi-table mapping, such as a subclass in a joined-table inheritance mapping, the statement must conform to the backend’s current capabilities, which may include that the backend does not support an UPDATE or DELETE statement that refers to multiple tables, or may have only limited support for this. This means that for mappings such as joined inheritance subclasses, the ORM version of the UPDATE/DELETE with WHERE criteria feature can only be used to a limited extent or not at all, depending on specifics.</p>
<p>The most straightforward way to emit a multi-row UPDATE statement for a joined-table subclass is to refer to the sub-table alone. This means the <a class="reference internal" href="../../core/dml.html#sqlalchemy.sql.expression.Update" title="sqlalchemy.sql.expression.Update"><code class="xref py py-func docutils literal notranslate"><span class="pre">Update()</span></code></a> construct should only refer to attributes that are local to the subclass table, as in the example below:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(Manager)</span>
<span class="go">...     .where(Manager.id == 1)</span>
<span class="go">...     .values(manager_name=&quot;Sandy Cheeks, President&quot;)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">manager_name</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Sandy Cheeks, President&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="o">&lt;</span><span class="p">...</span><span class="o">&gt;</span>
</div></pre></div>
</div>
<p>With the above form, a rudimentary way to refer to the base table in order to locate rows which will work on any SQL backend is so use a subquery:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(Manager)</span>
<span class="go">...     .where(</span>
<span class="go">...         Manager.id</span>
<span class="go">...         == select(Employee.id).where(Employee.name == &quot;sandy&quot;).scalar_subquery()</span>
<span class="go">...     )</span>
<span class="go">...     .values(manager_name=&quot;Sandy Cheeks, President&quot;)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">manager_name</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">employee</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">RETURNING</span><span class="w"> </span><span class="n">id</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Sandy Cheeks, President&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>For backends that support UPDATE…FROM, the subquery may be stated instead as additional plain WHERE criteria, however the criteria between the two tables must be stated explicitly in some way:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
<span class="go">...     update(Manager)</span>
<span class="go">...     .where(Manager.id == Employee.id, Employee.name == &quot;sandy&quot;)</span>
<span class="go">...     .values(manager_name=&quot;Sandy Cheeks, President&quot;)</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql'><span class="k">UPDATE</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">manager_name</span><span class="o">=?</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employee</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;Sandy Cheeks, President&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;sandy&#39;</span><span class="p">)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>For a DELETE, it’s expected that rows in both the base table and the sub-table would be DELETEd at the same time.   To DELETE many rows of joined inheritance objects <strong>without</strong> using cascading foreign keys, emit DELETE for each table individually:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">delete</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">Manager</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Manager</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<div class='show_sql'><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
</div><span class="go">&lt;...&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">delete</span><span class="p">(</span><span class="n">Employee</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Employee</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<div class='show_sql'><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">[...]</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
</div><span class="go">&lt;...&gt;</span></pre></div>
</div>
<p>Overall, normal <a class="reference internal" href="../../glossary.html#term-unit-of-work"><span class="xref std std-term">unit of work</span></a> processes should be <strong>preferred</strong> for updating and deleting rows for joined inheritance and other multi-table mappings, unless there is a performance rationale for using custom WHERE criteria.</p>
</div>
</div>
</section>
<section id="id7">
<h3>旧式查询方法<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h3>
<p>Legacy Query Methods</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--21-input--1" name="tab-set--21" type="radio"><label class="tab-label" for="tab-set--21-input--1">中文</label><div class="tab-content docutils container">
<p>ORM 启用的 UPDATE/DELETE 与 WHERE 条件的特性最初是 <a class="reference internal" href="query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> 对象的一部分，位于 <a class="reference internal" href="query.html#sqlalchemy.orm.Query.update" title="sqlalchemy.orm.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a> 和 <a class="reference internal" href="query.html#sqlalchemy.orm.Query.delete" title="sqlalchemy.orm.Query.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.delete()</span></code></a> 方法中。这些方法仍然可用，并提供了与 <a class="reference internal" href="#orm-queryguide-update-delete-where"><span class="std std-ref">使用自定义 WHERE 条件的 ORM UPDATE 和 DELETE</span></a> 中描述的功能相同的子集。主要的区别是，遗留方法不支持显式的 RETURNING 功能。</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="query.html#sqlalchemy.orm.Query.update" title="sqlalchemy.orm.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a></p>
<p><a class="reference internal" href="query.html#sqlalchemy.orm.Query.delete" title="sqlalchemy.orm.Query.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.delete()</span></code></a></p>
</div>
</div>
<input class="tab-input" id="tab-set--21-input--2" name="tab-set--21" type="radio"><label class="tab-label" for="tab-set--21-input--2">英文</label><div class="tab-content docutils container">
<p>The ORM enabled UPDATE/DELETE with WHERE feature was originally part of the now-legacy <a class="reference internal" href="query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object, in the <a class="reference internal" href="query.html#sqlalchemy.orm.Query.update" title="sqlalchemy.orm.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a> and <a class="reference internal" href="query.html#sqlalchemy.orm.Query.delete" title="sqlalchemy.orm.Query.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.delete()</span></code></a> methods.  These methods remain available and provide a subset of the same functionality as that described at <a class="reference internal" href="#orm-queryguide-update-delete-where"><span class="std std-ref">使用自定义 WHERE 条件的 ORM UPDATE 和 DELETE</span></a>.  The primary difference is that the legacy methods don’t provide for explicit RETURNING support.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="query.html#sqlalchemy.orm.Query.update" title="sqlalchemy.orm.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a></p>
<p><a class="reference internal" href="query.html#sqlalchemy.orm.Query.delete" title="sqlalchemy.orm.Query.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.delete()</span></code></a></p>
</div>
</div>
</div>
</section>
</section>
</section>
<aside class="topic">
<p class="topic-title">ORM Querying Guide</p>
<p>Next Query Guide Section: <a class="reference internal" href="columns.html"><span class="doc">列加载选项</span></a></p>
</aside>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="columns.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">列加载选项</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="inheritance.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">为继承映射编写 SELECT 语句</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                <a href="../../copyright.html">Copyright</a> &#169; 2007-2025, the SQLAlchemy authors and contributors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on 04/05/2025 04:00:26</div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">启用 ORM 的 INSERT、UPDATE 和 DELETE 语句</a><ul>
<li><a class="reference internal" href="#orm-insert">ORM 批量 INSERT 语句</a><ul>
<li><a class="reference internal" href="#returning">使用 RETURNING 获取新对象</a><ul>
<li><a class="reference internal" href="#orm-queryguide-bulk-insert-returning-ordered">将 RETURNING 记录与输入数据顺序关联</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm-queryguide-insert-heterogeneous-params">使用异构参数字典</a></li>
<li><a class="reference internal" href="#orm-insert-null">在 ORM 批量 INSERT 语句中发送 NULL 值</a></li>
<li><a class="reference internal" href="#insert">用于连接表继承的批量 INSERT</a></li>
<li><a class="reference internal" href="#sql-orm">使用 SQL 表达式的 ORM 批量插入</a><ul>
<li><a class="reference internal" href="#orm-queryguide-insert-values">使用每行 SQL 表达式的 ORM 批量插入</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm-queryguide-legacy-bulk-insert">旧会话批量 INSERT 方法</a></li>
<li><a class="reference internal" href="#ormupsert">ORM“upsert”语句</a><ul>
<li><a class="reference internal" href="#returning-upsert">将 RETURNING 与 upsert 语句结合使用</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="#orm-update">ORM 按主键批量 UPDATE</a><ul>
<li><a class="reference internal" href="#update-orm">禁用具有多个参数集的 UPDATE 语句的按主键批量 ORM 更新</a></li>
<li><a class="reference internal" href="#update">用于连接表继承的按主键批量 UPDATE</a></li>
<li><a class="reference internal" href="#orm-queryguide-legacy-bulk-update">旧会话批量 UPDATE 方法</a></li>
</ul>
</li>
<li><a class="reference internal" href="#where-orm-update-delete">使用自定义 WHERE 条件的 ORM UPDATE 和 DELETE</a><ul>
<li><a class="reference internal" href="#orm">启用 ORM 的更新和删除的重要说明和注意事项</a></li>
<li><a class="reference internal" href="#orm-queryguide-update-delete-sync">选择同步策略</a></li>
<li><a class="reference internal" href="#returning-update-delete-where">使用 RETURNING 和 UPDATE/DELETE 以及自定义 WHERE 条件</a></li>
<li><a class="reference internal" href="#update-delete-where">使用 UPDATE/DELETE 和自定义 WHERE 条件进行连接表继承</a></li>
<li><a class="reference internal" href="#id7">旧式查询方法</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../../_static/jquery.js?v=5d32c60e"></script>
    <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../../_static/documentation_options.js?v=2d0eb83f"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../../_static/tabs.js?v=3ee01567"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=2f3e6152"></script>
    <script src="../../_static/translations.js?v=beaddf03"></script>
    </body>
</html>