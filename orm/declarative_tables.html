<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="copyright" title="版权所有" href="../copyright.html" /><link rel="next" title="使用声明式映射器配置" href="declarative_config.html" /><link rel="prev" title="声明式映射风格" href="declarative_styles.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.08.06 -->
        <title>声明式的表配置 - SQLAlchemy 2.1 Documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/changelog.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_paramlinks.css" />
    <link rel="stylesheet" type="text/css" href="../_static/docs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">SQLAlchemy 2.1 Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">SQLAlchemy 2.1 Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">概述</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorial/index.html">SQLAlchemy 统一教程</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of SQLAlchemy 统一教程</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/engine.html">建立连接 - Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/dbapi_transactions.html">使用事务和DBAPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/metadata.html">使用数据库元数据</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../tutorial/data.html">处理数据</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of 处理数据</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/data_insert.html">使用 INSERT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/data_select.html">使用 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/data_update.html">使用 UPDATE 和 DELETE 语句</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/orm_data_manipulation.html">使用 ORM 进行数据操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/orm_related_objects.html">使用 ORM 相关对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/further_reading.html">进一步阅读</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">SQLAlchemy ORM</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of SQLAlchemy ORM</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quickstart.html">ORM 快速入门</a></li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="mapper_config.html">ORM 映射类配置</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of ORM 映射类配置</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="mapping_styles.html">ORM 映射类概述</a></li>
<li class="toctree-l3 current has-children"><a class="reference internal" href="declarative_mapping.html">使用声明式映射类</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of 使用声明式映射类</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l4"><a class="reference internal" href="declarative_styles.html">声明式映射风格</a></li>
<li class="toctree-l4 current current-page"><a class="current reference internal" href="#">声明式的表配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="declarative_config.html">使用声明式映射器配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="declarative_mixins.html">使用 Mixins 组合映射层次结构</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="dataclasses.html">与dataclass和attrs的集成</a></li>
<li class="toctree-l3"><a class="reference internal" href="mapped_sql_expr.html">SQL 表达式作为映射属性</a></li>
<li class="toctree-l3"><a class="reference internal" href="mapped_attributes.html">更改Attribute的行为</a></li>
<li class="toctree-l3"><a class="reference internal" href="composites.html">复合列类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="inheritance.html">映射类继承层次结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="nonstandard_mappings.html">非传统映射</a></li>
<li class="toctree-l3"><a class="reference internal" href="versioning.html">配置版本计数器</a></li>
<li class="toctree-l3"><a class="reference internal" href="mapping_api.html">类映射 API</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="scalar_mapping.html">映射 SQL 表达式</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of 映射 SQL 表达式</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="mapping_columns.html">映射表格列</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="relationships.html">关系配置</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of 关系配置</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="basic_relationships.html">基本关系模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="self_referential.html">邻接表关系</a></li>
<li class="toctree-l3"><a class="reference internal" href="join_conditions.html">配置关系连接方式</a></li>
<li class="toctree-l3"><a class="reference internal" href="large_collections.html">使用大型集合</a></li>
<li class="toctree-l3"><a class="reference internal" href="collection_api.html">集合自定义和 API 详细信息</a></li>
<li class="toctree-l3"><a class="reference internal" href="relationship_persistence.html">特殊关系的持久化模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="backref.html">使用旧版“backref”关系参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="relationship_api.html">关系 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="queryguide/index.html">ORM 查询指南</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of ORM 查询指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="queryguide/select.html">为 ORM 映射类编写 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="queryguide/inheritance.html">为继承映射编写 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="queryguide/dml.html">启用 ORM 的 INSERT、UPDATE 和 DELETE 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="queryguide/columns.html">列加载选项</a></li>
<li class="toctree-l3"><a class="reference internal" href="queryguide/relationships.html">关系加载技术</a></li>
<li class="toctree-l3"><a class="reference internal" href="queryguide/api.html">用于查询的 ORM API 功能</a></li>
<li class="toctree-l3"><a class="reference internal" href="queryguide/query.html">旧式查询 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="session.html">使用会话</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of 使用会话</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="session_basics.html">会话基础知识</a></li>
<li class="toctree-l3"><a class="reference internal" href="session_state_management.html">状态管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="cascades.html">级联</a></li>
<li class="toctree-l3"><a class="reference internal" href="session_transaction.html">事务和连接管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="persistence_techniques.html">附加持久性技术</a></li>
<li class="toctree-l3"><a class="reference internal" href="contextual.html">上下文/线程本地会话</a></li>
<li class="toctree-l3"><a class="reference internal" href="session_events.html">使用事件跟踪查询、对象和会话更改</a></li>
<li class="toctree-l3"><a class="reference internal" href="session_api.html">会话 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="extending.html">事件和内部</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of 事件和内部</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="events.html">ORM 事件</a></li>
<li class="toctree-l3"><a class="reference internal" href="internals.html">ORM 内部</a></li>
<li class="toctree-l3"><a class="reference internal" href="exceptions.html">ORM 异常</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="extensions/index.html">ORM 扩展</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of ORM 扩展</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="extensions/asyncio.html">异步 I/O (asyncio)</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/associationproxy.html">关联代理</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/automap.html">自动映射</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/baked.html">烘焙查询</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/declarative/index.html">声明式扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/mutable.html">突变追踪</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/orderinglist.html">排序列表</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/horizontal_shard.html">水平分片</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/hybrid.html">混合属性</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/indexable.html">Indexable</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/instrumentation.html">替代类检测</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="examples.html">核心和 ORM 示例</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../core/index.html">SQLAlchemy Core</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of SQLAlchemy Core</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/expression_api.html">SQL 语句和表达式 API</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of SQL 语句和表达式 API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/sqlelement.html">列元素和表达式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/operators.html">操作符参考</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/selectable.html">SELECT 和相关构造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/dml.html">插入,更新,删除</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/functions.html">SQL 和 范型函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/compiler.html">自定义 SQL 构造和编译扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/serializer.html">表达式序列化器扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/foundation.html">SQL 表达式语言基础构造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/visitors.html">访问者和遍历实用程序</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/schema.html">Schema 定义语言</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of Schema 定义语言</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/metadata.html">使用元数据描述数据库</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/reflection.html">反映数据库对象</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/defaults.html">列 INSERT/UPDATE 默认值</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/constraints.html">定义约束和索引</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/ddl.html">自定义 DDL</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/types.html">SQL 数据类型对象</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of SQL 数据类型对象</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/type_basics.html">类型层次结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/custom_types.html">自定义类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/type_api.html">基本类型 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/engines_connections.html">Engine和Connection的使用</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of Engine和Connection的使用</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/engines.html">Engine 配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/connections.html">使用Engines和Connection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/pooling.html">连接池</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/events.html">核心事件</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/api_basics.html">Core API 基础</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of Core API 基础</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/event.html">事件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/inspection.html">运行时审查 API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/exceptions.html">Core 异常</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/internals.html">Core 内部</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../dialects/index.html">Dialects</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of Dialects</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../dialects/postgresql.html">PostgreSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/mysql.html">MySQL 和 MariaDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/sqlite.html">SQLite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/oracle.html">Oracle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/mssql.html">Microsoft SQL Server</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../faq/index.html">常见问题</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of 常见问题</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq/installation.html">安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/connections.html">连接 / 引擎</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/metadata_schema.html">元数据 / Schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/sqlexpressions.html">SQL 表达式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/ormconfiguration.html">ORM 配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/performance.html">性能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/sessions.html">会话 / 查询</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/thirdparty.html">第三方包集成问题</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../errors.html">错误消息</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../changelog/index.html">变更和迁移</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of 变更和迁移</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_21.html">SQLAlchemy 2.1 有什么新功能？</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_21.html">2.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_20.html">2.0 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_14.html">1.4 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_13.html">1.3 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_12.html">1.2 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_11.html">1.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_10.html">1.0 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_09.html">0.9 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_08.html">0.8 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_07.html">0.7 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_06.html">0.6 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_05.html">0.5 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_04.html">0.4 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_03.html">0.3 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_02.html">0.2 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_01.html">0.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_20.html">SQLAlchemy 2.0 - Major Migration Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/whatsnew_20.html">What’s New in SQLAlchemy 2.0?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_14.html">What’s New in SQLAlchemy 1.4?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_13.html">What’s New in SQLAlchemy 1.3?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_12.html">What’s New in SQLAlchemy 1.2?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_11.html">What’s New in SQLAlchemy 1.1?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_10.html">What’s New in SQLAlchemy 1.0?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_09.html">What’s New in SQLAlchemy 0.9?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_08.html">What’s New in SQLAlchemy 0.8?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_07.html">What’s New in SQLAlchemy 0.7?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_06.html">What’s New in SQLAlchemy 0.6?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_05.html">What’s new in SQLAlchemy 0.5?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_04.html">What’s new in SQLAlchemy 0.4?</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="orm-declarative-table-config-toplevel">
<span id="id1"></span><h1>声明式的表配置<a class="headerlink" href="#orm-declarative-table-config-toplevel" title="Link to this heading">¶</a></h1>
<p>Table Configuration with Declarative</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">中文</label><div class="tab-content docutils container">
<p>如 <a class="reference internal" href="mapping_styles.html#orm-declarative-mapping"><span class="std std-ref">声明式映射</span></a> 中所介绍的，声明式风格包括同时生成映射的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象的能力，或直接容纳 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 或其他 <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><code class="xref py py-class docutils literal notranslate"><span class="pre">FromClause</span></code></a> 对象。</p>
<p>以下示例假设一个声明式基类，如:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>以下所有示例都说明了从上述 <code class="docutils literal notranslate"><span class="pre">Base</span></code> 继承的类。<a class="reference internal" href="declarative_styles.html#orm-declarative-decorator"><span class="std std-ref">使用装饰器进行声明性映射（无声明性基类）</span></a> 中介绍的装饰器风格在以下所有示例中也完全支持，声明式基类的旧形式也是如此，包括由 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.declarative_base" title="sqlalchemy.orm.declarative_base"><code class="xref py py-func docutils literal notranslate"><span class="pre">declarative_base()</span></code></a> 生成的基类。</p>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">英文</label><div class="tab-content docutils container">
<p>As introduced at <a class="reference internal" href="mapping_styles.html#orm-declarative-mapping"><span class="std std-ref">声明式映射</span></a>, the Declarative style
includes the ability to generate a mapped <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object
at the same time, or to accommodate a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> or other
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><code class="xref py py-class docutils literal notranslate"><span class="pre">FromClause</span></code></a> object directly.</p>
<p>The following examples assume a declarative base class as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>All of the examples that follow illustrate a class inheriting from the above
<code class="docutils literal notranslate"><span class="pre">Base</span></code>.  The decorator style introduced at <a class="reference internal" href="declarative_styles.html#orm-declarative-decorator"><span class="std std-ref">使用装饰器进行声明性映射（无声明性基类）</span></a>
is fully supported with all the following examples as well, as are legacy
forms of Declarative Base including base classes generated by
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.declarative_base" title="sqlalchemy.orm.declarative_base"><code class="xref py py-func docutils literal notranslate"><span class="pre">declarative_base()</span></code></a>.</p>
</div>
</div>
<section id="mapped-column">
<span id="orm-declarative-table"></span><h2>带有 <code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code> 的声明表<a class="headerlink" href="#mapped-column" title="Link to this heading">¶</a></h2>
<p>Declarative Table with <code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code></p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">中文</label><div class="tab-content docutils container">
<p>在使用声明式时，要映射的类的主体在大多数情况下包括一个属性 <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> ，该属性指示应与映射一起生成的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 的字符串名称。然后，在类主体中使用具有其他ORM特定配置功能的 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造来指示表中的列。下面的示例说明了在声明式映射中使用此构造的最基本方法:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">nickname</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>如上所述，<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造在类定义中内联放置为类级别属性。在类声明时，声明式映射过程将针对与声明式 <code class="docutils literal notranslate"><span class="pre">Base</span></code> 关联的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> 集合生成一个新的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象；在此过程中，每个 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 实例将用于生成一个 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象，该对象将成为此 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.columns" title="sqlalchemy.schema.Table.columns"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Table.columns</span></code></a> 集合的一部分。</p>
<p>在上述示例中，声明式将构建一个等效于以下内容的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 构造:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 生成的等效Table对象</span>
<span class="n">user_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">()),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nickname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">)),</span>
<span class="p">)</span></pre></div>
</div>
<p>当上述 <code class="docutils literal notranslate"><span class="pre">User</span></code> 类映射时，可以通过 <code class="docutils literal notranslate"><span class="pre">__table__</span></code> 属性直接访问此 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象；这在 <a class="reference internal" href="#orm-declarative-metadata"><span class="std std-ref">访问表和元数据</span></a> 中有进一步描述。</p>
<div class="admonition-mapped-column-column admonition">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code> 取代了 <code class="docutils literal notranslate"><span class="pre">Column()</span></code> 的使用</p>
<p>1.x 版本SQLAlchemy的用户将注意到 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造的使用，这是SQLAlchemy 2.0系列的新功能。此ORM特定的构造首先旨在成为声明式映射中 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 的直接替代，添加了新的ORM特定的便利功能，例如在构造中建立 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.deferred" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.deferred</span></code></a> 的能力，最重要的是向Mypy_和Pylance_等工具准确表示属性在运行时在类级别和实例级别的行为。正如在以下部分中将看到的那样，它也是SQLAlchemy 2.0中引入的新注释驱动配置风格的前沿。</p>
<p>旧代码的用户应注意，<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 形式在声明式中将始终以相同方式工作。不同形式的属性映射也可以在单个映射中的属性基础上混合使用，因此迁移到新形式可以以任何速度进行。有关逐步迁移到新形式的指南，请参见 <a class="reference internal" href="../changelog/whatsnew_20.html#whatsnew-20-orm-declarative-typing"><span class="std std-ref">ORM Declarative Models</span></a>。</p>
</div>
<p><a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造接受 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 构造接受的所有参数，以及其他ORM特定参数。通常省略 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.__name" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.__name</span></code></a> 字段，该字段指示数据库列的名称，因为声明式过程将使用分配给构造的属性名称并将其分配为列的名称（在上述示例中，这指的是名称 <code class="docutils literal notranslate"><span class="pre">id</span></code>、 <code class="docutils literal notranslate"><span class="pre">name</span></code>、 <code class="docutils literal notranslate"><span class="pre">fullname</span></code>、 <code class="docutils literal notranslate"><span class="pre">nickname</span></code> ）。分配备用的 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.__name" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.__name</span></code></a> 也是有效的，其中生成的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 将在SQL和DDL语句中使用给定的名称，而映射的 <code class="docutils literal notranslate"><span class="pre">User</span></code> 类将继续允许使用给定的属性名称访问该属性，与分配给列本身的名称无关（更多内容请参见 <a class="reference internal" href="#mapper-column-distinct-names"><span class="std std-ref">显式命名声明性映射列</span></a>）。</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p><a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造 <strong>仅在声明式类映射中有效</strong> 。在使用Core构造 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象以及使用 <a class="reference internal" href="#orm-imperative-table-configuration"><span class="std std-ref">imperative table</span></a> 配置时，仍然需要 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 构造以指示数据库列的存在。</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="mapping_columns.html#mapping-columns-toplevel"><span class="std std-ref">映射表格列</span></a> - 包含有关影响 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> 解释传入 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象的附加说明。</p>
</div>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">英文</label><div class="tab-content docutils container">
<p>When using Declarative, the body of the class to be mapped in most cases
includes an attribute <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> that indicates the string name of a
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> that should be generated along with the mapping. The
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct, which features additional ORM-specific
configuration capabilities not present in the plain <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>
class, is then used within the class body to indicate columns in the table. The
example below illustrates the most basic use of this construct within a
Declarative mapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">nickname</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> constructs are placed inline within the class
definition as class level attributes. At the point at which the class is
declared, the Declarative mapping process will generate a new
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object against the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> collection
associated with the Declarative <code class="docutils literal notranslate"><span class="pre">Base</span></code>; each instance of
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> will then be used to generate a
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object during this process, which will become part of
the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.columns" title="sqlalchemy.schema.Table.columns"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Table.columns</span></code></a> collection of this <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
object.</p>
<p>In the above example, Declarative will build a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
construct that is equivalent to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># equivalent Table object produced</span>
<span class="n">user_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">()),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nickname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">)),</span>
<span class="p">)</span></pre></div>
</div>
<p>When the <code class="docutils literal notranslate"><span class="pre">User</span></code> class above is mapped, this <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object
can be accessed directly via the <code class="docutils literal notranslate"><span class="pre">__table__</span></code> attribute; this is described
further at <a class="reference internal" href="#orm-declarative-metadata"><span class="std std-ref">访问表和元数据</span></a>.</p>
<div class="admonition-mapped-column-supersedes-the-use-of-column admonition">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code> supersedes the use of <code class="docutils literal notranslate"><span class="pre">Column()</span></code></p>
<p>Users of 1.x SQLAlchemy will note the use of the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a>
construct, which is new as of the SQLAlchemy 2.0 series.  This ORM-specific
construct is intended first and foremost to be a drop-in replacement for
the use of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> within Declarative mappings only, adding
new ORM-specific convenience features such as the ability to establish
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.deferred" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.deferred</span></code></a> within the construct, and most
importantly to indicate to typing tools such as <a class="reference external" href="https://mypy.readthedocs.io/en/stable/">Mypy</a> and <a class="reference external" href="https://github.com/microsoft/pylance-release">Pylance</a> an
accurate representation of how the attribute will behave at runtime at
both the class level as well as the instance level.  As will be seen in
the following sections, it’s also at the forefront of a new
annotation-driven configuration style introduced in SQLAlchemy 2.0.</p>
<p>Users of legacy code should be aware that the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> form
will always work in Declarative in the same way it always has. The different
forms of attribute mapping may also be mixed within a single mapping on an
attribute by attribute basis, so migration to the new form can be at
any pace.   See the section <a class="reference internal" href="../changelog/whatsnew_20.html#whatsnew-20-orm-declarative-typing"><span class="std std-ref">ORM Declarative Models</span></a> for
a step by step guide to migrating a Declarative model to the new form.</p>
</div>
<p>The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct accepts all arguments that are
accepted by the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> construct, as well as additional
ORM-specific arguments. The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.__name" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.__name</span></code></a> field,
indicating the name of the database column, is typically omitted, as the
Declarative process will make use of the attribute name given to the construct
and assign this as the name of the column (in the above example, this refers to
the names <code class="docutils literal notranslate"><span class="pre">id</span></code>, <code class="docutils literal notranslate"><span class="pre">name</span></code>, <code class="docutils literal notranslate"><span class="pre">fullname</span></code>, <code class="docutils literal notranslate"><span class="pre">nickname</span></code>). Assigning an alternate
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.__name" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.__name</span></code></a> is valid as well, where the resulting
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> will use the given name in SQL and DDL statements,
while the <code class="docutils literal notranslate"><span class="pre">User</span></code> mapped class will continue to allow access to the attribute
using the attribute name given, independent of the name given to the column
itself (more on this at <a class="reference internal" href="#mapper-column-distinct-names"><span class="std std-ref">显式命名声明性映射列</span></a>).</p>
<div class="admonition tip">
<p class="admonition-title">小技巧</p>
<p>The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct is <strong>only valid within a
Declarative class mapping</strong>.   When constructing a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
object using Core as well as when using
<a class="reference internal" href="#orm-imperative-table-configuration"><span class="std std-ref">imperative table</span></a> configuration,
the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> construct is still required in order to
indicate the presence of a database column.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="mapping_columns.html#mapping-columns-toplevel"><span class="std std-ref">映射表格列</span></a> - contains additional notes on affecting
how <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> interprets incoming <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects.</p>
</div>
</div>
</div>
<section id="orm-declarative-mapped-column">
<span id="id2"></span><h3>使用带注释的声明表（ <code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code> 的类型注释形式）<a class="headerlink" href="#orm-declarative-mapped-column" title="Link to this heading">¶</a></h3>
<p>Using Annotated Declarative Table (Type Annotated Forms for <code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code>)</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造能够从与声明式映射类中声明的属性关联的 <span class="target" id="index-0"></span><a class="pep reference external" href="https://peps.python.org/pep-0484/"><strong>PEP 484</strong></a> 类型注释中推导其列配置信息。如果使用这些类型注释，它们 <strong>必须</strong> 存在于一个特殊的SQLAlchemy类型 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 中，该类型是一个泛型_类型，然后在其中指示特定的Python类型。</p>
<p>下面说明了上一节中的映射，添加了 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 的使用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]]</span>
    <span class="n">nickname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>如上所述，当声明式处理每个类属性时，每个 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 将从左侧的相应 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 类型注释中推导其他参数（如果存在）。此外，声明式将在遇到没有分配给属性的值的 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 类型注释时隐式生成一个空的 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 指令（这种形式的灵感来自Python数据类_中使用的类似风格）；此 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造将继续从存在的 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 注释中推导其配置。</p>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct is capable of deriving its column-configuration
information from <span class="target" id="index-1"></span><a class="pep reference external" href="https://peps.python.org/pep-0484/"><strong>PEP 484</strong></a> type annotations associated with the attribute
as declared in the Declarative mapped class.   These type annotations,
if used,  <strong>must</strong>
be present within a special SQLAlchemy type called <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>, which
is a <a class="reference external" href="https://peps.python.org/pep-0484/#generics">generic</a> type that then indicates a specific Python type within it.</p>
<p>Below illustrates the mapping from the previous section, adding the use of
<a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">fullname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]]</span>
    <span class="n">nickname</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">))</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>Above, when Declarative processes each class attribute, each
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> will derive additional arguments from the
corresponding <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> type annotation on the left side, if
present.   Additionally, Declarative will generate an empty
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> directive implicitly, whenever a
<a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> type annotation is encountered that does not have
a value assigned to the attribute (this form is inspired by the similar
style used in Python <a class="reference external" href="https://docs.python.org/3/library/dataclasses.html">dataclasses</a>); this <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct
proceeds to derive its configuration from the <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>
annotation present.</p>
</div>
</div>
<section id="mapped-column-mapped">
<span id="orm-declarative-mapped-column-nullability"></span><h4><code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code> 从 <code class="docutils literal notranslate"><span class="pre">Mapped</span></code> 注释中派生数据类型和可空性<a class="headerlink" href="#mapped-column-mapped" title="Link to this heading">¶</a></h4>
<p><code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code> derives the datatype and nullability from the <code class="docutils literal notranslate"><span class="pre">Mapped</span></code> annotation</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造从 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 注释中推导出以下两个属性：</p>
<ul>
<li><p><strong>数据类型</strong> - 在 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 中给出的Python类型（如果存在）包含在 <code class="docutils literal notranslate"><span class="pre">typing.Optional</span></code> 构造中，与 <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> 子类（如 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Integer" title="sqlalchemy.types.Integer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Integer</span></code></a> 、 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a> 、<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.DateTime" title="sqlalchemy.types.DateTime"><code class="xref py py-class docutils literal notranslate"><span class="pre">DateTime</span></code></a> 或 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Uuid" title="sqlalchemy.types.Uuid"><code class="xref py py-class docutils literal notranslate"><span class="pre">Uuid</span></code></a>）相关联，以列出一些常见类型。</p>
<p>数据类型根据Python类型到SQLAlchemy数据类型的字典确定。此字典是完全可自定义的，如下一节 <a class="reference internal" href="#orm-declarative-mapped-column-type-map"><span class="std std-ref">自定义类型映射</span></a> 中详细说明。默认类型映射实现如下代码示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Type</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">decimal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span>

<span class="c1"># 默认类型映射，从 Mapped[] 注释中推导出 mapped_column() 的类型</span>
<span class="n">type_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">TypeEngine</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">bool</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(),</span>
    <span class="n">bytes</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">LargeBinary</span><span class="p">(),</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Date</span><span class="p">(),</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(),</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Time</span><span class="p">(),</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Interval</span><span class="p">(),</span>
    <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Numeric</span><span class="p">(),</span>
    <span class="n">float</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Float</span><span class="p">(),</span>
    <span class="n">int</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span>
    <span class="n">str</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span>
    <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Uuid</span><span class="p">(),</span>
<span class="p">}</span></pre></div>
</div>
</li>
</ul>
<p>如果 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造指示了类型传递到 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.__type" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.__type</span></code></a> 参数，则会忽略给定的Python类型。</p>
<ul>
<li><p><strong>可空性</strong> - <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造将通过传递 <code class="docutils literal notranslate"><span class="pre">True</span></code> 或 <code class="docutils literal notranslate"><span class="pre">False</span></code> 的 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.nullable" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.nullable</span></code></a> 参数首先指示其 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 为 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 或 <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> 。此外，如果 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.primary_key" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.primary_key</span></code></a> 参数存在并设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code> ，这也将意味着该列应为 <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> 。</p>
<p>如果 <strong>这两个参数都不存在</strong> ，则将使用 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 类型注释中的 <code class="docutils literal notranslate"><span class="pre">typing.Optional[]</span></code> 来确定可空性，其中 <code class="docutils literal notranslate"><span class="pre">typing.Optional[]</span></code> 表示 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> ，而没有 <code class="docutils literal notranslate"><span class="pre">typing.Optional[]</span></code> 表示 <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> 。如果根本不存在 <code class="docutils literal notranslate"><span class="pre">Mapped[]</span></code> 注释，并且没有 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.nullable" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.nullable</span></code></a> 或 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.primary_key" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.primary_key</span></code></a> 参数，则使用SQLAlchemy对 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 的通常默认 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> 。</p>
<p>在下面的示例中， <code class="docutils literal notranslate"><span class="pre">id</span></code> 和 <code class="docutils literal notranslate"><span class="pre">data</span></code> 列将为 <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code>，而 <code class="docutils literal notranslate"><span class="pre">additional_info</span></code> 列将为 <code class="docutils literal notranslate"><span class="pre">NULL</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="c1"># primary_key=True，因此将为 NOT NULL</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># 不是 Optional[]，因此将为 NOT NULL</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>

    <span class="c1"># Optional[]，因此将为 NULL</span>
    <span class="n">additional_info</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>使 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 的可空性与注释所暗示的不同也是完全有效的。例如，ORM映射属性可以在Python代码中允许 <code class="docutils literal notranslate"><span class="pre">None</span></code> ，该代码在首次创建和填充对象时与对象一起工作，但最终将值写入 <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> 的数据库列。存在时，<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.nullable" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.nullable</span></code></a> 参数将始终优先:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="c1"># 将是 String() NOT NULL，但在Python中可以是 None</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>同样，写入数据库列的非None属性由于某种原因需要在架构级别为 <code class="docutils literal notranslate"><span class="pre">NULL</span></code>，可以将 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.nullable" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.nullable</span></code></a> 设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="c1"># 将是 String() NULL，但类型检查器不会期望该属性为 None</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
</li>
</ul>
</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--2">英文</label><div class="tab-content docutils container">
<p>The two qualities that <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> derives from the
<a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> annotation are:</p>
<ul>
<li><p><strong>datatype</strong> - the Python type given inside <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>, as contained
within the <code class="docutils literal notranslate"><span class="pre">typing.Optional</span></code> construct if present, is associated with a
<a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> subclass such as <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Integer" title="sqlalchemy.types.Integer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Integer</span></code></a>, <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a>,
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.DateTime" title="sqlalchemy.types.DateTime"><code class="xref py py-class docutils literal notranslate"><span class="pre">DateTime</span></code></a>, or <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Uuid" title="sqlalchemy.types.Uuid"><code class="xref py py-class docutils literal notranslate"><span class="pre">Uuid</span></code></a>, to name a few common types.</p>
<p>The datatype is determined based on a dictionary of Python type to
SQLAlchemy datatype.   This dictionary is completely customizable,
as detailed in the next section <a class="reference internal" href="#orm-declarative-mapped-column-type-map"><span class="std std-ref">自定义类型映射</span></a>.
The default type map is implemented as in the code example below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Dict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Type</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">decimal</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">uuid</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">types</span>

<span class="c1"># default type mapping, deriving the type for mapped_column()</span>
<span class="c1"># from a Mapped[] annotation</span>
<span class="n">type_map</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">TypeEngine</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">bool</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Boolean</span><span class="p">(),</span>
    <span class="n">bytes</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">LargeBinary</span><span class="p">(),</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Date</span><span class="p">(),</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">DateTime</span><span class="p">(),</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">time</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Time</span><span class="p">(),</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Interval</span><span class="p">(),</span>
    <span class="n">decimal</span><span class="o">.</span><span class="n">Decimal</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Numeric</span><span class="p">(),</span>
    <span class="n">float</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Float</span><span class="p">(),</span>
    <span class="n">int</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">(),</span>
    <span class="n">str</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">String</span><span class="p">(),</span>
    <span class="n">uuid</span><span class="o">.</span><span class="n">UUID</span><span class="p">:</span> <span class="n">types</span><span class="o">.</span><span class="n">Uuid</span><span class="p">(),</span>
<span class="p">}</span></pre></div>
</div>
<p>If the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct indicates an explicit type
as passed to the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.__type" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.__type</span></code></a> argument, then
the given Python type is disregarded.</p>
</li>
<li><p><strong>nullability</strong> - The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct will indicate
its <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> as <code class="docutils literal notranslate"><span class="pre">NULL</span></code> or <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> first and foremost by
the presence of the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.nullable" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.nullable</span></code></a> parameter, passed
either as <code class="docutils literal notranslate"><span class="pre">True</span></code> or <code class="docutils literal notranslate"><span class="pre">False</span></code>. Additionally , if the
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.primary_key" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.primary_key</span></code></a> parameter is present and set to
<code class="docutils literal notranslate"><span class="pre">True</span></code>, that will also imply that the column should be <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code>.</p>
<p>In the absence of <strong>both</strong> of these parameters, the presence of
<code class="docutils literal notranslate"><span class="pre">typing.Optional[]</span></code> within the <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> type annotation will be
used to determine nullability, where <code class="docutils literal notranslate"><span class="pre">typing.Optional[]</span></code> means <code class="docutils literal notranslate"><span class="pre">NULL</span></code>,
and the absence of <code class="docutils literal notranslate"><span class="pre">typing.Optional[]</span></code> means <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code>. If there is no
<code class="docutils literal notranslate"><span class="pre">Mapped[]</span></code> annotation present at all, and there is no
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.nullable" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.nullable</span></code></a> or
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.primary_key" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.primary_key</span></code></a> parameter, then SQLAlchemy’s usual
default for <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> of <code class="docutils literal notranslate"><span class="pre">NULL</span></code> is used.</p>
<p>In the example below, the <code class="docutils literal notranslate"><span class="pre">id</span></code> and <code class="docutils literal notranslate"><span class="pre">data</span></code> columns will be <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code>,
and the <code class="docutils literal notranslate"><span class="pre">additional_info</span></code> column will be <code class="docutils literal notranslate"><span class="pre">NULL</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="c1"># primary_key=True, therefore will be NOT NULL</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># not Optional[], therefore will be NOT NULL</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>

    <span class="c1"># Optional[], therefore will be NULL</span>
    <span class="n">additional_info</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>It is also perfectly valid to have a <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> whose
nullability is <strong>different</strong> from what would be implied by the annotation.
For example, an ORM mapped attribute may be annotated as allowing <code class="docutils literal notranslate"><span class="pre">None</span></code>
within Python code that works with the object as it is first being created
and populated, however the value will ultimately be written to a database
column that is <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code>.   The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.nullable" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.nullable</span></code></a>
parameter, when present, will always take precedence:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="c1"># will be String() NOT NULL, but can be None in Python</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">str</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>Similarly, a non-None attribute that’s written to a database column that
for whatever reason needs to be NULL at the schema level,
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.nullable" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.nullable</span></code></a> may be set to <code class="docutils literal notranslate"><span class="pre">True</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="c1"># will be String() NULL, but type checker will not expect</span>
    <span class="c1"># the attribute to be None</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
</li>
</ul>
</div>
</div>
</section>
<section id="orm-declarative-mapped-column-type-map">
<span id="id3"></span><h4>自定义类型映射<a class="headerlink" href="#orm-declarative-mapped-column-type-map" title="Link to this heading">¶</a></h4>
<p>Customizing the Type Map</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--4-input--1" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--1">中文</label><div class="tab-content docutils container">
<p>Python类型到SQLAlchemy <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> 类型的映射在上一节中描述的默认情况下存在于 <code class="docutils literal notranslate"><span class="pre">sqlalchemy.sql.sqltypes</span></code> 模块中的硬编码字典中。然而，协调声明式映射过程的 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry" title="sqlalchemy.orm.registry"><code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code></a> 对象首先会咨询一个本地的用户定义类型字典，该字典可以在构造 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry" title="sqlalchemy.orm.registry"><code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code></a> 时作为 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> 参数传递，并且可以在首次使用时与 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.DeclarativeBase" title="sqlalchemy.orm.DeclarativeBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeclarativeBase</span></code></a> 超类关联。</p>
<p>例如，如果我们希望将 <code class="docutils literal notranslate"><span class="pre">int</span></code> 使用 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.BIGINT" title="sqlalchemy.types.BIGINT"><code class="xref py py-class docutils literal notranslate"><span class="pre">BIGINT</span></code></a> 数据类型， <code class="docutils literal notranslate"><span class="pre">datetime.datetime</span></code> 使用 <code class="docutils literal notranslate"><span class="pre">timezone=True</span></code> 的 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.TIMESTAMP" title="sqlalchemy.types.TIMESTAMP"><code class="xref py py-class docutils literal notranslate"><span class="pre">TIMESTAMP</span></code></a> 数据类型，并且仅在Microsoft SQL Server上希望将Python <code class="docutils literal notranslate"><span class="pre">str</span></code> 使用 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.NVARCHAR" title="sqlalchemy.types.NVARCHAR"><code class="xref py py-class docutils literal notranslate"><span class="pre">NVARCHAR</span></code></a> 数据类型，则可以配置注册表和声明式基类，如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BIGINT</span><span class="p">,</span> <span class="n">NVARCHAR</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">TIMESTAMP</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">int</span><span class="p">:</span> <span class="n">BIGINT</span><span class="p">,</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span> <span class="n">TIMESTAMP</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">str</span><span class="p">:</span> <span class="n">String</span><span class="p">()</span><span class="o">.</span><span class="n">with_variant</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">,</span> <span class="s2">&quot;mssql&quot;</span><span class="p">),</span>
    <span class="p">}</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">date</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>下面说明了在上述映射中生成的CREATE TABLE语句，首先在Microsoft SQL Server后端，说明 <code class="docutils literal notranslate"><span class="pre">NVARCHAR</span></code> 数据类型：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects</span><span class="w"> </span><span class="kn">import</span> <span class="n">mssql</span><span class="p">,</span> <span class="n">postgresql</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">mssql</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="n">id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">IDENTITY</span><span class="p">,</span>
<span class="nb">date</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">status</span><span class="w"> </span><span class="n">NVARCHAR</span><span class="p">(</span><span class="k">max</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>然后在PostgreSQL后端，说明 <code class="docutils literal notranslate"><span class="pre">TIMESTAMP</span> <span class="pre">WITH</span> <span class="pre">TIME</span> <span class="pre">ZONE</span></code> ：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">postgresql</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="n">id</span><span class="w"> </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="nb">date</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">status</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>通过使用 <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine.with_variant" title="sqlalchemy.types.TypeEngine.with_variant"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.with_variant()</span></code></a> 等方法，我们能够构建一个为不同后端定制的类型映射，同时仍然能够使用简洁的仅注释 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 配置。超过这一点还有两个级别的Python类型可配置性，分别在接下来的两节中描述。</p>
</div>
<input class="tab-input" id="tab-set--4-input--2" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--2">英文</label><div class="tab-content docutils container">
<p>The mapping of Python types to SQLAlchemy <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> types
described in the previous section defaults to a hardcoded dictionary
present in the <code class="docutils literal notranslate"><span class="pre">sqlalchemy.sql.sqltypes</span></code> module.  However, the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry" title="sqlalchemy.orm.registry"><code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code></a>
object that coordinates the Declarative mapping process will first consult
a local, user defined dictionary of types which may be passed
as the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> parameter when
constructing the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry" title="sqlalchemy.orm.registry"><code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code></a>, which may be associated with
the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.DeclarativeBase" title="sqlalchemy.orm.DeclarativeBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeclarativeBase</span></code></a> superclass when first used.</p>
<p>As an example, if we wish to make use of the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.BIGINT" title="sqlalchemy.types.BIGINT"><code class="xref py py-class docutils literal notranslate"><span class="pre">BIGINT</span></code></a> datatype for
<code class="docutils literal notranslate"><span class="pre">int</span></code>, the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.TIMESTAMP" title="sqlalchemy.types.TIMESTAMP"><code class="xref py py-class docutils literal notranslate"><span class="pre">TIMESTAMP</span></code></a> datatype with <code class="docutils literal notranslate"><span class="pre">timezone=True</span></code> for
<code class="docutils literal notranslate"><span class="pre">datetime.datetime</span></code>, and then only on Microsoft SQL Server we’d like to use
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.NVARCHAR" title="sqlalchemy.types.NVARCHAR"><code class="xref py py-class docutils literal notranslate"><span class="pre">NVARCHAR</span></code></a> datatype when Python <code class="docutils literal notranslate"><span class="pre">str</span></code> is used,
the registry and Declarative base could be configured as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BIGINT</span><span class="p">,</span> <span class="n">NVARCHAR</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">TIMESTAMP</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">int</span><span class="p">:</span> <span class="n">BIGINT</span><span class="p">,</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">:</span> <span class="n">TIMESTAMP</span><span class="p">(</span><span class="n">timezone</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">str</span><span class="p">:</span> <span class="n">String</span><span class="p">()</span><span class="o">.</span><span class="n">with_variant</span><span class="p">(</span><span class="n">NVARCHAR</span><span class="p">,</span> <span class="s2">&quot;mssql&quot;</span><span class="p">),</span>
    <span class="p">}</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">date</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>Below illustrates the CREATE TABLE statement generated for the above mapping,
first on the Microsoft SQL Server backend, illustrating the <code class="docutils literal notranslate"><span class="pre">NVARCHAR</span></code> datatype:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects</span><span class="w"> </span><span class="kn">import</span> <span class="n">mssql</span><span class="p">,</span> <span class="n">postgresql</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">mssql</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">IDENTITY</span><span class="p">,</span>
<span class="w">  </span><span class="nb">date</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="n">NVARCHAR</span><span class="p">(</span><span class="k">max</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>Then on the PostgreSQL backend, illustrating <code class="docutils literal notranslate"><span class="pre">TIMESTAMP</span> <span class="pre">WITH</span> <span class="pre">TIME</span> <span class="pre">ZONE</span></code>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">postgresql</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="w">  </span><span class="n">id</span><span class="w"> </span><span class="n">BIGSERIAL</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="nb">date</span><span class="w"> </span><span class="k">TIMESTAMP</span><span class="w"> </span><span class="k">WITH</span><span class="w"> </span><span class="k">TIME</span><span class="w"> </span><span class="k">ZONE</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="n">status</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">  </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>By making use of methods such as <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine.with_variant" title="sqlalchemy.types.TypeEngine.with_variant"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.with_variant()</span></code></a>, we’re able
to build up a type map that’s customized to what we need for different backends,
while still being able to use succinct annotation-only <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a>
configurations.  There are two more levels of Python-type configurability
available beyond this, described in the next two sections.</p>
</div>
</div>
</section>
<section id="orm-declarative-type-map-union-types">
<span id="id4"></span><h4>类型映射内的联合类型<a class="headerlink" href="#orm-declarative-type-map-union-types" title="Link to this heading">¶</a></h4>
<p>Union types inside the Type Map</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--5-input--1" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--1">中文</label><div class="tab-content docutils container">
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0.37 版本发生变更: </span>本节中描述的功能已被修复和增强以确保一致性。在此更改之前， <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> 中支持联合类型，但该功能在联合语法和 <code class="docutils literal notranslate"><span class="pre">None</span></code> 的处理方面表现出不一致的行为。请确保SQLAlchemy是最新的，然后再尝试使用本节中描述的功能。</p>
</div>
<p>SQLAlchemy支持在 <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> 中映射联合类型，以允许映射可以支持多种Python类型的数据库类型，例如 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> 或 <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSONB" title="sqlalchemy.dialects.postgresql.JSONB"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSONB</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSON</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects</span><span class="w"> </span><span class="kn">import</span> <span class="n">postgresql</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>

<span class="c1"># 使用管道运算符的新样式Union</span>
<span class="n">json_list</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">list</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>

<span class="c1"># 使用显式Union的旧样式Union</span>
<span class="n">json_scalar</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">float</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">bool</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">json_list</span><span class="p">:</span> <span class="n">postgresql</span><span class="o">.</span><span class="n">JSONB</span><span class="p">,</span>
        <span class="n">json_scalar</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">list_col</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">list</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">|</span> <span class="n">list</span><span class="p">[</span><span class="n">int</span><span class="p">]]</span>

    <span class="c1"># 使用JSON</span>
    <span class="n">scalar_col</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">json_scalar</span><span class="p">]</span>

    <span class="c1"># 使用JSON并且nullable=True</span>
    <span class="n">scalar_col_nullable</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">json_scalar</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>

    <span class="c1"># 由于json_scalar条目，这些形式也都使用JSON</span>
    <span class="n">scalar_col_newstyle</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">float</span> <span class="o">|</span> <span class="n">str</span> <span class="o">|</span> <span class="n">bool</span><span class="p">]</span>
    <span class="n">scalar_col_oldstyle</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">float</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">bool</span><span class="p">]]</span>
    <span class="n">scalar_col_mixedstyle</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">float</span> <span class="o">|</span> <span class="n">str</span> <span class="o">|</span> <span class="n">bool</span><span class="p">]]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上述示例将 <code class="docutils literal notranslate"><span class="pre">list[int]</span></code> 和 <code class="docutils literal notranslate"><span class="pre">list[str]</span></code> 的联合映射到Postgresql的 <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSONB" title="sqlalchemy.dialects.postgresql.JSONB"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSONB</span></code></a> 数据类型，而将 <code class="docutils literal notranslate"><span class="pre">float，str，bool</span></code> 的联合命名为 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> 数据类型。在 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 构造中声明的等效联合将匹配到类型映射中的相应条目。</p>
<p>联合类型的匹配基于联合的内容，不论单个类型如何命名，并且排除 <code class="docutils literal notranslate"><span class="pre">None</span></code> 类型的使用。也就是说， <code class="docutils literal notranslate"><span class="pre">json_scalar</span></code> 也将匹配 <code class="docutils literal notranslate"><span class="pre">str</span> <span class="pre">|</span> <span class="pre">bool</span> <span class="pre">|</span> <span class="pre">float</span> <span class="pre">|</span> <span class="pre">None</span></code> 。它 <strong>不会</strong> 匹配为此联合子集或超集的联合；即 <code class="docutils literal notranslate"><span class="pre">str</span> <span class="pre">|</span> <span class="pre">bool</span></code> 不会匹配， <code class="docutils literal notranslate"><span class="pre">str</span> <span class="pre">|</span> <span class="pre">bool</span> <span class="pre">|</span> <span class="pre">float</span> <span class="pre">|</span> <span class="pre">int</span></code> 也不会匹配。排除 <code class="docutils literal notranslate"><span class="pre">None</span></code> 的联合的单个内容必须完全匹配。</p>
<p><code class="docutils literal notranslate"><span class="pre">None</span></code> 值在从 <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> 到 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 的匹配中从不重要，但在指示 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 的可空性方面确实重要。当 <code class="docutils literal notranslate"><span class="pre">None</span></code> 出现在联合中时，无论是放置在 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 构造中。出现在 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 中时，它表明 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 将是可空的，除非有更具体的指示。此逻辑的工作方式与在 <a class="reference internal" href="#orm-declarative-mapped-column-nullability"><span class="std std-ref">mapped_column() 从 Mapped 注释中派生数据类型和可空性</span></a> 中描述的指示 <code class="docutils literal notranslate"><span class="pre">Optional</span></code> 类型相同。</p>
<p>上述映射的CREATE TABLE语句如下所示：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">postgresql</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">list_col</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalar_col</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalar_col_nullable</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalar_col_newstyle</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalar_col_oldstyle</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalar_col_mixedstyle</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>虽然联合类型使用“松散”的匹配方法来匹配任何等效的子类型集，但Python类型还具有一种创建“类型别名”的方法，这些类型别名被视为不同的类型，与包含相同组成的另一种类型不等效。这些类型与 <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> 的集成在下一节 <a class="reference internal" href="#orm-declarative-type-map-pep695-types"><span class="std std-ref">支持类型别名类型（由 PEP 695 定义）和 NewType</span></a> 中描述。</p>
</div>
<input class="tab-input" id="tab-set--5-input--2" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--2">英文</label><div class="tab-content docutils container">
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0.37 版本发生变更: </span>The features described in this section have been
repaired and enhanced to work consistently.  Prior to this change, union
types were supported in <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code>, however the feature
exhibited inconsistent behaviors between union syntaxes as well as in how
<code class="docutils literal notranslate"><span class="pre">None</span></code> was handled.   Please ensure SQLAlchemy is up to date before
attempting to use the features described in this section.</p>
</div>
<p>SQLAlchemy supports mapping union types inside the <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> to
allow mapping database types that can support multiple Python types, such as
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> or <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSONB" title="sqlalchemy.dialects.postgresql.JSONB"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSONB</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Union</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSON</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects</span><span class="w"> </span><span class="kn">import</span> <span class="n">postgresql</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>

<span class="c1"># new style Union using a pipe operator</span>
<span class="n">json_list</span> <span class="o">=</span> <span class="n">list</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">|</span> <span class="n">list</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>

<span class="c1"># old style Union using Union explicitly</span>
<span class="n">json_scalar</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">float</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">bool</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">json_list</span><span class="p">:</span> <span class="n">postgresql</span><span class="o">.</span><span class="n">JSONB</span><span class="p">,</span>
        <span class="n">json_scalar</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">list_col</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">list</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">|</span> <span class="n">list</span><span class="p">[</span><span class="n">int</span><span class="p">]]</span>

    <span class="c1"># uses JSON</span>
    <span class="n">scalar_col</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">json_scalar</span><span class="p">]</span>

    <span class="c1"># uses JSON and is also nullable=True</span>
    <span class="n">scalar_col_nullable</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">json_scalar</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>

    <span class="c1"># these forms all use JSON as well due to the json_scalar entry</span>
    <span class="n">scalar_col_newstyle</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">float</span> <span class="o">|</span> <span class="n">str</span> <span class="o">|</span> <span class="n">bool</span><span class="p">]</span>
    <span class="n">scalar_col_oldstyle</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">float</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">bool</span><span class="p">]]</span>
    <span class="n">scalar_col_mixedstyle</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">float</span> <span class="o">|</span> <span class="n">str</span> <span class="o">|</span> <span class="n">bool</span><span class="p">]]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>The above example maps the union of <code class="docutils literal notranslate"><span class="pre">list[int]</span></code> and <code class="docutils literal notranslate"><span class="pre">list[str]</span></code> to the Postgresql
<a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.JSONB" title="sqlalchemy.dialects.postgresql.JSONB"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSONB</span></code></a> datatype, while naming a union of <code class="docutils literal notranslate"><span class="pre">float,</span>
<span class="pre">str,</span> <span class="pre">bool</span></code> will match to the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> datatype.   An equivalent
union, stated in the <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> construct, will match into the
corresponding entry in the type map.</p>
<p>The matching of a union type is based on the contents of the union regardless
of how the individual types are named, and additionally excluding the use of
the <code class="docutils literal notranslate"><span class="pre">None</span></code> type.  That is, <code class="docutils literal notranslate"><span class="pre">json_scalar</span></code> will also match to <code class="docutils literal notranslate"><span class="pre">str</span> <span class="pre">|</span> <span class="pre">bool</span> <span class="pre">|</span>
<span class="pre">float</span> <span class="pre">|</span> <span class="pre">None</span></code>.   It will <strong>not</strong> match to a union that is a subset or superset
of this union; that is, <code class="docutils literal notranslate"><span class="pre">str</span> <span class="pre">|</span> <span class="pre">bool</span></code> would not match, nor would <code class="docutils literal notranslate"><span class="pre">str</span> <span class="pre">|</span> <span class="pre">bool</span>
<span class="pre">|</span> <span class="pre">float</span> <span class="pre">|</span> <span class="pre">int</span></code>.  The individual contents of the union excluding <code class="docutils literal notranslate"><span class="pre">None</span></code> must
be an exact match.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">None</span></code> value is never significant as far as matching
from <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> to <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>, however is significant
as an indicator for nullability of the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>. When <code class="docutils literal notranslate"><span class="pre">None</span></code> is present in the
union either as it is placed in the <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> construct.  When
present in <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>, it indicates the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>
would be nullable, in the absense of more specific indicators.  This logic works
in the same way as indicating an <code class="docutils literal notranslate"><span class="pre">Optional</span></code> type as described at
<a class="reference internal" href="#orm-declarative-mapped-column-nullability"><span class="std std-ref">mapped_column() 从 Mapped 注释中派生数据类型和可空性</span></a>.</p>
<p>The CREATE TABLE statement for the above mapping will look as below:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">)</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">postgresql</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">list_col</span><span class="w"> </span><span class="n">JSONB</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalar_col</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalar_col_not_null</span><span class="w"> </span><span class="n">JSON</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>While union types use a “loose” matching approach that matches on any equivalent
set of subtypes, Python typing also features a way to create “type aliases”
that are treated as distinct types that are non-equivalent to another type that
includes the same composition.   Integration of these types with <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code>
is described in the next section, <a class="reference internal" href="#orm-declarative-type-map-pep695-types"><span class="std std-ref">支持类型别名类型（由 PEP 695 定义）和 NewType</span></a>.</p>
</div>
</div>
</section>
<section id="pep-695-newtype">
<span id="orm-declarative-type-map-pep695-types"></span><h4>支持类型别名类型（由 PEP 695 定义）和 NewType<a class="headerlink" href="#pep-695-newtype" title="Link to this heading">¶</a></h4>
<p>Support for Type Alias Types (defined by PEP 695) and NewType</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--6-input--1" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--1">中文</label><div class="tab-content docutils container">
<p>与 <a class="reference internal" href="#orm-declarative-type-map-union-types"><span class="std std-ref">类型映射内的联合类型</span></a> 中描述的类型查找相比，Python类型还包括两种通过更正式的方式创建组合类型的方法，使用 <code class="docutils literal notranslate"><span class="pre">typing.NewType</span></code> 以及 <span class="target" id="index-2"></span><a class="pep reference external" href="https://peps.python.org/pep-0695/"><strong>PEP 695</strong></a> 引入的 <code class="docutils literal notranslate"><span class="pre">type</span></code> 关键字。这些类型的行为与普通类型别名（即将类型分配给变量名）不同，SQLAlchemy在从类型映射中解析这些类型时尊重这种差异。</p>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0.37 版本发生变更: </span>本节中描述的 <code class="docutils literal notranslate"><span class="pre">typing.NewType</span></code> 以及 <span class="target" id="index-3"></span><a class="pep reference external" href="https://peps.python.org/pep-0695/"><strong>PEP 695</strong></a> <code class="docutils literal notranslate"><span class="pre">type</span></code> 的行为已被正式化和修正。对于在某些2.0版本中有效但将在SQLAlchemy 2.1中删除的“松散匹配”模式，现在会发出弃用警告。在尝试使用本节中描述的功能之前，请确保SQLAlchemy是最新的。</p>
</div>
<p>typing模块允许使用 <code class="docutils literal notranslate"><span class="pre">typing.NewType</span></code> 创建“新类型”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NewType</span>

<span class="n">nstr30</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s2">&quot;nstr30&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span>
<span class="n">nstr50</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s2">&quot;nstr50&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span></pre></div>
</div>
<p>此外，在Python 3.12中，引入了一个由 <span class="target" id="index-4"></span><a class="pep reference external" href="https://peps.python.org/pep-0695/"><strong>PEP 695</strong></a> 定义的新功能，即提供 <code class="docutils literal notranslate"><span class="pre">type</span></code> 关键字来完成类似的任务；使用 <code class="docutils literal notranslate"><span class="pre">type</span></code> 会生成一个在许多方面类似于 <code class="docutils literal notranslate"><span class="pre">typing.NewType</span></code> 的对象，内部称为 <code class="docutils literal notranslate"><span class="pre">typing.TypeAliasType</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">type</span> <span class="n">SmallInt</span> <span class="o">=</span> <span class="n">int</span>
<span class="n">type</span> <span class="n">BigInt</span> <span class="o">=</span> <span class="n">int</span>
<span class="n">type</span> <span class="n">JsonScalar</span> <span class="o">=</span> <span class="n">str</span> <span class="o">|</span> <span class="n">float</span> <span class="o">|</span> <span class="n">bool</span> <span class="o">|</span> <span class="kc">None</span></pre></div>
</div>
<p>为了说明SQLAlchemy在用于 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 内的SQL类型查找时如何处理这些类型对象，重要的是要注意Python不认为两个等效的 <code class="docutils literal notranslate"><span class="pre">typing.TypeAliasType</span></code> 或 <code class="docutils literal notranslate"><span class="pre">typing.NewType</span></code> 对象是相等的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 即使两个 typing.NewType 对象都是 str，它们也不相等</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nstr50</span> <span class="o">==</span> <span class="n">nstr30</span>
<span class="kc">False</span>

<span class="c1"># 即使两个 TypeAliasType 对象都是 int，它们也不相等</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">SmallInt</span> <span class="o">==</span> <span class="n">BigInt</span>
<span class="kc">False</span>

<span class="c1"># 等效的联合类型不等于 JsonScalar</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">JsonScalar</span> <span class="o">==</span> <span class="n">str</span> <span class="o">|</span> <span class="n">float</span> <span class="o">|</span> <span class="n">bool</span> <span class="o">|</span> <span class="kc">None</span>
<span class="kc">False</span></pre></div>
</div>
<p>这是与普通联合类型比较方式相反的行为，并且告知SQLAlchemy的 <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> 的正确行为。当使用 <code class="docutils literal notranslate"><span class="pre">typing.NewType</span></code> 或 <span class="target" id="index-5"></span><a class="pep reference external" href="https://peps.python.org/pep-0695/"><strong>PEP 695</strong></a>  <code class="docutils literal notranslate"><span class="pre">type</span></code> 对象时，期望在 <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> 中显式地存在类型对象，以便从 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 类型中进行匹配，其中必须声明相同的对象才能进行匹配（不包括 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 内的类型是否也联合了 <code class="docutils literal notranslate"><span class="pre">None</span></code> ）。这与 <a class="reference internal" href="#orm-declarative-type-map-union-types"><span class="std std-ref">类型映射内的联合类型</span></a> 中描述的行为不同，其中直接引用的普通 <code class="docutils literal notranslate"><span class="pre">Union</span></code> 将基于特定类型在 <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> 中的组成而不是对象标识来匹配其他 <code class="docutils literal notranslate"><span class="pre">Union</span></code> 。</p>
<p>在下面的示例中， <code class="docutils literal notranslate"><span class="pre">nstr30</span></code>、 <code class="docutils literal notranslate"><span class="pre">nstr50</span></code>、 <code class="docutils literal notranslate"><span class="pre">SmallInt</span></code>、 <code class="docutils literal notranslate"><span class="pre">BigInt</span></code> 和 <code class="docutils literal notranslate"><span class="pre">JsonScalar</span></code> 的组合类型彼此之间没有重叠，可以在每个 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 构造中独立命名，并且在 <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> 中也是显式的。这些类型中的任何一个也可以与 <code class="docutils literal notranslate"><span class="pre">None</span></code> 联合或声明为 <code class="docutils literal notranslate"><span class="pre">Optional[]</span></code> 而不影响查找，仅派生列的可空性:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NewType</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">SmallInteger</span><span class="p">,</span> <span class="n">BigInteger</span><span class="p">,</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>

<span class="n">nstr30</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s2">&quot;nstr30&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span>
<span class="n">nstr50</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s2">&quot;nstr50&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span>
<span class="n">type</span> <span class="n">SmallInt</span> <span class="o">=</span> <span class="n">int</span>
<span class="n">type</span> <span class="n">BigInt</span> <span class="o">=</span> <span class="n">int</span>
<span class="n">type</span> <span class="n">JsonScalar</span> <span class="o">=</span> <span class="n">str</span> <span class="o">|</span> <span class="n">float</span> <span class="o">|</span> <span class="n">bool</span> <span class="o">|</span> <span class="kc">None</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TABase</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">nstr30</span><span class="p">:</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span>
        <span class="n">nstr50</span><span class="p">:</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
        <span class="n">SmallInt</span><span class="p">:</span> <span class="n">SmallInteger</span><span class="p">,</span>
        <span class="n">BigInteger</span><span class="p">:</span> <span class="n">BigInteger</span><span class="p">,</span>
        <span class="n">JsonScalar</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">TABase</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">normal_str</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>

    <span class="n">short_str</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">nstr30</span><span class="p">]</span>
    <span class="n">long_str_nullable</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">nstr50</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">small_int</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">SmallInt</span><span class="p">]</span>
    <span class="n">big_int</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">BigInteger</span><span class="p">]</span>
    <span class="n">scalar_col</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">JsonScalar</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上述映射的CREATE TABLE语句将展示我们配置的不同整数和字符串变体，如下所示：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">normal_str</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">short_str</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">long_str_nullable</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
<span class="w">    </span><span class="n">small_int</span><span class="w"> </span><span class="nb">SMALLINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">big_int</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalar_col</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>关于可空性， <code class="docutils literal notranslate"><span class="pre">JsonScalar</span></code> 类型在其定义中包含 <code class="docutils literal notranslate"><span class="pre">None</span></code>，这表明列是可空的。同样， <code class="docutils literal notranslate"><span class="pre">long_str_nullable</span></code> 列也将 <code class="docutils literal notranslate"><span class="pre">None</span></code> 与 <code class="docutils literal notranslate"><span class="pre">nstr50</span></code> 联合，这匹配 <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> 中的 <code class="docutils literal notranslate"><span class="pre">nstr50</span></code> 类型，同时对映射列应用可空性。其他列都保持为 NOT NULL，因为它们没有被标记为可选。</p>
</div>
<input class="tab-input" id="tab-set--6-input--2" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--2">英文</label><div class="tab-content docutils container">
<p>In contrast to the typing lookup described in
<a class="reference internal" href="#orm-declarative-type-map-union-types"><span class="std std-ref">类型映射内的联合类型</span></a>, Python typing also includes two
ways to create a composed type in a more formal way, using <code class="docutils literal notranslate"><span class="pre">typing.NewType</span></code> as
well as the <code class="docutils literal notranslate"><span class="pre">type</span></code> keyword introduced in <span class="target" id="index-6"></span><a class="pep reference external" href="https://peps.python.org/pep-0695/"><strong>PEP 695</strong></a>.  These types behave
differently from ordinary type aliases (i.e. assigning a type to a variable
name), and this difference is honored in how SQLAlchemy resolves these
types from the type map.</p>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0.37 版本发生变更: </span>The behaviors described in this section for <code class="docutils literal notranslate"><span class="pre">typing.NewType</span></code>
as well as <span class="target" id="index-7"></span><a class="pep reference external" href="https://peps.python.org/pep-0695/"><strong>PEP 695</strong></a> <code class="docutils literal notranslate"><span class="pre">type</span></code> have been formalized and corrected.
Deprecation warnings are now emitted for “loose matching” patterns that have
worked in some 2.0 releases, but are to be removed in SQLAlchemy 2.1.
Please ensure SQLAlchemy is up to date before attempting to use the features
described in this section.</p>
</div>
<p>The typing module allows the creation of “new types” using <code class="docutils literal notranslate"><span class="pre">typing.NewType</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NewType</span>

<span class="n">nstr30</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s2">&quot;nstr30&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span>
<span class="n">nstr50</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s2">&quot;nstr50&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span></pre></div>
</div>
<p>Additionally, in Python 3.12, a new feature defined by <span class="target" id="index-8"></span><a class="pep reference external" href="https://peps.python.org/pep-0695/"><strong>PEP 695</strong></a> was introduced which
provides the <code class="docutils literal notranslate"><span class="pre">type</span></code> keyword to accomplish a similar task; using
<code class="docutils literal notranslate"><span class="pre">type</span></code> produces an object that is similar in many ways to <code class="docutils literal notranslate"><span class="pre">typing.NewType</span></code>
which is internally referred to as <code class="docutils literal notranslate"><span class="pre">typing.TypeAliasType</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">type</span> <span class="n">SmallInt</span> <span class="o">=</span> <span class="n">int</span>
<span class="n">type</span> <span class="n">BigInt</span> <span class="o">=</span> <span class="n">int</span>
<span class="n">type</span> <span class="n">JsonScalar</span> <span class="o">=</span> <span class="n">str</span> <span class="o">|</span> <span class="n">float</span> <span class="o">|</span> <span class="n">bool</span> <span class="o">|</span> <span class="kc">None</span></pre></div>
</div>
<p>For the purposes of how SQLAlchemy treats these type objects when used
for SQL type lookup inside of <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>, it’s important to note
that Python does not consider two equivalent <code class="docutils literal notranslate"><span class="pre">typing.TypeAliasType</span></code>
or <code class="docutils literal notranslate"><span class="pre">typing.NewType</span></code> objects to be equal:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># two typing.NewType objects are not equal even if they are both str</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">nstr50</span> <span class="o">==</span> <span class="n">nstr30</span>
<span class="kc">False</span>

<span class="c1"># two TypeAliasType objects are not equal even if they are both int</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">SmallInt</span> <span class="o">==</span> <span class="n">BigInt</span>
<span class="kc">False</span>

<span class="c1"># an equivalent union is not equal to JsonScalar</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">JsonScalar</span> <span class="o">==</span> <span class="n">str</span> <span class="o">|</span> <span class="n">float</span> <span class="o">|</span> <span class="n">bool</span> <span class="o">|</span> <span class="kc">None</span>
<span class="kc">False</span></pre></div>
</div>
<p>This is the opposite behavior from how ordinary unions are compared, and
informs the correct behavior for SQLAlchemy’s <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code>. When
using <code class="docutils literal notranslate"><span class="pre">typing.NewType</span></code> or <span class="target" id="index-9"></span><a class="pep reference external" href="https://peps.python.org/pep-0695/"><strong>PEP 695</strong></a> <code class="docutils literal notranslate"><span class="pre">type</span></code> objects, the type object is
expected to be explicit within the <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> for it to be matched
from a <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> type, where the same object must be stated in order
for a match to be made (excluding whether or not the type inside of
<a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> also unions on <code class="docutils literal notranslate"><span class="pre">None</span></code>). This is distinct from the
behavior described at <a class="reference internal" href="#orm-declarative-type-map-union-types"><span class="std std-ref">类型映射内的联合类型</span></a>, where a
plain <code class="docutils literal notranslate"><span class="pre">Union</span></code> that is referenced directly will match to other <code class="docutils literal notranslate"><span class="pre">Unions</span></code>
based on the composition, rather than the object identity, of a particular type
in <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code>.</p>
<p>In the example below, the composed types for <code class="docutils literal notranslate"><span class="pre">nstr30</span></code>, <code class="docutils literal notranslate"><span class="pre">nstr50</span></code>,
<code class="docutils literal notranslate"><span class="pre">SmallInt</span></code>, <code class="docutils literal notranslate"><span class="pre">BigInt</span></code>, and <code class="docutils literal notranslate"><span class="pre">JsonScalar</span></code> have no overlap with each other
and can be named distinctly within each <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> construct, and
are also all explicit in <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code>.   Any of these types may
also be unioned with <code class="docutils literal notranslate"><span class="pre">None</span></code> or declared as <code class="docutils literal notranslate"><span class="pre">Optional[]</span></code> without affecting
the lookup, only deriving column nullability:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">NewType</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">SmallInteger</span><span class="p">,</span> <span class="n">BigInteger</span><span class="p">,</span> <span class="n">JSON</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">Mapped</span><span class="p">,</span> <span class="n">mapped_column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>

<span class="n">nstr30</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s2">&quot;nstr30&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span>
<span class="n">nstr50</span> <span class="o">=</span> <span class="n">NewType</span><span class="p">(</span><span class="s2">&quot;nstr50&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">)</span>
<span class="n">type</span> <span class="n">SmallInt</span> <span class="o">=</span> <span class="n">int</span>
<span class="n">type</span> <span class="n">BigInt</span> <span class="o">=</span> <span class="n">int</span>
<span class="n">type</span> <span class="n">JsonScalar</span> <span class="o">=</span> <span class="n">str</span> <span class="o">|</span> <span class="n">float</span> <span class="o">|</span> <span class="n">bool</span> <span class="o">|</span> <span class="kc">None</span>


<span class="k">class</span><span class="w"> </span><span class="nc">TABase</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">nstr30</span><span class="p">:</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span>
        <span class="n">nstr50</span><span class="p">:</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
        <span class="n">SmallInt</span><span class="p">:</span> <span class="n">SmallInteger</span><span class="p">,</span>
        <span class="n">BigInteger</span><span class="p">:</span> <span class="n">BigInteger</span><span class="p">,</span>
        <span class="n">JsonScalar</span><span class="p">:</span> <span class="n">JSON</span><span class="p">,</span>
    <span class="p">}</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">TABase</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">normal_str</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>

    <span class="n">short_str</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">nstr30</span><span class="p">]</span>
    <span class="n">long_str_nullable</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">nstr50</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">small_int</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">SmallInt</span><span class="p">]</span>
    <span class="n">big_int</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">BigInteger</span><span class="p">]</span>
    <span class="n">scalar_col</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">JsonScalar</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>a CREATE TABLE for the above mapping will illustrate the different variants
of integer and string we’ve configured, and looks like:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">normal_str</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">short_str</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">long_str_nullable</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
<span class="w">    </span><span class="n">small_int</span><span class="w"> </span><span class="nb">SMALLINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">big_int</span><span class="w"> </span><span class="nb">BIGINT</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">scalar_col</span><span class="w"> </span><span class="n">JSON</span><span class="p">,</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>Regarding nullability, the <code class="docutils literal notranslate"><span class="pre">JsonScalar</span></code> type includes <code class="docutils literal notranslate"><span class="pre">None</span></code> in its
definition, which indicates a nullable column.   Similarly the
<code class="docutils literal notranslate"><span class="pre">long_str_nullable</span></code> column applies a union of <code class="docutils literal notranslate"><span class="pre">None</span></code> to <code class="docutils literal notranslate"><span class="pre">nstr50</span></code>,
which matches to the <code class="docutils literal notranslate"><span class="pre">nstr50</span></code> type in the <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> while
also applying nullability to the mapped column.  The other columns all remain
NOT NULL as they are not indicated as optional.</p>
</div>
</div>
</section>
<section id="python">
<span id="orm-declarative-mapped-column-type-map-pep593"></span><h4>将多种类型配置映射到 Python 类型<a class="headerlink" href="#python" title="Link to this heading">¶</a></h4>
<p>Mapping Multiple Type Configurations to Python Types</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--7-input--1" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--1">中文</label><div class="tab-content docutils container">
<p>作为通过使用 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> 参数将单个Python类型与任何种类的 <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> 配置关联的附加功能，还可以根据附加的类型限定符将单个Python类型与SQL类型的不同变体关联起来。一个典型的例子是将Python <code class="docutils literal notranslate"><span class="pre">str</span></code> 数据类型映射到不同长度的 <code class="docutils literal notranslate"><span class="pre">VARCHAR</span></code> SQL类型。另一个例子是将不同类型的 <code class="docutils literal notranslate"><span class="pre">decimal.Decimal</span></code> 映射到不同大小的 <code class="docutils literal notranslate"><span class="pre">NUMERIC</span></code> 列。</p>
<p>Python的类型系统提供了一种很好的方法来向Python类型添加额外的元数据，即使用 <span class="target" id="index-10"></span><a class="pep reference external" href="https://peps.python.org/pep-0593/"><strong>PEP 593</strong></a> <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 泛型类型，它允许将附加信息与Python类型一起打包。当在 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> 中解析 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 对象时，<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造将通过标识正确解释它，如下面的示例所示，我们声明了两种 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a> 和 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Numeric" title="sqlalchemy.types.Numeric"><code class="xref py py-class docutils literal notranslate"><span class="pre">Numeric</span></code></a> 的变体:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Numeric</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">registry</span>

<span class="n">str_30</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
<span class="n">str_50</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">num_12_4</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Decimal</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>
<span class="n">num_6_2</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Decimal</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span>
        <span class="n">type_annotation_map</span><span class="o">=</span><span class="p">{</span>
            <span class="n">str_30</span><span class="p">:</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span>
            <span class="n">str_50</span><span class="p">:</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
            <span class="n">num_12_4</span><span class="p">:</span> <span class="n">Numeric</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="n">num_6_2</span><span class="p">:</span> <span class="n">Numeric</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>传递给 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 容器的Python类型（在上述示例中为 <code class="docutils literal notranslate"><span class="pre">str</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Decimal</span></code> 类型）对于打字工具的好处非常重要；就 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造而言，它只需要在 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> 字典中查找每个类型对象，而实际上不需要查看 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 对象，至少在这种特定情况下也是如此。同样，传递给 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 的参数（除底层Python类型本身之外）也不重要，只是必须至少存在一个参数才能使 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 构造有效。然后我们可以直接在映射中使用这些增强的类型，它们将匹配更具体的类型构造，如下例所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">short_name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str_30</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">long_name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str_50</span><span class="p">]</span>
    <span class="n">num_value</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">num_12_4</span><span class="p">]</span>
    <span class="n">short_num_value</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">num_6_2</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上述映射的CREATE TABLE语句将展示我们配置的不同 <code class="docutils literal notranslate"><span class="pre">VARCHAR</span></code> 和 <code class="docutils literal notranslate"><span class="pre">NUMERIC</span></code> 变体，如下所示：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="n">short_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">long_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">num_value</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">short_num_value</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">short_name</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>虽然将 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 类型链接到不同的SQL类型为我们提供了很大的灵活性，但下一节说明了 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 可以与声明式一起使用的第二种方式，这种方式甚至更加开放。</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>虽然 <code class="docutils literal notranslate"><span class="pre">typing.TypeAliasType</span></code> 可以分配给联合类型，就像上面定义的 <code class="docutils literal notranslate"><span class="pre">JsonScalar</span></code> 一样，但它的行为与没有 <code class="docutils literal notranslate"><span class="pre">type</span> <span class="pre">...</span></code> 语法定义的普通联合类型不同。以下映射包含与 <code class="docutils literal notranslate"><span class="pre">JsonScalar</span></code> 兼容的联合类型，但它们不会被识别:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">TABase</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">col_a</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span> <span class="o">|</span> <span class="n">float</span> <span class="o">|</span> <span class="n">bool</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">col_b</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span> <span class="o">|</span> <span class="n">float</span> <span class="o">|</span> <span class="n">bool</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>这会引发错误，因为 <code class="docutils literal notranslate"><span class="pre">col_a</span></code> 或 <code class="docutils literal notranslate"><span class="pre">col_b</span></code> 使用的联合类型没有在 <code class="docutils literal notranslate"><span class="pre">TABase</span></code> 类型映射中找到，并且必须直接引用 <code class="docutils literal notranslate"><span class="pre">JsonScalar</span></code> 。</p>
</div>
</div>
<input class="tab-input" id="tab-set--7-input--2" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--2">英文</label><div class="tab-content docutils container">
<p>As individual Python types may be associated with <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a>
configurations of any variety by using the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a>
parameter, an additional
capability is the ability to associate a single Python type with different
variants of a SQL type based on additional type qualifiers.  One typical
example of this is mapping the Python <code class="docutils literal notranslate"><span class="pre">str</span></code> datatype to <code class="docutils literal notranslate"><span class="pre">VARCHAR</span></code>
SQL types of different lengths.  Another is mapping different varieties of
<code class="docutils literal notranslate"><span class="pre">decimal.Decimal</span></code> to differently sized <code class="docutils literal notranslate"><span class="pre">NUMERIC</span></code> columns.</p>
<p>Python’s typing system provides a great way to add additional metadata to a
Python type which is by using the <span class="target" id="index-11"></span><a class="pep reference external" href="https://peps.python.org/pep-0593/"><strong>PEP 593</strong></a> <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> generic type, which
allows additional information to be bundled along with a Python type. The
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct will correctly interpret an <code class="docutils literal notranslate"><span class="pre">Annotated</span></code>
object by identity when resolving it in the
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a>, as in the example below where we
declare two variants of <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a> and <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Numeric" title="sqlalchemy.types.Numeric"><code class="xref py py-class docutils literal notranslate"><span class="pre">Numeric</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">decimal</span><span class="w"> </span><span class="kn">import</span> <span class="n">Decimal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Numeric</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">registry</span>

<span class="n">str_30</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="mi">30</span><span class="p">]</span>
<span class="n">str_50</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>
<span class="n">num_12_4</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Decimal</span><span class="p">,</span> <span class="mi">12</span><span class="p">]</span>
<span class="n">num_6_2</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">Decimal</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span>
        <span class="n">type_annotation_map</span><span class="o">=</span><span class="p">{</span>
            <span class="n">str_30</span><span class="p">:</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span>
            <span class="n">str_50</span><span class="p">:</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span>
            <span class="n">num_12_4</span><span class="p">:</span> <span class="n">Numeric</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="n">num_6_2</span><span class="p">:</span> <span class="n">Numeric</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>The Python type passed to the <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> container, in the above example the
<code class="docutils literal notranslate"><span class="pre">str</span></code> and <code class="docutils literal notranslate"><span class="pre">Decimal</span></code> types, is important only for the benefit of typing
tools; as far as the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct is concerned, it will only need
perform a lookup of each type object in the
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> dictionary without actually
looking inside of the <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> object, at least in this particular
context. Similarly, the arguments passed to <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> beyond the underlying
Python type itself are also not important, it’s only that at least one argument
must be present for the <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> construct to be valid. We can then use
these augmented types directly in our mapping where they will be matched to the
more specific type constructions, as in the following example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">short_name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str_30</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">long_name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str_50</span><span class="p">]</span>
    <span class="n">num_value</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">num_12_4</span><span class="p">]</span>
    <span class="n">short_num_value</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">num_6_2</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>a CREATE TABLE for the above mapping will illustrate the different variants
of <code class="docutils literal notranslate"><span class="pre">VARCHAR</span></code> and <code class="docutils literal notranslate"><span class="pre">NUMERIC</span></code> we’ve configured, and looks like:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="n">short_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">long_name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">num_value</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">short_num_value</span><span class="w"> </span><span class="nb">NUMERIC</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">short_name</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>While variety in linking <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> types to different SQL types grants
us a wide degree of flexibility, the next section illustrates a second
way in which <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> may be used with Declarative that is even
more open ended.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>While a <code class="docutils literal notranslate"><span class="pre">typing.TypeAliasType</span></code> can be assigned to unions, like in the
case of <code class="docutils literal notranslate"><span class="pre">JsonScalar</span></code> defined above, it has a different behavior than normal
unions defined without the <code class="docutils literal notranslate"><span class="pre">type</span> <span class="pre">...</span></code> syntax.
The following mapping includes unions that are compatible with <code class="docutils literal notranslate"><span class="pre">JsonScalar</span></code>,
but they will not be recognized:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">TABase</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">col_a</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span> <span class="o">|</span> <span class="n">float</span> <span class="o">|</span> <span class="n">bool</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">col_b</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span> <span class="o">|</span> <span class="n">float</span> <span class="o">|</span> <span class="n">bool</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>This raises an error since the union types used by <code class="docutils literal notranslate"><span class="pre">col_a</span></code> or <code class="docutils literal notranslate"><span class="pre">col_b</span></code>,
are not found in <code class="docutils literal notranslate"><span class="pre">TABase</span></code> type map and <code class="docutils literal notranslate"><span class="pre">JsonScalar</span></code> must be referenced
directly.</p>
</div>
</div>
</div>
</section>
<section id="orm-declarative-mapped-column-pep593">
<span id="id5"></span><h4>将整个列声明映射到 Python 类型<a class="headerlink" href="#orm-declarative-mapped-column-pep593" title="Link to this heading">¶</a></h4>
<p>Mapping Whole Column Declarations to Python Types</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--8-input--1" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--1">中文</label><div class="tab-content docutils container">
<p>上一节说明了使用 <span class="target" id="index-12"></span><a class="pep reference external" href="https://peps.python.org/pep-0593/"><strong>PEP 593</strong></a> <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 类型实例作为 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> 字典中的键。在这种形式中，<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造实际上不会查看 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 对象本身，而只是用作字典键。然而，声明式还具有直接从 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 对象中提取整个预先建立的 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造的能力。使用这种形式，我们不仅可以定义与Python类型链接的不同种类的SQL数据类型，而无需使用 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> 字典，还可以设置任何数量的参数，如可空性、列默认值和约束，以可重用的方式。</p>
<p>一组ORM模型通常会有某种类型的主键样式，适用于所有映射类。还可能有共同的列配置，例如带有默认值的时间戳和其他预先设定大小和配置的字段。我们可以将这些配置组合到 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 实例中，然后直接将这些实例捆绑到 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 实例中，这些实例可以在任何数量的类声明中重用。声明式将在以这种方式提供时解包 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 对象，跳过任何不适用于SQLAlchemy的指令，仅搜索SQLAlchemy ORM构造。</p>
<p>下面的示例说明了以这种方式使用的各种预配置字段类型，其中我们定义了代表 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Integer" title="sqlalchemy.types.Integer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Integer</span></code></a> 主键列的 <code class="docutils literal notranslate"><span class="pre">intpk</span></code> ，代表 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.DateTime" title="sqlalchemy.types.DateTime"><code class="xref py py-class docutils literal notranslate"><span class="pre">DateTime</span></code></a> 类型的 <code class="docutils literal notranslate"><span class="pre">timestamp</span></code>，该类型将使用 <code class="docutils literal notranslate"><span class="pre">CURRENT_TIMESTAMP</span></code> 作为DDL级别列默认值，以及代表长度为30的 <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a> 的 <code class="docutils literal notranslate"><span class="pre">required_name</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>


<span class="n">intpk</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">int</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
<span class="n">timestamp</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
    <span class="n">mapped_column</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">CURRENT_TIMESTAMP</span><span class="p">()),</span>
<span class="p">]</span>
<span class="n">required_name</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span></pre></div>
</div>
<p>上述 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 对象然后可以直接在 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 中使用，其中预配置的 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造将被提取并复制到每个属性特定的新实例中:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">intpk</span><span class="p">]</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">required_name</span><span class="p">]</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">timestamp</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上述映射的 <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code> 如下所示：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">created_at</span><span class="w"> </span><span class="n">DATETIME</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>以这种方式使用 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 类型时，类型的配置也可以在每个属性的基础上受到影响。对于上述示例中显式使用 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.nullable" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.nullable</span></code></a> 的类型，我们可以对任何类型应用 <code class="docutils literal notranslate"><span class="pre">Optional[]</span></code> 泛型修饰符，以便字段在Python级别上是可选的，这将独立于数据库中发生的 <code class="docutils literal notranslate"><span class="pre">NULL</span></code> / <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> 设置:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">timestamp</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
    <span class="n">mapped_column</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="c1"># pep-484类型将是Optional，但列将是NOT NULL</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">timestamp</span><span class="p">]]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p><a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造还与显式传递的 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造进行了协调，其参数将优先于 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 构造的参数。下面我们为我们的整数主键添加 <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKey" title="sqlalchemy.schema.ForeignKey"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKey</span></code></a> 约束，并且还为 <code class="docutils literal notranslate"><span class="pre">created_at</span></code> 列使用备用服务器默认值:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>

<span class="n">intpk</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">int</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
<span class="n">timestamp</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
    <span class="n">mapped_column</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">CURRENT_TIMESTAMP</span><span class="p">()),</span>
<span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Parent</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;parent&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">intpk</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="c1"># 为 mapped_column(Integer, primary_key=True) 添加 ForeignKey</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">intpk</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;parent.id&quot;</span><span class="p">))</span>

    <span class="c1"># 将服务器默认值从 CURRENT_TIMESTAMP 更改为 UTC_TIMESTAMP</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">UTC_TIMESTAMP</span><span class="p">())</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>CREATE TABLE 语句说明了这些每个属性的设置，添加了 <code class="docutils literal notranslate"><span class="pre">FOREIGN</span> <span class="pre">KEY</span></code> 约束并将 <code class="docutils literal notranslate"><span class="pre">UTC_TIMESTAMP</span></code> 替换为 <code class="docutils literal notranslate"><span class="pre">CURRENT_TIMESTAMP</span></code> ：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">created_at</span><span class="w"> </span><span class="n">DATETIME</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">UTC_TIMESTAMP</span><span class="p">()</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p><a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 的功能如上所述，其中可以使用包含“模板” <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 对象的 <span class="target" id="index-13"></span><a class="pep reference external" href="https://peps.python.org/pep-0593/"><strong>PEP 593</strong></a> <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 对象指示一组完全构造的列参数，该对象将被复制到属性中，目前尚未为其他ORM构造（如 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 和 <a class="reference internal" href="composites.html#sqlalchemy.orm.composite" title="sqlalchemy.orm.composite"><code class="xref py py-func docutils literal notranslate"><span class="pre">composite()</span></code></a> 实现。虽然理论上可能实现此功能，但目前尝试使用 <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> 来指示 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 和类似的进一步参数将在运行时引发 <code class="docutils literal notranslate"><span class="pre">NotImplementedError</span></code> 异常，但可能会在未来的版本中实现。</p>
</div>
</div>
<input class="tab-input" id="tab-set--8-input--2" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--2">英文</label><div class="tab-content docutils container">
<p>The previous section illustrated using <span class="target" id="index-14"></span><a class="pep reference external" href="https://peps.python.org/pep-0593/"><strong>PEP 593</strong></a> <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> type
instances as keys within the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a>
dictionary.  In this form, the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct does not
actually look inside the <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> object itself, it’s instead
used only as a dictionary key.  However, Declarative also has the ability to extract
an entire pre-established <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct from
an <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> object directly.  Using this form, we can define not only
different varieties of SQL datatypes linked to Python types without using
the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> dictionary, we can also
set up any number of arguments such as nullability, column defaults,
and constraints in a reusable fashion.</p>
<p>A set of ORM models will usually have some kind of primary
key style that is common to all mapped classes.   There also may be
common column configurations such as timestamps with defaults and other fields of
pre-established sizes and configurations.   We can compose these configurations
into <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> instances that we then bundle directly into
instances of <code class="docutils literal notranslate"><span class="pre">Annotated</span></code>, which are then re-used in any number of class
declarations.  Declarative will unpack an <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> object
when provided in this manner, skipping over any other directives that don’t
apply to SQLAlchemy and searching only for SQLAlchemy ORM constructs.</p>
<p>The example below illustrates a variety of pre-configured field types used
in this way, where we define <code class="docutils literal notranslate"><span class="pre">intpk</span></code> that represents an <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Integer" title="sqlalchemy.types.Integer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Integer</span></code></a> primary
key column, <code class="docutils literal notranslate"><span class="pre">timestamp</span></code> that represents a <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.DateTime" title="sqlalchemy.types.DateTime"><code class="xref py py-class docutils literal notranslate"><span class="pre">DateTime</span></code></a> type
which will use <code class="docutils literal notranslate"><span class="pre">CURRENT_TIMESTAMP</span></code> as a DDL level column default,
and <code class="docutils literal notranslate"><span class="pre">required_name</span></code> which is a <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a> of length 30 that’s
<code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>


<span class="n">intpk</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">int</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
<span class="n">timestamp</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
    <span class="n">mapped_column</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">CURRENT_TIMESTAMP</span><span class="p">()),</span>
<span class="p">]</span>
<span class="n">required_name</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">str</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)]</span></pre></div>
</div>
<p>The above <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> objects can then be used directly within
<a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a>, where the pre-configured <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a>
constructs will be extracted and copied to a new instance that will be
specific to each attribute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">intpk</span><span class="p">]</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">required_name</span><span class="p">]</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">timestamp</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code> for our above mapping looks like:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">name</span><span class="w"> </span><span class="nb">VARCHAR</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">created_at</span><span class="w"> </span><span class="n">DATETIME</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<p>When using <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> types in this way, the configuration of the type
may also be affected on a per-attribute basis.  For the types in the above
example that feature explicit use of <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.nullable" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.nullable</span></code></a>,
we can apply the <code class="docutils literal notranslate"><span class="pre">Optional[]</span></code> generic modifier to any of our types so that
the field is optional or not at the Python level, which will be independent
of the <code class="docutils literal notranslate"><span class="pre">NULL</span></code> / <code class="docutils literal notranslate"><span class="pre">NOT</span> <span class="pre">NULL</span></code> setting that takes place in the database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Optional</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">timestamp</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
    <span class="n">mapped_column</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
<span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="c1"># pep-484 type will be Optional, but column will be</span>
    <span class="c1"># NOT NULL</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Optional</span><span class="p">[</span><span class="n">timestamp</span><span class="p">]]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct is also reconciled with an explicitly
passed <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct, whose arguments will take precedence
over those of the <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> construct.   Below we add a <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKey" title="sqlalchemy.schema.ForeignKey"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKey</span></code></a>
constraint to our integer primary key and also use an alternate server
default for the <code class="docutils literal notranslate"><span class="pre">created_at</span></code> column:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Annotated</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>

<span class="n">intpk</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span><span class="n">int</span><span class="p">,</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)]</span>
<span class="n">timestamp</span> <span class="o">=</span> <span class="n">Annotated</span><span class="p">[</span>
    <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">,</span>
    <span class="n">mapped_column</span><span class="p">(</span><span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">CURRENT_TIMESTAMP</span><span class="p">()),</span>
<span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Parent</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;parent&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">intpk</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="c1"># add ForeignKey to mapped_column(Integer, primary_key=True)</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">intpk</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;parent.id&quot;</span><span class="p">))</span>

    <span class="c1"># change server default from CURRENT_TIMESTAMP to UTC_TIMESTAMP</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">timestamp</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">UTC_TIMESTAMP</span><span class="p">())</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>The CREATE TABLE statement illustrates these per-attribute settings,
adding a <code class="docutils literal notranslate"><span class="pre">FOREIGN</span> <span class="pre">KEY</span></code> constraint as well as substituting
<code class="docutils literal notranslate"><span class="pre">UTC_TIMESTAMP</span></code> for <code class="docutils literal notranslate"><span class="pre">CURRENT_TIMESTAMP</span></code>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">CreateTable</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">CreateTable</span><span class="p">(</span><span class="n">SomeClass</span><span class="o">.</span><span class="n">__table__</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="n">created_at</span><span class="w"> </span><span class="n">DATETIME</span><span class="w"> </span><span class="k">DEFAULT</span><span class="w"> </span><span class="n">UTC_TIMESTAMP</span><span class="p">()</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">),</span>
<span class="k">FOREIGN</span><span class="w"> </span><span class="k">KEY</span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">REFERENCES</span><span class="w"> </span><span class="n">parent</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span>
</div></pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>The feature of <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> just described, where
a fully constructed set of column arguments may be indicated using
<span class="target" id="index-15"></span><a class="pep reference external" href="https://peps.python.org/pep-0593/"><strong>PEP 593</strong></a> <code class="docutils literal notranslate"><span class="pre">Annotated</span></code> objects that contain a “template”
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> object to be copied into the attribute, is
currently not implemented for other ORM constructs such as
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> and <a class="reference internal" href="composites.html#sqlalchemy.orm.composite" title="sqlalchemy.orm.composite"><code class="xref py py-func docutils literal notranslate"><span class="pre">composite()</span></code></a>.   While this functionality
is in theory possible, for the moment attempting to use <code class="docutils literal notranslate"><span class="pre">Annotated</span></code>
to indicate further arguments for <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> and similar
will raise a <code class="docutils literal notranslate"><span class="pre">NotImplementedError</span></code> exception at runtime, but
may be implemented in future releases.</p>
</div>
</div>
</div>
</section>
<section id="python-enum-pep-586-literal">
<span id="orm-declarative-mapped-column-enums"></span><h4>在类型映射中使用 Python <code class="docutils literal notranslate"><span class="pre">Enum</span></code> 或 pep-586 <code class="docutils literal notranslate"><span class="pre">Literal</span></code> 类型<a class="headerlink" href="#python-enum-pep-586-literal" title="Link to this heading">¶</a></h4>
<p>Using Python <code class="docutils literal notranslate"><span class="pre">Enum</span></code> or pep-586 <code class="docutils literal notranslate"><span class="pre">Literal</span></code> types in the type map</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--9-input--1" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--1">中文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">在 2.0.0b4 版本加入: </span>- 增加了 <code class="docutils literal notranslate"><span class="pre">Enum</span></code> 支持</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">在 2.0.1 版本加入: </span>- 增加了 <code class="docutils literal notranslate"><span class="pre">Literal</span></code> 支持</p>
</div>
<p>用户定义的Python类型派生自Python内置的 <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> 以及 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> 类，在ORM声明式映射中使用时会自动链接到SQLAlchemy的 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> 数据类型。下面的示例在 <code class="docutils literal notranslate"><span class="pre">Mapped[]</span></code> 构造中使用了自定义的 <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Status</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
    <span class="n">RECEIVED</span> <span class="o">=</span> <span class="s2">&quot;received&quot;</span>
    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Status</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>在上述示例中，映射的属性 <code class="docutils literal notranslate"><span class="pre">SomeClass.status</span></code> 将链接到数据类型为 <code class="docutils literal notranslate"><span class="pre">Enum(Status)</span></code> 的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 。例如，我们可以在PostgreSQL数据库的CREATE TABLE输出中看到这一点：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TYPE</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ENUM</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;PENDING&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;RECEIVED&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;COMPLETED&#39;</span><span class="p">)</span>

<span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">SERIAL</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="n">status</span><span class="w"> </span><span class="n">status</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>同样，可以使用 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> ，使用包含所有字符串的 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">Status</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;received&quot;</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Status</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>在 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> 中使用的条目将基础 <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> Python类型以及 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> 类型链接到SQLAlchemy的 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> SQL类型，使用一种特殊形式，指示 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> 数据类型应自动配置自身以针对任意枚举类型。默认情况下，这种配置是隐式的，可以显式指示如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">),</span>
        <span class="n">typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">),</span>
    <span class="p">}</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>声明式中的解析逻辑能够解析 <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> 的子类以及 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> 实例，以匹配 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> 字典中的 <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> 或 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> 条目。然后 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> SQL类型知道如何生成具有适当设置的配置版本，包括默认字符串长度。如果传递的 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> 不只包含字符串值，则会引发信息性错误。</p>
<p><code class="docutils literal notranslate"><span class="pre">typing.TypeAliasType</span></code> 也可以用于创建枚举，通过将它们分配给字符串的 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="n">type</span> <span class="n">Status</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">]</span></pre></div>
</div>
<p>由于这是一个 <code class="docutils literal notranslate"><span class="pre">typing.TypeAliasType</span></code> ，它表示一个唯一的类型对象，因此必须将其放置在 <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> 中，以便成功查找，如下所示：</p>
<blockquote>
<div><p>import enum
import sqlalchemy</p>
<dl class="simple">
<dt>class Base(DeclarativeBase):</dt><dd><p>type_annotation_map = {Status: sqlalchemy.Enum(enum.Enum)}</p>
</dd>
</dl>
</div></blockquote>
<p>由于SQLAlchemy支持映射不同的 <code class="docutils literal notranslate"><span class="pre">typing.TypeAliasType</span></code> 对象（这些对象在结构上是独立等效的），这些对象必须存在于 <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> 中以避免歧义。</p>
</div>
<input class="tab-input" id="tab-set--9-input--2" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--2">英文</label><div class="tab-content docutils container">
<div class="versionadded">
<p><span class="versionmodified added">在 2.0.0b4 版本加入: </span>- Added <code class="docutils literal notranslate"><span class="pre">Enum</span></code> support</p>
</div>
<div class="versionadded">
<p><span class="versionmodified added">在 2.0.1 版本加入: </span>- Added <code class="docutils literal notranslate"><span class="pre">Literal</span></code> support</p>
</div>
<p>User-defined Python types which derive from the Python built-in <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code>
as well as the <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code>
class are automatically linked to the SQLAlchemy <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> datatype
when used in an ORM declarative mapping.  The example below uses
a custom <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> within the <code class="docutils literal notranslate"><span class="pre">Mapped[]</span></code> constructor:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Status</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
    <span class="n">RECEIVED</span> <span class="o">=</span> <span class="s2">&quot;received&quot;</span>
    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Status</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>In the above example, the mapped attribute <code class="docutils literal notranslate"><span class="pre">SomeClass.status</span></code> will be
linked to a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> with the datatype of <code class="docutils literal notranslate"><span class="pre">Enum(Status)</span></code>.
We can see this for example in the CREATE TABLE output for the PostgreSQL
database:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span></pre></div>
</div>
<p>CREATE TYPE status AS ENUM (‘PENDING’, ‘RECEIVED’, ‘COMPLETED’)</p>
<dl class="simple">
<dt>CREATE TABLE some_table (</dt><dd><p>id SERIAL NOT NULL,
status status NOT NULL,
PRIMARY KEY (id)</p>
</dd>
</dl>
<p>)</p>
<p>In a similar way, <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> may be used instead, using
a <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> that consists of all strings:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">Status</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;received&quot;</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Status</span><span class="p">]</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>The entries used in <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> link the base
<code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> Python type as well as the <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> type to the
SQLAlchemy <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> SQL type, using a special form which indicates to the
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> datatype that it should automatically configure itself against
an arbitrary enumerated type. This configuration, which is implicit by default,
would be indicated explicitly as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">),</span>
        <span class="n">typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">),</span>
    <span class="p">}</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>The resolution logic within Declarative is able to resolve subclasses
of <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> as well as instances of <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> to match the
<code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> or <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> entry in the
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> dictionary.  The <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a>
SQL type then knows how to produce a configured version of itself with the
appropriate settings, including default string length.   If a <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code>
that does not consist of only string values is passed, an informative
error is raised.</p>
<p><code class="docutils literal notranslate"><span class="pre">typing.TypeAliasType</span></code> can also be used to create enums, by assigning them
to a <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> of strings:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="n">type</span> <span class="n">Status</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;on&quot;</span><span class="p">,</span> <span class="s2">&quot;off&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">]</span></pre></div>
</div>
<p>Since this is a <code class="docutils literal notranslate"><span class="pre">typing.TypeAliasType</span></code>, it represents a unique type object,
so it must be placed in the <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> for it to be looked up
successfully, keyed to the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> type as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">Status</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">)}</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>Since SQLAlchemy supports mapping different <code class="docutils literal notranslate"><span class="pre">typing.TypeAliasType</span></code>
objects that are otherwise structurally equivalent individually,
these must be present in <code class="docutils literal notranslate"><span class="pre">type_annotation_map</span></code> to avoid ambiguity.</p>
</div>
</div>
<section id="id6">
<h5>原生枚举和命名<a class="headerlink" href="#id6" title="Link to this heading">¶</a></h5>
<p>Native Enums and Naming</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--10-input--1" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum.params.native_enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Enum.native_enum</span></code></a> 参数指的是 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> 数据类型是否应创建所谓的“本地”枚举，在 MySQL/MariaDB 上是 <code class="docutils literal notranslate"><span class="pre">ENUM</span></code> 数据类型，在 PostgreSQL 上是通过 <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TYPE</span></code> 创建的新 <code class="docutils literal notranslate"><span class="pre">TYPE</span></code> 对象，或者是“非本地”枚举，这意味着将使用 <code class="docutils literal notranslate"><span class="pre">VARCHAR</span></code> 来创建数据类型。对于 MySQL/MariaDB 或 PostgreSQL 以外的后端，在所有情况下都使用 <code class="docutils literal notranslate"><span class="pre">VARCHAR</span></code> （第三方方言可能有其自己的行为）。</p>
<p>由于 PostgreSQL 的 <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TYPE</span></code> 要求必须为要创建的类型提供一个显式名称，因此在处理隐式生成的 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> 而未在映射中指定显式 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> 数据类型时，存在特殊的回退逻辑：</p>
<ol class="arabic simple">
<li><p>如果 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> 链接到一个 <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> 对象，则 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum.params.native_enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Enum.native_enum</span></code></a> 参数默认为 <code class="docutils literal notranslate"><span class="pre">True</span></code>，并且枚举的名称将取自 <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> 数据类型的名称。PostgreSQL 后端将假定使用此名称的 <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TYPE</span></code>。</p></li>
<li><p>如果 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> 链接到一个 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> 对象，则 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum.params.native_enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Enum.native_enum</span></code></a> 参数默认为 <code class="docutils literal notranslate"><span class="pre">False</span></code>；不会生成名称，并且假定使用 <code class="docutils literal notranslate"><span class="pre">VARCHAR</span></code>。</p></li>
</ol>
<p>要将 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> 与 PostgreSQL <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TYPE</span></code> 类型一起使用，必须使用显式 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a>，可以在类型映射中使用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">Status</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;received&quot;</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">Status</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;received&quot;</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;status_enum&quot;</span><span class="p">),</span>
    <span class="p">}</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>或者在 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 中使用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">Status</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;received&quot;</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Status</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
        <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;received&quot;</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;status_enum&quot;</span><span class="p">)</span>
    <span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
</div>
<input class="tab-input" id="tab-set--10-input--2" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum.params.native_enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Enum.native_enum</span></code></a> parameter refers to if the
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> datatype should create a so-called “native”
enum, which on MySQL/MariaDB is the <code class="docutils literal notranslate"><span class="pre">ENUM</span></code> datatype and on PostgreSQL is
a new <code class="docutils literal notranslate"><span class="pre">TYPE</span></code> object created by <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TYPE</span></code>, or a “non-native” enum,
which means that <code class="docutils literal notranslate"><span class="pre">VARCHAR</span></code> will be used to create the datatype.  For
backends other than MySQL/MariaDB or PostgreSQL, <code class="docutils literal notranslate"><span class="pre">VARCHAR</span></code> is used in
all cases (third party dialects may have their own behaviors).</p>
<p>Because PostgreSQL’s <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TYPE</span></code> requires that there’s an explicit name
for the type to be created, special fallback logic exists when working
with implicitly generated <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> without specifying an
explicit <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> datatype within a mapping:</p>
<ol class="arabic simple">
<li><p>If the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> is linked to an <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> object, the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum.params.native_enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Enum.native_enum</span></code></a> parameter defaults to <code class="docutils literal notranslate"><span class="pre">True</span></code> and the name of the enum will be taken from the name of the <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> datatype.  The PostgreSQL backend will assume <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TYPE</span></code> with this name.</p></li>
<li><p>If the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> is linked to a <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> object, the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum.params.native_enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Enum.native_enum</span></code></a> parameter defaults to <code class="docutils literal notranslate"><span class="pre">False</span></code>; no name is generated and <code class="docutils literal notranslate"><span class="pre">VARCHAR</span></code> is assumed.</p></li>
</ol>
<p>To use <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> with a PostgreSQL <code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TYPE</span></code> type, an
explicit <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.sql.sqltypes.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> must be used, either within the
type map:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">Status</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;received&quot;</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">Status</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;received&quot;</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;status_enum&quot;</span><span class="p">),</span>
    <span class="p">}</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>Or alternatively within <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">Status</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;received&quot;</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">SomeClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;some_table&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">status</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">Status</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span>
        <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="s2">&quot;pending&quot;</span><span class="p">,</span> <span class="s2">&quot;received&quot;</span><span class="p">,</span> <span class="s2">&quot;completed&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;status_enum&quot;</span><span class="p">)</span>
    <span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
</div>
</div>
</section>
<section id="id7">
<h5>更改默认枚举的配置<a class="headerlink" href="#id7" title="Link to this heading">¶</a></h5>
<p>Altering the Configuration of the Default Enum</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--11-input--1" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--1">中文</label><div class="tab-content docutils container">
<p>为了修改隐式生成的 <code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code> 数据类型的固定配置，请在 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> 中指定新条目，指示附加参数。例如，要无条件地使用“非本地枚举”，可以将 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum.params.native_enum" title="sqlalchemy.types.Enum"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Enum.native_enum</span></code></a> 参数设置为 False，适用于所有类型:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">,</span> <span class="n">native_enum</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">,</span> <span class="n">native_enum</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">}</span></pre><div class="code-annotations-key"></div></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0.1 版本发生变更: </span>实现了在建立 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a> 时覆盖 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> 数据类型中的参数（如 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum.params.native_enum" title="sqlalchemy.types.Enum"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Enum.native_enum</span></code></a>）的支持。此前，此功能不起作用。</p>
</div>
<p>要对特定 <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> 子类型使用特定配置，例如在使用示例 <code class="docutils literal notranslate"><span class="pre">Status</span></code> 数据类型时将字符串长度设置为50:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Status</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
    <span class="n">RECEIVED</span> <span class="o">=</span> <span class="s2">&quot;received&quot;</span>
    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">Status</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">Status</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">native_enum</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="p">}</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>默认情况下，自动生成的 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> 不与 <code class="docutils literal notranslate"><span class="pre">Base</span></code> 使用的 <code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code> 实例关联，因此如果元数据定义了模式，它将不会自动与枚举关联。要自动将枚举与它们所属的元数据或表中的模式关联，可以设置 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum.params.inherit_schema" title="sqlalchemy.types.Enum"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Enum.inherit_schema</span></code></a> 参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sa</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="s2">&quot;my_schema&quot;</span><span class="p">)</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">Enum</span><span class="p">:</span> <span class="n">sa</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">Enum</span><span class="p">,</span> <span class="n">inherit_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span></pre><div class="code-annotations-key"></div></div>
</div>
</div>
<input class="tab-input" id="tab-set--11-input--2" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--2">英文</label><div class="tab-content docutils container">
<p>In order to modify the fixed configuration of the <code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code> datatype
that’s generated implicitly, specify new entries in the
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a>, indicating additional arguments.
For example, to use “non native enumerations” unconditionally, the
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum.params.native_enum" title="sqlalchemy.types.Enum"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Enum.native_enum</span></code></a> parameter may be set to False for all types:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">,</span> <span class="n">native_enum</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
        <span class="n">typing</span><span class="o">.</span><span class="n">Literal</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">,</span> <span class="n">native_enum</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="p">}</span></pre><div class="code-annotations-key"></div></div>
</div>
<div class="versionchanged">
<p><span class="versionmodified changed">在 2.0.1 版本发生变更: </span>Implemented support for overriding parameters</p>
</div>
<p>such as <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum.params.native_enum" title="sqlalchemy.types.Enum"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Enum.native_enum</span></code></a> within the
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> datatype when establishing the
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.params.type_annotation_map" title="sqlalchemy.orm.registry"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">registry.type_annotation_map</span></code></a>.  Previously, this
functionality was not working.</p>
<p>To use a specific configuration for a specific <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> subtype, such
as setting the string length to 50 when using the example <code class="docutils literal notranslate"><span class="pre">Status</span></code>
datatype:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Status</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">):</span>
    <span class="n">PENDING</span> <span class="o">=</span> <span class="s2">&quot;pending&quot;</span>
    <span class="n">RECEIVED</span> <span class="o">=</span> <span class="s2">&quot;received&quot;</span>
    <span class="n">COMPLETED</span> <span class="o">=</span> <span class="s2">&quot;completed&quot;</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">Status</span><span class="p">:</span> <span class="n">sqlalchemy</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">Status</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">native_enum</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="p">}</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>By default <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> that are automatically generated are not
associated with the <code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code> instance used by the <code class="docutils literal notranslate"><span class="pre">Base</span></code>, so if
the metadata defines a schema it will not be automatically associated with the
enum. To automatically associate the enum with the schema in the metadata or
table they belong to the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum.params.inherit_schema" title="sqlalchemy.types.Enum"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Enum.inherit_schema</span></code></a> can be set:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sa</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">sa</span><span class="o">.</span><span class="n">MetaData</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="s2">&quot;my_schema&quot;</span><span class="p">)</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">Enum</span><span class="p">:</span> <span class="n">sa</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">Enum</span><span class="p">,</span> <span class="n">inherit_schema</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span></pre><div class="code-annotations-key"></div></div>
</div>
</div>
</div>
</section>
<section id="enum-enum-typing-literal">
<h5>将特定的 <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> 或 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> 链接到其他数据类型<a class="headerlink" href="#enum-enum-typing-literal" title="Link to this heading">¶</a></h5>
<p>Linking Specific <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> or <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> to other datatypes</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--12-input--1" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--1">中文</label><div class="tab-content docutils container">
<p>上述示例中使用的 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> 可以自动配置自身以适应 <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> 或 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> 类型对象上存在的参数/属性。对于需要将特定种类的 <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> 或 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> 链接到其他类型的用例，也可以将这些特定类型放置在类型映射中。在下面的示例中，包含非字符串类型的 <code class="docutils literal notranslate"><span class="pre">Literal[]</span></code> 条目链接到 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> 数据类型:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSON</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">my_literal</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">my_literal</span><span class="p">:</span> <span class="n">JSON</span><span class="p">}</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>在上述配置中， <code class="docutils literal notranslate"><span class="pre">my_literal</span></code> 数据类型将解析为 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> 实例。其他 <code class="docutils literal notranslate"><span class="pre">Literal</span></code> 变体将继续解析为 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> 数据类型。</p>
</div>
<input class="tab-input" id="tab-set--12-input--2" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--2">英文</label><div class="tab-content docutils container">
<p>The above examples feature the use of an <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> that is
automatically configuring itself to the arguments / attributes present on
an <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> or <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> type object.    For use cases where
specific kinds of <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> or <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> should be linked to
other types, these specific types may be placed in the type map also.
In the example below, an entry for <code class="docutils literal notranslate"><span class="pre">Literal[]</span></code> that contains non-string
types is linked to the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> datatype:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Literal</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSON</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">my_literal</span> <span class="o">=</span> <span class="n">Literal</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;true&quot;</span><span class="p">,</span> <span class="s2">&quot;false&quot;</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">my_literal</span><span class="p">:</span> <span class="n">JSON</span><span class="p">}</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>In the above configuration, the <code class="docutils literal notranslate"><span class="pre">my_literal</span></code> datatype will resolve to a
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> instance.  Other <code class="docutils literal notranslate"><span class="pre">Literal</span></code> variants will continue
to resolve to <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Enum" title="sqlalchemy.types.Enum"><code class="xref py py-class docutils literal notranslate"><span class="pre">Enum</span></code></a> datatypes.</p>
</div>
</div>
</section>
</section>
<section id="id8">
<h4><code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code> 中的数据类功能<a class="headerlink" href="#id8" title="Link to this heading">¶</a></h4>
<p>Dataclass features in <code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code></p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--13-input--1" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造与SQLAlchemy的“本地数据类”功能集成，讨论见 <a class="reference internal" href="dataclasses.html#orm-declarative-native-dataclasses"><span class="std std-ref">声明式Dataclass映射</span></a>。有关 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 支持的其他指令的当前背景，请参见该部分。</p>
</div>
<input class="tab-input" id="tab-set--13-input--2" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct integrates with SQLAlchemy’s
“native dataclasses” feature, discussed at
<a class="reference internal" href="dataclasses.html#orm-declarative-native-dataclasses"><span class="std std-ref">声明式Dataclass映射</span></a>.   See that section for current
background on additional directives supported by <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a>.</p>
</div>
</div>
</section>
</section>
<section id="orm-declarative-metadata">
<span id="id9"></span><h3>访问表和元数据<a class="headerlink" href="#orm-declarative-metadata" title="Link to this heading">¶</a></h3>
<p>Accessing Table and Metadata</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--14-input--1" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--1">中文</label><div class="tab-content docutils container">
<p>声明式映射类将始终包含一个名为 <code class="docutils literal notranslate"><span class="pre">__table__</span></code> 的属性；当使用 <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> 的上述配置完成时，声明式过程通过 <code class="docutils literal notranslate"><span class="pre">__table__</span></code> 属性提供 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># 访问 Table</span>
<span class="n">user_table</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">__table__</span></pre></div>
</div>
<p>上述表最终与 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper.local_table" title="sqlalchemy.orm.Mapper.local_table"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Mapper.local_table</span></code></a> 属性对应，我们可以通过 <a class="reference internal" href="../core/inspection.html#inspection-toplevel"><span class="std std-ref">runtime inspection system</span></a> 看到:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">inspect</span>

<span class="n">user_table</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">local_table</span></pre></div>
</div>
<p>与声明式 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry" title="sqlalchemy.orm.registry"><code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code></a> 以及基类关联的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> 集合通常是运行DDL操作（如CREATE）以及与Alembic等迁移工具一起使用所必需的。此对象可通过 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry" title="sqlalchemy.orm.registry"><code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code></a> 以及声明式基类的 <code class="docutils literal notranslate"><span class="pre">.metadata</span></code> 属性获取。下面，对于一个小脚本，我们可能希望针对SQLite数据库发出所有表的CREATE语句:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite://&quot;</span><span class="p">)</span>

<span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span></pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--14-input--2" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--2">英文</label><div class="tab-content docutils container">
<p>A declaratively mapped class will always include an attribute called
<code class="docutils literal notranslate"><span class="pre">__table__</span></code>; when the above configuration using <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> is
complete, the declarative process makes the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
available via the <code class="docutils literal notranslate"><span class="pre">__table__</span></code> attribute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># access the Table</span>
<span class="n">user_table</span> <span class="o">=</span> <span class="n">User</span><span class="o">.</span><span class="n">__table__</span></pre></div>
</div>
<p>The above table is ultimately the same one that corresponds to the
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper.local_table" title="sqlalchemy.orm.Mapper.local_table"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Mapper.local_table</span></code></a> attribute, which we can see through the
<a class="reference internal" href="../core/inspection.html#inspection-toplevel"><span class="std std-ref">runtime inspection system</span></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">inspect</span>

<span class="n">user_table</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">local_table</span></pre></div>
</div>
<p>The <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> collection associated with both the declarative
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry" title="sqlalchemy.orm.registry"><code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code></a> as well as the base class is frequently necessary in
order to run DDL operations such as CREATE, as well as in use with migration
tools such as Alembic.   This object is available via the <code class="docutils literal notranslate"><span class="pre">.metadata</span></code>
attribute of <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry" title="sqlalchemy.orm.registry"><code class="xref py py-class docutils literal notranslate"><span class="pre">registry</span></code></a> as well as the declarative base class.
Below, for a small script we may wish to emit a CREATE for all tables against a
SQLite database:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;sqlite://&quot;</span><span class="p">)</span>

<span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span></pre></div>
</div>
</div>
</div>
</section>
<section id="orm-declarative-table-configuration">
<span id="id10"></span><h3>声明性表配置<a class="headerlink" href="#orm-declarative-table-configuration" title="Link to this heading">¶</a></h3>
<p>Declarative Table Configuration</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--15-input--1" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--1">中文</label><div class="tab-content docutils container">
<p>在使用带有 <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> 声明类属性的声明式表配置时，应使用 <code class="docutils literal notranslate"><span class="pre">__table_args__</span></code> 声明类属性提供要传递给 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 构造函数的附加参数。</p>
<p>此属性适用于通常传递给 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 构造函数的定位参数和关键字参数。
该属性可以通过两种形式之一指定。 一种是作为字典:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;sometable&quot;</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mysql_engine&quot;</span><span class="p">:</span> <span class="s2">&quot;InnoDB&quot;</span><span class="p">}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>另一种是元组形式，每个参数都是定位参数（通常是约束）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;sometable&quot;</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ForeignKeyConstraint</span><span class="p">([</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;remote_table.id&quot;</span><span class="p">]),</span>
        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">),</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>可以通过将最后一个参数指定为字典来使用上述形式指定关键字参数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;sometable&quot;</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ForeignKeyConstraint</span><span class="p">([</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;remote_table.id&quot;</span><span class="p">]),</span>
        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">),</span>
        <span class="p">{</span><span class="s2">&quot;autoload&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>类还可以使用 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.declared_attr" title="sqlalchemy.orm.declared_attr"><code class="xref py py-func docutils literal notranslate"><span class="pre">declared_attr()</span></code></a> 方法装饰器以动态样式指定 <code class="docutils literal notranslate"><span class="pre">__table_args__</span></code> 声明属性和 <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> 属性。 有关背景，请参见 <a class="reference internal" href="declarative_mixins.html#orm-mixins-toplevel"><span class="std std-ref">使用 Mixins 组合映射层次结构</span></a>。</p>
</div>
<input class="tab-input" id="tab-set--15-input--2" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--2">英文</label><div class="tab-content docutils container">
<p>When using Declarative Table configuration with the <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code>
declarative class attribute, additional arguments to be supplied to the
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> constructor should be provided using the
<code class="docutils literal notranslate"><span class="pre">__table_args__</span></code> declarative class attribute.</p>
<p>This attribute accommodates both positional as well as keyword
arguments that are normally sent to the
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> constructor.
The attribute can be specified in one of two forms. One is as a
dictionary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;sometable&quot;</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;mysql_engine&quot;</span><span class="p">:</span> <span class="s2">&quot;InnoDB&quot;</span><span class="p">}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The other, a tuple, where each argument is positional
(usually constraints):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;sometable&quot;</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ForeignKeyConstraint</span><span class="p">([</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;remote_table.id&quot;</span><span class="p">]),</span>
        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">),</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Keyword arguments can be specified with the above form by
specifying the last argument as a dictionary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;sometable&quot;</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">ForeignKeyConstraint</span><span class="p">([</span><span class="s2">&quot;id&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;remote_table.id&quot;</span><span class="p">]),</span>
        <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">),</span>
        <span class="p">{</span><span class="s2">&quot;autoload&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>A class may also specify the <code class="docutils literal notranslate"><span class="pre">__table_args__</span></code> declarative attribute,
as well as the <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> attribute, in a dynamic style using the
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.declared_attr" title="sqlalchemy.orm.declared_attr"><code class="xref py py-func docutils literal notranslate"><span class="pre">declared_attr()</span></code></a> method decorator.   See
<a class="reference internal" href="declarative_mixins.html#orm-mixins-toplevel"><span class="std std-ref">使用 Mixins 组合映射层次结构</span></a> for background.</p>
</div>
</div>
</section>
<section id="orm-declarative-table-schema-name">
<span id="id11"></span><h3>使用声明性表的显式架构名称<a class="headerlink" href="#orm-declarative-table-schema-name" title="Link to this heading">¶</a></h3>
<p>Explicit Schema Name with Declarative Table</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--16-input--1" name="tab-set--16" type="radio"><label class="tab-label" for="tab-set--16-input--1">中文</label><div class="tab-content docutils container">
<p>类 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 的模式名称如 <a class="reference internal" href="../core/metadata.html#schema-table-schema-name"><span class="std std-ref">指定架构名称</span></a> 中所述，使用 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.params.schema" title="sqlalchemy.schema.Table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Table.schema</span></code></a> 参数应用于单个 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>。在使用声明式表时，此选项与其他选项一样传递给 <code class="docutils literal notranslate"><span class="pre">__table_args__</span></code> 字典:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;sometable&quot;</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="s2">&quot;some_schema&quot;</span><span class="p">}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>也可以使用 <a class="reference internal" href="../core/metadata.html#schema-metadata-schema-name"><span class="std std-ref">使用元数据指定默认架构名称</span></a> 中记录的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData.params.schema" title="sqlalchemy.schema.MetaData"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">MetaData.schema</span></code></a> 参数将模式名称全局应用于所有 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象。可以单独构建 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> 对象，并通过直接分配给 <code class="docutils literal notranslate"><span class="pre">metadata</span></code> 属性将其与 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.DeclarativeBase" title="sqlalchemy.orm.DeclarativeBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeclarativeBase</span></code></a> 子类关联:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="s2">&quot;some_schema&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata_obj</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># 默认将使用 &quot;some_schema&quot;</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;sometable&quot;</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../core/metadata.html#metadata-toplevel"><span class="std std-ref">使用元数据描述数据库</span></a> 中的 <a class="reference internal" href="../core/metadata.html#schema-table-schema-name"><span class="std std-ref">指定架构名称</span></a> 。</p>
</div>
</div>
<input class="tab-input" id="tab-set--16-input--2" name="tab-set--16" type="radio"><label class="tab-label" for="tab-set--16-input--2">英文</label><div class="tab-content docutils container">
<p>The schema name for a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> as documented at
<a class="reference internal" href="../core/metadata.html#schema-table-schema-name"><span class="std std-ref">指定架构名称</span></a> is applied to an individual <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
using the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.params.schema" title="sqlalchemy.schema.Table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Table.schema</span></code></a> argument.   When using Declarative
tables, this option is passed like any other to the <code class="docutils literal notranslate"><span class="pre">__table_args__</span></code>
dictionary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;sometable&quot;</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;schema&quot;</span><span class="p">:</span> <span class="s2">&quot;some_schema&quot;</span><span class="p">}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The schema name can also be applied to all <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> objects
globally by using the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData.params.schema" title="sqlalchemy.schema.MetaData"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">MetaData.schema</span></code></a> parameter documented
at <a class="reference internal" href="../core/metadata.html#schema-metadata-schema-name"><span class="std std-ref">使用元数据指定默认架构名称</span></a>.   The <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> object
may be constructed separately and associated with a <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.DeclarativeBase" title="sqlalchemy.orm.DeclarativeBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeclarativeBase</span></code></a>
subclass by assigning to the <code class="docutils literal notranslate"><span class="pre">metadata</span></code> attribute directly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="s2">&quot;some_schema&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="n">metadata</span> <span class="o">=</span> <span class="n">metadata_obj</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># will use &quot;some_schema&quot; by default</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;sometable&quot;</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../core/metadata.html#schema-table-schema-name"><span class="std std-ref">指定架构名称</span></a> - in the <a class="reference internal" href="../core/metadata.html#metadata-toplevel"><span class="std std-ref">使用元数据描述数据库</span></a> documentation.</p>
</div>
</div>
</div>
</section>
<section id="orm-declarative-column-options">
<span id="id12"></span><h3>为声明性映射列设置加载和持久性选项<a class="headerlink" href="#orm-declarative-column-options" title="Link to this heading">¶</a></h3>
<p>Setting Load and Persistence Options for Declarative Mapped Columns</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--17-input--1" name="tab-set--17" type="radio"><label class="tab-label" for="tab-set--17-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造接受影响生成的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 映射的其他ORM特定参数，影响其加载和持久化行为。常用的选项包括：</p>
<ul>
<li><p><strong>延迟列加载</strong> - <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.deferred" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.deferred</span></code></a> 布尔值默认使用 <a class="reference internal" href="queryguide/columns.html#orm-queryguide-column-deferral"><span class="std std-ref">延迟列加载</span></a> 建立 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>。在下面的示例中， <code class="docutils literal notranslate"><span class="pre">User.bio</span></code> 列默认不会加载，而是仅在访问时加载</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">bio</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Text</span><span class="p">,</span> <span class="n">deferred</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="queryguide/columns.html#orm-queryguide-column-deferral"><span class="std std-ref">使用【列延迟】限制加载哪些列</span></a> - 延迟列加载的完整描述</p>
</div>
</li>
<li><p><strong>活动历史</strong> - <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.active_history" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.active_history</span></code></a> 确保在更改属性值时，先前的值将已加载并成为在检查属性历史时的 <a class="reference internal" href="internals.html#sqlalchemy.orm.AttributeState.history" title="sqlalchemy.orm.AttributeState.history"><code class="xref py py-attr docutils literal notranslate"><span class="pre">AttributeState.history</span></code></a> 集合的一部分。这可能会产生额外的SQL语句</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">important_identifier</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">active_history</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
</li>
</ul>
<p>有关支持参数的列表，请参见 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 的文档字符串。</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-imperative-table-column-options"><span class="std std-ref">为命令式表应用加载、持久性和映射选项列</span></a> - 描述使用 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code></a> 和 <a class="reference internal" href="queryguide/columns.html#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a> 配置命令式表</p>
</div>
</div>
<input class="tab-input" id="tab-set--17-input--2" name="tab-set--17" type="radio"><label class="tab-label" for="tab-set--17-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct accepts additional ORM-specific
arguments that affect how the generated <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> is
mapped, affecting its load and persistence-time behavior.   Options
that are commonly used include:</p>
<ul>
<li><p><strong>deferred column loading</strong> - The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.deferred" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.deferred</span></code></a>
boolean establishes the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> using
<a class="reference internal" href="queryguide/columns.html#orm-queryguide-column-deferral"><span class="std std-ref">deferred column loading</span></a> by default.  In the example
below, the <code class="docutils literal notranslate"><span class="pre">User.bio</span></code> column will not be loaded by default, but only
when accessed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">bio</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Text</span><span class="p">,</span> <span class="n">deferred</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="queryguide/columns.html#orm-queryguide-column-deferral"><span class="std std-ref">使用【列延迟】限制加载哪些列</span></a> - full description of deferred column loading</p>
</div>
</li>
<li><p><strong>active history</strong> - The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.active_history" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.active_history</span></code></a>
ensures that upon change of value for the attribute, the previous value
will have been loaded and made part of the <a class="reference internal" href="internals.html#sqlalchemy.orm.AttributeState.history" title="sqlalchemy.orm.AttributeState.history"><code class="xref py py-attr docutils literal notranslate"><span class="pre">AttributeState.history</span></code></a>
collection when inspecting the history of the attribute.   This may incur
additional SQL statements:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">important_identifier</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">active_history</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
</li>
</ul>
<p>See the docstring for <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> for a list of supported
parameters.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-imperative-table-column-options"><span class="std std-ref">为命令式表应用加载、持久性和映射选项列</span></a> - describes using
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code></a> and <a class="reference internal" href="queryguide/columns.html#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a> for use with
Imperative Table configuration</p>
</div>
</div>
</div>
</section>
<section id="orm-declarative-table-column-naming">
<span id="mapper-column-distinct-names"></span><span id="id13"></span><h3>显式命名声明性映射列<a class="headerlink" href="#orm-declarative-table-column-naming" title="Link to this heading">¶</a></h3>
<p>Naming Declarative Mapped Columns Explicitly</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--18-input--1" name="tab-set--18" type="radio"><label class="tab-label" for="tab-set--18-input--1">中文</label><div class="tab-content docutils container">
<p>到目前为止的所有示例中，<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造都链接到ORM映射属性，其中给 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 的Python属性名称也是我们在CREATE TABLE语句以及查询中看到的列名称。可以通过传递字符串位置参数 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.__name" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.__name</span></code></a> 作为第一个位置参数来表示SQL中列的名称。在下面的示例中， <code class="docutils literal notranslate"><span class="pre">User</span></code> 类映射有给列本身的备用名称:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="s2">&quot;user_name&quot;</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>上述示例中， <code class="docutils literal notranslate"><span class="pre">User.id</span></code> 解析为名为 <code class="docutils literal notranslate"><span class="pre">user_id</span></code> 的列， <code class="docutils literal notranslate"><span class="pre">User.name</span></code> 解析为名为 <code class="docutils literal notranslate"><span class="pre">user_name</span></code> 的列。我们可以使用Python属性名称编写 <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> 语句，并将看到生成的SQL名称：</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">user_name</span>
<span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;user&quot;</span>
<span class="k">WHERE</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">user_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">:</span><span class="n">user_name_1</span>
</div></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-imperative-table-column-naming"><span class="std std-ref">用于映射表列的备用属性名称</span></a> - 适用于命令式表</p>
</div>
</div>
<input class="tab-input" id="tab-set--18-input--2" name="tab-set--18" type="radio"><label class="tab-label" for="tab-set--18-input--2">英文</label><div class="tab-content docutils container">
<p>All of the examples thus far feature the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct
linked to an ORM mapped attribute, where the Python attribute name given
to the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> is also that of the column as we see in
CREATE TABLE statements as well as queries.   The name for a column as
expressed in SQL may be indicated by passing the string positional argument
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column.params.__name" title="sqlalchemy.orm.mapped_column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">mapped_column.__name</span></code></a> as the first positional argument.
In the example below, the <code class="docutils literal notranslate"><span class="pre">User</span></code> class is mapped with alternate names
given to the columns themselves:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="s2">&quot;user_name&quot;</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>Where above <code class="docutils literal notranslate"><span class="pre">User.id</span></code> resolves to a column named <code class="docutils literal notranslate"><span class="pre">user_id</span></code>
and <code class="docutils literal notranslate"><span class="pre">User.name</span></code> resolves to a column named <code class="docutils literal notranslate"><span class="pre">user_name</span></code>.  We
may write a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> statement using our Python attribute names
and will see the SQL names generated:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;x&quot;</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">user_id</span><span class="p">,</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">user_name</span>
<span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;user&quot;</span>
<span class="k">WHERE</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">user_name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">:</span><span class="n">user_name_1</span>
</div></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-imperative-table-column-naming"><span class="std std-ref">用于映射表列的备用属性名称</span></a> - applies to Imperative Table</p>
</div>
</div>
</div>
</section>
<section id="orm-declarative-table-adding-columns">
<span id="id14"></span><h3>将其他列附加到现有的声明性映射类<a class="headerlink" href="#orm-declarative-table-adding-columns" title="Link to this heading">¶</a></h3>
<p>Appending additional columns to an existing Declarative mapped class</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--19-input--1" name="tab-set--19" type="radio"><label class="tab-label" for="tab-set--19-input--1">中文</label><div class="tab-content docutils container">
<p>声明式表配置允许在 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 元数据已经生成后，向现有映射添加新的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象。</p>
<p>对于使用声明式基类声明的声明式类，底层元类 <code class="xref py py-class docutils literal notranslate"><span class="pre">DeclarativeMeta</span></code> 包含一个 <code class="docutils literal notranslate"><span class="pre">__setattr__()</span></code> 方法，该方法将拦截额外的 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 或核心 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象，并将它们添加到 <code class="xref py py-class docutils literal notranslate"><span class="pre">Table`（使用</span> <span class="pre">:meth:</span></code>.Table.append_column`）以及现有的 <code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper`（使用</span> <span class="pre">:meth:</span></code>.Mapper.add_property`）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MyClass</span><span class="o">.</span><span class="n">some_new_column</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></pre></div>
</div>
<p>使用核心 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MyClass</span><span class="o">.</span><span class="n">some_new_column</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></pre></div>
</div>
<p>支持所有参数，包括备用名称，例如 <code class="docutils literal notranslate"><span class="pre">MyClass.some_new_column</span> <span class="pre">=</span> <span class="pre">mapped_column(&quot;some_name&quot;,</span> <span class="pre">String)</span></code>。但是，必须将SQL类型显式传递给 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 或 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象，如上述示例中传递的 <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a> 类型。 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 注释类型无法参与此操作。</p>
<p>在使用单表继承的特定情况下，也可以将其他 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象添加到映射中，其中映射子类上存在其他列，但它们没有自己的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>。这在 <a class="reference internal" href="inheritance.html#single-inheritance"><span class="std std-ref">单表继承</span></a> 部分中进行了说明。</p>
<p><a class="reference internal" href="basic_relationships.html#orm-declarative-table-adding-relationship"><span class="std std-ref">在声明后向映射类添加关系</span></a> - 类似的 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 示例</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>将映射属性分配给已映射的类仅在使用“声明式基类”时才会正确运行，这意味着 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.DeclarativeBase" title="sqlalchemy.orm.DeclarativeBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeclarativeBase</span></code></a> 的用户定义子类或 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.declarative_base" title="sqlalchemy.orm.declarative_base"><code class="xref py py-func docutils literal notranslate"><span class="pre">declarative_base()</span></code></a> 或 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.generate_base" title="sqlalchemy.orm.registry.generate_base"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.generate_base()</span></code></a> 返回的动态生成类。此“基类”包含一个实现特殊 <code class="docutils literal notranslate"><span class="pre">__setattr__()</span></code> 方法的Python元类，用于拦截这些操作。</p>
<p>如果类是使用 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.mapped" title="sqlalchemy.orm.registry.mapped"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped()</span></code></a> 之类的装饰器或 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.map_imperatively" title="sqlalchemy.orm.registry.map_imperatively"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.map_imperatively()</span></code></a> 之类的命令式函数进行映射的，则在运行时将类映射的属性分配给映射类将 <strong>不会</strong> 起作用。</p>
</div>
</div>
<input class="tab-input" id="tab-set--19-input--2" name="tab-set--19" type="radio"><label class="tab-label" for="tab-set--19-input--2">英文</label><div class="tab-content docutils container">
<p>A declarative table configuration allows the addition of new
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects to an existing mapping after the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
metadata has already been generated.</p>
<p>For a declarative class that is declared using a declarative base class,
the underlying metaclass <code class="xref py py-class docutils literal notranslate"><span class="pre">DeclarativeMeta</span></code> includes a <code class="docutils literal notranslate"><span class="pre">__setattr__()</span></code>
method that will intercept additional <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> or Core
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects and
add them to both the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> using <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.append_column" title="sqlalchemy.schema.Table.append_column"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Table.append_column()</span></code></a>
as well as to the existing <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> using <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper.add_property" title="sqlalchemy.orm.Mapper.add_property"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Mapper.add_property()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MyClass</span><span class="o">.</span><span class="n">some_new_column</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></pre></div>
</div>
<p>Using core <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">MyClass</span><span class="o">.</span><span class="n">some_new_column</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></pre></div>
</div>
<p>All arguments are supported including an alternate name, such as
<code class="docutils literal notranslate"><span class="pre">MyClass.some_new_column</span> <span class="pre">=</span> <span class="pre">mapped_column(&quot;some_name&quot;,</span> <span class="pre">String)</span></code>.  However,
the SQL type must be passed to the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> or
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object explicitly, as in the above examples where
the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a> type is passed.  There’s no capability for
the <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> annotation type to take part in the operation.</p>
<p>Additional <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects may also be added to a mapping
in the specific circumstance of using single table inheritance, where
additional columns are present on mapped subclasses that have
no <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> of their own.  This is illustrated in the section
<a class="reference internal" href="inheritance.html#single-inheritance"><span class="std std-ref">单表继承</span></a>.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="basic_relationships.html#orm-declarative-table-adding-relationship"><span class="std std-ref">在声明后向映射类添加关系</span></a> - similar examples for <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a></p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Assignment of mapped
properties to an already mapped class will only
function correctly if the “declarative base” class is used, meaning
the user-defined subclass of <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.DeclarativeBase" title="sqlalchemy.orm.DeclarativeBase"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeclarativeBase</span></code></a> or the
dynamically generated class returned by <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.declarative_base" title="sqlalchemy.orm.declarative_base"><code class="xref py py-func docutils literal notranslate"><span class="pre">declarative_base()</span></code></a>
or <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.generate_base" title="sqlalchemy.orm.registry.generate_base"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.generate_base()</span></code></a>.   This “base” class includes
a Python metaclass which implements a special <code class="docutils literal notranslate"><span class="pre">__setattr__()</span></code> method
that intercepts these operations.</p>
<p>Runtime assignment of class-mapped attributes to a mapped class will <strong>not</strong> work
if the class is mapped using decorators like <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.mapped" title="sqlalchemy.orm.registry.mapped"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.mapped()</span></code></a>
or imperative functions like <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.registry.map_imperatively" title="sqlalchemy.orm.registry.map_imperatively"><code class="xref py py-meth docutils literal notranslate"><span class="pre">registry.map_imperatively()</span></code></a>.</p>
</div>
</div>
</div>
</section>
</section>
<section id="orm-imperative-table-configuration">
<span id="id15"></span><h2>使用命令式表的声明式（又名混合声明式）<a class="headerlink" href="#orm-imperative-table-configuration" title="Link to this heading">¶</a></h2>
<p>Declarative with Imperative Table (a.k.a. Hybrid Declarative)</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--20-input--1" name="tab-set--20" type="radio"><label class="tab-label" for="tab-set--20-input--1">中文</label><div class="tab-content docutils container">
<p>声明式映射还可以使用预先存在的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象，或者其他任意的 <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><code class="xref py py-class docutils literal notranslate"><span class="pre">FromClause</span></code></a> 构造（例如 <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Join" title="sqlalchemy.sql.expression.Join"><code class="xref py py-class docutils literal notranslate"><span class="pre">Join</span></code></a> 或 <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a>），这些构造是单独构建的。</p>
<p>这被称为“混合声明式(hybrid declarative)”映射，因为类使用声明式样式进行所有涉及映射器配置的操作，但映射的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象是单独生成的，并直接传递给声明式过程:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># 直接构建Table。 Base.metadata 集合通常是MetaData的一个不错选择，但可以使用任何MetaData集合。</span>

<span class="n">user_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nickname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
<span class="p">)</span>


<span class="c1"># 使用此表构建User类。</span>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>以上，<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象是使用 <a class="reference internal" href="../core/metadata.html#metadata-describing"><span class="std std-ref">使用元数据描述数据库</span></a> 中描述的方法构建的。然后可以直接应用于声明式映射的类。此形式不使用 <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> 和 <code class="docutils literal notranslate"><span class="pre">__table_args__</span></code> 声明类属性。上面的配置通常更易读为内联定义:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nickname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>上述样式的一个自然结果是 <code class="docutils literal notranslate"><span class="pre">__table__</span></code> 属性本身在类定义块中定义。因此，可以在后续属性中立即引用，例如下面的示例，该示例说明在多态映射器配置中引用 <code class="docutils literal notranslate"><span class="pre">type</span></code> 列:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Person</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s2">&quot;person&quot;</span><span class="p">,</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;polymorphic_on&quot;</span><span class="p">:</span> <span class="n">__table__</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
        <span class="s2">&quot;polymorphic_identity&quot;</span><span class="p">:</span> <span class="s2">&quot;person&quot;</span><span class="p">,</span>
    <span class="p">}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>当要映射非 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 构造（例如 <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Join" title="sqlalchemy.sql.expression.Join"><code class="xref py py-class docutils literal notranslate"><span class="pre">Join</span></code></a> 或 <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a> 对象）时，也使用“命令式表(imperative table)”形式。下面是一个示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span><span class="p">,</span> <span class="n">select</span>

<span class="n">subq</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">select</span><span class="p">(</span>
        <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;order_count&quot;</span><span class="p">),</span>
        <span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">price</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;highest_order&quot;</span><span class="p">),</span>
        <span class="n">orders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
    <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">customer_select</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">customers</span><span class="p">,</span> <span class="n">subq</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">customers</span><span class="p">,</span> <span class="n">subq</span><span class="p">,</span> <span class="n">customers</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">subq</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
    <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">customer_select</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>有关映射到非 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 构造的背景，请参见 <a class="reference internal" href="nonstandard_mappings.html#orm-mapping-joins"><span class="std std-ref">将一个类映射到多个表</span></a> 和 <a class="reference internal" href="nonstandard_mappings.html#orm-mapping-arbitrary-subqueries"><span class="std std-ref">将一个类映射到任意子查询</span></a> 部分。</p>
<p>当类本身使用替代形式的属性声明（例如Python数据类）时，“命令式表(imperative table)”形式特别有用。有关详细信息，请参见 <a class="reference internal" href="dataclasses.html#orm-declarative-dataclasses"><span class="std std-ref">将 ORM 映射应用于现有数据类（旧式数据类使用）</span></a> 部分。</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../core/metadata.html#metadata-describing"><span class="std std-ref">使用元数据描述数据库</span></a></p>
<p><a class="reference internal" href="dataclasses.html#orm-declarative-dataclasses"><span class="std std-ref">将 ORM 映射应用于现有数据类（旧式数据类使用）</span></a></p>
</div>
</div>
<input class="tab-input" id="tab-set--20-input--2" name="tab-set--20" type="radio"><label class="tab-label" for="tab-set--20-input--2">英文</label><div class="tab-content docutils container">
<p>Declarative mappings may also be provided with a pre-existing
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object, or otherwise a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> or other
arbitrary <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.FromClause" title="sqlalchemy.sql.expression.FromClause"><code class="xref py py-class docutils literal notranslate"><span class="pre">FromClause</span></code></a> construct (such as a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Join" title="sqlalchemy.sql.expression.Join"><code class="xref py py-class docutils literal notranslate"><span class="pre">Join</span></code></a>
or <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a>) that is constructed separately.</p>
<p>This is referred to as a “hybrid declarative”
mapping, as the class is mapped using the declarative style for everything
involving the mapper configuration, however the mapped <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
object is produced separately and passed to the declarative process
directly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="c1"># construct a Table directly.  The Base.metadata collection is</span>
<span class="c1"># usually a good choice for MetaData but any MetaData</span>
<span class="c1"># collection may be used.</span>

<span class="n">user_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nickname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
<span class="p">)</span>


<span class="c1"># construct the User class using this table.</span>
<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object is constructed using the approach
described at <a class="reference internal" href="../core/metadata.html#metadata-describing"><span class="std std-ref">使用元数据描述数据库</span></a>.   It can then be applied directly
to a class that is declaratively mapped.  The <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> and
<code class="docutils literal notranslate"><span class="pre">__table_args__</span></code> declarative class attributes are not used in this form.
The above configuration is often more readable as an inline definition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s2">&quot;user&quot;</span><span class="p">,</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;fullname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;nickname&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>A natural effect of the above style is that the <code class="docutils literal notranslate"><span class="pre">__table__</span></code> attribute is
itself defined within the class definition block.   As such it may be
immediately referenced within subsequent attributes, such as the example
below which illustrates referring to the <code class="docutils literal notranslate"><span class="pre">type</span></code> column in a polymorphic
mapper configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Person</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s2">&quot;person&quot;</span><span class="p">,</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
        <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;polymorphic_on&quot;</span><span class="p">:</span> <span class="n">__table__</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
        <span class="s2">&quot;polymorphic_identity&quot;</span><span class="p">:</span> <span class="s2">&quot;person&quot;</span><span class="p">,</span>
    <span class="p">}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The “imperative table” form is also used when a non-<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
construct, such as a <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Join" title="sqlalchemy.sql.expression.Join"><code class="xref py py-class docutils literal notranslate"><span class="pre">Join</span></code></a> or <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Subquery" title="sqlalchemy.sql.expression.Subquery"><code class="xref py py-class docutils literal notranslate"><span class="pre">Subquery</span></code></a> object,
is to be mapped.  An example below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span><span class="p">,</span> <span class="n">select</span>

<span class="n">subq</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">select</span><span class="p">(</span>
        <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;order_count&quot;</span><span class="p">),</span>
        <span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">price</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;highest_order&quot;</span><span class="p">),</span>
        <span class="n">orders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">customer_id</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">orders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
    <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
<span class="p">)</span>

<span class="n">customer_select</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">customers</span><span class="p">,</span> <span class="n">subq</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join_from</span><span class="p">(</span><span class="n">customers</span><span class="p">,</span> <span class="n">subq</span><span class="p">,</span> <span class="n">customers</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">subq</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">customer_id</span><span class="p">)</span>
    <span class="o">.</span><span class="n">subquery</span><span class="p">()</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">customer_select</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>For background on mapping to non-<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> constructs see
the sections <a class="reference internal" href="nonstandard_mappings.html#orm-mapping-joins"><span class="std std-ref">将一个类映射到多个表</span></a> and <a class="reference internal" href="nonstandard_mappings.html#orm-mapping-arbitrary-subqueries"><span class="std std-ref">将一个类映射到任意子查询</span></a>.</p>
<p>The “imperative table” form is of particular use when the class itself
is using an alternative form of attribute declaration, such as Python
dataclasses.   See the section <a class="reference internal" href="dataclasses.html#orm-declarative-dataclasses"><span class="std std-ref">将 ORM 映射应用于现有数据类（旧式数据类使用）</span></a> for detail.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../core/metadata.html#metadata-describing"><span class="std std-ref">使用元数据描述数据库</span></a></p>
<p><a class="reference internal" href="dataclasses.html#orm-declarative-dataclasses"><span class="std std-ref">将 ORM 映射应用于现有数据类（旧式数据类使用）</span></a></p>
</div>
</div>
</div>
<section id="orm-imperative-table-column-naming">
<span id="id16"></span><h3>用于映射表列的备用属性名称<a class="headerlink" href="#orm-imperative-table-column-naming" title="Link to this heading">¶</a></h3>
<p>Alternate Attribute Names for Mapping Table Columns</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--21-input--1" name="tab-set--21" type="radio"><label class="tab-label" for="tab-set--21-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="#orm-declarative-table-column-naming"><span class="std std-ref">显式命名声明性映射列</span></a> 部分说明了如何使用 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 为生成的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象提供单独于其映射的属性名称的特定名称。</p>
<p>使用命令式表配置时，我们已经有 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象。要将它们映射到备用名称，我们可以将 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 直接分配给所需的属性:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;user_name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_name</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>上述 <code class="docutils literal notranslate"><span class="pre">User</span></code> 映射将通过 <code class="docutils literal notranslate"><span class="pre">User.id</span></code> 和 <code class="docutils literal notranslate"><span class="pre">User.name</span></code> 属性引用 <code class="docutils literal notranslate"><span class="pre">&quot;user_id&quot;</span></code> 和 <code class="docutils literal notranslate"><span class="pre">&quot;user_name&quot;</span></code> 列，与 <a class="reference internal" href="#orm-declarative-table-column-naming"><span class="std std-ref">显式命名声明性映射列</span></a> 中演示的方式相同。</p>
<p>上述映射的一个警告是，直接内联链接到 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 在使用 <span class="target" id="index-16"></span><a class="pep reference external" href="https://peps.python.org/pep-0484/"><strong>PEP 484</strong></a> 类型工具时不会正确键入。一种解决此问题的策略是将 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象应用于 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code></a> 函数中；虽然 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> 已经自动为其内部使用生成了此属性对象，但通过在类声明中命名它，类型工具将能够将属性与 <a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> 注释匹配:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">column_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_property</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_property</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_name</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-declarative-table-column-naming"><span class="std std-ref">显式命名声明性映射列</span></a> - 应用到声明式表(Declarative Table)</p>
</div>
</div>
<input class="tab-input" id="tab-set--21-input--2" name="tab-set--21" type="radio"><label class="tab-label" for="tab-set--21-input--2">英文</label><div class="tab-content docutils container">
<p>The section <a class="reference internal" href="#orm-declarative-table-column-naming"><span class="std std-ref">显式命名声明性映射列</span></a> illustrated how to
use <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> to provide a specific name for the generated
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object separate from the attribute name under which
it is mapped.</p>
<p>When using Imperative Table configuration, we already have
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects present.  To map these to alternate names
we may assign the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> to the desired attributes
directly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;user_name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_name</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">User</span></code> mapping above will refer to the <code class="docutils literal notranslate"><span class="pre">&quot;user_id&quot;</span></code> and <code class="docutils literal notranslate"><span class="pre">&quot;user_name&quot;</span></code>
columns via the <code class="docutils literal notranslate"><span class="pre">User.id</span></code> and <code class="docutils literal notranslate"><span class="pre">User.name</span></code> attributes, in the same
way as demonstrated at <a class="reference internal" href="#orm-declarative-table-column-naming"><span class="std std-ref">显式命名声明性映射列</span></a>.</p>
<p>One caveat to the above mapping is that the direct inline link to
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> will not be typed correctly when using
<span class="target" id="index-17"></span><a class="pep reference external" href="https://peps.python.org/pep-0484/"><strong>PEP 484</strong></a> typing tools.   A strategy to resolve this is to apply the
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects within the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code></a>
function; while the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> already generates this property
object for its internal use automatically, by naming it in the class
declaration, typing tools will be able to match the attribute to the
<a class="reference internal" href="internals.html#sqlalchemy.orm.Mapped" title="sqlalchemy.orm.Mapped"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapped</span></code></a> annotation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">column_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_property</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_property</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_name</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-declarative-table-column-naming"><span class="std std-ref">显式命名声明性映射列</span></a> - applies to Declarative Table</p>
</div>
</div>
</div>
</section>
<section id="orm-imperative-table-column-options">
<span id="column-property-options"></span><span id="id17"></span><h3>为命令式表应用加载、持久性和映射选项列<a class="headerlink" href="#orm-imperative-table-column-options" title="Link to this heading">¶</a></h3>
<p>Applying Load, Persistence and Mapping Options for Imperative Table Columns</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--22-input--1" name="tab-set--22" type="radio"><label class="tab-label" for="tab-set--22-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="#orm-declarative-column-options"><span class="std std-ref">为声明性映射列设置加载和持久性选项</span></a> 部分回顾了在使用 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 构造和声明式表配置时如何设置加载和持久化选项。使用命令式表配置时，我们已经有现有的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象被映射。为了将这些 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象与特定于ORM映射的其他参数一起映射，我们可以使用 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code></a> 和 <a class="reference internal" href="queryguide/columns.html#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a> 构造来关联列的其他参数。选项包括：</p>
<ul>
<li><p><strong>延迟列加载</strong> -
<a class="reference internal" href="queryguide/columns.html#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a> 函数是调用 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code></a> 并将 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property.params.deferred" title="sqlalchemy.orm.column_property"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">column_property.deferred</span></code></a> 参数设置为 <code class="docutils literal notranslate"><span class="pre">True</span></code> 的简写；此构造默认使用 <a class="reference internal" href="queryguide/columns.html#orm-queryguide-column-deferral"><span class="std std-ref">延迟列加载</span></a> 建立 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>。在下面的示例中， <code class="docutils literal notranslate"><span class="pre">User.bio</span></code> 列默认不会加载，而是仅在访问时加载:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">deferred</span>

<span class="n">user_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;bio&quot;</span><span class="p">,</span> <span class="n">Text</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span>

    <span class="n">bio</span> <span class="o">=</span> <span class="n">deferred</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">bio</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="queryguide/columns.html#orm-queryguide-column-deferral"><span class="std std-ref">使用【列延迟】限制加载哪些列</span></a> - 延迟列加载的完整描述</p>
</div>
<ul>
<li><p><strong>活动历史</strong> -
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property.params.active_history" title="sqlalchemy.orm.column_property"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">column_property.active_history</span></code></a> 确保在更改属性值时，先前的值将已加载并成为在检查属性历史时的 <a class="reference internal" href="internals.html#sqlalchemy.orm.AttributeState.history" title="sqlalchemy.orm.AttributeState.history"><code class="xref py py-attr docutils literal notranslate"><span class="pre">AttributeState.history</span></code></a> 集合的一部分。这可能会产生额外的SQL语句:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">column_property</span>

<span class="n">user_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;important_identifier&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span>

    <span class="n">important_identifier</span> <span class="o">=</span> <span class="n">column_property</span><span class="p">(</span>
        <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">important_identifier</span><span class="p">,</span> <span class="n">active_history</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code></a> 构造对于将类映射到如连接和选择等替代FROM子句的情况也很重要。有关这些情况的更多背景信息，请参见：</p>
<ul class="simple">
<li><p><a class="reference internal" href="nonstandard_mappings.html#maptojoin"><span class="std std-ref">将一个类映射到多个表</span></a></p></li>
<li><p><a class="reference internal" href="mapped_sql_expr.html#mapper-sql-expressions"><span class="std std-ref">SQL 表达式作为映射属性</span></a></p></li>
</ul>
<p>对于使用 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> 的声明式表配置，大多数选项可以直接使用；有关示例，请参见 <a class="reference internal" href="#orm-declarative-column-options"><span class="std std-ref">为声明性映射列设置加载和持久性选项</span></a> 部分。</p>
</div>
</div>
<input class="tab-input" id="tab-set--22-input--2" name="tab-set--22" type="radio"><label class="tab-label" for="tab-set--22-input--2">英文</label><div class="tab-content docutils container">
<p>The section <a class="reference internal" href="#orm-declarative-column-options"><span class="std std-ref">为声明性映射列设置加载和持久性选项</span></a> reviewed how to set load
and persistence options when using the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a> construct
with Declarative Table configuration.  When using Imperative Table configuration,
we already have existing <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects that are mapped.
In order to map these <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects along with additional
parameters that are specific to the ORM mapping, we may use the
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code></a> and <a class="reference internal" href="queryguide/columns.html#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a> constructs in order to
associate additional parameters with the column.   Options include:</p>
<ul>
<li><p><strong>deferred column loading</strong> - The <a class="reference internal" href="queryguide/columns.html#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a> function is shorthand
for invoking <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code></a> with the
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property.params.deferred" title="sqlalchemy.orm.column_property"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">column_property.deferred</span></code></a> parameter set to <code class="docutils literal notranslate"><span class="pre">True</span></code>;
this construct establishes the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> using
<a class="reference internal" href="queryguide/columns.html#orm-queryguide-column-deferral"><span class="std std-ref">deferred column loading</span></a> by default.  In the example
below, the <code class="docutils literal notranslate"><span class="pre">User.bio</span></code> column will not be loaded by default, but only
when accessed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">deferred</span>

<span class="n">user_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;bio&quot;</span><span class="p">,</span> <span class="n">Text</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span>

    <span class="n">bio</span> <span class="o">=</span> <span class="n">deferred</span><span class="p">(</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">bio</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</li>
</ul>
<blockquote>
<div><div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="queryguide/columns.html#orm-queryguide-column-deferral"><span class="std std-ref">使用【列延迟】限制加载哪些列</span></a> - full description of deferred column loading</p>
</div>
</div></blockquote>
<ul>
<li><p><strong>active history</strong> - The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property.params.active_history" title="sqlalchemy.orm.column_property"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">column_property.active_history</span></code></a>
ensures that upon change of value for the attribute, the previous value
will have been loaded and made part of the <a class="reference internal" href="internals.html#sqlalchemy.orm.AttributeState.history" title="sqlalchemy.orm.AttributeState.history"><code class="xref py py-attr docutils literal notranslate"><span class="pre">AttributeState.history</span></code></a>
collection when inspecting the history of the attribute.   This may incur
additional SQL statements:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">deferred</span>

<span class="n">user_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;user&quot;</span><span class="p">,</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;important_identifier&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span>

    <span class="n">important_identifier</span> <span class="o">=</span> <span class="n">column_property</span><span class="p">(</span>
        <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">important_identifier</span><span class="p">,</span> <span class="n">active_history</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</li>
</ul>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p>The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.column_property" title="sqlalchemy.orm.column_property"><code class="xref py py-func docutils literal notranslate"><span class="pre">column_property()</span></code></a> construct is also important for cases
where classes are mapped to alternative FROM clauses such as joins and
selects.  More background on these cases is at:</p>
<ul class="simple">
<li><p><a class="reference internal" href="nonstandard_mappings.html#maptojoin"><span class="std std-ref">将一个类映射到多个表</span></a></p></li>
<li><p><a class="reference internal" href="mapped_sql_expr.html#mapper-sql-expressions"><span class="std std-ref">SQL 表达式作为映射属性</span></a></p></li>
</ul>
<p>For Declarative Table configuration with <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.mapped_column" title="sqlalchemy.orm.mapped_column"><code class="xref py py-func docutils literal notranslate"><span class="pre">mapped_column()</span></code></a>,
most options are available directly; see the section
<a class="reference internal" href="#orm-declarative-column-options"><span class="std std-ref">为声明性映射列设置加载和持久性选项</span></a> for examples.</p>
</div>
</div>
</div>
</section>
</section>
<section id="orm-declarative-reflected">
<span id="id18"></span><h2>使用反射表进行声明式映射<a class="headerlink" href="#orm-declarative-reflected" title="Link to this heading">¶</a></h2>
<p>Mapping Declaratively with Reflected Tables</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--23-input--1" name="tab-set--23" type="radio"><label class="tab-label" for="tab-set--23-input--1">中文</label><div class="tab-content docutils container">
<p>有几种模式可以提供针对从数据库中内省的一系列 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象生成映射类的方法，使用在 <a class="reference internal" href="../core/reflection.html#metadata-reflection"><span class="std std-ref">反映数据库对象</span></a> 中描述的反射过程。</p>
<p>将类映射到从数据库反射的表的简单方法是使用声明式混合映射，将 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.params.autoload_with" title="sqlalchemy.schema.Table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Table.autoload_with</span></code></a> 参数传递给 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 的构造函数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://user:pass@hostname/my_existing_database&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s2">&quot;mytable&quot;</span><span class="p">,</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>上述模式的一个变体是使用 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData.reflect" title="sqlalchemy.schema.MetaData.reflect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MetaData.reflect()</span></code></a> 方法一次反射一组 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象，然后从 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> 中引用它们:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://user:pass@hostname/my_existing_database&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">reflect</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s2">&quot;mytable&quot;</span><span class="p">]</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>使用 <code class="docutils literal notranslate"><span class="pre">__table__</span></code> 方法的一个警告是，映射类不能在表被反射之前声明，这需要在声明应用程序类时存在数据库连接源；通常类在应用程序模块被导入时声明，但在应用程序开始运行代码以便消耗配置信息并创建引擎之前，数据库连接不可用。当前有两种方法可以解决这个问题，在接下来的两个部分中描述。</p>
</div>
<input class="tab-input" id="tab-set--23-input--2" name="tab-set--23" type="radio"><label class="tab-label" for="tab-set--23-input--2">英文</label><div class="tab-content docutils container">
<p>There are several patterns available which provide for producing mapped
classes against a series of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> objects that were
introspected from the database, using the reflection process described at
<a class="reference internal" href="../core/reflection.html#metadata-reflection"><span class="std std-ref">反映数据库对象</span></a>.</p>
<p>A simple way to map a class to a table reflected from the database is to
use a declarative hybrid mapping, passing the
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.params.autoload_with" title="sqlalchemy.schema.Table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Table.autoload_with</span></code></a> parameter to the constructor for
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://user:pass@hostname/my_existing_database&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
        <span class="s2">&quot;mytable&quot;</span><span class="p">,</span>
        <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
        <span class="n">autoload_with</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>A variant on the above pattern that scales for many tables is to use the
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData.reflect" title="sqlalchemy.schema.MetaData.reflect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MetaData.reflect()</span></code></a> method to reflect a full set of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>
objects at once, then refer to them from the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>

<span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://user:pass@hostname/my_existing_database&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">reflect</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="s2">&quot;mytable&quot;</span><span class="p">]</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>One caveat to the approach of using <code class="docutils literal notranslate"><span class="pre">__table__</span></code> is that the mapped classes cannot
be declared until the tables have been reflected, which requires the database
connectivity source to be present while the application classes are being
declared; it’s typical that classes are declared as the modules of an
application are being imported, but database connectivity isn’t available
until the application starts running code so that it can consume configuration
information and create an engine.   There are currently two approaches
to working around this, described in the next two sections.</p>
</div>
</div>
<section id="deferredreflection">
<span id="orm-declarative-reflected-deferred-reflection"></span><h3>使用 DeferredReflection<a class="headerlink" href="#deferredreflection" title="Link to this heading">¶</a></h3>
<p>Using DeferredReflection</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--24-input--1" name="tab-set--24" type="radio"><label class="tab-label" for="tab-set--24-input--1">中文</label><div class="tab-content docutils container">
<p>为了适应在表元数据反射之后声明映射类的用例，可以使用一个简单的扩展，称为 <a class="reference internal" href="extensions/declarative/index.html#sqlalchemy.ext.declarative.DeferredReflection" title="sqlalchemy.ext.declarative.DeferredReflection"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeferredReflection</span></code></a> 混入，它会更改声明式映射过程，直到调用一个特殊的类级别方法 <a class="reference internal" href="extensions/declarative/index.html#sqlalchemy.ext.declarative.DeferredReflection.prepare" title="sqlalchemy.ext.declarative.DeferredReflection.prepare"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeferredReflection.prepare()</span></code></a>，该方法将对目标数据库执行反射过程，并将结果与声明式表映射过程集成，即使用 <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> 属性的类:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.declarative</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeferredReflection</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Reflected</span><span class="p">(</span><span class="n">DeferredReflection</span><span class="p">):</span>
    <span class="n">__abstract__</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Foo</span><span class="p">(</span><span class="n">Reflected</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;foo&quot;</span>
    <span class="n">bars</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Bar&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Bar</span><span class="p">(</span><span class="n">Reflected</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span>

    <span class="n">foo_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;foo.id&quot;</span><span class="p">))</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>在上面，我们创建了一个混入类 <code class="docutils literal notranslate"><span class="pre">Reflected</span></code>，它将作为我们声明层次结构中类的基础，当调用 <code class="docutils literal notranslate"><span class="pre">Reflected.prepare</span></code> 方法时，这些类应该成为映射的。上述映射在给定 <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> 之前是不完整的:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://user:pass@hostname/my_existing_database&quot;</span><span class="p">)</span>
<span class="n">Reflected</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span></pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Reflected</span></code> 类的目的是定义应该反射映射的类的范围。插件将在调用 <code class="docutils literal notranslate"><span class="pre">.prepare()</span></code> 的目标的子类树中搜索，并反射所有由声明类命名的表；与目标表没有通过外键约束关联的目标数据库中的表将不会被反射。</p>
</div>
<input class="tab-input" id="tab-set--24-input--2" name="tab-set--24" type="radio"><label class="tab-label" for="tab-set--24-input--2">英文</label><div class="tab-content docutils container">
<p>To accommodate the use case of declaring mapped classes where reflection of
table metadata can occur afterwards, a simple extension called the
<a class="reference internal" href="extensions/declarative/index.html#sqlalchemy.ext.declarative.DeferredReflection" title="sqlalchemy.ext.declarative.DeferredReflection"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeferredReflection</span></code></a> mixin is available, which alters the declarative
mapping process to be delayed until a special class-level
<a class="reference internal" href="extensions/declarative/index.html#sqlalchemy.ext.declarative.DeferredReflection.prepare" title="sqlalchemy.ext.declarative.DeferredReflection.prepare"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DeferredReflection.prepare()</span></code></a> method is called, which will perform
the reflection process against a target database, and will integrate the
results with the declarative table mapping process, that is, classes which
use the <code class="docutils literal notranslate"><span class="pre">__tablename__</span></code> attribute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.declarative</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeferredReflection</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Reflected</span><span class="p">(</span><span class="n">DeferredReflection</span><span class="p">):</span>
    <span class="n">__abstract__</span> <span class="o">=</span> <span class="kc">True</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Foo</span><span class="p">(</span><span class="n">Reflected</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;foo&quot;</span>
    <span class="n">bars</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Bar&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Bar</span><span class="p">(</span><span class="n">Reflected</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span>

    <span class="n">foo_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;foo.id&quot;</span><span class="p">))</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, we create a mixin class <code class="docutils literal notranslate"><span class="pre">Reflected</span></code> that will serve as a base
for classes in our declarative hierarchy that should become mapped when
the <code class="docutils literal notranslate"><span class="pre">Reflected.prepare</span></code> method is called.   The above mapping is not
complete until we do so, given an <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql+psycopg2://user:pass@hostname/my_existing_database&quot;</span><span class="p">)</span>
<span class="n">Reflected</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span></pre></div>
</div>
<p>The purpose of the <code class="docutils literal notranslate"><span class="pre">Reflected</span></code> class is to define the scope at which
classes should be reflectively mapped.   The plugin will search among the
subclass tree of the target against which <code class="docutils literal notranslate"><span class="pre">.prepare()</span></code> is called and reflect
all tables which are named by declared classes; tables in the target database
that are not part of mappings and are not related to the target tables
via foreign key constraint will not be reflected.</p>
</div>
</div>
</section>
<section id="automap">
<h3>使用 Automap<a class="headerlink" href="#automap" title="Link to this heading">¶</a></h3>
<p>Using Automap</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--25-input--1" name="tab-set--25" type="radio"><label class="tab-label" for="tab-set--25-input--1">中文</label><div class="tab-content docutils container">
<p>对映射现有数据库使用表反射的更自动化解决方案是使用 <a class="reference internal" href="extensions/automap.html#automap-toplevel"><span class="std std-ref">自动映射</span></a> 扩展。此扩展将从数据库模式生成整个映射类，包括基于观察到的外键约束的类之间的关系。虽然它包括自定义的钩子，例如允许自定义类命名和关系命名方案的钩子，但automap面向的是一种快速的零配置工作方式。如果应用程序希望具有使用表反射的完全显式模型，则 <a class="reference internal" href="#orm-declarative-reflected-deferred-reflection"><span class="std std-ref">DeferredReflection</span></a> 类可能更适合其不那么自动化的方法。</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="extensions/automap.html#automap-toplevel"><span class="std std-ref">自动映射</span></a></p>
</div>
</div>
<input class="tab-input" id="tab-set--25-input--2" name="tab-set--25" type="radio"><label class="tab-label" for="tab-set--25-input--2">英文</label><div class="tab-content docutils container">
<p>A more automated solution to mapping against an existing database where table
reflection is to be used is to use the <a class="reference internal" href="extensions/automap.html#automap-toplevel"><span class="std std-ref">自动映射</span></a> extension. This
extension will generate entire mapped classes from a database schema, including
relationships between classes based on observed foreign key constraints. While
it includes hooks for customization, such as hooks that allow custom
class naming and relationship naming schemes, automap is oriented towards an
expedient zero-configuration style of working. If an application wishes to have
a fully explicit model that makes use of table reflection, the
<a class="reference internal" href="#orm-declarative-reflected-deferred-reflection"><span class="std std-ref">DeferredReflection</span></a>
class may be preferable for its less automated approach.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="extensions/automap.html#automap-toplevel"><span class="std std-ref">自动映射</span></a></p>
</div>
</div>
</div>
</section>
<section id="mapper-automated-reflection-schemes">
<span id="id19"></span><h3>从反射表自动执行列命名方案<a class="headerlink" href="#mapper-automated-reflection-schemes" title="Link to this heading">¶</a></h3>
<p>Automating Column Naming Schemes from Reflected Tables</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--26-input--1" name="tab-set--26" type="radio"><label class="tab-label" for="tab-set--26-input--1">中文</label><div class="tab-content docutils container">
<p>使用任何前述的反射技术时，我们可以选择更改列的映射命名方案。<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象包含一个参数 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.key" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.key</span></code></a>，这是一个字符串名称，用于确定此 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 在 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.c" title="sqlalchemy.schema.Table.c"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Table.c</span></code></a> 集合中以何种名称存在，与列的SQL名称无关。如果没有通过其他方式提供，例如在 <a class="reference internal" href="#orm-imperative-table-column-naming"><span class="std std-ref">用于映射表列的备用属性名称</span></a> 中说明的那样，此键也将由 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> 用作映射 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 的属性名称。</p>
<p>使用表反射时，我们可以拦截将用于 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 的参数，并使用 <a class="reference internal" href="../core/events.html#sqlalchemy.events.DDLEvents.column_reflect" title="sqlalchemy.events.DDLEvents.column_reflect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DDLEvents.column_reflect()</span></code></a> 事件应用所需的任何更改，包括 <code class="docutils literal notranslate"><span class="pre">.key</span></code> 属性以及数据类型。</p>
<p>事件钩子最容易与使用中的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> 对象关联，如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s2">&quot;column_reflect&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">column_reflect</span><span class="p">(</span><span class="n">inspector</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">column_info</span><span class="p">):</span>
    <span class="c1"># 设置 column.key = &quot;attr_&lt;lower_case_name&gt;&quot;</span>
    <span class="n">column_info</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;attr_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">column_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>使用上述事件，反射 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象时将使用我们的事件拦截，并添加一个新的 <code class="docutils literal notranslate"><span class="pre">.key</span></code> 元素，如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;some_table&quot;</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">some_engine</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>该方法还适用于 <a class="reference internal" href="extensions/declarative/index.html#sqlalchemy.ext.declarative.DeferredReflection" title="sqlalchemy.ext.declarative.DeferredReflection"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeferredReflection</span></code></a> 基类以及 <a class="reference internal" href="extensions/automap.html#automap-toplevel"><span class="std std-ref">自动映射</span></a> 扩展。对于automap的详细信息，请参见 <a class="reference internal" href="extensions/automap.html#automap-intercepting-columns"><span class="std std-ref">Intercepting Column Definitions</span></a> 部分。</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-declarative-reflected"><span class="std std-ref">使用反射表进行声明式映射</span></a></p>
<p><a class="reference internal" href="../core/events.html#sqlalchemy.events.DDLEvents.column_reflect" title="sqlalchemy.events.DDLEvents.column_reflect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DDLEvents.column_reflect()</span></code></a></p>
<p><a class="reference internal" href="extensions/automap.html#automap-intercepting-columns"><span class="std std-ref">Intercepting Column Definitions</span></a> - 见 <a class="reference internal" href="extensions/automap.html#automap-toplevel"><span class="std std-ref">自动映射</span></a> 文档</p>
</div>
</div>
<input class="tab-input" id="tab-set--26-input--2" name="tab-set--26" type="radio"><label class="tab-label" for="tab-set--26-input--2">英文</label><div class="tab-content docutils container">
<p>When using any of the previous reflection techniques, we have the option
to change the naming scheme by which columns are mapped.   The
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object includes a parameter
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.key" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.key</span></code></a> which is a string name that determines
under what name
this <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> will be present in the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.c" title="sqlalchemy.schema.Table.c"><code class="xref py py-attr docutils literal notranslate"><span class="pre">Table.c</span></code></a>
collection, independently of the SQL name of the column.  This key is also
used by <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> as the attribute name under which the
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> will be mapped, if not supplied through other
means such as that illustrated at <a class="reference internal" href="#orm-imperative-table-column-naming"><span class="std std-ref">用于映射表列的备用属性名称</span></a>.</p>
<p>When working with table reflection, we can intercept the parameters that
will be used for <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> as they are received using
the <a class="reference internal" href="../core/events.html#sqlalchemy.events.DDLEvents.column_reflect" title="sqlalchemy.events.DDLEvents.column_reflect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DDLEvents.column_reflect()</span></code></a> event and apply whatever
changes we need, including the <code class="docutils literal notranslate"><span class="pre">.key</span></code> attribute but also things like
datatypes.</p>
<p>The event hook is most easily
associated with the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> object that’s in use
as illustrated below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">event</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="s2">&quot;column_reflect&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">column_reflect</span><span class="p">(</span><span class="n">inspector</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">column_info</span><span class="p">):</span>
    <span class="c1"># set column.key = &quot;attr_&lt;lower_case_name&gt;&quot;</span>
    <span class="n">column_info</span><span class="p">[</span><span class="s2">&quot;key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;attr_</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">column_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>With the above event, the reflection of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects will be intercepted
with our event that adds a new “.key” element, such as in a mapping as below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">MyClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;some_table&quot;</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">autoload_with</span><span class="o">=</span><span class="n">some_engine</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The approach also works with both the <a class="reference internal" href="extensions/declarative/index.html#sqlalchemy.ext.declarative.DeferredReflection" title="sqlalchemy.ext.declarative.DeferredReflection"><code class="xref py py-class docutils literal notranslate"><span class="pre">DeferredReflection</span></code></a> base class
as well as with the <a class="reference internal" href="extensions/automap.html#automap-toplevel"><span class="std std-ref">自动映射</span></a> extension.   For automap
specifically, see the section <a class="reference internal" href="extensions/automap.html#automap-intercepting-columns"><span class="std std-ref">Intercepting Column Definitions</span></a> for
background.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#orm-declarative-reflected"><span class="std std-ref">使用反射表进行声明式映射</span></a></p>
<p><a class="reference internal" href="../core/events.html#sqlalchemy.events.DDLEvents.column_reflect" title="sqlalchemy.events.DDLEvents.column_reflect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DDLEvents.column_reflect()</span></code></a></p>
<p><a class="reference internal" href="extensions/automap.html#automap-intercepting-columns"><span class="std std-ref">Intercepting Column Definitions</span></a> - in the <a class="reference internal" href="extensions/automap.html#automap-toplevel"><span class="std std-ref">自动映射</span></a> documentation</p>
</div>
</div>
</div>
</section>
<section id="mapper-primary-key">
<span id="id20"></span><h3>映射到一组显式主键列<a class="headerlink" href="#mapper-primary-key" title="Link to this heading">¶</a></h3>
<p>Mapping to an Explicit Set of Primary Key Columns</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--27-input--1" name="tab-set--27" type="radio"><label class="tab-label" for="tab-set--27-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> 构造在成功映射表时，总是需要至少一个列被标识为该可选择的“主键”。这是为了在加载或持久化ORM对象时，可以使用适当的 <a class="reference internal" href="../glossary.html#term-identity-key"><span class="xref std std-term">identity key</span></a> 将其放置在 <a class="reference internal" href="../glossary.html#term-identity-map"><span class="xref std std-term">identity map</span></a> 中。</p>
<p>在这些情况下，反射表不包括主键约束，以及在一般情况下 <a class="reference internal" href="nonstandard_mappings.html#orm-mapping-arbitrary-subqueries"><span class="std std-ref">映射任意可选择的</span></a> 时，可能不存在主键列，提供了 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper.params.primary_key" title="sqlalchemy.orm.Mapper"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.primary_key</span></code></a> 参数，以便可以将任何一组列配置为表的“主键”，就ORM映射而言。</p>
<p>给定以下示例：针对现有 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象的命令式表映射，其中表没有声明主键（如在反射场景中可能发生的那样），我们可以如下示例映射这样的表:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">UniqueConstraint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">group_users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;group_users&quot;</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;group_id&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;group_id&quot;</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">GroupUsers</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">group_users</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;primary_key&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">group_users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">group_users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">group_id</span><span class="p">]}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>在上面， <code class="docutils literal notranslate"><span class="pre">group_users</span></code> 表是某种类型的关联表，具有字符串列 <code class="docutils literal notranslate"><span class="pre">user_id</span></code> 和 <code class="docutils literal notranslate"><span class="pre">group_id</span></code>，但没有设置主键；相反，只有一个 <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">UniqueConstraint</span></code></a> 确立了这两列代表唯一键。<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> 不会自动检查唯一约束是否为主键；相反，我们使用 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper.params.primary_key" title="sqlalchemy.orm.Mapper"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.primary_key</span></code></a> 参数，传递 <code class="docutils literal notranslate"><span class="pre">[group_users.c.user_id,</span> <span class="pre">group_users.c.group_id]</span></code> 的集合，表明这两列应被用于构建 <code class="docutils literal notranslate"><span class="pre">GroupUsers</span></code> 类实例的标识键。</p>
</div>
<input class="tab-input" id="tab-set--27-input--2" name="tab-set--27" type="radio"><label class="tab-label" for="tab-set--27-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> construct in order to successfully map a table always
requires that at least one column be identified as the “primary key” for
that selectable.   This is so that when an ORM object is loaded or persisted,
it can be placed in the <a class="reference internal" href="../glossary.html#term-identity-map"><span class="xref std std-term">identity map</span></a> with an appropriate
<a class="reference internal" href="../glossary.html#term-identity-key"><span class="xref std std-term">identity key</span></a>.</p>
<p>In those cases where the a reflected table to be mapped does not include
a primary key constraint, as well as in the general case for
<a class="reference internal" href="nonstandard_mappings.html#orm-mapping-arbitrary-subqueries"><span class="std std-ref">mapping against arbitrary selectables</span></a>
where primary key columns might not be present, the
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper.params.primary_key" title="sqlalchemy.orm.Mapper"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.primary_key</span></code></a> parameter is provided so that any set of
columns may be configured as the “primary key” for the table, as far as
ORM mapping is concerned.</p>
<p>Given the following example of an Imperative Table
mapping against an existing <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object where the table does not
have any declared primary key (as may occur in reflection scenarios), we may
map such a table as in the following example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">String</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">UniqueConstraint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">group_users</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;group_users&quot;</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;group_id&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">40</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;group_id&quot;</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">GroupUsers</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">group_users</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;primary_key&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">group_users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">group_users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">group_id</span><span class="p">]}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, the <code class="docutils literal notranslate"><span class="pre">group_users</span></code> table is an association table of some kind
with string columns <code class="docutils literal notranslate"><span class="pre">user_id</span></code> and <code class="docutils literal notranslate"><span class="pre">group_id</span></code>, but no primary key is set up;
instead, there is only a <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">UniqueConstraint</span></code></a> establishing that the
two columns represent a unique key.   The <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> does not automatically
inspect unique constraints for primary keys; instead, we make use of the
<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper.params.primary_key" title="sqlalchemy.orm.Mapper"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.primary_key</span></code></a> parameter, passing a collection of
<code class="docutils literal notranslate"><span class="pre">[group_users.c.user_id,</span> <span class="pre">group_users.c.group_id]</span></code>, indicating that these two
columns should be used in order to construct the identity key for instances
of the <code class="docutils literal notranslate"><span class="pre">GroupUsers</span></code> class.</p>
</div>
</div>
</section>
<section id="include-exclude-cols">
<span id="id21"></span><h3>映射表列的子集<a class="headerlink" href="#include-exclude-cols" title="Link to this heading">¶</a></h3>
<p>Mapping a Subset of Table Columns</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--28-input--1" name="tab-set--28" type="radio"><label class="tab-label" for="tab-set--28-input--1">中文</label><div class="tab-content docutils container">
<p>有时表反射可能会提供一个包含许多不重要列的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> ，这些列可以安全地忽略。对于具有许多不需要在应用程序中引用的列的表，<a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper.params.include_properties" title="sqlalchemy.orm.Mapper"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.include_properties</span></code></a> 或 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper.params.exclude_properties" title="sqlalchemy.orm.Mapper"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.exclude_properties</span></code></a> 参数可以指示要映射的列子集，目标 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 中的其他列将不会被ORM以任何方式考虑。示例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;include_properties&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;user_name&quot;</span><span class="p">]}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>在上述示例中， <code class="docutils literal notranslate"><span class="pre">User</span></code> 类将映射到 <code class="docutils literal notranslate"><span class="pre">user_table</span></code> 表，仅包括 <code class="docutils literal notranslate"><span class="pre">user_id</span></code> 和 <code class="docutils literal notranslate"><span class="pre">user_name</span></code> 列 - 其余的不被引用。</p>
<p>类似地:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">address_table</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;exclude_properties&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;street&quot;</span><span class="p">,</span> <span class="s2">&quot;city&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;zip&quot;</span><span class="p">]}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>将 <code class="docutils literal notranslate"><span class="pre">Address</span></code> 类映射到 <code class="docutils literal notranslate"><span class="pre">address_table</span></code> 表，包括所有存在的列，除了 <code class="docutils literal notranslate"><span class="pre">street</span></code>、 <code class="docutils literal notranslate"><span class="pre">city</span></code>、 <code class="docutils literal notranslate"><span class="pre">state</span></code> 和 <code class="docutils literal notranslate"><span class="pre">zip</span></code> 。</p>
<p>如两个示例中所示，列可以通过字符串名称引用，也可以直接引用 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象。直接引用对象可能有助于明确性以及在映射到可能具有重复名称的多表构造时解决歧义:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;include_properties&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_name</span><span class="p">]</span>
    <span class="p">}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>当列不包含在映射中时，这些列不会在执行 <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> 或遗留 <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> 对象时发出的SELECT语句中引用，也不会在映射类上有任何表示该列的映射属性；分配该名称的属性除了正常的Python属性分配外不会有任何效果。</p>
<p>然而，重要的是要注意，即使这些列可能从ORM映射中排除， <strong>架构级别的列默认值仍将有效(schema level column defaults WILL
still be in effect)</strong> ，对于包含这些默认值的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象也是如此。</p>
<p>“架构级别的列默认值”是指在 <a class="reference internal" href="../core/defaults.html#metadata-defaults"><span class="std std-ref">列 INSERT/UPDATE 默认值</span></a> 中描述的默认值，包括由 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.default" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.default</span></code></a>、<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.onupdate" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.onupdate</span></code></a>、<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.server_default" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.server_default</span></code></a> 和 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.server_onupdate" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.server_onupdate</span></code></a> 参数配置的默认值。这些构造继续具有正常效果，因为在 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.default" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.default</span></code></a> 和 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.onupdate" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.onupdate</span></code></a> 的情况下，<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象仍然存在于底层 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 上，从而允许在ORM发出INSERT或UPDATE时进行默认函数，并且在 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.server_default" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.server_default</span></code></a> 和 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.server_onupdate" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.server_onupdate</span></code></a> 的情况下，关系数据库本身会以服务器端行为发出这些默认值。</p>
</div>
<input class="tab-input" id="tab-set--28-input--2" name="tab-set--28" type="radio"><label class="tab-label" for="tab-set--28-input--2">英文</label><div class="tab-content docutils container">
<p>Sometimes table reflection may provide a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> with many
columns that are not important for our needs and may be safely ignored.
For such a table that has lots of columns that don’t need to be referenced
in the application, the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper.params.include_properties" title="sqlalchemy.orm.Mapper"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.include_properties</span></code></a>
or <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.Mapper.params.exclude_properties" title="sqlalchemy.orm.Mapper"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Mapper.exclude_properties</span></code></a> parameters can indicate
a subset of columns to be mapped, where other columns from the
target <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> will not be considered by the ORM in any
way.   Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;include_properties&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">,</span> <span class="s2">&quot;user_name&quot;</span><span class="p">]}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>In the above example, the <code class="docutils literal notranslate"><span class="pre">User</span></code> class will map to the <code class="docutils literal notranslate"><span class="pre">user_table</span></code> table, only
including the <code class="docutils literal notranslate"><span class="pre">user_id</span></code> and <code class="docutils literal notranslate"><span class="pre">user_name</span></code> columns - the rest are not referenced.</p>
<p>Similarly:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">address_table</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;exclude_properties&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;street&quot;</span><span class="p">,</span> <span class="s2">&quot;city&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;zip&quot;</span><span class="p">]}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>will map the <code class="docutils literal notranslate"><span class="pre">Address</span></code> class to the <code class="docutils literal notranslate"><span class="pre">address_table</span></code> table, including
all columns present except <code class="docutils literal notranslate"><span class="pre">street</span></code>, <code class="docutils literal notranslate"><span class="pre">city</span></code>, <code class="docutils literal notranslate"><span class="pre">state</span></code>, and <code class="docutils literal notranslate"><span class="pre">zip</span></code>.</p>
<p>As indicated in the two examples, columns may be referenced either
by string name or by referring to the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object
directly.  Referring to the object directly may be useful for explicitness as
well as to resolve ambiguities when
mapping to multi-table constructs that might have repeated names:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__table__</span> <span class="o">=</span> <span class="n">user_table</span>
    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;include_properties&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">user_table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_name</span><span class="p">]</span>
    <span class="p">}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>When columns are not included in a mapping, these columns will not be
referenced in any SELECT statements emitted when executing <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>
or legacy <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> objects, nor will there be any mapped attribute
on the mapped class which represents the column; assigning an attribute of that
name will have no effect beyond that of a normal Python attribute assignment.</p>
<p>However, it is important to note that <strong>schema level column defaults WILL
still be in effect</strong> for those <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects that include them,
even though they may be excluded from the ORM mapping.</p>
<p>“Schema level column defaults” refers to the defaults described at
<a class="reference internal" href="../core/defaults.html#metadata-defaults"><span class="std std-ref">列 INSERT/UPDATE 默认值</span></a> including those configured by the
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.default" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.default</span></code></a>, <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.onupdate" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.onupdate</span></code></a>,
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.server_default" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.server_default</span></code></a> and
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.server_onupdate" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.server_onupdate</span></code></a> parameters. These constructs
continue to have normal effects because in the case of
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.default" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.default</span></code></a> and <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.onupdate" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.onupdate</span></code></a>, the
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object is still present on the underlying
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a>, thus allowing the default functions to take place when
the ORM emits an INSERT or UPDATE, and in the case of
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.server_default" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.server_default</span></code></a> and
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.server_onupdate" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.server_onupdate</span></code></a>, the relational database itself
emits these defaults as a server side behavior.</p>
</div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="declarative_config.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">使用声明式映射器配置</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="declarative_styles.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">声明式映射风格</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                <a href="../copyright.html">Copyright</a> &#169; 2007-2025, the SQLAlchemy authors and contributors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on 04/05/2025 04:00:26</div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">声明式的表配置</a><ul>
<li><a class="reference internal" href="#mapped-column">带有 <code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code> 的声明表</a><ul>
<li><a class="reference internal" href="#orm-declarative-mapped-column">使用带注释的声明表（ <code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code> 的类型注释形式）</a><ul>
<li><a class="reference internal" href="#mapped-column-mapped"><code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code> 从 <code class="docutils literal notranslate"><span class="pre">Mapped</span></code> 注释中派生数据类型和可空性</a></li>
<li><a class="reference internal" href="#orm-declarative-mapped-column-type-map">自定义类型映射</a></li>
<li><a class="reference internal" href="#orm-declarative-type-map-union-types">类型映射内的联合类型</a></li>
<li><a class="reference internal" href="#pep-695-newtype">支持类型别名类型（由 PEP 695 定义）和 NewType</a></li>
<li><a class="reference internal" href="#python">将多种类型配置映射到 Python 类型</a></li>
<li><a class="reference internal" href="#orm-declarative-mapped-column-pep593">将整个列声明映射到 Python 类型</a></li>
<li><a class="reference internal" href="#python-enum-pep-586-literal">在类型映射中使用 Python <code class="docutils literal notranslate"><span class="pre">Enum</span></code> 或 pep-586 <code class="docutils literal notranslate"><span class="pre">Literal</span></code> 类型</a><ul>
<li><a class="reference internal" href="#id6">原生枚举和命名</a></li>
<li><a class="reference internal" href="#id7">更改默认枚举的配置</a></li>
<li><a class="reference internal" href="#enum-enum-typing-literal">将特定的 <code class="docutils literal notranslate"><span class="pre">enum.Enum</span></code> 或 <code class="docutils literal notranslate"><span class="pre">typing.Literal</span></code> 链接到其他数据类型</a></li>
</ul>
</li>
<li><a class="reference internal" href="#id8"><code class="docutils literal notranslate"><span class="pre">mapped_column()</span></code> 中的数据类功能</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm-declarative-metadata">访问表和元数据</a></li>
<li><a class="reference internal" href="#orm-declarative-table-configuration">声明性表配置</a></li>
<li><a class="reference internal" href="#orm-declarative-table-schema-name">使用声明性表的显式架构名称</a></li>
<li><a class="reference internal" href="#orm-declarative-column-options">为声明性映射列设置加载和持久性选项</a></li>
<li><a class="reference internal" href="#orm-declarative-table-column-naming">显式命名声明性映射列</a></li>
<li><a class="reference internal" href="#orm-declarative-table-adding-columns">将其他列附加到现有的声明性映射类</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm-imperative-table-configuration">使用命令式表的声明式（又名混合声明式）</a><ul>
<li><a class="reference internal" href="#orm-imperative-table-column-naming">用于映射表列的备用属性名称</a></li>
<li><a class="reference internal" href="#orm-imperative-table-column-options">为命令式表应用加载、持久性和映射选项列</a></li>
</ul>
</li>
<li><a class="reference internal" href="#orm-declarative-reflected">使用反射表进行声明式映射</a><ul>
<li><a class="reference internal" href="#deferredreflection">使用 DeferredReflection</a></li>
<li><a class="reference internal" href="#automap">使用 Automap</a></li>
<li><a class="reference internal" href="#mapper-automated-reflection-schemes">从反射表自动执行列命名方案</a></li>
<li><a class="reference internal" href="#mapper-primary-key">映射到一组显式主键列</a></li>
<li><a class="reference internal" href="#include-exclude-cols">映射表列的子集</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=2d0eb83f"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/tabs.js?v=3ee01567"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=2f3e6152"></script>
    <script src="../_static/translations.js?v=beaddf03"></script>
    </body>
</html>