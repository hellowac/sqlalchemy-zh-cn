<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="copyright" title="版权所有" href="../copyright.html" /><link rel="next" title="使用大型集合" href="large_collections.html" /><link rel="prev" title="邻接表关系" href="self_referential.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.08.06 -->
        <title>配置关系连接方式 - SQLAlchemy 2.1 Documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/changelog.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_paramlinks.css" />
    <link rel="stylesheet" type="text/css" href="../_static/docs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">SQLAlchemy 2.1 Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">SQLAlchemy 2.1 Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">概述</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorial/index.html">SQLAlchemy 统一教程</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of SQLAlchemy 统一教程</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/engine.html">建立连接 - Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/dbapi_transactions.html">使用事务和DBAPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/metadata.html">使用数据库元数据</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../tutorial/data.html">处理数据</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of 处理数据</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/data_insert.html">使用 INSERT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/data_select.html">使用 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/data_update.html">使用 UPDATE 和 DELETE 语句</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/orm_data_manipulation.html">使用 ORM 进行数据操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/orm_related_objects.html">使用 ORM 相关对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/further_reading.html">进一步阅读</a></li>
</ul>
</li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">SQLAlchemy ORM</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of SQLAlchemy ORM</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="quickstart.html">ORM 快速入门</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="mapper_config.html">ORM 映射类配置</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of ORM 映射类配置</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="mapping_styles.html">ORM 映射类概述</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="declarative_mapping.html">使用声明式映射类</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of 使用声明式映射类</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="declarative_styles.html">声明式映射风格</a></li>
<li class="toctree-l4"><a class="reference internal" href="declarative_tables.html">声明式的表配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="declarative_config.html">使用声明式映射器配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="declarative_mixins.html">使用 Mixins 组合映射层次结构</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="dataclasses.html">与dataclass和attrs的集成</a></li>
<li class="toctree-l3"><a class="reference internal" href="mapped_sql_expr.html">SQL 表达式作为映射属性</a></li>
<li class="toctree-l3"><a class="reference internal" href="mapped_attributes.html">更改Attribute的行为</a></li>
<li class="toctree-l3"><a class="reference internal" href="composites.html">复合列类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="inheritance.html">映射类继承层次结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="nonstandard_mappings.html">非传统映射</a></li>
<li class="toctree-l3"><a class="reference internal" href="versioning.html">配置版本计数器</a></li>
<li class="toctree-l3"><a class="reference internal" href="mapping_api.html">类映射 API</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="scalar_mapping.html">映射 SQL 表达式</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of 映射 SQL 表达式</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="mapping_columns.html">映射表格列</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 current has-children"><a class="reference internal" href="relationships.html">关系配置</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of 关系配置</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="basic_relationships.html">基本关系模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="self_referential.html">邻接表关系</a></li>
<li class="toctree-l3 current current-page"><a class="current reference internal" href="#">配置关系连接方式</a></li>
<li class="toctree-l3"><a class="reference internal" href="large_collections.html">使用大型集合</a></li>
<li class="toctree-l3"><a class="reference internal" href="collection_api.html">集合自定义和 API 详细信息</a></li>
<li class="toctree-l3"><a class="reference internal" href="relationship_persistence.html">特殊关系的持久化模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="backref.html">使用旧版“backref”关系参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="relationship_api.html">关系 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="queryguide/index.html">ORM 查询指南</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of ORM 查询指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="queryguide/select.html">为 ORM 映射类编写 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="queryguide/inheritance.html">为继承映射编写 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="queryguide/dml.html">启用 ORM 的 INSERT、UPDATE 和 DELETE 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="queryguide/columns.html">列加载选项</a></li>
<li class="toctree-l3"><a class="reference internal" href="queryguide/relationships.html">关系加载技术</a></li>
<li class="toctree-l3"><a class="reference internal" href="queryguide/api.html">用于查询的 ORM API 功能</a></li>
<li class="toctree-l3"><a class="reference internal" href="queryguide/query.html">旧式查询 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="session.html">使用会话</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of 使用会话</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="session_basics.html">会话基础知识</a></li>
<li class="toctree-l3"><a class="reference internal" href="session_state_management.html">状态管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="cascades.html">级联</a></li>
<li class="toctree-l3"><a class="reference internal" href="session_transaction.html">事务和连接管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="persistence_techniques.html">附加持久性技术</a></li>
<li class="toctree-l3"><a class="reference internal" href="contextual.html">上下文/线程本地会话</a></li>
<li class="toctree-l3"><a class="reference internal" href="session_events.html">使用事件跟踪查询、对象和会话更改</a></li>
<li class="toctree-l3"><a class="reference internal" href="session_api.html">会话 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="extending.html">事件和内部</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of 事件和内部</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="events.html">ORM 事件</a></li>
<li class="toctree-l3"><a class="reference internal" href="internals.html">ORM 内部</a></li>
<li class="toctree-l3"><a class="reference internal" href="exceptions.html">ORM 异常</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="extensions/index.html">ORM 扩展</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of ORM 扩展</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="extensions/asyncio.html">异步 I/O (asyncio)</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/associationproxy.html">关联代理</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/automap.html">自动映射</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/baked.html">烘焙查询</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/declarative/index.html">声明式扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/mutable.html">突变追踪</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/orderinglist.html">排序列表</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/horizontal_shard.html">水平分片</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/hybrid.html">混合属性</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/indexable.html">Indexable</a></li>
<li class="toctree-l3"><a class="reference internal" href="extensions/instrumentation.html">替代类检测</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="examples.html">核心和 ORM 示例</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../core/index.html">SQLAlchemy Core</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of SQLAlchemy Core</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/expression_api.html">SQL 语句和表达式 API</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of SQL 语句和表达式 API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/sqlelement.html">列元素和表达式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/operators.html">操作符参考</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/selectable.html">SELECT 和相关构造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/dml.html">插入,更新,删除</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/functions.html">SQL 和 范型函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/compiler.html">自定义 SQL 构造和编译扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/serializer.html">表达式序列化器扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/foundation.html">SQL 表达式语言基础构造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/visitors.html">访问者和遍历实用程序</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/schema.html">Schema 定义语言</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of Schema 定义语言</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/metadata.html">使用元数据描述数据库</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/reflection.html">反映数据库对象</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/defaults.html">列 INSERT/UPDATE 默认值</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/constraints.html">定义约束和索引</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/ddl.html">自定义 DDL</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/types.html">SQL 数据类型对象</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of SQL 数据类型对象</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/type_basics.html">类型层次结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/custom_types.html">自定义类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/type_api.html">基本类型 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/engines_connections.html">Engine和Connection的使用</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of Engine和Connection的使用</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/engines.html">Engine 配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/connections.html">使用Engines和Connection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/pooling.html">连接池</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/events.html">核心事件</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/api_basics.html">Core API 基础</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of Core API 基础</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/event.html">事件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/inspection.html">运行时审查 API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/exceptions.html">Core 异常</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/internals.html">Core 内部</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../dialects/index.html">Dialects</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of Dialects</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../dialects/postgresql.html">PostgreSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/mysql.html">MySQL 和 MariaDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/sqlite.html">SQLite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/oracle.html">Oracle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/mssql.html">Microsoft SQL Server</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../faq/index.html">常见问题</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of 常见问题</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq/installation.html">安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/connections.html">连接 / 引擎</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/metadata_schema.html">元数据 / Schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/sqlexpressions.html">SQL 表达式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/ormconfiguration.html">ORM 配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/performance.html">性能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/sessions.html">会话 / 查询</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/thirdparty.html">第三方包集成问题</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../errors.html">错误消息</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../changelog/index.html">变更和迁移</a><input class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of 变更和迁移</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_21.html">SQLAlchemy 2.1 有什么新功能？</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_21.html">2.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_20.html">2.0 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_14.html">1.4 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_13.html">1.3 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_12.html">1.2 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_11.html">1.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_10.html">1.0 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_09.html">0.9 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_08.html">0.8 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_07.html">0.7 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_06.html">0.6 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_05.html">0.5 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_04.html">0.4 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_03.html">0.3 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_02.html">0.2 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/changelog_01.html">0.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_20.html">SQLAlchemy 2.0 - Major Migration Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/whatsnew_20.html">What’s New in SQLAlchemy 2.0?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_14.html">What’s New in SQLAlchemy 1.4?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_13.html">What’s New in SQLAlchemy 1.3?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_12.html">What’s New in SQLAlchemy 1.2?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_11.html">What’s New in SQLAlchemy 1.1?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_10.html">What’s New in SQLAlchemy 1.0?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_09.html">What’s New in SQLAlchemy 0.9?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_08.html">What’s New in SQLAlchemy 0.8?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_07.html">What’s New in SQLAlchemy 0.7?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_06.html">What’s New in SQLAlchemy 0.6?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_05.html">What’s new in SQLAlchemy 0.5?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../changelog/migration_04.html">What’s new in SQLAlchemy 0.4?</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="relationship-configure-joins">
<span id="id1"></span><h1>配置关系连接方式<a class="headerlink" href="#relationship-configure-joins" title="Link to this heading">¶</a></h1>
<p>Configuring how Relationship Joins</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--0-input--1" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 通常会通过检查两个表之间的外键关系来确定应比较哪些列来创建两个表之间的连接。在各种情况下，此行为都需要定制。</p>
</div>
<input class="tab-input" id="tab-set--0-input--2" name="tab-set--0" type="radio"><label class="tab-label" for="tab-set--0-input--2">英文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> will normally create a join between two tables by examining the foreign key relationship between the two tables to determine which columns should be compared.  There are a variety of situations where this behavior needs to be customized.</p>
</div>
</div>
<section id="relationship-foreign-keys">
<span id="id2"></span><h2>处理多个连接路径<a class="headerlink" href="#relationship-foreign-keys" title="Link to this heading">¶</a></h2>
<p>Handling Multiple Join Paths</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--1-input--1" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--1">中文</label><div class="tab-content docutils container">
<p>最常见的情况之一是两个表之间有多个外键路径。</p>
<p>考虑一个 <code class="docutils literal notranslate"><span class="pre">Customer</span></code> 类，其中包含两个指向 <code class="docutils literal notranslate"><span class="pre">Address</span></code> 类的外键:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">relationship</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;customer&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">billing_address_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;address.id&quot;</span><span class="p">))</span>
    <span class="n">shipping_address_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;address.id&quot;</span><span class="p">))</span>

    <span class="n">billing_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">)</span>
    <span class="n">shipping_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">street</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">zip</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>上述映射，当我们尝试使用它时，会产生错误：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>sqlalchemy.exc.AmbiguousForeignKeysError: Could not determine join
condition between parent/child tables on relationship
Customer.billing_address - there are multiple foreign key
paths linking the tables.  Specify the &#39;foreign_keys&#39; argument,
providing a list of those columns which should be
counted as containing a foreign key reference to the parent table.</pre></div>
</div>
<p>上述消息相当长。<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 可以返回许多潜在的消息，这些消息经过精心定制以检测各种常见的配置问题；大多数情况下会建议解决歧义或其他缺失信息所需的额外配置。</p>
<p>在这种情况下，消息希望我们通过为每个 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 指定应考虑的外键列来限定每个 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>，适当的形式如下:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;customer&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">billing_address_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;address.id&quot;</span><span class="p">))</span>
    <span class="n">shipping_address_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;address.id&quot;</span><span class="p">))</span>

    <span class="n">billing_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="p">[</span><span class="n">billing_address_id</span><span class="p">])</span>
    <span class="n">shipping_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="p">[</span><span class="n">shipping_address_id</span><span class="p">])</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>在上面，我们指定了 <code class="docutils literal notranslate"><span class="pre">foreign_keys</span></code> 参数，这是一个 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 或 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象列表，用于指示应被视为“外键”的列，换句话说，即包含引用父表值的列。从 <code class="docutils literal notranslate"><span class="pre">Customer</span></code> 对象加载 <code class="docutils literal notranslate"><span class="pre">Customer.billing_address</span></code> 关系将使用 <code class="docutils literal notranslate"><span class="pre">billing_address_id</span></code> 中存在的值来标识要加载的 <code class="docutils literal notranslate"><span class="pre">Address</span></code> 中的行；类似地， <code class="docutils literal notranslate"><span class="pre">shipping_address_id</span></code> 用于 <code class="docutils literal notranslate"><span class="pre">shipping_address</span></code> 关系。这两个列的链接在持久化期间也起作用；在刷新期间，刚插入的 <code class="docutils literal notranslate"><span class="pre">Address</span></code> 对象的新生成主键将被复制到关联的 <code class="docutils literal notranslate"><span class="pre">Customer</span></code> 对象的适当外键列中。</p>
<p>在使用声明式指定 <code class="docutils literal notranslate"><span class="pre">foreign_keys</span></code> 时，我们也可以使用字符串名称来指定，但重要的是，如果使用列表， <strong>列表是字符串的一部分</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">billing_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="s2">&quot;[Customer.billing_address_id]&quot;</span><span class="p">)</span></pre></div>
</div>
<p>在这个特定示例中，列表在任何情况下都是不必要的，因为我们只需要一个 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">billing_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="s2">&quot;Customer.billing_address_id&quot;</span><span class="p">)</span></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>作为 Python 可评估字符串传递时，<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.foreign_keys" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.foreign_keys</span></code></a> 参数使用 Python 的 <code class="docutils literal notranslate"><span class="pre">eval()</span></code> 函数进行解释。 <strong>不要将不受信任的输入传递给此字符串</strong>。有关声明式评估 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 参数的详细信息，请参见 <a class="reference internal" href="extensions/declarative/relationships.html#declarative-relationship-eval"><span class="std std-ref">Evaluation of relationship arguments</span></a>。</p>
</div>
</div>
<input class="tab-input" id="tab-set--1-input--2" name="tab-set--1" type="radio"><label class="tab-label" for="tab-set--1-input--2">英文</label><div class="tab-content docutils container">
<p>One of the most common situations to deal with is when
there are more than one foreign key path between two tables.</p>
<p>Consider a <code class="docutils literal notranslate"><span class="pre">Customer</span></code> class that contains two foreign keys to an <code class="docutils literal notranslate"><span class="pre">Address</span></code>
class:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">relationship</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;customer&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">billing_address_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;address.id&quot;</span><span class="p">))</span>
    <span class="n">shipping_address_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;address.id&quot;</span><span class="p">))</span>

    <span class="n">billing_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">)</span>
    <span class="n">shipping_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">street</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">zip</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The above mapping, when we attempt to use it, will produce the error:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>sqlalchemy.exc.AmbiguousForeignKeysError: Could not determine join
condition between parent/child tables on relationship
Customer.billing_address - there are multiple foreign key
paths linking the tables.  Specify the &#39;foreign_keys&#39; argument,
providing a list of those columns which should be
counted as containing a foreign key reference to the parent table.</pre></div>
</div>
<p>The above message is pretty long.  There are many potential messages
that <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> can return, which have been carefully tailored
to detect a variety of common configurational issues; most will suggest
the additional configuration that’s needed to resolve the ambiguity
or other missing information.</p>
<p>In this case, the message wants us to qualify each <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>
by instructing for each one which foreign key column should be considered, and
the appropriate form is as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Customer</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;customer&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">billing_address_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;address.id&quot;</span><span class="p">))</span>
    <span class="n">shipping_address_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;address.id&quot;</span><span class="p">))</span>

    <span class="n">billing_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="p">[</span><span class="n">billing_address_id</span><span class="p">])</span>
    <span class="n">shipping_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="p">[</span><span class="n">shipping_address_id</span><span class="p">])</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, we specify the <code class="docutils literal notranslate"><span class="pre">foreign_keys</span></code> argument, which is a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> or list
of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects which indicate those columns to be considered “foreign”,
or in other words, the columns that contain a value referring to a parent table.
Loading the <code class="docutils literal notranslate"><span class="pre">Customer.billing_address</span></code> relationship from a <code class="docutils literal notranslate"><span class="pre">Customer</span></code>
object will use the value present in <code class="docutils literal notranslate"><span class="pre">billing_address_id</span></code> in order to
identify the row in <code class="docutils literal notranslate"><span class="pre">Address</span></code> to be loaded; similarly, <code class="docutils literal notranslate"><span class="pre">shipping_address_id</span></code>
is used for the <code class="docutils literal notranslate"><span class="pre">shipping_address</span></code> relationship.   The linkage of the two
columns also plays a role during persistence; the newly generated primary key
of a just-inserted <code class="docutils literal notranslate"><span class="pre">Address</span></code> object will be copied into the appropriate
foreign key column of an associated <code class="docutils literal notranslate"><span class="pre">Customer</span></code> object during a flush.</p>
<p>When specifying <code class="docutils literal notranslate"><span class="pre">foreign_keys</span></code> with Declarative, we can also use string
names to specify, however it is important that if using a list, the <strong>list
is part of the string</strong>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">billing_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="s2">&quot;[Customer.billing_address_id]&quot;</span><span class="p">)</span></pre></div>
</div>
<p>In this specific example, the list is not necessary in any case as there’s only
one <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> we need:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">billing_address</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="s2">&quot;Customer.billing_address_id&quot;</span><span class="p">)</span></pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>When passed as a Python-evaluable string, the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.foreign_keys" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.foreign_keys</span></code></a> argument is interpreted using Python’s
<code class="docutils literal notranslate"><span class="pre">eval()</span></code> function. <strong>DO NOT PASS UNTRUSTED INPUT TO THIS STRING</strong>. See
<a class="reference internal" href="extensions/declarative/relationships.html#declarative-relationship-eval"><span class="std std-ref">Evaluation of relationship arguments</span></a> for details on declarative
evaluation of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> arguments.</p>
</div>
</div>
</div>
</section>
<section id="relationship-primaryjoin">
<span id="id3"></span><h2>指定备用连接条件<a class="headerlink" href="#relationship-primaryjoin" title="Link to this heading">¶</a></h2>
<p>Specifying Alternate Join Conditions</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--2-input--1" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 在构建连接时的默认行为是将一侧主键列的值等同于另一侧引用外键的列的值。我们可以使用 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 参数（以及在使用“secondary”表时使用的 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> 参数）将此标准更改为我们想要的任何内容。</p>
<p>在下面的示例中，使用 <code class="docutils literal notranslate"><span class="pre">User</span></code> 类以及存储街道地址的 <code class="docutils literal notranslate"><span class="pre">Address</span></code> 类，我们创建一个关系 <code class="docutils literal notranslate"><span class="pre">boston_addresses</span></code>，它只加载那些指定城市为“Boston”的 <code class="docutils literal notranslate"><span class="pre">Address</span></code> 对象:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">relationship</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">boston_addresses</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Address&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;and_(User.id==Address.user_id, Address.city==&#39;Boston&#39;)&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user.id&quot;</span><span class="p">))</span>

    <span class="n">street</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">zip</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>在这个字符串 SQL 表达式中，我们使用了 <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.and_" title="sqlalchemy.sql.expression.and_"><code class="xref py py-func docutils literal notranslate"><span class="pre">and_()</span></code></a> 连接构造来建立两个不同的连接条件谓词 - 将 <code class="docutils literal notranslate"><span class="pre">User.id</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Address.user_id</span></code> 列连接到一起，并将 <code class="docutils literal notranslate"><span class="pre">Address</span></code> 中的行限制为仅 <code class="docutils literal notranslate"><span class="pre">city='Boston'</span></code>。在使用声明式时，基本的 SQL 函数如 <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.and_" title="sqlalchemy.sql.expression.and_"><code class="xref py py-func docutils literal notranslate"><span class="pre">and_()</span></code></a> 在字符串 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 参数的评估命名空间中自动可用。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>当作为 Python 可评估字符串传递时，<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 参数使用 Python 的 <code class="docutils literal notranslate"><span class="pre">eval()</span></code> 函数进行解释。 <strong>不要将不受信任的输入传递给此字符串</strong>。有关声明式评估 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 参数的详细信息，请参见 <a class="reference internal" href="extensions/declarative/relationships.html#declarative-relationship-eval"><span class="std std-ref">Evaluation of relationship arguments</span></a>。</p>
</div>
<p>我们在 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 中使用的自定义条件通常仅在 SQLAlchemy 渲染 SQL 以加载或表示此关系时才重要。也就是说，它用于发出 SQL 语句以执行每个属性的延迟加载，或在查询时构建连接时使用，例如通过 <code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code>，或通过“joined”或“subquery”风格的预加载。当正在操作内存中的对象时，我们可以将任何我们想要的 <code class="docutils literal notranslate"><span class="pre">Address</span></code> 对象放入 <code class="docutils literal notranslate"><span class="pre">boston_addresses</span></code> 集合中，而不管 <code class="docutils literal notranslate"><span class="pre">.city</span></code> 属性的值是什么。对象将保持在集合中，直到属性过期并从数据库中重新加载应用的条件。当发生刷新时， <code class="docutils literal notranslate"><span class="pre">boston_addresses</span></code> 内的对象将无条件刷新，将主键 <code class="docutils literal notranslate"><span class="pre">user.id</span></code> 列的值分配到每行的持有外键的 <code class="docutils literal notranslate"><span class="pre">address.user_id</span></code> 列中。 <code class="docutils literal notranslate"><span class="pre">city</span></code> 条件在这里没有效果，因为刷新过程只关心将主键值同步到引用的外键值中。</p>
</div>
<input class="tab-input" id="tab-set--2-input--2" name="tab-set--2" type="radio"><label class="tab-label" for="tab-set--2-input--2">英文</label><div class="tab-content docutils container">
<p>The default behavior of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> when constructing a join
is that it equates the value of primary key columns
on one side to that of foreign-key-referring columns on the other.
We can change this criterion to be anything we’d like using the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>
argument, as well as the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a>
argument in the case when a “secondary” table is used.</p>
<p>In the example below, using the <code class="docutils literal notranslate"><span class="pre">User</span></code> class
as well as an <code class="docutils literal notranslate"><span class="pre">Address</span></code> class which stores a street address,  we
create a relationship <code class="docutils literal notranslate"><span class="pre">boston_addresses</span></code> which will only
load those <code class="docutils literal notranslate"><span class="pre">Address</span></code> objects which specify a city of “Boston”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">relationship</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">boston_addresses</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Address&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;and_(User.id==Address.user_id, Address.city==&#39;Boston&#39;)&quot;</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;address&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user.id&quot;</span><span class="p">))</span>

    <span class="n">street</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">city</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">zip</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Within this string SQL expression, we made use of the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.and_" title="sqlalchemy.sql.expression.and_"><code class="xref py py-func docutils literal notranslate"><span class="pre">and_()</span></code></a> conjunction
construct to establish two distinct predicates for the join condition - joining
both the <code class="docutils literal notranslate"><span class="pre">User.id</span></code> and <code class="docutils literal notranslate"><span class="pre">Address.user_id</span></code> columns to each other, as well as
limiting rows in <code class="docutils literal notranslate"><span class="pre">Address</span></code> to just <code class="docutils literal notranslate"><span class="pre">city='Boston'</span></code>.   When using
Declarative, rudimentary SQL functions like <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.and_" title="sqlalchemy.sql.expression.and_"><code class="xref py py-func docutils literal notranslate"><span class="pre">and_()</span></code></a> are automatically
available in the evaluated namespace of a string <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>
argument.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>When passed as a Python-evaluable string, the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> argument is interpreted using
Python’s
<code class="docutils literal notranslate"><span class="pre">eval()</span></code> function. <strong>DO NOT PASS UNTRUSTED INPUT TO THIS STRING</strong>. See
<a class="reference internal" href="extensions/declarative/relationships.html#declarative-relationship-eval"><span class="std std-ref">Evaluation of relationship arguments</span></a> for details on declarative
evaluation of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> arguments.</p>
</div>
<p>The custom criteria we use in a <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>
is generally only significant when SQLAlchemy is rendering SQL in
order to load or represent this relationship. That is, it’s used in
the SQL statement that’s emitted in order to perform a per-attribute
lazy load, or when a join is constructed at query time, such as via
<code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.join()</span></code>, or via the eager “joined” or “subquery” styles of
loading.   When in-memory objects are being manipulated, we can place
any <code class="docutils literal notranslate"><span class="pre">Address</span></code> object we’d like into the <code class="docutils literal notranslate"><span class="pre">boston_addresses</span></code>
collection, regardless of what the value of the <code class="docutils literal notranslate"><span class="pre">.city</span></code> attribute
is.   The objects will remain present in the collection until the
attribute is expired and re-loaded from the database where the
criterion is applied.   When a flush occurs, the objects inside of
<code class="docutils literal notranslate"><span class="pre">boston_addresses</span></code> will be flushed unconditionally, assigning value
of the primary key <code class="docutils literal notranslate"><span class="pre">user.id</span></code> column onto the foreign-key-holding
<code class="docutils literal notranslate"><span class="pre">address.user_id</span></code> column for each row.  The <code class="docutils literal notranslate"><span class="pre">city</span></code> criteria has no
effect here, as the flush process only cares about synchronizing
primary key values into referencing foreign key values.</p>
</div>
</div>
</section>
<section id="relationship-custom-foreign">
<span id="id4"></span><h2>创建自定义外部条件<a class="headerlink" href="#relationship-custom-foreign" title="Link to this heading">¶</a></h2>
<p>Creating Custom Foreign Conditions</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--3-input--1" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--1">中文</label><div class="tab-content docutils container">
<p>主连接条件的另一个元素是如何确定那些被认为是“外键”的列。通常，某些 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象将指定 <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKey" title="sqlalchemy.schema.ForeignKey"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKey</span></code></a>，或者是与连接条件相关的 <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint" title="sqlalchemy.schema.ForeignKeyConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKeyConstraint</span></code></a> 的一部分。<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 会查看这种外键状态，因为它决定了如何为此关系加载和持久化数据。然而，<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 参数可以用来创建不涉及任何“schema”级别外键的连接条件。我们可以结合使用 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 以及 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.foreign_keys" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.foreign_keys</span></code></a> 和 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.remote_side" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.remote_side</span></code></a> 显式地建立这样的连接。</p>
<p>在下面的示例中，一个类 <code class="docutils literal notranslate"><span class="pre">HostEntry</span></code> 自引用连接，将字符串 <code class="docutils literal notranslate"><span class="pre">content</span></code> 列等同于 <code class="docutils literal notranslate"><span class="pre">ip_address</span></code> 列，这是一个名为 <code class="docutils literal notranslate"><span class="pre">INET</span></code> 的 PostgreSQL 类型。我们需要使用 <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.cast" title="sqlalchemy.sql.expression.cast"><code class="xref py py-func docutils literal notranslate"><span class="pre">cast()</span></code></a> 将连接的一侧强制转换为另一侧的类型:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">relationship</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects.postgresql</span><span class="w"> </span><span class="kn">import</span> <span class="n">INET</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">HostEntry</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;host_entry&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ip_address</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">INET</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="c1"># relationship() 使用显式 foreign_keys 和 remote_side</span>
    <span class="n">parent_host</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;HostEntry&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="n">ip_address</span> <span class="o">==</span> <span class="n">cast</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">INET</span><span class="p">),</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
        <span class="n">remote_side</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>上述关系将产生如下连接：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">host_entry</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">host_entry</span><span class="p">.</span><span class="n">ip_address</span><span class="p">,</span><span class="w"> </span><span class="n">host_entry</span><span class="p">.</span><span class="n">content</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">host_entry</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">host_entry</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">host_entry_1</span>
<span class="k">ON</span><span class="w"> </span><span class="n">host_entry_1</span><span class="p">.</span><span class="n">ip_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">host_entry</span><span class="p">.</span><span class="n">content</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">INET</span><span class="p">)</span></pre></div>
</div>
<p>上述的另一种语法是在线使用 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a> 和 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.remote" title="sqlalchemy.orm.remote"><code class="xref py py-func docutils literal notranslate"><span class="pre">remote()</span></code></a> <a class="reference internal" href="../glossary.html#term-annotations"><span class="xref std std-term">annotations</span></a>，在 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 表达式中。这种语法表示 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 通常自行应用于连接条件的注释，给定 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.foreign_keys" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.foreign_keys</span></code></a> 和 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.remote_side" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.remote_side</span></code></a> 参数。当存在显式连接条件时，这些函数可能更简洁，并且还标记了“外键”或“远程”的确切列，而不管该列是否多次声明或在复杂 SQL 表达式中:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">foreign</span><span class="p">,</span> <span class="n">remote</span>


<span class="k">class</span><span class="w"> </span><span class="nc">HostEntry</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;host_entry&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ip_address</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">INET</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="c1"># relationship() 使用显式 foreign() 和 remote() 注释</span>
    <span class="c1"># 代替单独的参数</span>
    <span class="n">parent_host</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;HostEntry&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span> <span class="o">==</span> <span class="n">cast</span><span class="p">(</span><span class="n">foreign</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">INET</span><span class="p">),</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</div>
<input class="tab-input" id="tab-set--3-input--2" name="tab-set--3" type="radio"><label class="tab-label" for="tab-set--3-input--2">英文</label><div class="tab-content docutils container">
<p>Another element of the primary join condition is how those columns
considered “foreign” are determined.  Usually, some subset
of <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> objects will specify <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKey" title="sqlalchemy.schema.ForeignKey"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKey</span></code></a>, or otherwise
be part of a <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint" title="sqlalchemy.schema.ForeignKeyConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKeyConstraint</span></code></a> that’s relevant to the join condition.
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> looks to this foreign key status as it decides
how it should load and persist data for this relationship.   However, the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> argument can be used to create a join condition that
doesn’t involve any “schema” level foreign keys.  We can combine <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>
along with <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.foreign_keys" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.foreign_keys</span></code></a> and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.remote_side" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.remote_side</span></code></a> explicitly in order to
establish such a join.</p>
<p>Below, a class <code class="docutils literal notranslate"><span class="pre">HostEntry</span></code> joins to itself, equating the string <code class="docutils literal notranslate"><span class="pre">content</span></code>
column to the <code class="docutils literal notranslate"><span class="pre">ip_address</span></code> column, which is a PostgreSQL type called <code class="docutils literal notranslate"><span class="pre">INET</span></code>.
We need to use <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.cast" title="sqlalchemy.sql.expression.cast"><code class="xref py py-func docutils literal notranslate"><span class="pre">cast()</span></code></a> in order to cast one side of the join to the
type of the other:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">cast</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">relationship</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects.postgresql</span><span class="w"> </span><span class="kn">import</span> <span class="n">INET</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">HostEntry</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;host_entry&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ip_address</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">INET</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="c1"># relationship() using explicit foreign_keys, remote_side</span>
    <span class="n">parent_host</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;HostEntry&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="n">ip_address</span> <span class="o">==</span> <span class="n">cast</span><span class="p">(</span><span class="n">content</span><span class="p">,</span> <span class="n">INET</span><span class="p">),</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">content</span><span class="p">,</span>
        <span class="n">remote_side</span><span class="o">=</span><span class="n">ip_address</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The above relationship will produce a join like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">host_entry</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">host_entry</span><span class="p">.</span><span class="n">ip_address</span><span class="p">,</span><span class="w"> </span><span class="n">host_entry</span><span class="p">.</span><span class="n">content</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">host_entry</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">host_entry</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">host_entry_1</span>
<span class="k">ON</span><span class="w"> </span><span class="n">host_entry_1</span><span class="p">.</span><span class="n">ip_address</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">CAST</span><span class="p">(</span><span class="n">host_entry</span><span class="p">.</span><span class="n">content</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">INET</span><span class="p">)</span></pre></div>
</div>
<p>An alternative syntax to the above is to use the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a> and
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.remote" title="sqlalchemy.orm.remote"><code class="xref py py-func docutils literal notranslate"><span class="pre">remote()</span></code></a> <a class="reference internal" href="../glossary.html#term-annotations"><span class="xref std std-term">annotations</span></a>,
inline within the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> expression.
This syntax represents the annotations that <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> normally
applies by itself to the join condition given the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.foreign_keys" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.foreign_keys</span></code></a> and
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.remote_side" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.remote_side</span></code></a> arguments.  These functions may
be more succinct when an explicit join condition is present, and additionally
serve to mark exactly the column that is “foreign” or “remote” independent
of whether that column is stated multiple times or within complex
SQL expressions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">foreign</span><span class="p">,</span> <span class="n">remote</span>


<span class="k">class</span><span class="w"> </span><span class="nc">HostEntry</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;host_entry&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ip_address</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">INET</span><span class="p">)</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>

    <span class="c1"># relationship() using explicit foreign() and remote() annotations</span>
    <span class="c1"># in lieu of separate arguments</span>
    <span class="n">parent_host</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;HostEntry&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="n">ip_address</span><span class="p">)</span> <span class="o">==</span> <span class="n">cast</span><span class="p">(</span><span class="n">foreign</span><span class="p">(</span><span class="n">content</span><span class="p">),</span> <span class="n">INET</span><span class="p">),</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</div>
</div>
</section>
<section id="relationship-custom-operator">
<span id="id5"></span><h2>在连接条件中使用自定义运算符<a class="headerlink" href="#relationship-custom-operator" title="Link to this heading">¶</a></h2>
<p>Using custom operators in join conditions</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--4-input--1" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--1">中文</label><div class="tab-content docutils container">
<p>关系的另一个用例是使用自定义运算符，例如在与 <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.INET" title="sqlalchemy.dialects.postgresql.INET"><code class="xref py py-class docutils literal notranslate"><span class="pre">INET</span></code></a> 和 <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.CIDR" title="sqlalchemy.dialects.postgresql.CIDR"><code class="xref py py-class docutils literal notranslate"><span class="pre">CIDR</span></code></a> 类型连接时使用 PostgreSQL 的“包含于” <code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code> 运算符。对于自定义布尔运算符，我们使用 <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.Operators.bool_op" title="sqlalchemy.sql.expression.Operators.bool_op"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.bool_op()</span></code></a> 函数:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">inet_column</span><span class="o">.</span><span class="n">bool_op</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;&quot;</span><span class="p">)(</span><span class="n">cidr_column</span><span class="p">)</span></pre></div>
</div>
<p>如上所述的比较可以直接与 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 一起使用，当构建 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 时:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">IPA</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;ip_address&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">v4address</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">INET</span><span class="p">)</span>

    <span class="n">network</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Network&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;IPA.v4address.bool_op(&#39;&lt;&lt;&#39;)(foreign(Network.v4representation))&quot;</span><span class="p">,</span>
        <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Network</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;network&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">v4representation</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">CIDR</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>如上所述的查询:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">select</span><span class="p">(</span><span class="n">IPA</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IPA</span><span class="o">.</span><span class="n">network</span><span class="p">)</span></pre></div>
</div>
<p>将渲染为：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">ip_address</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ip_address_id</span><span class="p">,</span><span class="w"> </span><span class="n">ip_address</span><span class="p">.</span><span class="n">v4address</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ip_address_v4address</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">ip_address</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">ip_address</span><span class="p">.</span><span class="n">v4address</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">network</span><span class="p">.</span><span class="n">v4representation</span></pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--4-input--2" name="tab-set--4" type="radio"><label class="tab-label" for="tab-set--4-input--2">英文</label><div class="tab-content docutils container">
<p>Another use case for relationships is the use of custom operators, such
as PostgreSQL’s “is contained within” <code class="docutils literal notranslate"><span class="pre">&lt;&lt;</span></code> operator when joining with
types such as <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.INET" title="sqlalchemy.dialects.postgresql.INET"><code class="xref py py-class docutils literal notranslate"><span class="pre">INET</span></code></a> and <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.CIDR" title="sqlalchemy.dialects.postgresql.CIDR"><code class="xref py py-class docutils literal notranslate"><span class="pre">CIDR</span></code></a>.
For custom boolean operators we use the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.Operators.bool_op" title="sqlalchemy.sql.expression.Operators.bool_op"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.bool_op()</span></code></a> function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">inet_column</span><span class="o">.</span><span class="n">bool_op</span><span class="p">(</span><span class="s2">&quot;&lt;&lt;&quot;</span><span class="p">)(</span><span class="n">cidr_column</span><span class="p">)</span></pre></div>
</div>
<p>A comparison like the above may be used directly with
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> when constructing
a <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">IPA</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;ip_address&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">v4address</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">INET</span><span class="p">)</span>

    <span class="n">network</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Network&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;IPA.v4address.bool_op(&#39;&lt;&lt;&#39;)(foreign(Network.v4representation))&quot;</span><span class="p">,</span>
        <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Network</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;network&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">v4representation</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">CIDR</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, a query such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">select</span><span class="p">(</span><span class="n">IPA</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">IPA</span><span class="o">.</span><span class="n">network</span><span class="p">)</span></pre></div>
</div>
<p>Will render as:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">ip_address</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ip_address_id</span><span class="p">,</span><span class="w"> </span><span class="n">ip_address</span><span class="p">.</span><span class="n">v4address</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">ip_address_v4address</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">ip_address</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">network</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">ip_address</span><span class="p">.</span><span class="n">v4address</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">network</span><span class="p">.</span><span class="n">v4representation</span></pre></div>
</div>
</div>
</div>
</section>
<section id="sql">
<span id="relationship-custom-operator-sql-function"></span><h2>基于 SQL 函数的自定义运算符<a class="headerlink" href="#sql" title="Link to this heading">¶</a></h2>
<p>Custom operators based on SQL functions</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--5-input--1" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--1">中文</label><div class="tab-content docutils container">
<p><a href="#id6"><span class="problematic" id="id7">:param:`~.Operators.op.is_comparison`</span></a> 的用例变体是当我们不使用运算符，而是使用 SQL 函数时。此用例的典型示例是 PostgreSQL PostGIS 函数，但任何解析为二进制条件的数据库上的任何 SQL 函数都可以应用。为了适应这种用例，<a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.as_comparison" title="sqlalchemy.sql.functions.FunctionElement.as_comparison"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.as_comparison()</span></code></a> 方法可以修改任何 SQL 函数，例如从 <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.func" title="sqlalchemy.sql.expression.func"><code class="xref py py-data docutils literal notranslate"><span class="pre">func</span></code></a> 命名空间调用的那些，以向 ORM 表明函数生成两个表达式的比较。下面的示例使用了 <a class="reference external" href="https://geoalchemy-2.readthedocs.io/">Geoalchemy2</a> 库:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">geoalchemy2</span><span class="w"> </span><span class="kn">import</span> <span class="n">Geometry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">func</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">foreign</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Polygon</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;polygon&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Geometry</span><span class="p">(</span><span class="s2">&quot;POLYGON&quot;</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">))</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Point&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;func.ST_Contains(foreign(Polygon.geom), Point.geom).as_comparison(1, 2)&quot;</span><span class="p">,</span>
        <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Point</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;point&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Geometry</span><span class="p">(</span><span class="s2">&quot;POINT&quot;</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">))</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>上面，<a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.as_comparison" title="sqlalchemy.sql.functions.FunctionElement.as_comparison"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.as_comparison()</span></code></a> 表示 <code class="docutils literal notranslate"><span class="pre">func.ST_Contains()</span></code> SQL 函数正在比较 <code class="docutils literal notranslate"><span class="pre">Polygon.geom</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Point.geom</span></code> 表达式。<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a> 注释另外指出在此特定关系中哪个列承担“外键”角色。</p>
</div>
<input class="tab-input" id="tab-set--5-input--2" name="tab-set--5" type="radio"><label class="tab-label" for="tab-set--5-input--2">英文</label><div class="tab-content docutils container">
<p>A variant to the use case for <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.Operators.op.params.is_comparison" title="sqlalchemy.sql.expression.Operators.op"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Operators.op.is_comparison</span></code></a> is
when we aren’t using an operator, but a SQL function.   The typical example
of this use case is the PostgreSQL PostGIS functions however any SQL
function on any database that resolves to a binary condition may apply.
To suit this use case, the <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.as_comparison" title="sqlalchemy.sql.functions.FunctionElement.as_comparison"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.as_comparison()</span></code></a> method
can modify any SQL function, such as those invoked from the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.func" title="sqlalchemy.sql.expression.func"><code class="xref py py-data docutils literal notranslate"><span class="pre">func</span></code></a>
namespace, to indicate to the ORM that the function produces a comparison of
two expressions.  The below example illustrates this with the
<a class="reference external" href="https://geoalchemy-2.readthedocs.io/">Geoalchemy2</a> library:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">geoalchemy2</span><span class="w"> </span><span class="kn">import</span> <span class="n">Geometry</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">func</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">foreign</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Polygon</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;polygon&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Geometry</span><span class="p">(</span><span class="s2">&quot;POLYGON&quot;</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">))</span>
    <span class="n">points</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Point&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;func.ST_Contains(foreign(Polygon.geom), Point.geom).as_comparison(1, 2)&quot;</span><span class="p">,</span>
        <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Point</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;point&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">geom</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Geometry</span><span class="p">(</span><span class="s2">&quot;POINT&quot;</span><span class="p">,</span> <span class="n">srid</span><span class="o">=</span><span class="mi">4326</span><span class="p">))</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, the <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.as_comparison" title="sqlalchemy.sql.functions.FunctionElement.as_comparison"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.as_comparison()</span></code></a> indicates that the
<code class="docutils literal notranslate"><span class="pre">func.ST_Contains()</span></code> SQL function is comparing the <code class="docutils literal notranslate"><span class="pre">Polygon.geom</span></code> and
<code class="docutils literal notranslate"><span class="pre">Point.geom</span></code> expressions. The <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a> annotation additionally notes
which column takes on the “foreign key” role in this particular relationship.</p>
</div>
</div>
</section>
<section id="relationship-overlapping-foreignkeys">
<span id="id9"></span><h2>重叠外键<a class="headerlink" href="#relationship-overlapping-foreignkeys" title="Link to this heading">¶</a></h2>
<p>Overlapping Foreign Keys</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--6-input--1" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--1">中文</label><div class="tab-content docutils container">
<p>在使用复合外键时可能会出现一种罕见的情况，即单个列可能是通过外键约束引用的多个列的主题。</p>
<p>考虑一个（确实复杂的）映射，例如 <code class="docutils literal notranslate"><span class="pre">Magazine</span></code> 对象，通过复合主键方案由 <code class="docutils literal notranslate"><span class="pre">Writer</span></code> 对象和 <code class="docutils literal notranslate"><span class="pre">Article</span></code> 对象引用，两者都包括 <code class="docutils literal notranslate"><span class="pre">magazine_id</span></code>；然后为了使 <code class="docutils literal notranslate"><span class="pre">Article</span></code> 也引用 <code class="docutils literal notranslate"><span class="pre">Writer</span></code>， <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> 参与了两个单独的关系； <code class="docutils literal notranslate"><span class="pre">Article.magazine</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Article.writer</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Magazine</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;magazine&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;article&quot;</span>

    <span class="n">article_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">magazine_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;magazine.id&quot;</span><span class="p">))</span>
    <span class="n">writer_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span>

    <span class="n">magazine</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Magazine&quot;</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Writer&quot;</span><span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="s2">&quot;article_id&quot;</span><span class="p">,</span> <span class="s2">&quot;magazine_id&quot;</span><span class="p">),</span>
        <span class="n">ForeignKeyConstraint</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;writer_id&quot;</span><span class="p">,</span> <span class="s2">&quot;magazine_id&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;writer.id&quot;</span><span class="p">,</span> <span class="s2">&quot;writer.magazine_id&quot;</span><span class="p">]</span>
        <span class="p">),</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Writer</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;writer&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">magazine_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;magazine.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">magazine</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Magazine&quot;</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>配置上述映射时，我们会看到发出的警告：</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>SAWarning: relationship &#39;Article.writer&#39; will copy column
writer.magazine_id to column article.magazine_id,
which conflicts with relationship(s): &#39;Article.magazine&#39;
(copies magazine.id to article.magazine_id). Consider applying
viewonly=True to read-only relationships, or provide a primaryjoin
condition marking writable columns with the foreign() annotation.</pre></div>
</div>
<p>这源于这样一个事实，即 <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> 是两个不同外键约束的主题；它直接作为源列引用 <code class="docutils literal notranslate"><span class="pre">Magazine.id</span></code>，但在引用 <code class="docutils literal notranslate"><span class="pre">Writer</span></code> 的复合键的上下文中也作为源列引用 <code class="docutils literal notranslate"><span class="pre">Writer.magazine_id</span></code>。如果我们将一个 <code class="docutils literal notranslate"><span class="pre">Article</span></code> 与一个特定的 <code class="docutils literal notranslate"><span class="pre">Magazine</span></code> 关联起来，但随后将 <code class="docutils literal notranslate"><span class="pre">Article</span></code> 与一个与 <em>不同</em> 的 <code class="docutils literal notranslate"><span class="pre">Magazine</span></code> 关联的 <code class="docutils literal notranslate"><span class="pre">Writer</span></code> 关联，那么 ORM 将以非确定性的方式覆盖 <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code>，静默地更改我们引用的杂志；如果我们将 <code class="docutils literal notranslate"><span class="pre">Writer</span></code> 与 <code class="docutils literal notranslate"><span class="pre">Article</span></code> 取消关联，它也可能尝试将 NULL 放入此列中。警告让我们知道这是事实。</p>
<p>为了解决这个问题，我们需要将 <code class="docutils literal notranslate"><span class="pre">Article</span></code> 的行为分解为包括以下三个特性：</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Article</span></code> 首先根据仅在 <code class="docutils literal notranslate"><span class="pre">Article.magazine</span></code> 关系中持久化的数据写入 <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code>，即从 <code class="docutils literal notranslate"><span class="pre">Magazine.id</span></code> 复制的值。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Article</span></code> 可以代表在 <code class="docutils literal notranslate"><span class="pre">Article.writer</span></code> 关系中持久化的数据写入 <code class="docutils literal notranslate"><span class="pre">Article.writer_id</span></code>，但仅写入 <code class="docutils literal notranslate"><span class="pre">Writer.id</span></code> 列；<code class="docutils literal notranslate"><span class="pre">Writer.magazine_id</span></code> 列不应该写入 <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code>，因为它最终来自 <code class="docutils literal notranslate"><span class="pre">Magazine.id</span></code>。</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Article</span></code> 在加载 <code class="docutils literal notranslate"><span class="pre">Article.writer</span></code> 时会考虑 <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code>，尽管它*不会*代表此关系写入它。</p></li>
</ol>
<p>为了实现 #1 和 #2，我们可以仅将 <code class="docutils literal notranslate"><span class="pre">Article.writer_id</span></code> 指定为 <code class="docutils literal notranslate"><span class="pre">Article.writer</span></code> 的“外键”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Writer&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="s2">&quot;Article.writer_id&quot;</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>然而，这样做的效果是 <code class="docutils literal notranslate"><span class="pre">Article.writer</span></code> 在查询 <code class="docutils literal notranslate"><span class="pre">Writer</span></code> 时不考虑 <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">article</span><span class="p">.</span><span class="n">article_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">article_article_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">article</span><span class="p">.</span><span class="n">magazine_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">article_magazine_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">article</span><span class="p">.</span><span class="n">writer_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">article_writer_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">article</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">writer</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">article</span><span class="p">.</span><span class="n">writer_id</span></pre></div>
</div>
<p>因此，为了实现 #1、#2 和 #3，我们可以通过完全表达连接条件以及要写入的列来实现，结合使用 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>，以及 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.foreign_keys" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.foreign_keys</span></code></a> 参数，或者更简洁地通过注释 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Writer&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;and_(Writer.id == foreign(Article.writer_id), &quot;</span>
        <span class="s2">&quot;Writer.magazine_id == Article.magazine_id)&quot;</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</div>
<input class="tab-input" id="tab-set--6-input--2" name="tab-set--6" type="radio"><label class="tab-label" for="tab-set--6-input--2">英文</label><div class="tab-content docutils container">
<p>A rare scenario can arise when composite foreign keys are used, such that
a single column may be the subject of more than one column
referred to via foreign key constraint.</p>
<p>Consider an (admittedly complex) mapping such as the <code class="docutils literal notranslate"><span class="pre">Magazine</span></code> object,
referred to both by the <code class="docutils literal notranslate"><span class="pre">Writer</span></code> object and the <code class="docutils literal notranslate"><span class="pre">Article</span></code> object
using a composite primary key scheme that includes <code class="docutils literal notranslate"><span class="pre">magazine_id</span></code>
for both; then to make <code class="docutils literal notranslate"><span class="pre">Article</span></code> refer to <code class="docutils literal notranslate"><span class="pre">Writer</span></code> as well,
<code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> is involved in two separate relationships;
<code class="docutils literal notranslate"><span class="pre">Article.magazine</span></code> and <code class="docutils literal notranslate"><span class="pre">Article.writer</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Magazine</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;magazine&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;article&quot;</span>

    <span class="n">article_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">magazine_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;magazine.id&quot;</span><span class="p">))</span>
    <span class="n">writer_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">()</span>

    <span class="n">magazine</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Magazine&quot;</span><span class="p">)</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Writer&quot;</span><span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="s2">&quot;article_id&quot;</span><span class="p">,</span> <span class="s2">&quot;magazine_id&quot;</span><span class="p">),</span>
        <span class="n">ForeignKeyConstraint</span><span class="p">(</span>
            <span class="p">[</span><span class="s2">&quot;writer_id&quot;</span><span class="p">,</span> <span class="s2">&quot;magazine_id&quot;</span><span class="p">],</span> <span class="p">[</span><span class="s2">&quot;writer.id&quot;</span><span class="p">,</span> <span class="s2">&quot;writer.magazine_id&quot;</span><span class="p">]</span>
        <span class="p">),</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Writer</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;writer&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">magazine_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;magazine.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">magazine</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Magazine&quot;</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>When the above mapping is configured, we will see this warning emitted:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>SAWarning: relationship &#39;Article.writer&#39; will copy column
writer.magazine_id to column article.magazine_id,
which conflicts with relationship(s): &#39;Article.magazine&#39;
(copies magazine.id to article.magazine_id). Consider applying
viewonly=True to read-only relationships, or provide a primaryjoin
condition marking writable columns with the foreign() annotation.</pre></div>
</div>
<p>What this refers to originates from the fact that <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> is
the subject of two different foreign key constraints; it refers to
<code class="docutils literal notranslate"><span class="pre">Magazine.id</span></code> directly as a source column, but also refers to
<code class="docutils literal notranslate"><span class="pre">Writer.magazine_id</span></code> as a source column in the context of the
composite key to <code class="docutils literal notranslate"><span class="pre">Writer</span></code>.   If we associate an <code class="docutils literal notranslate"><span class="pre">Article</span></code> with a
particular <code class="docutils literal notranslate"><span class="pre">Magazine</span></code>, but then associate the <code class="docutils literal notranslate"><span class="pre">Article</span></code> with a
<code class="docutils literal notranslate"><span class="pre">Writer</span></code> that’s  associated  with a <em>different</em> <code class="docutils literal notranslate"><span class="pre">Magazine</span></code>, the ORM
will overwrite <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> non-deterministically, silently
changing which magazine to which we refer; it may
also attempt to place NULL into this column if we de-associate a
<code class="docutils literal notranslate"><span class="pre">Writer</span></code> from an <code class="docutils literal notranslate"><span class="pre">Article</span></code>.  The warning lets us know this is the case.</p>
<p>To solve this, we need to break out the behavior of <code class="docutils literal notranslate"><span class="pre">Article</span></code> to include
all three of the following features:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">Article</span></code> first and foremost writes to
<code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> based on data persisted in the <code class="docutils literal notranslate"><span class="pre">Article.magazine</span></code>
relationship only, that is a value copied from <code class="docutils literal notranslate"><span class="pre">Magazine.id</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Article</span></code> can write to <code class="docutils literal notranslate"><span class="pre">Article.writer_id</span></code> on behalf of data
persisted in the  <code class="docutils literal notranslate"><span class="pre">Article.writer</span></code> relationship, but only the
<code class="docutils literal notranslate"><span class="pre">Writer.id</span></code> column; the <code class="docutils literal notranslate"><span class="pre">Writer.magazine_id</span></code> column should not
be written into <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> as it ultimately is sourced
from <code class="docutils literal notranslate"><span class="pre">Magazine.id</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">Article</span></code> takes <code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> into account when loading
<code class="docutils literal notranslate"><span class="pre">Article.writer</span></code>, even though it <em>doesn’t</em> write to it on behalf
of this relationship.</p></li>
</ol>
<p>To get just #1 and #2, we could specify only <code class="docutils literal notranslate"><span class="pre">Article.writer_id</span></code> as the
“foreign keys” for <code class="docutils literal notranslate"><span class="pre">Article.writer</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Writer&quot;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="s2">&quot;Article.writer_id&quot;</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>However, this has the effect of <code class="docutils literal notranslate"><span class="pre">Article.writer</span></code> not taking
<code class="docutils literal notranslate"><span class="pre">Article.magazine_id</span></code> into account when querying against <code class="docutils literal notranslate"><span class="pre">Writer</span></code>:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">article</span><span class="p">.</span><span class="n">article_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">article_article_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">article</span><span class="p">.</span><span class="n">magazine_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">article_magazine_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">article</span><span class="p">.</span><span class="n">writer_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">article_writer_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">article</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">writer</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">writer</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">article</span><span class="p">.</span><span class="n">writer_id</span></pre></div>
</div>
<p>Therefore, to get at all of #1, #2, and #3, we express the join condition
as well as which columns to be written by combining
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> fully, along with either the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.foreign_keys" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.foreign_keys</span></code></a> argument, or more succinctly by
annotating with <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Article</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">writer</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Writer&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;and_(Writer.id == foreign(Article.writer_id), &quot;</span>
        <span class="s2">&quot;Writer.magazine_id == Article.magazine_id)&quot;</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</div>
</div>
</section>
<section id="id10">
<h2>非关系比较/物化路径<a class="headerlink" href="#id10" title="Link to this heading">¶</a></h2>
<p>Non-relational Comparisons / Materialized Path</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--7-input--1" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--1">中文</label><div class="tab-content docutils container">
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>本节详细介绍了一个实验性功能。</p>
</div>
<p>使用自定义表达式意味着我们可以生成不遵循通常主键/外键模型的不正统连接条件。一个这样的例子是物化路径模式，我们比较字符串以获得重叠的路径标记，从而生成树结构。</p>
<p>通过谨慎使用 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a> 和 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.remote" title="sqlalchemy.orm.remote"><code class="xref py py-func docutils literal notranslate"><span class="pre">remote()</span></code></a>，我们可以构建一个有效地生成基本物化路径系统的关系。本质上，当 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a> 和 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.remote" title="sqlalchemy.orm.remote"><code class="xref py py-func docutils literal notranslate"><span class="pre">remote()</span></code></a> 在比较表达式的*同一*侧时，关系被认为是“一对多”；当它们在 <em>不同</em> 侧时，关系被认为是“多对一”。对于这里使用的比较，我们将处理集合，因此我们将其配置为“一对多”：</p>
<blockquote>
<div><dl>
<dt>class Element(Base):</dt><dd><p>__tablename__ = “element”</p>
<p>path = mapped_column(String, primary_key=True)</p>
<dl class="simple">
<dt>descendants = relationship(</dt><dd><p>“Element”,
primaryjoin=remote(foreign(path)).like(path.concat(“/%”)),
viewonly=True,
order_by=path,</p>
</dd>
</dl>
<p>)</p>
</dd>
</dl>
</div></blockquote>
<p>上面，如果给定一个路径属性为 <code class="docutils literal notranslate"><span class="pre">&quot;/foo/bar2&quot;</span></code> 的 <code class="docutils literal notranslate"><span class="pre">Element</span></code> 对象，我们希望加载 <code class="docutils literal notranslate"><span class="pre">Element.descendants</span></code> 看起来像：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">element_path</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">element</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;/foo/bar2&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;/%&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">path</span></pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--7-input--2" name="tab-set--7" type="radio"><label class="tab-label" for="tab-set--7-input--2">英文</label><div class="tab-content docutils container">
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>this section details an experimental feature.</p>
</div>
<p>Using custom expressions means we can produce unorthodox join conditions that
don’t obey the usual primary/foreign key model.  One such example is the
materialized path pattern, where we compare strings for overlapping path tokens
in order to produce a tree structure.</p>
<p>Through careful use of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a> and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.remote" title="sqlalchemy.orm.remote"><code class="xref py py-func docutils literal notranslate"><span class="pre">remote()</span></code></a>, we can build
a relationship that effectively produces a rudimentary materialized path
system.   Essentially, when <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.foreign" title="sqlalchemy.orm.foreign"><code class="xref py py-func docutils literal notranslate"><span class="pre">foreign()</span></code></a> and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.remote" title="sqlalchemy.orm.remote"><code class="xref py py-func docutils literal notranslate"><span class="pre">remote()</span></code></a> are
on the <em>same</em> side of the comparison expression, the relationship is considered
to be “one to many”; when they are on <em>different</em> sides, the relationship
is considered to be “many to one”.   For the comparison we’ll use here,
we’ll be dealing with collections so we keep things configured as “one to many”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Element</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;element&quot;</span>

    <span class="n">path</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">descendants</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Element&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="n">foreign</span><span class="p">(</span><span class="n">path</span><span class="p">))</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="s2">&quot;/%&quot;</span><span class="p">)),</span>
        <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="n">path</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, if given an <code class="docutils literal notranslate"><span class="pre">Element</span></code> object with a path attribute of <code class="docutils literal notranslate"><span class="pre">&quot;/foo/bar2&quot;</span></code>,
we seek for a load of <code class="docutils literal notranslate"><span class="pre">Element.descendants</span></code> to look like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">element_path</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">element</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">path</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;/foo/bar2&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;/%&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">path</span></pre></div>
</div>
</div>
</div>
</section>
<section id="self-referential-many-to-many">
<span id="id11"></span><h2>自引用多对多关系<a class="headerlink" href="#self-referential-many-to-many" title="Link to this heading">¶</a></h2>
<p>Self-Referential Many-to-Many Relationship</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--8-input--1" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--1">中文</label><div class="tab-content docutils container">
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p>本节记录了“邻接列表”模式的两表变体，该模式记录在 <a class="reference internal" href="self_referential.html#self-referential"><span class="std std-ref">邻接表关系</span></a> 中。请务必查看子部分中的自引用查询模式
<a class="reference internal" href="self_referential.html#self-referential-query"><span class="std std-ref">自引用查询策略</span></a> 和 <a class="reference internal" href="self_referential.html#self-referential-eager-loading"><span class="std std-ref">配置自引用预加载</span></a>，这些模式同样适用于此处讨论的映射模式。</p>
</div>
<p>多对多关系可以通过 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 和 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> 之一或两者进行定制 - 后者对于使用 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a> 参数指定多对多引用的关系非常重要。
一种涉及使用 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 和 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> 的常见情况是建立一个从类到自身的多对多关系，如下所示:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span><span class="p">,</span> <span class="n">relationship</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">node_to_node</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;node_to_node&quot;</span><span class="p">,</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;left_node_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;right_node_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;node&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">right_nodes</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Node&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Node&quot;</span><span class="p">,</span>
        <span class="n">secondary</span><span class="o">=</span><span class="n">node_to_node</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="n">id</span> <span class="o">==</span> <span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">left_node_id</span><span class="p">,</span>
        <span class="n">secondaryjoin</span><span class="o">=</span><span class="n">id</span> <span class="o">==</span> <span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">right_node_id</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;left_nodes&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">left_nodes</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Node&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Node&quot;</span><span class="p">,</span>
        <span class="n">secondary</span><span class="o">=</span><span class="n">node_to_node</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="n">id</span> <span class="o">==</span> <span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">right_node_id</span><span class="p">,</span>
        <span class="n">secondaryjoin</span><span class="o">=</span><span class="n">id</span> <span class="o">==</span> <span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">left_node_id</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;right_nodes&quot;</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>如上所示，SQLAlchemy 无法自动知道哪些列应该连接到 <code class="docutils literal notranslate"><span class="pre">right_nodes</span></code> 和 <code class="docutils literal notranslate"><span class="pre">left_nodes</span></code> 关系。<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 和 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> 参数建立了我们希望如何连接到关联表。
在上面的声明形式中，由于我们在与 <code class="docutils literal notranslate"><span class="pre">Node</span></code> 类对应的 Python 块中声明了这些条件，所以 <code class="docutils literal notranslate"><span class="pre">id</span></code> 变量可以直接作为我们希望连接的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> 对象使用。</p>
<p>或者，我们可以使用字符串定义 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 和 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> 参数，这在我们的配置中尚未提供 <code class="docutils literal notranslate"><span class="pre">Node.id</span></code> 列对象或 <code class="docutils literal notranslate"><span class="pre">node_to_node</span></code> 表可能尚未可用的情况下是合适的。
当在声明字符串中引用普通的 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> 对象时，我们使用表在 <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> 中的字符串名称:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;node&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">right_nodes</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Node&quot;</span><span class="p">,</span>
        <span class="n">secondary</span><span class="o">=</span><span class="s2">&quot;node_to_node&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;Node.id==node_to_node.c.left_node_id&quot;</span><span class="p">,</span>
        <span class="n">secondaryjoin</span><span class="o">=</span><span class="s2">&quot;Node.id==node_to_node.c.right_node_id&quot;</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;left_nodes&quot;</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>当作为 Python 可评估字符串传递时，<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 和 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> 参数使用 Python 的 <code class="docutils literal notranslate"><span class="pre">eval()</span></code> 函数进行解释。 <strong>不要将不受信任的输入传递给这些字符串</strong>。有关声明式评估 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 参数的详细信息，请参见 <a class="reference internal" href="extensions/declarative/relationships.html#declarative-relationship-eval"><span class="std std-ref">Evaluation of relationship arguments</span></a>。</p>
</div>
<p>这里的经典映射情况类似，其中 <code class="docutils literal notranslate"><span class="pre">node_to_node</span></code> 可以连接到 <code class="docutils literal notranslate"><span class="pre">node.c.id</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">MetaData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">registry</span>

<span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">mapper_registry</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>

<span class="n">node_to_node</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;node_to_node&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;left_node_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;right_node_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;node&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="n">mapper_registry</span><span class="o">.</span><span class="n">map_imperatively</span><span class="p">(</span>
    <span class="n">Node</span><span class="p">,</span>
    <span class="n">node</span><span class="p">,</span>
    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;right_nodes&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span>
            <span class="n">Node</span><span class="p">,</span>
            <span class="n">secondary</span><span class="o">=</span><span class="n">node_to_node</span><span class="p">,</span>
            <span class="n">primaryjoin</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">left_node_id</span><span class="p">,</span>
            <span class="n">secondaryjoin</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">right_node_id</span><span class="p">,</span>
            <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;left_nodes&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">},</span>
<span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>请注意，在这两个示例中，<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.backref" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.backref</span></code></a> 关键字指定了一个 <code class="docutils literal notranslate"><span class="pre">left_nodes</span></code> 反向引用 - 当 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 以相反方向创建第二个关系时，它足够智能地反转 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 和 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> 参数。</p>
<ul class="simple">
<li><p><a class="reference internal" href="self_referential.html#self-referential"><span class="std std-ref">邻接表关系</span></a> - 单表版本</p></li>
<li><p><a class="reference internal" href="self_referential.html#self-referential-query"><span class="std std-ref">自引用查询策略</span></a> - 自引用映射查询提示</p></li>
<li><p><a class="reference internal" href="self_referential.html#self-referential-eager-loading"><span class="std std-ref">配置自引用预加载</span></a> - 自引用映射预加载提示</p></li>
</ul>
</div>
<input class="tab-input" id="tab-set--8-input--2" name="tab-set--8" type="radio"><label class="tab-label" for="tab-set--8-input--2">英文</label><div class="tab-content docutils container">
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p>This section documents a two-table variant of the “adjacency list” pattern,
which is documented at <a class="reference internal" href="self_referential.html#self-referential"><span class="std std-ref">邻接表关系</span></a>.  Be sure to review the
self-referential querying patterns in subsections
<a class="reference internal" href="self_referential.html#self-referential-query"><span class="std std-ref">自引用查询策略</span></a> and <a class="reference internal" href="self_referential.html#self-referential-eager-loading"><span class="std std-ref">配置自引用预加载</span></a>
which apply equally well to the mapping pattern discussed here.</p>
</div>
<p>Many to many relationships can be customized by one or both of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>
and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> - the latter is significant for a relationship that
specifies a many-to-many reference using the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a> argument.
A common situation which involves the usage of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a>
is when establishing a many-to-many relationship from a class to itself, as shown below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">List</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span><span class="p">,</span> <span class="n">relationship</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">node_to_node</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;node_to_node&quot;</span><span class="p">,</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;left_node_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;right_node_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;node&quot;</span>
    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">label</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span><span class="p">]</span>
    <span class="n">right_nodes</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Node&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Node&quot;</span><span class="p">,</span>
        <span class="n">secondary</span><span class="o">=</span><span class="n">node_to_node</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="n">id</span> <span class="o">==</span> <span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">left_node_id</span><span class="p">,</span>
        <span class="n">secondaryjoin</span><span class="o">=</span><span class="n">id</span> <span class="o">==</span> <span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">right_node_id</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;left_nodes&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">left_nodes</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="s2">&quot;Node&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Node&quot;</span><span class="p">,</span>
        <span class="n">secondary</span><span class="o">=</span><span class="n">node_to_node</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="n">id</span> <span class="o">==</span> <span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">right_node_id</span><span class="p">,</span>
        <span class="n">secondaryjoin</span><span class="o">=</span><span class="n">id</span> <span class="o">==</span> <span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">left_node_id</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;right_nodes&quot;</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>Where above, SQLAlchemy can’t know automatically which columns should connect
to which for the <code class="docutils literal notranslate"><span class="pre">right_nodes</span></code> and <code class="docutils literal notranslate"><span class="pre">left_nodes</span></code> relationships.   The <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>
and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> arguments establish how we’d like to join to the association table.
In the Declarative form above, as we are declaring these conditions within the Python
block that corresponds to the <code class="docutils literal notranslate"><span class="pre">Node</span></code> class, the <code class="docutils literal notranslate"><span class="pre">id</span></code> variable is available directly
as the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> object we wish to join with.</p>
<p>Alternatively, we can define the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>
and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> arguments using strings, which is suitable
in the case that our configuration does not have either the <code class="docutils literal notranslate"><span class="pre">Node.id</span></code> column
object available yet or the <code class="docutils literal notranslate"><span class="pre">node_to_node</span></code> table perhaps isn’t yet available.
When referring to a plain <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object in a declarative string, we
use the string name of the table as it is present in the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;node&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">label</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
    <span class="n">right_nodes</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Node&quot;</span><span class="p">,</span>
        <span class="n">secondary</span><span class="o">=</span><span class="s2">&quot;node_to_node&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;Node.id==node_to_node.c.left_node_id&quot;</span><span class="p">,</span>
        <span class="n">secondaryjoin</span><span class="o">=</span><span class="s2">&quot;Node.id==node_to_node.c.right_node_id&quot;</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;left_nodes&quot;</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>When passed as a Python-evaluable string, the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> and
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> arguments are interpreted using
Python’s <code class="docutils literal notranslate"><span class="pre">eval()</span></code> function. <strong>DO NOT PASS UNTRUSTED INPUT TO THESE
STRINGS</strong>. See <a class="reference internal" href="extensions/declarative/relationships.html#declarative-relationship-eval"><span class="std std-ref">Evaluation of relationship arguments</span></a> for details on
declarative evaluation of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> arguments.</p>
</div>
<p>A classical mapping situation here is similar, where <code class="docutils literal notranslate"><span class="pre">node_to_node</span></code> can be joined
to <code class="docutils literal notranslate"><span class="pre">node.c.id</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span><span class="p">,</span> <span class="n">MetaData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">relationship</span><span class="p">,</span> <span class="n">registry</span>

<span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">mapper_registry</span> <span class="o">=</span> <span class="n">registry</span><span class="p">()</span>

<span class="n">node_to_node</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;node_to_node&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;left_node_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;right_node_id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;node&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">),</span>
<span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="p">:</span>
    <span class="k">pass</span>


<span class="n">mapper_registry</span><span class="o">.</span><span class="n">map_imperatively</span><span class="p">(</span>
    <span class="n">Node</span><span class="p">,</span>
    <span class="n">node</span><span class="p">,</span>
    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;right_nodes&quot;</span><span class="p">:</span> <span class="n">relationship</span><span class="p">(</span>
            <span class="n">Node</span><span class="p">,</span>
            <span class="n">secondary</span><span class="o">=</span><span class="n">node_to_node</span><span class="p">,</span>
            <span class="n">primaryjoin</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">left_node_id</span><span class="p">,</span>
            <span class="n">secondaryjoin</span><span class="o">=</span><span class="n">node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">node_to_node</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">right_node_id</span><span class="p">,</span>
            <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;left_nodes&quot;</span><span class="p">,</span>
        <span class="p">)</span>
    <span class="p">},</span>
<span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Note that in both examples, the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.backref" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.backref</span></code></a>
keyword specifies a <code class="docutils literal notranslate"><span class="pre">left_nodes</span></code> backref - when
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> creates the second relationship in the reverse
direction, it’s smart enough to reverse the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> and
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a> arguments.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<ul class="simple">
<li><p><a class="reference internal" href="self_referential.html#self-referential"><span class="std std-ref">邻接表关系</span></a> - single table version</p></li>
<li><p><a class="reference internal" href="self_referential.html#self-referential-query"><span class="std std-ref">自引用查询策略</span></a> - tips on querying with self-referential
mappings</p></li>
<li><p><a class="reference internal" href="self_referential.html#self-referential-eager-loading"><span class="std std-ref">配置自引用预加载</span></a> - tips on eager loading with self-
referential mapping</p></li>
</ul>
</div>
</div>
</div>
</section>
<section id="composite-secondary-join">
<span id="id12"></span><h2>复合“次要”连接<a class="headerlink" href="#composite-secondary-join" title="Link to this heading">¶</a></h2>
<p>Composite “Secondary” Joins</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--9-input--1" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--1">中文</label><div class="tab-content docutils container">
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>本节介绍了 SQLAlchemy 支持的一些极端情况，但建议尽可能通过使用合理的关系布局和/或 <a class="reference internal" href="mapped_attributes.html#mapper-hybrids"><span class="std std-ref">in-Python attributes</span></a> 以更简单的方式解决这些问题。</p>
</div>
<p>有时，当需要在两个表之间建立 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 时，需要涉及两个或三个以上的表才能将它们连接起来。这是一个 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 的领域，试图突破可能的界限，许多这些特殊用例的最终解决方案通常需要在 SQLAlchemy 邮件列表中讨论。</p>
<p>在较新的 SQLAlchemy 版本中，可以在某些情况下使用 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a> 参数来提供由多个表组成的复合目标。以下是这样的连接条件的示例（要求至少版本 0.9.2 才能按原样运行）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;b.id&quot;</span><span class="p">))</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;D&quot;</span><span class="p">,</span>
        <span class="n">secondary</span><span class="o">=</span><span class="s2">&quot;join(B, D, B.d_id == D.id).join(C, C.d_id == D.id)&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;and_(A.b_id == B.id, A.id == C.a_id)&quot;</span><span class="p">,</span>
        <span class="n">secondaryjoin</span><span class="o">=</span><span class="s2">&quot;D.id == B.d_id&quot;</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">d_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;d.id&quot;</span><span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">C</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;c&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>
    <span class="n">d_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;d.id&quot;</span><span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">D</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>在上面的示例中，我们以声明方式提供了 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a>、<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 和 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a>，直接引用命名表 <code class="docutils literal notranslate"><span class="pre">a</span></code>、 <code class="docutils literal notranslate"><span class="pre">b</span></code>、 <code class="docutils literal notranslate"><span class="pre">c</span></code>、 <code class="docutils literal notranslate"><span class="pre">d</span></code>。从 <code class="docutils literal notranslate"><span class="pre">A</span></code> 到 <code class="docutils literal notranslate"><span class="pre">D</span></code> 的查询如下所示：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">d</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_b_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b_1</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d_1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">b_1</span><span class="p">.</span><span class="n">d_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_1</span><span class="p">.</span><span class="n">id</span>
<span class="w">        </span><span class="k">JOIN</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">c_1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">c_1</span><span class="p">.</span><span class="n">d_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_1</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c_1</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b_1</span><span class="p">.</span><span class="n">d_id</span>
</div></pre></div>
</div>
<p>在上面的示例中，我们利用能够将多个表放入“secondary”容器的优势，以便我们可以跨多个表进行连接，同时保持 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 的“简单性”，因为在“左侧”和“右侧”都有“一个”表；复杂性保持在中间。</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>像上面这样的关系通常标记为 <code class="docutils literal notranslate"><span class="pre">viewonly=True</span></code>，使用 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.viewonly" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.viewonly</span></code></a>，并应被视为只读。尽管有时可以使这样的关系可写，但这通常很复杂且容易出错。</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#relationship-viewonly-notes"><span class="std std-ref">使用 viewonly 关系参数的注意事项</span></a></p>
</div>
</div>
<input class="tab-input" id="tab-set--9-input--2" name="tab-set--9" type="radio"><label class="tab-label" for="tab-set--9-input--2">英文</label><div class="tab-content docutils container">
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>This section features far edge cases that are somewhat supported
by SQLAlchemy, however it is recommended to solve problems like these
in simpler ways whenever possible, by using reasonable relational
layouts and / or <a class="reference internal" href="mapped_attributes.html#mapper-hybrids"><span class="std std-ref">in-Python attributes</span></a>.</p>
</div>
<p>Sometimes, when one seeks to build a <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> between two tables
there is a need for more than just two or three tables to be involved in
order to join them.  This is an area of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> where one seeks
to push the boundaries of what’s possible, and often the ultimate solution to
many of these exotic use cases needs to be hammered out on the SQLAlchemy mailing
list.</p>
<p>In more recent versions of SQLAlchemy, the <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a>
parameter can be used in some of these cases in order to provide a composite
target consisting of multiple tables.   Below is an example of such a
join condition (requires version 0.9.2 at least to function as is):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;b.id&quot;</span><span class="p">))</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;D&quot;</span><span class="p">,</span>
        <span class="n">secondary</span><span class="o">=</span><span class="s2">&quot;join(B, D, B.d_id == D.id).join(C, C.d_id == D.id)&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;and_(A.b_id == B.id, A.id == C.a_id)&quot;</span><span class="p">,</span>
        <span class="n">secondaryjoin</span><span class="o">=</span><span class="s2">&quot;D.id == B.d_id&quot;</span><span class="p">,</span>
        <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">d_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;d.id&quot;</span><span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">C</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;c&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>
    <span class="n">d_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;d.id&quot;</span><span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">D</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>In the above example, we provide all three of <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a>,
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a>, and <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondaryjoin</span></code></a>,
in the declarative style referring to the named tables <code class="docutils literal notranslate"><span class="pre">a</span></code>, <code class="docutils literal notranslate"><span class="pre">b</span></code>, <code class="docutils literal notranslate"><span class="pre">c</span></code>, <code class="docutils literal notranslate"><span class="pre">d</span></code>
directly.  A query from <code class="docutils literal notranslate"><span class="pre">A</span></code> to <code class="docutils literal notranslate"><span class="pre">D</span></code> looks like:</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">d</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_b_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b_1</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">d_1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">b_1</span><span class="p">.</span><span class="n">d_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_1</span><span class="p">.</span><span class="n">id</span>
<span class="w">        </span><span class="k">JOIN</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">c_1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">c_1</span><span class="p">.</span><span class="n">d_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d_1</span><span class="p">.</span><span class="n">id</span><span class="p">)</span>
<span class="w">    </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">c_1</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b_1</span><span class="p">.</span><span class="n">d_id</span>
</div></pre></div>
</div>
<p>In the above example, we take advantage of being able to stuff multiple
tables into a “secondary” container, so that we can join across many
tables while still keeping things “simple” for <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>, in that
there’s just “one” table on both the “left” and the “right” side; the
complexity is kept within the middle.</p>
<div class="admonition warning">
<p class="admonition-title">警告</p>
<p>A relationship like the above is typically marked as <code class="docutils literal notranslate"><span class="pre">viewonly=True</span></code>, using <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.viewonly" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.viewonly</span></code></a>, and should be considered as read-only.  While there are sometimes ways to make relationships like the above writable, this is generally complicated and error prone.</p>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#relationship-viewonly-notes"><span class="std std-ref">使用 viewonly 关系参数的注意事项</span></a></p>
</div>
</div>
</div>
</section>
<section id="relationship-aliased-class">
<span id="relationship-non-primary-mapper"></span><span id="id13"></span><h2>与别名类的关系<a class="headerlink" href="#relationship-aliased-class" title="Link to this heading">¶</a></h2>
<p>Relationship to Aliased Class</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--10-input--1" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--1">中文</label><div class="tab-content docutils container">
<p>在上一节中，我们展示了一种技术，其中使用 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a> 将附加表放入连接条件中。有一种复杂的连接情况，即使这种技术也不足以解决；当我们希望从 <code class="docutils literal notranslate"><span class="pre">A</span></code> 连接到 <code class="docutils literal notranslate"><span class="pre">B</span></code> 时，使用任意数量的中间表 <code class="docutils literal notranslate"><span class="pre">C</span></code>、<code class="docutils literal notranslate"><span class="pre">D</span></code> 等，但在 <code class="docutils literal notranslate"><span class="pre">A</span></code> 和 <code class="docutils literal notranslate"><span class="pre">B</span></code> 之间也有直接的连接条件。在这种情况下，从 <code class="docutils literal notranslate"><span class="pre">A</span></code> 到 <code class="docutils literal notranslate"><span class="pre">B</span></code> 的连接可能很难仅通过复杂的 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> 条件来表达，因为中间表可能需要特殊处理，并且不能通过 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a> 对象来表达，因为 <code class="docutils literal notranslate"><span class="pre">A-&gt;secondary-&gt;B</span></code> 模式不支持在 <code class="docutils literal notranslate"><span class="pre">A</span></code> 和 <code class="docutils literal notranslate"><span class="pre">B</span></code> 之间的任何直接引用。当遇到这种 <strong>极其高级</strong> 情况时，我们可以求助于创建第二个映射作为关系的目标。这就是我们使用 <a class="reference internal" href="queryguide/api.html#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> 来映射一个包含我们需要的所有附加表的类。为了产生这个类的“替代”映射，我们使用 <a class="reference internal" href="queryguide/api.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> 函数生成新的构造，然后对该对象使用 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> ，就像它是一个普通的映射类一样。</p>
<p>下面展示了一个简单的从 <code class="docutils literal notranslate"><span class="pre">A</span></code> 到 <code class="docutils literal notranslate"><span class="pre">B</span></code> 的 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 连接，但是 primaryjoin 条件通过两个附加实体 <code class="docutils literal notranslate"><span class="pre">C</span></code> 和 <code class="docutils literal notranslate"><span class="pre">D</span></code> 得到了增强，这些实体的行也必须同时与 <code class="docutils literal notranslate"><span class="pre">A</span></code> 和 <code class="docutils literal notranslate"><span class="pre">B</span></code> 的行对齐:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;b.id&quot;</span><span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">C</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;c&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>

    <span class="n">some_c_value</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">D</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">c_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;c.id&quot;</span><span class="p">))</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;b.id&quot;</span><span class="p">))</span>

    <span class="n">some_d_value</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>


<span class="c1"># 1. 将 join() 设置为一个变量，以便我们可以在映射中多次引用它。</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">D</span><span class="o">.</span><span class="n">c_id</span><span class="p">)</span>

<span class="c1"># 2. 创建一个 AliasedClass 到 B</span>
<span class="n">B_viacd</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">A</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">B_viacd</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">j</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b_id</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>通过上述映射，一个简单的连接如下所示：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_b_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">c_id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span>
</div></pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--10-input--2" name="tab-set--10" type="radio"><label class="tab-label" for="tab-set--10-input--2">英文</label><div class="tab-content docutils container">
<p>In the previous section, we illustrated a technique where we used
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a> in order to place additional
tables within a join condition.   There is one complex join case where
even this technique is not sufficient; when we seek to join from <code class="docutils literal notranslate"><span class="pre">A</span></code>
to <code class="docutils literal notranslate"><span class="pre">B</span></code>, making use of any number of <code class="docutils literal notranslate"><span class="pre">C</span></code>, <code class="docutils literal notranslate"><span class="pre">D</span></code>, etc. in between,
however there are also join conditions between <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code>
<em>directly</em>.  In this case, the join from <code class="docutils literal notranslate"><span class="pre">A</span></code> to <code class="docutils literal notranslate"><span class="pre">B</span></code> may be
difficult to express with just a complex
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> condition, as the intermediary
tables may need special handling, and it is also not expressible with
a <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.secondary" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.secondary</span></code></a> object, since the
<code class="docutils literal notranslate"><span class="pre">A-&gt;secondary-&gt;B</span></code> pattern does not support any references between
<code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code> directly.  When this <strong>extremely advanced</strong> case
arises, we can resort to creating a second mapping as a target for the
relationship.  This is where we use <a class="reference internal" href="queryguide/api.html#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> in order to make a
mapping to a class that includes all the additional tables we need for
this join. In order to produce this mapper as an “alternative” mapping
for our class, we use the <a class="reference internal" href="queryguide/api.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> function to produce the new
construct, then use <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> against the object as though it
were a plain mapped class.</p>
<p>Below illustrates a <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> with a simple join from <code class="docutils literal notranslate"><span class="pre">A</span></code> to
<code class="docutils literal notranslate"><span class="pre">B</span></code>, however the primaryjoin condition is augmented with two additional
entities <code class="docutils literal notranslate"><span class="pre">C</span></code> and <code class="docutils literal notranslate"><span class="pre">D</span></code>, which also must have rows that line up with
the rows in both <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code> simultaneously:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;b.id&quot;</span><span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">C</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;c&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>

    <span class="n">some_c_value</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">D</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;d&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">c_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;c.id&quot;</span><span class="p">))</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;b.id&quot;</span><span class="p">))</span>

    <span class="n">some_d_value</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>


<span class="c1"># 1. set up the join() as a variable, so we can refer</span>
<span class="c1"># to it in the mapping multiple times.</span>
<span class="n">j</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">D</span><span class="o">.</span><span class="n">c_id</span><span class="p">)</span>

<span class="c1"># 2. Create an AliasedClass to B</span>
<span class="n">B_viacd</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">A</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">B_viacd</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">j</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b_id</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>With the above mapping, a simple join looks like:</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_b_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="n">b</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">c_id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span>
</div></pre></div>
</div>
</div>
</div>
<section id="aliasedclass">
<h3>将 AliasedClass 映射与类型集成并避免早期映射器配置<a class="headerlink" href="#aliasedclass" title="Link to this heading">¶</a></h3>
<p>Integrating AliasedClass Mappings with Typing and Avoiding Early Mapper Configuration</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--11-input--1" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--1">中文</label><div class="tab-content docutils container">
<p>创建 <a class="reference internal" href="queryguide/api.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> 构造针对映射类会强制 <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.configure_mappers" title="sqlalchemy.orm.configure_mappers"><code class="xref py py-func docutils literal notranslate"><span class="pre">configure_mappers()</span></code></a> 步骤进行，这将解析所有当前类及其关系。如果当前映射所需的无关映射类尚未声明，或者关系本身的配置需要访问尚未声明的类，这可能会有问题。此外，SQLAlchemy 的声明模式在关系声明在前时与 Python 类型最有效地协作。</p>
<p>要组织关系的构造以解决这些问题，可以使用配置级事件钩子，如 <a class="reference internal" href="events.html#sqlalchemy.orm.MapperEvents.before_mapper_configured" title="sqlalchemy.orm.MapperEvents.before_mapper_configured"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MapperEvents.before_mapper_configured()</span></code></a>，它将在所有映射准备好配置时调用配置代码:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">event</span>


<span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;b.id&quot;</span><span class="p">))</span>


<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="s2">&quot;before_mapper_configured&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_configure_ab_relationship</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
    <span class="c1"># 在配置钩子中进行上述配置</span>

    <span class="n">j</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">D</span><span class="o">.</span><span class="n">c_id</span><span class="p">)</span>
    <span class="n">B_viacd</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">A</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">B_viacd</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">j</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b_id</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>如上所述，函数 <code class="docutils literal notranslate"><span class="pre">_configure_ab_relationship()</span></code> 仅在请求完全配置的 <code class="docutils literal notranslate"><span class="pre">A</span></code> 版本时调用，此时类 <code class="docutils literal notranslate"><span class="pre">B</span></code>、<code class="docutils literal notranslate"><span class="pre">D</span></code> 和 <code class="docutils literal notranslate"><span class="pre">C</span></code> 将可用。</p>
<p>对于与内联类型集成的方法，可以使用类似的技术有效地生成用于别名类的“单例”创建模式，其中它作为全局变量进行延迟初始化，然后可以在关系内联中使用:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="n">B_viacd</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">b_viacd_join</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;b.id&quot;</span><span class="p">))</span>

    <span class="c1"># 1. 使用 lambdas 声明关系，允许其解析为延迟配置的目标</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">B_viacd</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">A</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">b_viacd_join</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b_id</span>
    <span class="p">)</span>


<span class="c1"># 2. 使用 before_mapper_configured 钩子配置关系的目标。</span>
<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="s2">&quot;before_mapper_configured&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_configure_ab_relationship</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
    <span class="c1"># 3. 在配置钩子中将 join() 和 AliasedClass 设置为全局变量。</span>

    <span class="k">global</span> <span class="n">B_viacd</span><span class="p">,</span> <span class="n">b_viacd_join</span>

    <span class="n">b_viacd_join</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">D</span><span class="o">.</span><span class="n">c_id</span><span class="p">)</span>
    <span class="n">B_viacd</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">b_viacd_join</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
</div>
<input class="tab-input" id="tab-set--11-input--2" name="tab-set--11" type="radio"><label class="tab-label" for="tab-set--11-input--2">英文</label><div class="tab-content docutils container">
<p>The creation of the <a class="reference internal" href="queryguide/api.html#sqlalchemy.orm.aliased" title="sqlalchemy.orm.aliased"><code class="xref py py-func docutils literal notranslate"><span class="pre">aliased()</span></code></a> construct against a mapped class
forces the <a class="reference internal" href="mapping_api.html#sqlalchemy.orm.configure_mappers" title="sqlalchemy.orm.configure_mappers"><code class="xref py py-func docutils literal notranslate"><span class="pre">configure_mappers()</span></code></a> step to proceed, which will resolve
all current classes and their relationships.  This may be problematic if
unrelated mapped classes needed by the current mappings have not yet been
declared, or if the configuration of the relationship itself needs access
to as-yet undeclared classes.  Additionally, SQLAlchemy’s Declarative pattern
works with Python typing most effectively when relationships are declared
up front.</p>
<p>To organize the construction of the relationship to work with these issues, a
configure level event hook like <a class="reference internal" href="events.html#sqlalchemy.orm.MapperEvents.before_mapper_configured" title="sqlalchemy.orm.MapperEvents.before_mapper_configured"><code class="xref py py-meth docutils literal notranslate"><span class="pre">MapperEvents.before_mapper_configured()</span></code></a>
may be used, which will invoke the configuration code only when all mappings
are ready for configuration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">event</span>


<span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;b.id&quot;</span><span class="p">))</span>


<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="s2">&quot;before_mapper_configured&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_configure_ab_relationship</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
    <span class="c1"># do the above configuration in a configuration hook</span>

    <span class="n">j</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">D</span><span class="o">.</span><span class="n">c_id</span><span class="p">)</span>
    <span class="n">B_viacd</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">A</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">B_viacd</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">j</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b_id</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, the function <code class="docutils literal notranslate"><span class="pre">_configure_ab_relationship()</span></code> will be invoked only
when a fully configured version of <code class="docutils literal notranslate"><span class="pre">A</span></code> is requested, at which point the
classes <code class="docutils literal notranslate"><span class="pre">B</span></code>, <code class="docutils literal notranslate"><span class="pre">D</span></code> and <code class="docutils literal notranslate"><span class="pre">C</span></code> would be available.</p>
<p>For an approach that integrates with inline typing, a similar technique can be
used to effectively generate a “singleton” creation pattern for the aliased
class where it is late-initialized as a global variable, which can then be used
in the relationship inline:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">typing</span><span class="w"> </span><span class="kn">import</span> <span class="n">Any</span>

<span class="n">B_viacd</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">b_viacd_join</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;b.id&quot;</span><span class="p">))</span>

    <span class="c1"># 1. the relationship can be declared using lambdas, allowing it to resolve</span>
    <span class="c1">#    to targets that are late-configured</span>
    <span class="n">b</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="k">lambda</span><span class="p">:</span> <span class="n">B_viacd</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">A</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">b_viacd_join</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b_id</span>
    <span class="p">)</span>


<span class="c1"># 2. configure the targets of the relationship using a before_mapper_configured</span>
<span class="c1">#    hook.</span>
<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="s2">&quot;before_mapper_configured&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_configure_ab_relationship</span><span class="p">(</span><span class="n">mapper</span><span class="p">,</span> <span class="bp">cls</span><span class="p">):</span>
    <span class="c1"># 3. set up the join() and AliasedClass as globals from within</span>
    <span class="c1">#    the configuration hook.</span>

    <span class="k">global</span> <span class="n">B_viacd</span><span class="p">,</span> <span class="n">b_viacd_join</span>

    <span class="n">b_viacd_join</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">D</span><span class="o">.</span><span class="n">c_id</span><span class="p">)</span>
    <span class="n">B_viacd</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">b_viacd_join</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
</div>
</div>
</section>
<section id="id14">
<h3>在查询中使用 AliasedClass 目标<a class="headerlink" href="#id14" title="Link to this heading">¶</a></h3>
<p>Using the AliasedClass target in Queries</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--12-input--1" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--1">中文</label><div class="tab-content docutils container">
<p>在前面的示例中， <code class="docutils literal notranslate"><span class="pre">A.b</span></code> 关系引用 <code class="docutils literal notranslate"><span class="pre">B_viacd</span></code> 实体作为目标，而 <strong>不是</strong> 直接引用 <code class="docutils literal notranslate"><span class="pre">B</span></code> 类。要添加涉及 <code class="docutils literal notranslate"><span class="pre">A.b</span></code> 关系的附加条件，通常需要直接引用 <code class="docutils literal notranslate"><span class="pre">B_viacd</span></code>，而不是使用 <code class="docutils literal notranslate"><span class="pre">B</span></code>，特别是在 <code class="docutils literal notranslate"><span class="pre">A.b</span></code> 的目标实体要转换为别名或子查询的情况下。下面展示了使用子查询而不是连接的相同关系:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subq</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">D</span><span class="o">.</span><span class="n">c_id</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>

<span class="n">B_viacd_subquery</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">subq</span><span class="p">)</span>

<span class="n">A</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">B_viacd_subquery</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">subq</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></pre></div>
</div>
<p>使用上述 <code class="docutils literal notranslate"><span class="pre">A.b</span></code> 关系的查询将呈现一个子查询：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_b_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">some_b_column</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">some_b_column</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">c_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">id</span>
</div></pre></div>
</div>
<p>如果我们想添加基于 <code class="docutils literal notranslate"><span class="pre">A.b</span></code> 连接的附加条件，必须以 <code class="docutils literal notranslate"><span class="pre">B_viacd_subquery</span></code> 而不是直接 <code class="docutils literal notranslate"><span class="pre">B</span></code> 的形式进行：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">B_viacd_subquery</span><span class="o">.</span><span class="n">some_b_column</span> <span class="o">==</span> <span class="s2">&quot;some b&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">B_viacd_subquery</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_b_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">some_b_column</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">some_b_column</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">c_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">some_b_column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">id</span>
</div></pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--12-input--2" name="tab-set--12" type="radio"><label class="tab-label" for="tab-set--12-input--2">英文</label><div class="tab-content docutils container">
<p>In the previous example, the <code class="docutils literal notranslate"><span class="pre">A.b</span></code> relationship refers to the <code class="docutils literal notranslate"><span class="pre">B_viacd</span></code>
entity as the target, and <strong>not</strong> the <code class="docutils literal notranslate"><span class="pre">B</span></code> class directly. To add additional
criteria involving the <code class="docutils literal notranslate"><span class="pre">A.b</span></code> relationship, it’s typically necessary to
reference the <code class="docutils literal notranslate"><span class="pre">B_viacd</span></code> directly rather than using <code class="docutils literal notranslate"><span class="pre">B</span></code>, especially in a
case where the target entity of <code class="docutils literal notranslate"><span class="pre">A.b</span></code> is to be transformed into an alias or a
subquery. Below illustrates the same relationship using a subquery, rather than
a join:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subq</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">B</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">D</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">D</span><span class="o">.</span><span class="n">c_id</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span>

<span class="n">B_viacd_subquery</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">subq</span><span class="p">)</span>

<span class="n">A</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">B_viacd_subquery</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">subq</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></pre></div>
</div>
<p>A query using the above <code class="docutils literal notranslate"><span class="pre">A.b</span></code> relationship will render a subquery:</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_b_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">some_b_column</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">some_b_column</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">c_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">id</span>
</div></pre></div>
</div>
<p>If we want to add additional criteria based on the <code class="docutils literal notranslate"><span class="pre">A.b</span></code> join, we must do
so in terms of <code class="docutils literal notranslate"><span class="pre">B_viacd_subquery</span></code> rather than <code class="docutils literal notranslate"><span class="pre">B</span></code> directly:</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span>
    <span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
    <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">b</span><span class="p">)</span>
    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">B_viacd_subquery</span><span class="o">.</span><span class="n">some_b_column</span> <span class="o">==</span> <span class="s2">&quot;some b&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">B_viacd_subquery</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_b_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">some_b_column</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">some_b_column</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="k">c</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">d</span><span class="p">.</span><span class="n">c_id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">some_b_column</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">id</span>
</div></pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="relationship-to-window-function">
<span id="id15"></span><h2>使用窗口函数的行限制关系<a class="headerlink" href="#relationship-to-window-function" title="Link to this heading">¶</a></h2>
<p>Row-Limited Relationships with Window Functions</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--13-input--1" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--1">中文</label><div class="tab-content docutils container">
<p>另一个有趣的用例是将关系应用到 <a class="reference internal" href="queryguide/api.html#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> 对象的情况，其中关系需要连接到任何形式的特殊 SELECT。一个场景是需要使用窗口函数，例如限制关系应该返回多少行。下面的示例展示了一个非主映射器关系，它将为每个集合加载前十个项目:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>


<span class="n">partition</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
    <span class="n">B</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">partition_by</span><span class="o">=</span><span class="n">B</span><span class="o">.</span><span class="n">a_id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>

<span class="n">partitioned_b</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">partition</span><span class="p">)</span>

<span class="n">A</span><span class="o">.</span><span class="n">partitioned_bs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
    <span class="n">partitioned_b</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="n">and_</span><span class="p">(</span><span class="n">partitioned_b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">==</span> <span class="n">A</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">partition</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>我们可以在大多数加载器策略中使用上述 <code class="docutils literal notranslate"><span class="pre">partitioned_bs</span></code> 关系，例如 <a class="reference internal" href="queryguide/relationships.html#sqlalchemy.orm.selectinload" title="sqlalchemy.orm.selectinload"><code class="xref py py-func docutils literal notranslate"><span class="pre">selectinload()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">a1</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">selectinload</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">partitioned_bs</span><span class="p">))):</span>
    <span class="n">print</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">partitioned_bs</span><span class="p">)</span>  <span class="c1"># &lt;-- 最多不超过十个对象</span></pre></div>
</div>
<p>上述“selectinload”查询如下所示：</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
<span class="w">    </span><span class="n">a_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_1_id</span><span class="p">,</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1_id</span><span class="p">,</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1_a_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">anon_1</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1_data</span><span class="p">,</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="k">index</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1_index</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_1</span>
<span class="k">JOIN</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">data</span><span class="p">,</span>
<span class="w">    </span><span class="n">row_number</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">index</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1</span>
<span class="k">ON</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="k">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="n">index_1</span><span class="p">)</span><span class="n">s</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">a_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="n">collection</span><span class="w"> </span><span class="p">...)</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a_1</span><span class="p">.</span><span class="n">id</span></pre></div>
</div>
<p>如上所述，对于“a”中的每个匹配主键，我们将按“b.id”顺序获取前十个“bs”。通过在“a_id”上分区，我们确保每个“行号”都是特定于父“a_id”的。</p>
<p>这样的映射通常还包括从“A”到“B”的“普通”关系，用于持久化操作以及需要每个“A”的完整“B”对象集时。</p>
</div>
<input class="tab-input" id="tab-set--13-input--2" name="tab-set--13" type="radio"><label class="tab-label" for="tab-set--13-input--2">英文</label><div class="tab-content docutils container">
<p>Another interesting use case for relationships to <a class="reference internal" href="queryguide/api.html#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a>
objects are situations where
the relationship needs to join to a specialized SELECT of any form.   One
scenario is when the use of a window function is desired, such as to limit
how many rows should be returned for a relationship.  The example below
illustrates a non-primary mapper relationship that will load the first
ten items for each collection:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>


<span class="n">partition</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span>
    <span class="n">B</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">order_by</span><span class="o">=</span><span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">partition_by</span><span class="o">=</span><span class="n">B</span><span class="o">.</span><span class="n">a_id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;index&quot;</span><span class="p">)</span>
<span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">()</span>

<span class="n">partitioned_b</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">partition</span><span class="p">)</span>

<span class="n">A</span><span class="o">.</span><span class="n">partitioned_bs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
    <span class="n">partitioned_b</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="n">and_</span><span class="p">(</span><span class="n">partitioned_b</span><span class="o">.</span><span class="n">a_id</span> <span class="o">==</span> <span class="n">A</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">partition</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">index</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
<span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>We can use the above <code class="docutils literal notranslate"><span class="pre">partitioned_bs</span></code> relationship with most of the loader
strategies, such as <a class="reference internal" href="queryguide/relationships.html#sqlalchemy.orm.selectinload" title="sqlalchemy.orm.selectinload"><code class="xref py py-func docutils literal notranslate"><span class="pre">selectinload()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">a1</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">scalars</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">selectinload</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">partitioned_bs</span><span class="p">))):</span>
    <span class="n">print</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">partitioned_bs</span><span class="p">)</span>  <span class="c1"># &lt;-- will be no more than ten objects</span></pre></div>
</div>
<p>Where above, the “selectinload” query looks like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
<span class="w">    </span><span class="n">a_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_1_id</span><span class="p">,</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1_id</span><span class="p">,</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1_a_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">anon_1</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1_data</span><span class="p">,</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="k">index</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1_index</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_1</span>
<span class="k">JOIN</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">data</span><span class="p">,</span>
<span class="w">    </span><span class="n">row_number</span><span class="p">()</span><span class="w"> </span><span class="n">OVER</span><span class="w"> </span><span class="p">(</span><span class="n">PARTITION</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="k">index</span>
<span class="w">    </span><span class="k">FROM</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1</span>
<span class="k">ON</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">a_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="k">index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="n">index_1</span><span class="p">)</span><span class="n">s</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">a_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="k">primary</span><span class="w"> </span><span class="k">key</span><span class="w"> </span><span class="n">collection</span><span class="w"> </span><span class="p">...)</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a_1</span><span class="p">.</span><span class="n">id</span></pre></div>
</div>
<p>Above, for each matching primary key in “a”, we will get the first ten
“bs” as ordered by “b.id”.   By partitioning on “a_id” we ensure that each
“row number” is local to the parent “a_id”.</p>
<p>Such a mapping would ordinarily also include a “plain” relationship
from “A” to “B”, for persistence operations as well as when the full
set of “B” objects per “A” is desired.</p>
</div>
</div>
</section>
<section id="query-enabled-properties">
<span id="id16"></span><h2>构建启用查询的属性<a class="headerlink" href="#query-enabled-properties" title="Link to this heading">¶</a></h2>
<p>Building Query-Enabled Properties</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--14-input--1" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--1">中文</label><div class="tab-content docutils container">
<p>非常复杂的自定义连接条件可能无法直接持久化，在某些情况下甚至可能无法正确加载。要移除持久化部分，可以在 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 上使用 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.viewonly" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.viewonly</span></code></a> 标志，将其设为只读属性（写入集合的数据将在刷新时被忽略）。但是，在极端情况下，可以考虑将常规 Python 属性与 <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> 结合使用，如下所示：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">addresses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">with_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>在其他情况下，描述符可以构建为利用现有的 Python 数据。有关特殊 Python 属性的更多讨论，请参见 <a class="reference internal" href="mapped_attributes.html#mapper-hybrids"><span class="std std-ref">使用描述符和混合</span></a> 部分。</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="mapped_attributes.html#mapper-hybrids"><span class="std std-ref">使用描述符和混合</span></a></p>
</div>
</div>
<input class="tab-input" id="tab-set--14-input--2" name="tab-set--14" type="radio"><label class="tab-label" for="tab-set--14-input--2">英文</label><div class="tab-content docutils container">
<p>Very ambitious custom join conditions may fail to be directly persistable, and
in some cases may not even load correctly. To remove the persistence part of
the equation, use the flag <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.viewonly" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.viewonly</span></code></a> on the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>, which establishes it as a read-only
attribute (data written to the collection will be ignored on flush()).
However, in extreme cases, consider using a regular Python property in
conjunction with <a class="reference internal" href="queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">addresses</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">object_session</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">with_parent</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">...</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>In other cases, the descriptor can be built to make use of existing in-Python
data.  See the section on <a class="reference internal" href="mapped_attributes.html#mapper-hybrids"><span class="std std-ref">使用描述符和混合</span></a> for more general discussion
of special Python attributes.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="mapped_attributes.html#mapper-hybrids"><span class="std std-ref">使用描述符和混合</span></a></p>
</div>
</div>
</div>
</section>
<section id="viewonly">
<span id="relationship-viewonly-notes"></span><h2>使用 viewonly 关系参数的注意事项<a class="headerlink" href="#viewonly" title="Link to this heading">¶</a></h2>
<p>Notes on using the viewonly relationship parameter</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--15-input--1" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--1">中文</label><div class="tab-content docutils container">
<p><a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.viewonly" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.viewonly</span></code></a> 参数应用于 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 构造时，表示该 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> 不会参与任何 ORM <a class="reference internal" href="../glossary.html#term-unit-of-work"><span class="xref std std-term">unit of work</span></a> 操作，此外，该属性不期望参与其表示的集合的 Python 内部变异。这意味着虽然 viewonly 关系可能引用可变的 Python 集合（如列表或集合），但在映射实例上对该列表或集合进行更改对 ORM 刷新过程 <strong>没有影响</strong>。</p>
<p>要探索此场景，请考虑以下映射:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">and_</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">relationship</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">all_tasks</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">()</span>

    <span class="n">current_week_tasks</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">and_</span><span class="p">(</span>
            <span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">Task</span><span class="o">.</span><span class="n">user_account_id</span><span class="p">,</span>
            <span class="c1"># 该表达式适用于 PostgreSQL，但可能不支持其他数据库引擎</span>
            <span class="n">Task</span><span class="o">.</span><span class="n">task_date</span> <span class="o">&gt;=</span> <span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;task&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">user_account_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user_account.id&quot;</span><span class="p">))</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">task_date</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="n">user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">User</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;current_week_tasks&quot;</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>以下部分将指出此配置的不同方面。</p>
</div>
<input class="tab-input" id="tab-set--15-input--2" name="tab-set--15" type="radio"><label class="tab-label" for="tab-set--15-input--2">英文</label><div class="tab-content docutils container">
<p>The <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.viewonly" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.viewonly</span></code></a> parameter when applied to a
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> construct indicates that this <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>
will not take part in any ORM <a class="reference internal" href="../glossary.html#term-unit-of-work"><span class="xref std std-term">unit of work</span></a> operations, and additionally
that the attribute does not expect to participate within in-Python mutations
of its represented collection.  This means
that while the viewonly relationship may refer to a mutable Python collection
like a list or set, making changes to that list or set as present on a
mapped instance will have <strong>no effect</strong> on the ORM flush process.</p>
<p>To explore this scenario consider this mapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">__future__</span><span class="w"> </span><span class="kn">import</span> <span class="n">annotations</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">datetime</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">and_</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">func</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeclarativeBase</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">Mapped</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">mapped_column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">relationship</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Base</span><span class="p">(</span><span class="n">DeclarativeBase</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">all_tasks</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">()</span>

    <span class="n">current_week_tasks</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="k">lambda</span><span class="p">:</span> <span class="n">and_</span><span class="p">(</span>
            <span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">Task</span><span class="o">.</span><span class="n">user_account_id</span><span class="p">,</span>
            <span class="c1"># this expression works on PostgreSQL but may not be supported</span>
            <span class="c1"># by other database engines</span>
            <span class="n">Task</span><span class="o">.</span><span class="n">task_date</span> <span class="o">&gt;=</span> <span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">),</span>
        <span class="p">),</span>
        <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;task&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">user_account_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user_account.id&quot;</span><span class="p">))</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">task_date</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="n">user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">User</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;current_week_tasks&quot;</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>The following sections will note different aspects of this configuration.</p>
</div>
</div>
<section id="python-backref-viewonly-true">
<h3>在 Python 中，包括 backref 的突变不适用于 viewonly=True<a class="headerlink" href="#python-backref-viewonly-true" title="Link to this heading">¶</a></h3>
<p>In-Python mutations including backrefs are not appropriate with viewonly=True</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--16-input--1" name="tab-set--16" type="radio"><label class="tab-label" for="tab-set--16-input--1">中文</label><div class="tab-content docutils container">
<p>上面的映射将 <code class="docutils literal notranslate"><span class="pre">User.current_week_tasks</span></code> 视为 <code class="docutils literal notranslate"><span class="pre">Task.user</span></code> 属性的 <a class="reference internal" href="../glossary.html#term-backref"><span class="xref std std-term">backref</span></a> 目标。SQLAlchemy 的 ORM 配置过程目前不会对此进行标记，但这实际上是一个配置错误。更改 <code class="docutils literal notranslate"><span class="pre">Task</span></code> 上的 <code class="docutils literal notranslate"><span class="pre">.user</span></code> 属性不会影响 <code class="docutils literal notranslate"><span class="pre">.current_week_tasks</span></code> 属性:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">u1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span>
<span class="go">[]</span></pre></div>
</div>
<p>这里有另一个名为 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.sync_backrefs" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.sync_backrefs</span></code></a> 的参数，可以打开它以允许在这种情况下更改 <code class="docutils literal notranslate"><span class="pre">.current_week_tasks</span></code>，但这不被认为是 viewonly 关系的最佳实践，viewonly 关系不应该依赖于 Python 内部变异。</p>
<p>在此映射中，可以在 <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code> 和 <code class="docutils literal notranslate"><span class="pre">Task.user</span></code> 之间配置 backrefs，因为它们都不是 viewonly 并且将正常同步。</p>
<p>除了 viewonly 关系禁用 backref 变异的问题外，Python 中对 <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code> 集合的简单更改在将更改刷新到数据库之前，也不会反映在 <code class="docutils literal notranslate"><span class="pre">User.current_week_tasks</span></code> 集合中。</p>
<p>总体而言，对于需要自定义集合立即响应 Python 内部变异的用例，viewonly 关系通常不合适。更好的方法是使用 SQLAlchemy 的 <a class="reference internal" href="extensions/hybrid.html#hybrids-toplevel"><span class="std std-ref">混合属性</span></a> 功能，或对于仅实例的情况使用 Python <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code>，其中可以实现基于当前 Python 实例生成的用户定义集合。要更改我们的示例以这种方式工作，我们修复 <code class="docutils literal notranslate"><span class="pre">Task.user</span></code> 上的 <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.back_populates" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.back_populates</span></code></a> 参数以引用 <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code>，然后展示一个简单的 <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code>，该属性将根据即时的 <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code> 集合提供结果:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">all_tasks</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_week_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]:</span>
        <span class="n">past_seven_days</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_tasks</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">task_date</span> <span class="o">&gt;=</span> <span class="n">past_seven_days</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;task&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">user_account_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user_account.id&quot;</span><span class="p">))</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">task_date</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="n">user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">User</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;all_tasks&quot;</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>使用每次动态计算的 Python 集合，我们可以保证始终获得正确的答案，而无需使用数据库:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">u1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span>
<span class="go">[&lt;__main__.Task object at 0x7f3d699523c0&gt;]</span></pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--16-input--2" name="tab-set--16" type="radio"><label class="tab-label" for="tab-set--16-input--2">英文</label><div class="tab-content docutils container">
<p>The above mapping targets the <code class="docutils literal notranslate"><span class="pre">User.current_week_tasks</span></code> viewonly relationship
as the <a class="reference internal" href="../glossary.html#term-backref"><span class="xref std std-term">backref</span></a> target of the <code class="docutils literal notranslate"><span class="pre">Task.user</span></code> attribute.  This is not
currently flagged by SQLAlchemy’s ORM configuration process, however is a
configuration error.   Changing the <code class="docutils literal notranslate"><span class="pre">.user</span></code> attribute on a <code class="docutils literal notranslate"><span class="pre">Task</span></code> will not
affect the <code class="docutils literal notranslate"><span class="pre">.current_week_tasks</span></code> attribute:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">u1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span>
<span class="go">[]</span></pre></div>
</div>
<p>There is another parameter called <a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.sync_backrefs" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.sync_backrefs</span></code></a>
which can be turned on here to allow <code class="docutils literal notranslate"><span class="pre">.current_week_tasks</span></code> to be mutated in this
case, however this is not considered to be a best practice with a viewonly
relationship, which instead should not be relied upon for in-Python mutations.</p>
<p>In this mapping, backrefs can be configured between <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code> and
<code class="docutils literal notranslate"><span class="pre">Task.user</span></code>, as these are both not viewonly and will synchronize normally.</p>
<p>Beyond the issue of backref mutations being disabled for viewonly relationships,
plain changes to the <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code> collection in Python
are also not reflected in the <code class="docutils literal notranslate"><span class="pre">User.current_week_tasks</span></code> collection until
changes have been flushed to the database.</p>
<p>Overall, for a use case where a custom collection should respond immediately to
in-Python mutations, the viewonly relationship is generally not appropriate.  A
better approach is to use the <a class="reference internal" href="extensions/hybrid.html#hybrids-toplevel"><span class="std std-ref">混合属性</span></a> feature of SQLAlchemy, or
for instance-only cases to use a Python <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code>, where a user-defined
collection that is generated in terms of the current Python instance can be
implemented.  To change our example to work this way, we repair the
<a class="reference internal" href="relationship_api.html#sqlalchemy.orm.relationship.params.back_populates" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.back_populates</span></code></a> parameter on <code class="docutils literal notranslate"><span class="pre">Task.user</span></code> to
reference <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code>, and
then illustrate a simple <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> that will deliver results in terms of
the immediate <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code> collection:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_account&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>

    <span class="n">all_tasks</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">current_week_tasks</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">list</span><span class="p">[</span><span class="n">Task</span><span class="p">]:</span>
        <span class="n">past_seven_days</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">datetime</span><span class="o">.</span><span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=</span><span class="mi">7</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_tasks</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">task_date</span> <span class="o">&gt;=</span> <span class="n">past_seven_days</span><span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Task</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;task&quot;</span>

    <span class="n">id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">user_account_id</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user_account.id&quot;</span><span class="p">))</span>
    <span class="n">description</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">str</span> <span class="o">|</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">task_date</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapped_column</span><span class="p">(</span><span class="n">server_default</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>

    <span class="n">user</span><span class="p">:</span> <span class="n">Mapped</span><span class="p">[</span><span class="n">User</span><span class="p">]</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;all_tasks&quot;</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>Using an in-Python collection calculated on the fly each time, we are guaranteed
to have the correct answer at all times, without the need to use a database
at all:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">u1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span>
<span class="go">[&lt;__main__.Task object at 0x7f3d699523c0&gt;]</span></pre></div>
</div>
</div>
</div>
</section>
<section id="viewonly-true">
<h3>viewonly=True 集合/属性在过期之前不会被重新查询<a class="headerlink" href="#viewonly-true" title="Link to this heading">¶</a></h3>
<p>viewonly=True collections / attributes do not get re-queried until expired</p>
<div class="tab-set docutils container">
<input checked="True" class="tab-input" id="tab-set--17-input--1" name="tab-set--17" type="radio"><label class="tab-label" for="tab-set--17-input--1">中文</label><div class="tab-content docutils container">
<p>继续使用原始的 viewonly 属性，如果我们确实对 <a class="reference internal" href="../glossary.html#term-persistent"><span class="xref std std-term">persistent</span></a> 对象上的 <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code> 集合进行更改，那么 viewonly 集合只能在发生 <strong>两</strong> 件事后显示此更改的净结果。首先是对 <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code> 的更改被 <a class="reference internal" href="../glossary.html#term-flushed"><span class="xref std std-term">flushed</span></a>，以便新数据至少在本地事务范围内在数据库中可用。其次是 <code class="docutils literal notranslate"><span class="pre">User.current_week_tasks</span></code> 属性被 <a class="reference internal" href="../glossary.html#term-expired"><span class="xref std std-term">expired</span></a> 并通过新的 SQL 查询重新加载到数据库中。</p>
<p>为了支持此要求，最简单的流程是仅在主要是只读的操作中使用 viewonly 关系。例如，如果我们从数据库中重新检索一个 <code class="docutils literal notranslate"><span class="pre">User</span></code>，集合将是最新的：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span><span class="p">)</span>
<span class="go">[&lt;__main__.Task object at 0x7f8711b906b0&gt;]</span></pre></div>
</div>
<p>当我们对 <code class="docutils literal notranslate"><span class="pre">u1.all_tasks</span></code> 进行修改时，如果我们希望这些更改反映在 <code class="docutils literal notranslate"><span class="pre">u1.current_week_tasks</span></code> viewonly 关系中，这些更改需要被刷新，并且 <code class="docutils literal notranslate"><span class="pre">u1.current_week_tasks</span></code> 属性需要被过期，以便在下一次访问时 <a class="reference internal" href="../glossary.html#term-lazy-load"><span class="xref std std-term">lazy load</span></a>。最简单的方法是使用 <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.commit" title="sqlalchemy.orm.Session.commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code></a>，保持 <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.params.expire_on_commit" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.expire_on_commit</span></code></a> 参数设置为默认值 <code class="docutils literal notranslate"><span class="pre">True</span></code>：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">u1</span><span class="o">.</span><span class="n">all_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
<span class="gp">... </span>    <span class="n">sess</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span><span class="p">)</span>
<span class="go">[&lt;__main__.Task object at 0x7f8711b90ec0&gt;, &lt;__main__.Task object at 0x7f8711b90a10&gt;]</span></pre></div>
</div>
<p>如上所述，调用 <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.commit" title="sqlalchemy.orm.Session.commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code></a> 将 <code class="docutils literal notranslate"><span class="pre">u1.all_tasks</span></code> 的更改刷新到数据库，然后使所有对象过期，因此当我们访问 <code class="docutils literal notranslate"><span class="pre">u1.current_week_tasks</span></code> 时，发生了 <a class="reference internal" href="../glossary.html#term-lazy-load"><span class="xref std std-term">lazy load</span></a>，从数据库中重新获取此属性的内容。</p>
<p>要拦截操作而不实际提交事务，需要先显式使属性 <a class="reference internal" href="../glossary.html#term-expired"><span class="xref std std-term">expired</span></a> 。一种简单的方法是直接调用它。在下面的示例中，<a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.flush" title="sqlalchemy.orm.Session.flush"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.flush()</span></code></a> 将待处理的更改发送到数据库，然后使用 <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.expire" title="sqlalchemy.orm.Session.expire"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.expire()</span></code></a> 使 <code class="docutils literal notranslate"><span class="pre">u1.current_week_tasks</span></code> 集合过期，以便在下一次访问时重新获取：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">u1</span><span class="o">.</span><span class="n">all_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
<span class="gp">... </span>    <span class="n">sess</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">sess</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;current_week_tasks&quot;</span><span class="p">])</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span><span class="p">)</span>
<span class="go">[&lt;__main__.Task object at 0x7fd95a4c8c50&gt;, &lt;__main__.Task object at 0x7fd95a4c8c80&gt;]</span></pre></div>
</div>
<p>我们实际上可以跳过调用 <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.flush" title="sqlalchemy.orm.Session.flush"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.flush()</span></code></a>，假设 <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> 保持 <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.params.autoflush" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.autoflush</span></code></a> 为默认值 <code class="docutils literal notranslate"><span class="pre">True</span></code>，因为过期的 <code class="docutils literal notranslate"><span class="pre">current_week_tasks</span></code> 属性将在过期后访问时触发自动刷新：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">u1</span><span class="o">.</span><span class="n">all_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
<span class="gp">... </span>    <span class="n">sess</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;current_week_tasks&quot;</span><span class="p">])</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span><span class="p">)</span>  <span class="c1"># 触发查询前的自动刷新</span>
<span class="go">[&lt;__main__.Task object at 0x7fd95a4c8c50&gt;, &lt;__main__.Task object at 0x7fd95a4c8c80&gt;]</span></pre></div>
</div>
<p>继续上述方法更复杂一点，我们可以在相关的 <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code> 集合更改时使用 <a class="reference internal" href="../core/event.html#event-toplevel"><span class="std std-ref">event hooks</span></a> 程序化地应用过期。这是一种 <strong>高级技术</strong>，首先应该考虑更简单的架构，如 <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> 或坚持只读用例。在我们的简单示例中，这将配置为：</p>
<blockquote>
<div><p>from sqlalchemy import event, inspect</p>
<p>&#64;event.listens_for(User.all_tasks, “append”)
&#64;event.listens_for(User.all_tasks, “remove”)
&#64;event.listens_for(User.all_tasks, “bulk_replace”)
def _expire_User_current_week_tasks(target, value, initiator):</p>
<blockquote>
<div><p>inspect(target).session.expire(target, [“current_week_tasks”])</p>
</div></blockquote>
</div></blockquote>
<p>通过上述钩子，变异操作会被拦截，并导致 <code class="docutils literal notranslate"><span class="pre">User.current_week_tasks</span></code> 集合自动过期：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">u1</span><span class="o">.</span><span class="n">all_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span><span class="p">)</span>
<span class="go">[&lt;__main__.Task object at 0x7f66d093ccb0&gt;, &lt;__main__.Task object at 0x7f66d093cce0&gt;]</span></pre></div>
</div>
<p>上述 <a class="reference internal" href="events.html#sqlalchemy.orm.AttributeEvents" title="sqlalchemy.orm.AttributeEvents"><code class="xref py py-class docutils literal notranslate"><span class="pre">AttributeEvents</span></code></a> 事件钩子也会被 backref 变异触发，因此通过上述钩子对 <code class="docutils literal notranslate"><span class="pre">Task.user</span></code> 的更改也会被拦截：</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">t1</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<span class="gp">... </span>    <span class="n">t1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">u1</span>
<span class="gp">... </span>    <span class="n">sess</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span><span class="p">)</span>
<span class="go">[&lt;__main__.Task object at 0x7f3b0c070d10&gt;, &lt;__main__.Task object at 0x7f3b0c057d10&gt;]</span></pre></div>
</div>
</div>
<input class="tab-input" id="tab-set--17-input--2" name="tab-set--17" type="radio"><label class="tab-label" for="tab-set--17-input--2">英文</label><div class="tab-content docutils container">
<p>Continuing with the original viewonly attribute, if we do in fact make changes
to the <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code> collection on a <a class="reference internal" href="../glossary.html#term-persistent"><span class="xref std std-term">persistent</span></a> object, the
viewonly collection can only show the net result of this change after <strong>two</strong>
things occur.  The first is that the change to <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code> is
<a class="reference internal" href="../glossary.html#term-flushed"><span class="xref std std-term">flushed</span></a>, so that the new data is available in the database, at least
within the scope of the local transaction.  The second is that the <code class="docutils literal notranslate"><span class="pre">User.current_week_tasks</span></code>
attribute is <a class="reference internal" href="../glossary.html#term-expired"><span class="xref std std-term">expired</span></a> and reloaded via a new SQL query to the database.</p>
<p>To support this requirement, the simplest flow to use is one where the
<strong>viewonly relationship is consumed only in operations that are primarily read
only to start with</strong>.   Such as below, if we retrieve a <code class="docutils literal notranslate"><span class="pre">User</span></code> fresh from
the database, the collection will be current:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span><span class="p">)</span>
<span class="go">[&lt;__main__.Task object at 0x7f8711b906b0&gt;]</span></pre></div>
</div>
<p>When we make modifications to <code class="docutils literal notranslate"><span class="pre">u1.all_tasks</span></code>, if we want to see these changes
reflected in the <code class="docutils literal notranslate"><span class="pre">u1.current_week_tasks</span></code> viewonly relationship, these changes need to be flushed
and the <code class="docutils literal notranslate"><span class="pre">u1.current_week_tasks</span></code> attribute needs to be expired, so that
it will <a class="reference internal" href="../glossary.html#term-lazy-load"><span class="xref std std-term">lazy load</span></a> on next access.  The simplest approach to this is
to use <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.commit" title="sqlalchemy.orm.Session.commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code></a>, keeping the <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.params.expire_on_commit" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.expire_on_commit</span></code></a>
parameter set at its default of <code class="docutils literal notranslate"><span class="pre">True</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">u1</span><span class="o">.</span><span class="n">all_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
<span class="gp">... </span>    <span class="n">sess</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span><span class="p">)</span>
<span class="go">[&lt;__main__.Task object at 0x7f8711b90ec0&gt;, &lt;__main__.Task object at 0x7f8711b90a10&gt;]</span></pre></div>
</div>
<p>Above, the call to <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.commit" title="sqlalchemy.orm.Session.commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.commit()</span></code></a> flushed the changes to <code class="docutils literal notranslate"><span class="pre">u1.all_tasks</span></code>
to the database, then expired all objects, so that when we accessed <code class="docutils literal notranslate"><span class="pre">u1.current_week_tasks</span></code>,
a :term:` lazy load` occurred which fetched the contents for this attribute
freshly from the database.</p>
<p>To intercept operations without actually committing the transaction,
the attribute needs to be explicitly <a class="reference internal" href="../glossary.html#term-expired"><span class="xref std std-term">expired</span></a>
first.   A simplistic way to do this is to just call it directly.  In
the example below, <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.flush" title="sqlalchemy.orm.Session.flush"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.flush()</span></code></a> sends pending changes to the
database, then <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.expire" title="sqlalchemy.orm.Session.expire"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.expire()</span></code></a> is used to expire the <code class="docutils literal notranslate"><span class="pre">u1.current_week_tasks</span></code>
collection so that it re-fetches on next access:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">u1</span><span class="o">.</span><span class="n">all_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
<span class="gp">... </span>    <span class="n">sess</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
<span class="gp">... </span>    <span class="n">sess</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;current_week_tasks&quot;</span><span class="p">])</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span><span class="p">)</span>
<span class="go">[&lt;__main__.Task object at 0x7fd95a4c8c50&gt;, &lt;__main__.Task object at 0x7fd95a4c8c80&gt;]</span></pre></div>
</div>
<p>We can in fact skip the call to <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.flush" title="sqlalchemy.orm.Session.flush"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.flush()</span></code></a>, assuming a
<a class="reference internal" href="session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> that keeps <a class="reference internal" href="session_api.html#sqlalchemy.orm.Session.params.autoflush" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.autoflush</span></code></a> at its
default value of <code class="docutils literal notranslate"><span class="pre">True</span></code>, as the expired <code class="docutils literal notranslate"><span class="pre">current_week_tasks</span></code> attribute will
trigger autoflush when accessed after expiration:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">u1</span><span class="o">.</span><span class="n">all_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
<span class="gp">... </span>    <span class="n">sess</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">u1</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;current_week_tasks&quot;</span><span class="p">])</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span><span class="p">)</span>  <span class="c1"># triggers autoflush before querying</span>
<span class="go">[&lt;__main__.Task object at 0x7fd95a4c8c50&gt;, &lt;__main__.Task object at 0x7fd95a4c8c80&gt;]</span></pre></div>
</div>
<p>Continuing with the above approach to something more elaborate, we can apply
the expiration programmatically when the related <code class="docutils literal notranslate"><span class="pre">User.all_tasks</span></code> collection
changes, using <a class="reference internal" href="../core/event.html#event-toplevel"><span class="std std-ref">event hooks</span></a>.   This an <strong>advanced
technique</strong>, where simpler architectures like <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> or sticking to
read-only use cases should be examined first.  In our simple example, this
would be configured as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">event</span><span class="p">,</span> <span class="n">inspect</span>


<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">all_tasks</span><span class="p">,</span> <span class="s2">&quot;append&quot;</span><span class="p">)</span>
<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">all_tasks</span><span class="p">,</span> <span class="s2">&quot;remove&quot;</span><span class="p">)</span>
<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">all_tasks</span><span class="p">,</span> <span class="s2">&quot;bulk_replace&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">_expire_User_current_week_tasks</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">):</span>
    <span class="n">inspect</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;current_week_tasks&quot;</span><span class="p">])</span></pre></div>
</div>
<p>With the above hooks, mutation operations are intercepted and result in
the <code class="docutils literal notranslate"><span class="pre">User.current_week_tasks</span></code> collection to be expired automatically:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">u1</span><span class="o">.</span><span class="n">all_tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()))</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span><span class="p">)</span>
<span class="go">[&lt;__main__.Task object at 0x7f66d093ccb0&gt;, &lt;__main__.Task object at 0x7f66d093cce0&gt;]</span></pre></div>
</div>
<p>The <a class="reference internal" href="events.html#sqlalchemy.orm.AttributeEvents" title="sqlalchemy.orm.AttributeEvents"><code class="xref py py-class docutils literal notranslate"><span class="pre">AttributeEvents</span></code></a> event hooks used above are also triggered
by backref mutations, so with the above hooks a change to <code class="docutils literal notranslate"><span class="pre">Task.user</span></code> is
also intercepted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="k">as</span> <span class="n">sess</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">u1</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span><span class="n">select</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">t1</span> <span class="o">=</span> <span class="n">Task</span><span class="p">(</span><span class="n">task_date</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">())</span>
<span class="gp">... </span>    <span class="n">t1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">u1</span>
<span class="gp">... </span>    <span class="n">sess</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">print</span><span class="p">(</span><span class="n">u1</span><span class="o">.</span><span class="n">current_week_tasks</span><span class="p">)</span>
<span class="go">[&lt;__main__.Task object at 0x7f3b0c070d10&gt;, &lt;__main__.Task object at 0x7f3b0c057d10&gt;]</span></pre></div>
</div>
</div>
</div>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="large_collections.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">使用大型集合</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="self_referential.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">邻接表关系</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                <a href="../copyright.html">Copyright</a> &#169; 2007-2025, the SQLAlchemy authors and contributors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on 04/05/2025 04:00:26</div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">配置关系连接方式</a><ul>
<li><a class="reference internal" href="#relationship-foreign-keys">处理多个连接路径</a></li>
<li><a class="reference internal" href="#relationship-primaryjoin">指定备用连接条件</a></li>
<li><a class="reference internal" href="#relationship-custom-foreign">创建自定义外部条件</a></li>
<li><a class="reference internal" href="#relationship-custom-operator">在连接条件中使用自定义运算符</a></li>
<li><a class="reference internal" href="#sql">基于 SQL 函数的自定义运算符</a></li>
<li><a class="reference internal" href="#relationship-overlapping-foreignkeys">重叠外键</a></li>
<li><a class="reference internal" href="#id10">非关系比较/物化路径</a></li>
<li><a class="reference internal" href="#self-referential-many-to-many">自引用多对多关系</a></li>
<li><a class="reference internal" href="#composite-secondary-join">复合“次要”连接</a></li>
<li><a class="reference internal" href="#relationship-aliased-class">与别名类的关系</a><ul>
<li><a class="reference internal" href="#aliasedclass">将 AliasedClass 映射与类型集成并避免早期映射器配置</a></li>
<li><a class="reference internal" href="#id14">在查询中使用 AliasedClass 目标</a></li>
</ul>
</li>
<li><a class="reference internal" href="#relationship-to-window-function">使用窗口函数的行限制关系</a></li>
<li><a class="reference internal" href="#query-enabled-properties">构建启用查询的属性</a></li>
<li><a class="reference internal" href="#viewonly">使用 viewonly 关系参数的注意事项</a><ul>
<li><a class="reference internal" href="#python-backref-viewonly-true">在 Python 中，包括 backref 的突变不适用于 viewonly=True</a></li>
<li><a class="reference internal" href="#viewonly-true">viewonly=True 集合/属性在过期之前不会被重新查询</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=2d0eb83f"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/tabs.js?v=3ee01567"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=2f3e6152"></script>
    <script src="../_static/translations.js?v=beaddf03"></script>
    </body>
</html>