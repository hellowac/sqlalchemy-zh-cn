<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="copyright" title="版权所有" href="../copyright.html" /><link rel="next" title="What’s New in SQLAlchemy 1.1?" href="migration_11.html" /><link rel="prev" title="What’s New in SQLAlchemy 1.3?" href="migration_13.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.08.06 -->
        <title>What’s New in SQLAlchemy 1.2? - SQLAlchemy 2.1 Documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/changelog.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_paramlinks.css" />
    <link rel="stylesheet" type="text/css" href="../_static/docs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">SQLAlchemy 2.1 Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">SQLAlchemy 2.1 Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">概述</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorial/index.html">SQLAlchemy 统一教程</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of SQLAlchemy 统一教程</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/engine.html">建立连接 - Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/dbapi_transactions.html">使用事务和DBAPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/metadata.html">使用数据库元数据</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../tutorial/data.html">处理数据</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of 处理数据</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/data_insert.html">使用 INSERT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/data_select.html">使用 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/data_update.html">使用 UPDATE 和 DELETE 语句</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/orm_data_manipulation.html">使用 ORM 进行数据操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/orm_related_objects.html">使用 ORM 相关对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/further_reading.html">进一步阅读</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../orm/index.html">SQLAlchemy ORM</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of SQLAlchemy ORM</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../orm/quickstart.html">ORM 快速入门</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../orm/mapper_config.html">ORM 映射类配置</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of ORM 映射类配置</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../orm/mapping_styles.html">ORM 映射类概述</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../orm/declarative_mapping.html">使用声明式映射类</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of 使用声明式映射类</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../orm/declarative_styles.html">声明式映射风格</a></li>
<li class="toctree-l4"><a class="reference internal" href="../orm/declarative_tables.html">声明式的表配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../orm/declarative_config.html">使用声明式映射器配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../orm/declarative_mixins.html">使用 Mixins 组合映射层次结构</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../orm/dataclasses.html">与dataclass和attrs的集成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/mapped_sql_expr.html">SQL 表达式作为映射属性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/mapped_attributes.html">更改Attribute的行为</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/composites.html">复合列类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/inheritance.html">映射类继承层次结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/nonstandard_mappings.html">非传统映射</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/versioning.html">配置版本计数器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/mapping_api.html">类映射 API</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../orm/scalar_mapping.html">映射 SQL 表达式</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of 映射 SQL 表达式</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../orm/mapping_columns.html">映射表格列</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../orm/relationships.html">关系配置</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of 关系配置</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../orm/basic_relationships.html">基本关系模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/self_referential.html">邻接表关系</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/join_conditions.html">配置关系连接方式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/large_collections.html">使用大型集合</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/collection_api.html">集合自定义和 API 详细信息</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/relationship_persistence.html">特殊关系的持久化模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/backref.html">使用旧版“backref”关系参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/relationship_api.html">关系 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../orm/queryguide/index.html">ORM 查询指南</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of ORM 查询指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/select.html">为 ORM 映射类编写 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/inheritance.html">为继承映射编写 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/dml.html">启用 ORM 的 INSERT、UPDATE 和 DELETE 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/columns.html">列加载选项</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/relationships.html">关系加载技术</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/api.html">用于查询的 ORM API 功能</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/query.html">旧式查询 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../orm/session.html">使用会话</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of 使用会话</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../orm/session_basics.html">会话基础知识</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/session_state_management.html">状态管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/cascades.html">级联</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/session_transaction.html">事务和连接管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/persistence_techniques.html">附加持久性技术</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/contextual.html">上下文/线程本地会话</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/session_events.html">使用事件跟踪查询、对象和会话更改</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/session_api.html">会话 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../orm/extending.html">事件和内部</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of 事件和内部</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../orm/events.html">ORM 事件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/internals.html">ORM 内部</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/exceptions.html">ORM 异常</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../orm/extensions/index.html">ORM 扩展</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of ORM 扩展</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/asyncio.html">异步 I/O (asyncio)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/associationproxy.html">关联代理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/automap.html">自动映射</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/baked.html">烘焙查询</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/declarative/index.html">声明式扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/mutable.html">突变追踪</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/orderinglist.html">排序列表</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/horizontal_shard.html">水平分片</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/hybrid.html">混合属性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/indexable.html">Indexable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/instrumentation.html">替代类检测</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../orm/examples.html">核心和 ORM 示例</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../core/index.html">SQLAlchemy Core</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of SQLAlchemy Core</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/expression_api.html">SQL 语句和表达式 API</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of SQL 语句和表达式 API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/sqlelement.html">列元素和表达式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/operators.html">操作符参考</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/selectable.html">SELECT 和相关构造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/dml.html">插入,更新,删除</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/functions.html">SQL 和 范型函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/compiler.html">自定义 SQL 构造和编译扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/serializer.html">表达式序列化器扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/foundation.html">SQL 表达式语言基础构造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/visitors.html">访问者和遍历实用程序</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/schema.html">Schema 定义语言</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of Schema 定义语言</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/metadata.html">使用元数据描述数据库</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/reflection.html">反映数据库对象</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/defaults.html">列 INSERT/UPDATE 默认值</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/constraints.html">定义约束和索引</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/ddl.html">自定义 DDL</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/types.html">SQL 数据类型对象</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of SQL 数据类型对象</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/type_basics.html">类型层次结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/custom_types.html">自定义类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/type_api.html">基本类型 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/engines_connections.html">Engine和Connection的使用</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of Engine和Connection的使用</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/engines.html">Engine 配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/connections.html">使用Engines和Connection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/pooling.html">连接池</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/events.html">核心事件</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/api_basics.html">Core API 基础</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of Core API 基础</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/event.html">事件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/inspection.html">运行时审查 API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/exceptions.html">Core 异常</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/internals.html">Core 内部</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../dialects/index.html">Dialects</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of Dialects</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../dialects/postgresql.html">PostgreSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/mysql.html">MySQL 和 MariaDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/sqlite.html">SQLite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/oracle.html">Oracle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/mssql.html">Microsoft SQL Server</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../faq/index.html">常见问题</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of 常见问题</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq/installation.html">安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/connections.html">连接 / 引擎</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/metadata_schema.html">元数据 / Schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/sqlexpressions.html">SQL 表达式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/ormconfiguration.html">ORM 配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/performance.html">性能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/sessions.html">会话 / 查询</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/thirdparty.html">第三方包集成问题</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../errors.html">错误消息</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">变更和迁移</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of 变更和迁移</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="migration_21.html">SQLAlchemy 2.1 有什么新功能？</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_21.html">2.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_20.html">2.0 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_14.html">1.4 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_13.html">1.3 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_12.html">1.2 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_11.html">1.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_10.html">1.0 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_09.html">0.9 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_08.html">0.8 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_07.html">0.7 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_06.html">0.6 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_05.html">0.5 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_04.html">0.4 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_03.html">0.3 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_02.html">0.2 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_01.html">0.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_20.html">SQLAlchemy 2.0 - Major Migration Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="whatsnew_20.html">What’s New in SQLAlchemy 2.0?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_14.html">What’s New in SQLAlchemy 1.4?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_13.html">What’s New in SQLAlchemy 1.3?</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">What’s New in SQLAlchemy 1.2?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_11.html">What’s New in SQLAlchemy 1.1?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_10.html">What’s New in SQLAlchemy 1.0?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_09.html">What’s New in SQLAlchemy 0.9?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_08.html">What’s New in SQLAlchemy 0.8?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_07.html">What’s New in SQLAlchemy 0.7?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_06.html">What’s New in SQLAlchemy 0.6?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_05.html">What’s new in SQLAlchemy 0.5?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_04.html">What’s new in SQLAlchemy 0.4?</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="what-s-new-in-sqlalchemy-1-2">
<h1>What’s New in SQLAlchemy 1.2?<a class="headerlink" href="#what-s-new-in-sqlalchemy-1-2" title="Link to this heading">¶</a></h1>
<div class="admonition-about-this-document admonition">
<p class="admonition-title">About this Document</p>
<p>This document describes changes between SQLAlchemy version 1.1
and SQLAlchemy version 1.2.</p>
</div>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>This guide introduces what’s new in SQLAlchemy version 1.2,
and also documents changes which affect users migrating
their applications from the 1.1 series of SQLAlchemy to 1.2.</p>
<p>Please carefully review the sections on behavioral changes for
potentially backwards-incompatible changes in behavior.</p>
</section>
<section id="platform-support">
<h2>Platform Support<a class="headerlink" href="#platform-support" title="Link to this heading">¶</a></h2>
<section id="targeting-python-2-7-and-up">
<h3>Targeting Python 2.7 and Up<a class="headerlink" href="#targeting-python-2-7-and-up" title="Link to this heading">¶</a></h3>
<p>SQLAlchemy 1.2 now moves the minimum Python version to 2.7, no longer
supporting 2.6.   New language features are expected to be merged
into the 1.2 series that were not supported in Python 2.6.  For Python 3 support,
SQLAlchemy is currently tested on versions 3.5 and 3.6.</p>
</section>
</section>
<section id="new-features-and-improvements-orm">
<h2>New Features and Improvements - ORM<a class="headerlink" href="#new-features-and-improvements-orm" title="Link to this heading">¶</a></h2>
<section id="baked-loading-now-the-default-for-lazy-loads">
<span id="change-3954"></span><h3>“Baked” loading now the default for lazy loads<a class="headerlink" href="#baked-loading-now-the-default-for-lazy-loads" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="../orm/extensions/baked.html#module-sqlalchemy.ext.baked" title="sqlalchemy.ext.baked"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sqlalchemy.ext.baked</span></code></a> extension, first introduced in the 1.0 series,
allows for the construction of a so-called <a class="reference internal" href="../orm/extensions/baked.html#sqlalchemy.ext.baked.BakedQuery" title="sqlalchemy.ext.baked.BakedQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">BakedQuery</span></code></a> object,
which is an object that generates a <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object in conjunction
with a cache key representing the structure of the query; this cache key
is then linked to the resulting string SQL statement so that subsequent use
of another <a class="reference internal" href="../orm/extensions/baked.html#sqlalchemy.ext.baked.BakedQuery" title="sqlalchemy.ext.baked.BakedQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">BakedQuery</span></code></a> with the same structure will bypass all the
overhead of building the <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object, building the core
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a> object within, as well as the compilation of the <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.select" title="sqlalchemy.sql.expression.select"><code class="xref py py-func docutils literal notranslate"><span class="pre">select()</span></code></a>
into a string, cutting out well the majority of function call overhead normally
associated with constructing and emitting an ORM <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object.</p>
<p>The <a class="reference internal" href="../orm/extensions/baked.html#sqlalchemy.ext.baked.BakedQuery" title="sqlalchemy.ext.baked.BakedQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">BakedQuery</span></code></a> is now used by default by the ORM when it generates
a “lazy” query for the lazy load of a <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> construct, e.g.
that of the default <code class="docutils literal notranslate"><span class="pre">lazy=&quot;select&quot;</span></code> relationship loader strategy.  This
will allow for a significant reduction in function calls within the scope
of an application’s use of lazy load queries to load collections and related
objects.   Previously, this feature was available
in 1.0 and 1.1 through the use of a global API method or by using the
<code class="docutils literal notranslate"><span class="pre">baked_select</span></code> strategy, it’s now the only implementation for this behavior.
The feature has also been improved such that the caching can still take place
for objects that have additional loader options in effect subsequent
to the lazy load.</p>
<p>The caching behavior can be disabled on a per-relationship basis using the
<a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship.params.bake_queries" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.bake_queries</span></code></a> flag, which is available for
very unusual cases, such as a relationship that uses a custom
<a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> implementation that’s not compatible with caching.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3954">#3954</a></p>
</section>
<section id="new-selectin-eager-loading-loads-all-collections-at-once-using-in">
<span id="change-3944"></span><h3>New “selectin” eager loading, loads all collections at once using IN<a class="headerlink" href="#new-selectin-eager-loading-loads-all-collections-at-once-using-in" title="Link to this heading">¶</a></h3>
<p>A new eager loader called “selectin” loading is added, which in many ways
is similar to “subquery” loading, however produces a simpler SQL statement
that is cacheable as well as more efficient.</p>
<p>Given a query as below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%e</span><span class="s2">d%&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">subqueryload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">))</span>
<span class="p">)</span></pre></div>
</div>
<p>The SQL produced would be the query against <code class="docutils literal notranslate"><span class="pre">User</span></code> followed by the
subqueryload for <code class="docutils literal notranslate"><span class="pre">User.addresses</span></code> (note the parameters are also listed):</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_id</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_name</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">users</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="o">?</span>
<span class="p">(</span><span class="s1">&#39;%ed%&#39;</span><span class="p">,)</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">addresses</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">addresses_id</span><span class="p">,</span>
<span class="w">       </span><span class="n">addresses</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">addresses_user_id</span><span class="p">,</span>
<span class="w">       </span><span class="n">addresses</span><span class="p">.</span><span class="n">email_address</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">addresses_email_address</span><span class="p">,</span>
<span class="w">       </span><span class="n">anon_1</span><span class="p">.</span><span class="n">users_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1_users_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">users</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">anon_1</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">addresses</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">users_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addresses</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">anon_1</span><span class="p">.</span><span class="n">users_id</span>
<span class="p">(</span><span class="s1">&#39;%ed%&#39;</span><span class="p">,)</span></pre></div>
</div>
<p>With “selectin” loading, we instead get a SELECT that refers to the
actual primary key values loaded in the parent query:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">q</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%e</span><span class="s2">d%&quot;</span><span class="p">))</span>
    <span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">selectinload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">))</span>
<span class="p">)</span></pre></div>
</div>
<p>Produces:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_id</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_name</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">users</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="o">?</span>
<span class="p">(</span><span class="s1">&#39;%ed%&#39;</span><span class="p">,)</span>

<span class="k">SELECT</span><span class="w"> </span><span class="n">users_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_1_id</span><span class="p">,</span>
<span class="w">       </span><span class="n">addresses</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">addresses_id</span><span class="p">,</span>
<span class="w">       </span><span class="n">addresses</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">addresses_user_id</span><span class="p">,</span>
<span class="w">       </span><span class="n">addresses</span><span class="p">.</span><span class="n">email_address</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">addresses_email_address</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_1</span>
<span class="k">JOIN</span><span class="w"> </span><span class="n">addresses</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">users_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addresses</span><span class="p">.</span><span class="n">user_id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">users_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">users_1</span><span class="p">.</span><span class="n">id</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span></pre></div>
</div>
<p>The above SELECT statement includes these advantages:</p>
<ul class="simple">
<li><p>It doesn’t use a subquery, just an INNER JOIN, meaning it will perform
much better on a database like MySQL that doesn’t like subqueries</p></li>
<li><p>Its structure is independent of the original query; in conjunction with the
new <a class="reference internal" href="#change-3953"><span class="std std-ref">expanding IN parameter system</span></a> we can in most cases
use the “baked” query to cache the string SQL, reducing per-query overhead
significantly</p></li>
<li><p>Because the query only fetches for a given list of primary key identifiers,
“selectin” loading is potentially compatible with <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.yield_per" title="sqlalchemy.orm.Query.yield_per"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.yield_per()</span></code></a> to
operate on chunks of a SELECT result at a time, provided that the
database driver allows for multiple, simultaneous cursors (SQLite, PostgreSQL;
<strong>not</strong> MySQL drivers or SQL Server ODBC drivers).   Neither joined eager
loading nor subquery eager loading are compatible with <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.yield_per" title="sqlalchemy.orm.Query.yield_per"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.yield_per()</span></code></a>.</p></li>
</ul>
<p>The disadvantages of selectin eager loading are potentially large SQL
queries, with large lists of IN parameters.  The list of IN parameters themselves
are chunked in groups of 500, so a result set of more than 500 lead objects
will have more additional “SELECT IN” queries following.  Also, support
for composite primary keys depends on the database’s ability to use
tuples with IN, e.g.
<code class="docutils literal notranslate"><span class="pre">(table.column_one,</span> <span class="pre">table_column_two)</span> <span class="pre">IN</span> <span class="pre">((?,</span> <span class="pre">?),</span> <span class="pre">(?,</span> <span class="pre">?)</span> <span class="pre">(?,</span> <span class="pre">?))</span></code>.
Currently, PostgreSQL and MySQL are known to be compatible with this syntax,
SQLite is not.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../orm/queryguide/relationships.html#selectin-eager-loading"><span class="std std-ref">选择 IN 加载</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3944">#3944</a></p>
</section>
<section id="selectin-polymorphic-loading-loads-subclasses-using-separate-in-queries">
<span id="change-3948"></span><h3>“selectin” polymorphic loading, loads subclasses using separate IN queries<a class="headerlink" href="#selectin-polymorphic-loading-loads-subclasses-using-separate-in-queries" title="Link to this heading">¶</a></h3>
<p>Along similar lines as the “selectin” relationship loading feature just
described at <a class="reference internal" href="#change-3944"><span class="std std-ref">New “selectin” eager loading, loads all collections at once using IN</span></a> is “selectin” polymorphic loading.  This
is a polymorphic loading feature tailored primarily towards joined eager
loading that allows the loading of the base entity to proceed with a simple
SELECT statement, but then the attributes of the additional subclasses
are loaded with additional SELECT statements:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">selectin_polymorphic</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Employee</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span>
<span class="go">...     selectin_polymorphic(Employee, [Manager, Engineer])</span>
<span class="go">... )</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class='show_sql'><span class="k">SELECT</span>
<span class="w">    </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">employee</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee_name</span><span class="p">,</span>
<span class="w">    </span><span class="n">employee</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee_type</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">employee</span>
<span class="p">()</span>

<span class="k">SELECT</span>
<span class="w">    </span><span class="n">engineer</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">engineer_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">employee</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee_type</span><span class="p">,</span>
<span class="w">    </span><span class="n">engineer</span><span class="p">.</span><span class="n">engineer_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">engineer_engineer_name</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">engineer</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">engineer</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">)</span>

<span class="k">SELECT</span>
<span class="w">    </span><span class="n">manager</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">manager_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee_id</span><span class="p">,</span>
<span class="w">    </span><span class="n">employee</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">employee_type</span><span class="p">,</span>
<span class="w">    </span><span class="n">manager</span><span class="p">.</span><span class="n">manager_name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">manager_manager_name</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">manager</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">manager</span><span class="p">.</span><span class="n">id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span>
<span class="p">(</span><span class="mi">3</span><span class="p">,)</span>
</div></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../orm/queryguide/inheritance.html#polymorphic-selectin"><span class="std std-ref">使用 selectin_polymorphic()</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3948">#3948</a></p>
</section>
<section id="orm-attributes-that-can-receive-ad-hoc-sql-expressions">
<span id="change-3058"></span><h3>ORM attributes that can receive ad-hoc SQL expressions<a class="headerlink" href="#orm-attributes-that-can-receive-ad-hoc-sql-expressions" title="Link to this heading">¶</a></h3>
<p>A new ORM attribute type <a class="reference internal" href="../orm/queryguide/columns.html#sqlalchemy.orm.query_expression" title="sqlalchemy.orm.query_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">query_expression()</span></code></a> is added which
is similar to <a class="reference internal" href="../orm/queryguide/columns.html#sqlalchemy.orm.deferred" title="sqlalchemy.orm.deferred"><code class="xref py py-func docutils literal notranslate"><span class="pre">deferred()</span></code></a>, except its SQL expression
is determined at query time using a new option <a class="reference internal" href="../orm/queryguide/columns.html#sqlalchemy.orm.with_expression" title="sqlalchemy.orm.with_expression"><code class="xref py py-func docutils literal notranslate"><span class="pre">with_expression()</span></code></a>;
if not specified, the attribute defaults to <code class="docutils literal notranslate"><span class="pre">None</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">query_expression</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">with_expression</span>


<span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">)</span>

    <span class="c1"># will be None normally...</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">query_expression</span><span class="p">()</span>


<span class="c1"># but let&#39;s give it x + y</span>
<span class="n">a1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">with_expression</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">A</span><span class="o">.</span><span class="n">x</span> <span class="o">+</span> <span class="n">A</span><span class="o">.</span><span class="n">y</span><span class="p">))</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">print</span><span class="p">(</span><span class="n">a1</span><span class="o">.</span><span class="n">expr</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../orm/mapped_sql_expr.html#mapper-querytime-expression"><span class="std std-ref">查询时 SQL 表达式作为映射属性</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3058">#3058</a></p>
</section>
<section id="orm-support-of-multiple-table-deletes">
<span id="change-orm-959"></span><h3>ORM Support of multiple-table deletes<a class="headerlink" href="#orm-support-of-multiple-table-deletes" title="Link to this heading">¶</a></h3>
<p>The ORM <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.delete" title="sqlalchemy.orm.Query.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.delete()</span></code></a> method supports multiple-table criteria
for DELETE, as introduced in <a class="reference internal" href="#change-959"><span class="std std-ref">Multiple-table criteria support for DELETE</span></a>.   The feature works
in the same manner as multiple-table criteria for UPDATE, first
introduced in 0.8 and described at <a class="reference internal" href="migration_08.html#change-orm-2365"><span class="std std-ref">Query.update() supports UPDATE..FROM</span></a>.</p>
<p>Below, we emit a DELETE against <code class="docutils literal notranslate"><span class="pre">SomeEntity</span></code>, adding
a FROM clause (or equivalent, depending on backend)
against <code class="docutils literal notranslate"><span class="pre">SomeOtherEntity</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="p">(</span><span class="n">SomeEntity</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">SomeEntity</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">SomeOtherEntity</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
    <span class="n">SomeOtherEntity</span><span class="o">.</span><span class="n">foo</span> <span class="o">==</span> <span class="s2">&quot;bar&quot;</span>
<span class="p">)</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#change-959"><span class="std std-ref">Multiple-table criteria support for DELETE</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/959">#959</a></p>
</section>
<section id="support-for-bulk-updates-of-hybrids-composites">
<span id="change-3229"></span><h3>Support for bulk updates of hybrids, composites<a class="headerlink" href="#support-for-bulk-updates-of-hybrids-composites" title="Link to this heading">¶</a></h3>
<p>Both hybrid attributes (e.g. <a class="reference internal" href="../orm/extensions/hybrid.html#module-sqlalchemy.ext.hybrid" title="sqlalchemy.ext.hybrid"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sqlalchemy.ext.hybrid</span></code></a>) as well as composite
attributes (<a class="reference internal" href="../orm/composites.html#mapper-composite"><span class="std std-ref">复合列类型</span></a>) now support being used in the
SET clause of an UPDATE statement when using <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.update" title="sqlalchemy.orm.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a>.</p>
<p>For hybrids, simple expressions can be used directly, or the new decorator
<a class="reference internal" href="../orm/extensions/hybrid.html#sqlalchemy.ext.hybrid.hybrid_property.update_expression" title="sqlalchemy.ext.hybrid.hybrid_property.update_expression"><code class="xref py py-meth docutils literal notranslate"><span class="pre">hybrid_property.update_expression()</span></code></a> can be used to break a value
into multiple columns/expressions:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Person</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">first_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>
    <span class="n">last_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span>

    <span class="nd">@hybrid</span><span class="o">.</span><span class="n">hybrid_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">expression</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">update_expression</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">f</span><span class="p">,</span> <span class="n">l</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[(</span><span class="bp">cls</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="n">f</span><span class="p">),</span> <span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">last_name</span><span class="p">,</span> <span class="n">l</span><span class="p">)]</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, an UPDATE can be rendered using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Person</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Person</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">Person</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="s2">&quot;Dr. No&quot;</span><span class="p">})</span></pre></div>
</div>
<p>Similar functionality is available for composites, where composite values
will be broken out into their individual columns for bulk UPDATE:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Vertex</span><span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">Edge</span><span class="o">.</span><span class="n">start</span><span class="p">:</span> <span class="n">Point</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">)})</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../orm/extensions/hybrid.html#hybrid-bulk-update"><span class="std std-ref">Allowing Bulk ORM Update</span></a></p>
</div>
</section>
<section id="hybrid-attributes-support-reuse-among-subclasses-redefinition-of-getter">
<span id="change-3911-3912"></span><h3>Hybrid attributes support reuse among subclasses, redefinition of &#64;getter<a class="headerlink" href="#hybrid-attributes-support-reuse-among-subclasses-redefinition-of-getter" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="../orm/extensions/hybrid.html#sqlalchemy.ext.hybrid.hybrid_property" title="sqlalchemy.ext.hybrid.hybrid_property"><code class="xref py py-class docutils literal notranslate"><span class="pre">sqlalchemy.ext.hybrid.hybrid_property</span></code></a> class now supports
calling mutators like <code class="docutils literal notranslate"><span class="pre">&#64;setter</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;expression</span></code> etc. multiple times
across subclasses, and now provides a <code class="docutils literal notranslate"><span class="pre">&#64;getter</span></code> mutator, so that
a particular hybrid can be repurposed across subclasses or other
classes.  This now is similar to the behavior of <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> in standard
Python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">FirstNameOnly</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">first_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="nd">@hybrid_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">class</span><span class="w"> </span><span class="nc">FirstNameLastName</span><span class="p">(</span><span class="n">FirstNameOnly</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">last_name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="nd">@FirstNameOnly</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">getter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_name</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="n">maxsplit</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@name</span><span class="o">.</span><span class="n">expression</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">first_name</span><span class="p">,</span> <span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="n">last_name</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, the <code class="docutils literal notranslate"><span class="pre">FirstNameOnly.name</span></code> hybrid is referenced by the
<code class="docutils literal notranslate"><span class="pre">FirstNameLastName</span></code> subclass in order to repurpose it specifically to the
new subclass.   This is achieved by copying the hybrid object to a new one
within each call to <code class="docutils literal notranslate"><span class="pre">&#64;getter</span></code>, <code class="docutils literal notranslate"><span class="pre">&#64;setter</span></code>, as well as in all other
mutator methods like <code class="docutils literal notranslate"><span class="pre">&#64;expression</span></code>, leaving the previous hybrid’s definition
intact.  Previously, methods like <code class="docutils literal notranslate"><span class="pre">&#64;setter</span></code> would modify the existing
hybrid in-place, interfering with the definition on the superclass.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>Be sure to read the documentation at <a class="reference internal" href="../orm/extensions/hybrid.html#hybrid-reuse-subclass"><span class="std std-ref">Reusing Hybrid Properties across Subclasses</span></a>
for important notes regarding how to override
<a class="reference internal" href="../orm/extensions/hybrid.html#sqlalchemy.ext.hybrid.hybrid_property.expression" title="sqlalchemy.ext.hybrid.hybrid_property.expression"><code class="xref py py-meth docutils literal notranslate"><span class="pre">hybrid_property.expression()</span></code></a>
and <a class="reference internal" href="../orm/extensions/hybrid.html#sqlalchemy.ext.hybrid.hybrid_property.comparator" title="sqlalchemy.ext.hybrid.hybrid_property.comparator"><code class="xref py py-meth docutils literal notranslate"><span class="pre">hybrid_property.comparator()</span></code></a>, as a special qualifier
<a class="reference internal" href="../orm/extensions/hybrid.html#sqlalchemy.ext.hybrid.hybrid_property.overrides" title="sqlalchemy.ext.hybrid.hybrid_property.overrides"><code class="xref py py-attr docutils literal notranslate"><span class="pre">hybrid_property.overrides</span></code></a> may be necessary to avoid name
conflicts with <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.QueryableAttribute" title="sqlalchemy.orm.QueryableAttribute"><code class="xref py py-class docutils literal notranslate"><span class="pre">QueryableAttribute</span></code></a> in some cases.</p>
</div>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>This change in <code class="docutils literal notranslate"><span class="pre">&#64;hybrid_property</span></code> implies that when adding setters and
other state to a <code class="docutils literal notranslate"><span class="pre">&#64;hybrid_property</span></code>, the <strong>methods must retain the name
of the original hybrid</strong>, else the new hybrid with the additional state will
be present on the class as the non-matching name.  This is the same behavior
as that of the <code class="docutils literal notranslate"><span class="pre">&#64;property</span></code> construct that is part of standard Python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">FirstNameOnly</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="nd">@hybrid_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span>

    <span class="c1"># WRONG - will raise AttributeError: can&#39;t set attribute when</span>
    <span class="c1"># assigning to .name</span>
    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_set_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">value</span>


<span class="k">class</span><span class="w"> </span><span class="nc">FirstNameOnly</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="nd">@hybrid_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span>

    <span class="c1"># CORRECT - note regular Python @property works the same way</span>
    <span class="nd">@name</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">first_name</span> <span class="o">=</span> <span class="n">value</span></pre><div class="code-non-annotations-key"></div></div>
</div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3911">#3911</a></p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3912">#3912</a></p>
</section>
<section id="new-bulk-replace-event">
<span id="change-3896-event"></span><h3>New bulk_replace event<a class="headerlink" href="#new-bulk-replace-event" title="Link to this heading">¶</a></h3>
<p>To suit the validation use case described in <a class="reference internal" href="#change-3896-validates"><span class="std std-ref">A &#64;validates method receives all values on bulk-collection set before comparison</span></a>,
a new <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.AttributeEvents.bulk_replace" title="sqlalchemy.orm.AttributeEvents.bulk_replace"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AttributeEvents.bulk_replace()</span></code></a> method is added, which is
called in conjunction with the <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.AttributeEvents.append" title="sqlalchemy.orm.AttributeEvents.append"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AttributeEvents.append()</span></code></a> and
<a class="reference internal" href="../orm/events.html#sqlalchemy.orm.AttributeEvents.remove" title="sqlalchemy.orm.AttributeEvents.remove"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AttributeEvents.remove()</span></code></a> events.  “bulk_replace” is called before
“append” and “remove” so that the collection can be modified ahead of comparison
to the existing collection.   After that, individual items
are appended to a new target collection, firing off the “append”
event for items new to the collection, as was the previous behavior.
Below illustrates both “bulk_replace” and
“append” at the same time, including that “append” will receive an object
already handled by “bulk_replace” if collection assignment is used.
A new symbol <code class="xref py py-attr docutils literal notranslate"><span class="pre">attributes.OP_BULK_REPLACE</span></code> may be used to determine
if this “append” event is the second part of a bulk replace:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm.attributes</span><span class="w"> </span><span class="kn">import</span> <span class="n">OP_BULK_REPLACE</span>


<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">SomeObject</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;bulk_replace&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_collection</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">values</span><span class="p">,</span> <span class="n">initiator</span><span class="p">):</span>
    <span class="n">values</span><span class="p">[:]</span> <span class="o">=</span> <span class="p">[</span><span class="n">_make_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">values</span><span class="p">]</span>


<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">SomeObject</span><span class="o">.</span><span class="n">collection</span><span class="p">,</span> <span class="s2">&quot;append&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">process_collection</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">initiator</span><span class="p">):</span>
    <span class="c1"># make sure bulk_replace didn&#39;t already do it</span>
    <span class="k">if</span> <span class="n">initiator</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">initiator</span><span class="o">.</span><span class="n">op</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">OP_BULK_REPLACE</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">_make_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">value</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3896">#3896</a></p>
</section>
<section id="new-modified-event-handler-for-sqlalchemy-ext-mutable">
<span id="change-3303"></span><h3>New “modified” event handler for sqlalchemy.ext.mutable<a class="headerlink" href="#new-modified-event-handler-for-sqlalchemy-ext-mutable" title="Link to this heading">¶</a></h3>
<p>A new event handler <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.AttributeEvents.modified" title="sqlalchemy.orm.AttributeEvents.modified"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AttributeEvents.modified()</span></code></a> is added, which is
triggered corresponding to calls to the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.attributes.flag_modified" title="sqlalchemy.orm.attributes.flag_modified"><code class="xref py py-func docutils literal notranslate"><span class="pre">flag_modified()</span></code></a>
method, which is normally called from the <a class="reference internal" href="../orm/extensions/mutable.html#module-sqlalchemy.ext.mutable" title="sqlalchemy.ext.mutable"><code class="xref py py-mod docutils literal notranslate"><span class="pre">sqlalchemy.ext.mutable</span></code></a>
extension:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.declarative</span><span class="w"> </span><span class="kn">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.ext.mutable</span><span class="w"> </span><span class="kn">import</span> <span class="n">MutableDict</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">event</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>


<span class="k">class</span><span class="w"> </span><span class="nc">MyDataClass</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;my_data&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">MutableDict</span><span class="o">.</span><span class="n">as_mutable</span><span class="p">(</span><span class="n">JSONEncodedDict</span><span class="p">))</span>


<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">MyDataClass</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="s2">&quot;modified&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">modified_json</span><span class="p">(</span><span class="n">instance</span><span class="p">):</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&quot;json value modified:&quot;</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">data</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, the event handler will be triggered when an in-place change to the
<code class="docutils literal notranslate"><span class="pre">.data</span></code> dictionary occurs.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3303">#3303</a></p>
</section>
<section id="added-for-update-arguments-to-session-refresh">
<span id="change-3991"></span><h3>Added “for update” arguments to Session.refresh<a class="headerlink" href="#added-for-update-arguments-to-session-refresh" title="Link to this heading">¶</a></h3>
<p>Added new argument <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.refresh.params.with_for_update" title="sqlalchemy.orm.Session.refresh"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.refresh.with_for_update</span></code></a> to the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.refresh" title="sqlalchemy.orm.Session.refresh"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.refresh()</span></code></a> method.  When the <code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.with_lockmode()</span></code>
method were deprecated in favor of <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.with_for_update" title="sqlalchemy.orm.Query.with_for_update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.with_for_update()</span></code></a>,
the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.refresh" title="sqlalchemy.orm.Session.refresh"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Session.refresh()</span></code></a> method was never updated to reflect
the new option:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">some_object</span><span class="p">,</span> <span class="n">with_for_update</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
<p>The <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.refresh.params.with_for_update" title="sqlalchemy.orm.Session.refresh"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.refresh.with_for_update</span></code></a> argument accepts a dictionary
of options that will be passed as the same arguments which are sent to
<a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.with_for_update" title="sqlalchemy.orm.Query.with_for_update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.with_for_update()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">refresh</span><span class="p">(</span><span class="n">some_objects</span><span class="p">,</span> <span class="n">with_for_update</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;read&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span></pre></div>
</div>
<p>The new parameter supersedes the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.refresh.params.lockmode" title="sqlalchemy.orm.Session.refresh"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.refresh.lockmode</span></code></a>
parameter.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3991">#3991</a></p>
</section>
<section id="in-place-mutation-operators-work-for-mutableset-mutablelist">
<span id="change-3853"></span><h3>In-place mutation operators work for MutableSet, MutableList<a class="headerlink" href="#in-place-mutation-operators-work-for-mutableset-mutablelist" title="Link to this heading">¶</a></h3>
<p>Implemented the in-place mutation operators <code class="docutils literal notranslate"><span class="pre">__ior__</span></code>, <code class="docutils literal notranslate"><span class="pre">__iand__</span></code>,
<code class="docutils literal notranslate"><span class="pre">__ixor__</span></code> and <code class="docutils literal notranslate"><span class="pre">__isub__</span></code> for <a class="reference internal" href="../orm/extensions/mutable.html#sqlalchemy.ext.mutable.MutableSet" title="sqlalchemy.ext.mutable.MutableSet"><code class="xref py py-class docutils literal notranslate"><span class="pre">MutableSet</span></code></a> and <code class="docutils literal notranslate"><span class="pre">__iadd__</span></code>
for <a class="reference internal" href="../orm/extensions/mutable.html#sqlalchemy.ext.mutable.MutableList" title="sqlalchemy.ext.mutable.MutableList"><code class="xref py py-class docutils literal notranslate"><span class="pre">MutableList</span></code></a>.   While these
methods would successfully update the collection previously, they would
not correctly fire off change events.   The operators mutate the collection
as before but additionally emit the correct change event so that the change
becomes part of the next flush process:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">MyModel</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">json_set</span> <span class="o">&amp;=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">}</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3853">#3853</a></p>
</section>
<section id="associationproxy-any-has-contains-work-with-chained-association-proxies">
<span id="change-3769"></span><h3>AssociationProxy any(), has(), contains() work with chained association proxies<a class="headerlink" href="#associationproxy-any-has-contains-work-with-chained-association-proxies" title="Link to this heading">¶</a></h3>
<p>The <code class="xref py py-meth docutils literal notranslate"><span class="pre">AssociationProxy.any()</span></code>, <code class="xref py py-meth docutils literal notranslate"><span class="pre">AssociationProxy.has()</span></code>
and <code class="xref py py-meth docutils literal notranslate"><span class="pre">AssociationProxy.contains()</span></code> comparison methods now support
linkage to an attribute that is
itself also an <a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxy" title="sqlalchemy.ext.associationproxy.AssociationProxy"><code class="xref py py-class docutils literal notranslate"><span class="pre">AssociationProxy</span></code></a>, recursively.  Below, <code class="docutils literal notranslate"><span class="pre">A.b_values</span></code>
is an association proxy that links to <code class="docutils literal notranslate"><span class="pre">AtoB.bvalue</span></code>, which is
itself an association proxy onto <code class="docutils literal notranslate"><span class="pre">B</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">b_values</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s2">&quot;atob&quot;</span><span class="p">,</span> <span class="s2">&quot;b_value&quot;</span><span class="p">)</span>
    <span class="n">c_values</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s2">&quot;atob&quot;</span><span class="p">,</span> <span class="s2">&quot;c_value&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;C&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">C</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;c&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;b.id&quot;</span><span class="p">))</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AtoB</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;atob&quot;</span>

    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;b.id&quot;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;A&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;atob&quot;</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;atob&quot;</span><span class="p">)</span>

    <span class="n">b_value</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>
    <span class="n">c_value</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>We can query on <code class="docutils literal notranslate"><span class="pre">A.b_values</span></code> using <code class="xref py py-meth docutils literal notranslate"><span class="pre">AssociationProxy.contains()</span></code> to
query across the two proxies <code class="docutils literal notranslate"><span class="pre">A.b_values</span></code>, <code class="docutils literal notranslate"><span class="pre">AtoB.b_value</span></code>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">b_values</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;hi&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">atob</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atob</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">b</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atob</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">:</span><span class="n">value_1</span><span class="p">)))</span>
</div></pre></div>
</div>
<p>Similarly, we can query on <code class="docutils literal notranslate"><span class="pre">A.c_values</span></code> using <code class="xref py py-meth docutils literal notranslate"><span class="pre">AssociationProxy.any()</span></code>
to query across the two proxies <code class="docutils literal notranslate"><span class="pre">A.c_values</span></code>, <code class="docutils literal notranslate"><span class="pre">AtoB.c_value</span></code>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">c_values</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class='show_sql'><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">atob</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atob</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">b</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">atob</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span>
<span class="k">FROM</span><span class="w"> </span><span class="k">c</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">b_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="k">c</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">:</span><span class="n">value_1</span><span class="p">)))))</span>
</div></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3769">#3769</a></p>
</section>
<section id="change-4137">
<span id="identity-key-enhancements-to-support-sharding"></span><h3>Identity key enhancements to support sharding<a class="headerlink" href="#change-4137" title="Link to this heading">¶</a></h3>
<p>The identity key structure used by the ORM now contains an additional
member, so that two identical primary keys that originate from different
contexts can co-exist within the same identity map.</p>
<p>The example at <a class="reference internal" href="../orm/examples.html#examples-sharding"><span class="std std-ref">水平分片</span></a> has been updated to illustrate this
behavior.  The example shows a sharded class <code class="docutils literal notranslate"><span class="pre">WeatherLocation</span></code> that
refers to a dependent <code class="docutils literal notranslate"><span class="pre">WeatherReport</span></code> object, where the <code class="docutils literal notranslate"><span class="pre">WeatherReport</span></code>
class is mapped to a table that stores a simple integer primary key.  Two
<code class="docutils literal notranslate"><span class="pre">WeatherReport</span></code> objects from different databases may have the same
primary key value.   The example now illustrates that a new <code class="docutils literal notranslate"><span class="pre">identity_token</span></code>
field tracks this difference so that the two objects can co-exist in the
same identity map:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tokyo</span> <span class="o">=</span> <span class="n">WeatherLocation</span><span class="p">(</span><span class="s2">&quot;Asia&quot;</span><span class="p">,</span> <span class="s2">&quot;Tokyo&quot;</span><span class="p">)</span>
<span class="n">newyork</span> <span class="o">=</span> <span class="n">WeatherLocation</span><span class="p">(</span><span class="s2">&quot;North America&quot;</span><span class="p">,</span> <span class="s2">&quot;New York&quot;</span><span class="p">)</span>

<span class="n">tokyo</span><span class="o">.</span><span class="n">reports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Report</span><span class="p">(</span><span class="mf">80.0</span><span class="p">))</span>
<span class="n">newyork</span><span class="o">.</span><span class="n">reports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Report</span><span class="p">(</span><span class="mi">75</span><span class="p">))</span>

<span class="n">sess</span> <span class="o">=</span> <span class="n">create_session</span><span class="p">()</span>

<span class="n">sess</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span><span class="n">tokyo</span><span class="p">,</span> <span class="n">newyork</span><span class="p">,</span> <span class="n">quito</span><span class="p">])</span>

<span class="n">sess</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="c1"># the Report class uses a simple integer primary key.  So across two</span>
<span class="c1"># databases, a primary key will be repeated.  The &quot;identity_token&quot; tracks</span>
<span class="c1"># in memory that these two identical primary keys are local to different</span>
<span class="c1"># databases.</span>

<span class="n">newyork_report</span> <span class="o">=</span> <span class="n">newyork</span><span class="o">.</span><span class="n">reports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">tokyo_report</span> <span class="o">=</span> <span class="n">tokyo</span><span class="o">.</span><span class="n">reports</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="k">assert</span> <span class="n">inspect</span><span class="p">(</span><span class="n">newyork_report</span><span class="p">)</span><span class="o">.</span><span class="n">identity_key</span> <span class="o">==</span> <span class="p">(</span><span class="n">Report</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="s2">&quot;north_america&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">inspect</span><span class="p">(</span><span class="n">tokyo_report</span><span class="p">)</span><span class="o">.</span><span class="n">identity_key</span> <span class="o">==</span> <span class="p">(</span><span class="n">Report</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,),</span> <span class="s2">&quot;asia&quot;</span><span class="p">)</span>

<span class="c1"># the token representing the originating shard is also available directly</span>

<span class="k">assert</span> <span class="n">inspect</span><span class="p">(</span><span class="n">newyork_report</span><span class="p">)</span><span class="o">.</span><span class="n">identity_token</span> <span class="o">==</span> <span class="s2">&quot;north_america&quot;</span>
<span class="k">assert</span> <span class="n">inspect</span><span class="p">(</span><span class="n">tokyo_report</span><span class="p">)</span><span class="o">.</span><span class="n">identity_token</span> <span class="o">==</span> <span class="s2">&quot;asia&quot;</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4137">#4137</a></p>
</section>
</section>
<section id="new-features-and-improvements-core">
<h2>New Features and Improvements - Core<a class="headerlink" href="#new-features-and-improvements-core" title="Link to this heading">¶</a></h2>
<section id="boolean-datatype-now-enforces-strict-true-false-none-values">
<span id="change-4102"></span><h3>Boolean datatype now enforces strict True/False/None values<a class="headerlink" href="#boolean-datatype-now-enforces-strict-true-false-none-values" title="Link to this heading">¶</a></h3>
<p>In version 1.1, the change described in <a class="reference internal" href="migration_11.html#change-3730"><span class="std std-ref">Non-native boolean integer values coerced to zero/one/None in all cases</span></a> produced an
unintended side effect of altering the way <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Boolean" title="sqlalchemy.types.Boolean"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boolean</span></code></a> behaves when
presented with a non-integer value, such as a string.   In particular, the
string value <code class="docutils literal notranslate"><span class="pre">&quot;0&quot;</span></code>, which would previously result in the value <code class="docutils literal notranslate"><span class="pre">False</span></code>
being generated, would now produce <code class="docutils literal notranslate"><span class="pre">True</span></code>.  Making matters worse, the change
in behavior was only for some backends and not others, meaning code that sends
string <code class="docutils literal notranslate"><span class="pre">&quot;0&quot;</span></code> values to <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Boolean" title="sqlalchemy.types.Boolean"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boolean</span></code></a> would break inconsistently across
backends.</p>
<p>The ultimate solution to this problem is that <strong>string values are not supported
with Boolean</strong>, so in 1.2 a hard <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> is raised if a non-integer /
True/False/None value is passed.  Additionally, only the integer values
0 and 1 are accepted.</p>
<p>To accommodate for applications that wish to have more liberal interpretation
of boolean values, the <a class="reference internal" href="../core/custom_types.html#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> should be used.   Below
illustrates a recipe that will allow for the “liberal” behavior of the pre-1.1
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Boolean" title="sqlalchemy.types.Boolean"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boolean</span></code></a> datatype:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Boolean</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeDecorator</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LiberalBoolean</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">Boolean</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_bind_param</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">dialect</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">bool</span><span class="p">(</span><span class="n">int</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">value</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4102">#4102</a></p>
</section>
<section id="pessimistic-disconnection-detection-added-to-the-connection-pool">
<span id="change-3919"></span><h3>Pessimistic disconnection detection added to the connection pool<a class="headerlink" href="#pessimistic-disconnection-detection-added-to-the-connection-pool" title="Link to this heading">¶</a></h3>
<p>The connection pool documentation has long featured a recipe for using
the <a class="reference internal" href="../core/events.html#sqlalchemy.events.ConnectionEvents.engine_connect" title="sqlalchemy.events.ConnectionEvents.engine_connect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ConnectionEvents.engine_connect()</span></code></a> engine event to emit a simple
statement on a checked-out connection to test it for liveness.   The
functionality of this recipe has now been added into the connection pool
itself, when used in conjunction with an appropriate dialect.   Using
the new parameter <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.pool_pre_ping" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.pool_pre_ping</span></code></a>, each connection
checked out will be tested for freshness before being returned:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;mysql+pymysql://&quot;</span><span class="p">,</span> <span class="n">pool_pre_ping</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
<p>While the “pre-ping” approach adds a small amount of latency to the connection
pool checkout, for a typical application that is transactionally-oriented
(which includes most ORM applications), this overhead is minimal, and
eliminates the problem of acquiring a stale connection that will raise
an error, requiring that the application either abandon or retry the operation.</p>
<p>The feature does <strong>not</strong> accommodate for connections dropped within
an ongoing transaction or SQL operation.  If an application must recover
from these as well, it would need to employ its own operation retry logic
to anticipate these errors.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../core/pooling.html#pool-disconnects-pessimistic"><span class="std std-ref">断开连接处理 - 悲观</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3919">#3919</a></p>
</section>
<section id="the-in-not-in-operator-s-empty-collection-behavior-is-now-configurable-default-expression-simplified">
<span id="change-3907"></span><h3>The IN / NOT IN operator’s empty collection behavior is now configurable; default expression simplified<a class="headerlink" href="#the-in-not-in-operator-s-empty-collection-behavior-is-now-configurable-default-expression-simplified" title="Link to this heading">¶</a></h3>
<p>An expression such as <code class="docutils literal notranslate"><span class="pre">column.in_([])</span></code>, which is assumed to be false,
now produces the expression <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">!=</span> <span class="pre">1</span></code>
by default, instead of <code class="docutils literal notranslate"><span class="pre">column</span> <span class="pre">!=</span> <span class="pre">column</span></code>.  This will <strong>change the result</strong>
of a query that is comparing a SQL expression or column that evaluates to
NULL when compared to an empty set, producing a boolean value false or true
(for NOT IN) rather than NULL.  The warning that would emit under
this condition is also removed.  The old behavior is available using the
<a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.empty_in_strategy" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.empty_in_strategy</span></code></a> parameter to
<a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code></a>.</p>
<p>In SQL, the IN and NOT IN operators do not support comparison to a
collection of values that is explicitly empty; meaning, this syntax is
illegal:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">mycolumn</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">()</span></pre></div>
</div>
<p>To work around this, SQLAlchemy and other database libraries detect this
condition and render an alternative expression that evaluates to false, or
in the case of NOT IN, to true, based on the theory that “col IN ()” is always
false since nothing is in “the empty set”.    Typically, in order to
produce a false/true constant that is portable across databases and works
in the context of the WHERE clause, a simple tautology such as <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">!=</span> <span class="pre">1</span></code> is
used to evaluate to false and <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">=</span> <span class="pre">1</span></code> to evaluate to true (a simple constant
“0” or “1” often does not work as the target of a WHERE clause).</p>
<p>SQLAlchemy in its early days began with this approach as well, but soon it
was theorized that the SQL expression <code class="docutils literal notranslate"><span class="pre">column</span> <span class="pre">IN</span> <span class="pre">()</span></code> would not evaluate to
false if the “column” were NULL; instead, the expression would produce NULL,
since “NULL” means “unknown”, and comparisons to NULL in SQL usually produce
NULL.</p>
<p>To simulate this result, SQLAlchemy changed from using <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">!=</span> <span class="pre">1</span></code> to
instead use th expression <code class="docutils literal notranslate"><span class="pre">expr</span> <span class="pre">!=</span> <span class="pre">expr</span></code> for empty “IN” and <code class="docutils literal notranslate"><span class="pre">expr</span> <span class="pre">=</span> <span class="pre">expr</span></code>
for empty “NOT IN”; that is, instead of using a fixed value we use the
actual left-hand side of the expression.  If the left-hand side of
the expression passed evaluates to NULL, then the comparison overall
also gets the NULL result instead of false or true.</p>
<p>Unfortunately, users eventually complained that this expression had a very
severe performance impact on some query planners.   At that point, a warning
was added when an empty IN expression was encountered, favoring that SQLAlchemy
continues to be “correct” and urging users to avoid code that generates empty
IN predicates in general, since typically they can be safely omitted.  However,
this is of course burdensome in the case of queries that are built up dynamically
from input variables, where an incoming set of values might be empty.</p>
<p>In recent months, the original assumptions of this decision have been
questioned.  The notion that the expression “NULL IN ()” should return NULL was
only theoretical, and could not be tested since databases don’t support that
syntax.  However, as it turns out, you can in fact ask a relational database
what value it would return for “NULL IN ()” by simulating the empty set as
follows:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">NULL</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span></pre></div>
</div>
<p>With the above test, we see that the databases themselves can’t agree on
the answer.  PostgreSQL, considered by most to be the most “correct” database,
returns False; because even though “NULL” represents “unknown”, the “empty set”
means nothing is present, including all unknown values.  On the
other hand, MySQL and MariaDB return NULL for the above expression, defaulting
to the more common behavior of “all comparisons to NULL return NULL”.</p>
<p>SQLAlchemy’s SQL architecture is more sophisticated than it was when this
design decision was first made, so we can now allow either behavior to
be invoked at SQL string compilation time.  Previously, the conversion to a
comparison expression were done at construction time, that is, the moment
the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnOperators.in_" title="sqlalchemy.sql.expression.ColumnOperators.in_"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.in_()</span></code></a> or <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnOperators.notin_" title="sqlalchemy.sql.expression.ColumnOperators.notin_"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.notin_()</span></code></a> operators were invoked.
With the compilation-time behavior, the dialect itself can be instructed
to invoke either approach, that is, the “static” <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">!=</span> <span class="pre">1</span></code> comparison or the
“dynamic” <code class="docutils literal notranslate"><span class="pre">expr</span> <span class="pre">!=</span> <span class="pre">expr</span></code> comparison.   The default has been <strong>changed</strong>
to be the “static” comparison, since this agrees with the behavior that
PostgreSQL would have in any case and this is also what the vast majority
of users prefer.   This will <strong>change the result</strong> of a query that is comparing
a null expression to the empty set, particularly one that is querying
for the negation <code class="docutils literal notranslate"><span class="pre">where(~null_expr.in_([]))</span></code>, since this now evaluates to true
and not NULL.</p>
<p>The behavior can now be controlled using the flag
<a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.empty_in_strategy" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.empty_in_strategy</span></code></a>, which defaults to the
<code class="docutils literal notranslate"><span class="pre">&quot;static&quot;</span></code> setting, but may also be set to <code class="docutils literal notranslate"><span class="pre">&quot;dynamic&quot;</span></code> or
<code class="docutils literal notranslate"><span class="pre">&quot;dynamic_warn&quot;</span></code>, where the <code class="docutils literal notranslate"><span class="pre">&quot;dynamic_warn&quot;</span></code> setting is equivalent to the
previous behavior of emitting <code class="docutils literal notranslate"><span class="pre">expr</span> <span class="pre">!=</span> <span class="pre">expr</span></code> as well as a performance
warning.   However, it is anticipated that most users will appreciate the
“static” default.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3907">#3907</a></p>
</section>
<section id="late-expanded-in-parameter-sets-allow-in-expressions-with-cached-statements">
<span id="change-3953"></span><h3>Late-expanded IN parameter sets allow IN expressions with cached statements<a class="headerlink" href="#late-expanded-in-parameter-sets-allow-in-expressions-with-cached-statements" title="Link to this heading">¶</a></h3>
<p>Added a new kind of <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.bindparam" title="sqlalchemy.sql.expression.bindparam"><code class="xref py py-func docutils literal notranslate"><span class="pre">bindparam()</span></code></a> called “expanding”.  This is
for use in <code class="docutils literal notranslate"><span class="pre">IN</span></code> expressions where the list of elements is rendered
into individual bound parameters at statement execution time, rather
than at statement compilation time.  This allows both a single bound
parameter name to be linked to an IN expression of multiple elements,
as well as allows query caching to be used with IN expressions.  The
new feature allows the related features of “select in” loading and
“polymorphic in” loading to make use of the baked query extension
to reduce call overhead:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">table</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">col</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bindparam</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">,</span> <span class="n">expanding</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span>
<span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;foo&quot;</span><span class="p">:</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]})</span></pre></div>
</div>
<p>The feature should be regarded as <strong>experimental</strong> within the 1.2 series.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3953">#3953</a></p>
</section>
<section id="flattened-operator-precedence-for-comparison-operators">
<span id="change-3999"></span><h3>Flattened operator precedence for comparison operators<a class="headerlink" href="#flattened-operator-precedence-for-comparison-operators" title="Link to this heading">¶</a></h3>
<p>The operator precedence for operators like IN, LIKE, equals, IS, MATCH, and
other comparison operators has been flattened into one level.  This will
have the effect of more parenthesization being generated when comparison
operators are combined together, such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">null</span><span class="p">())</span> <span class="o">!=</span> <span class="p">(</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">null</span><span class="p">())</span></pre></div>
</div>
<p>Will now generate <code class="docutils literal notranslate"><span class="pre">(q</span> <span class="pre">IS</span> <span class="pre">NULL)</span> <span class="pre">!=</span> <span class="pre">(y</span> <span class="pre">IS</span> <span class="pre">NULL)</span></code> rather than
<code class="docutils literal notranslate"><span class="pre">q</span> <span class="pre">IS</span> <span class="pre">NULL</span> <span class="pre">!=</span> <span class="pre">y</span> <span class="pre">IS</span> <span class="pre">NULL</span></code>.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3999">#3999</a></p>
</section>
<section id="support-for-sql-comments-on-table-column-includes-ddl-reflection">
<span id="change-1546"></span><h3>Support for SQL Comments on Table, Column, includes DDL, reflection<a class="headerlink" href="#support-for-sql-comments-on-table-column-includes-ddl-reflection" title="Link to this heading">¶</a></h3>
<p>The Core receives support for string comments associated with tables
and columns.   These are specified via the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table.params.comment" title="sqlalchemy.schema.Table"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Table.comment</span></code></a> and
<a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.comment" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.comment</span></code></a> arguments:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;my_table&quot;</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;the Q value&quot;</span><span class="p">),</span>
    <span class="n">comment</span><span class="o">=</span><span class="s2">&quot;my Q table&quot;</span><span class="p">,</span>
<span class="p">)</span></pre></div>
</div>
<p>Above, DDL will be rendered appropriately upon table create to associate
the above comments with the table/ column within the schema.  When
the above table is autoloaded or inspected with <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_columns" title="sqlalchemy.engine.reflection.Inspector.get_columns"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_columns()</span></code></a>,
the comments are included.   The table comment is also available independently
using the <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_table_comment" title="sqlalchemy.engine.reflection.Inspector.get_table_comment"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_table_comment()</span></code></a> method.</p>
<p>Current backend support includes MySQL, PostgreSQL, and Oracle.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/1546">#1546</a></p>
</section>
<section id="multiple-table-criteria-support-for-delete">
<span id="change-959"></span><h3>Multiple-table criteria support for DELETE<a class="headerlink" href="#multiple-table-criteria-support-for-delete" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Delete" title="sqlalchemy.sql.expression.Delete"><code class="xref py py-class docutils literal notranslate"><span class="pre">Delete</span></code></a> construct now supports multiple-table criteria,
implemented for those backends which support it, currently these are
PostgreSQL, MySQL and Microsoft SQL Server (support is also added to the
currently non-working Sybase dialect).   The feature works in the same
was as that of multiple-table criteria for UPDATE, first introduced in
the 0.7 and 0.8 series.</p>
<p>Given a statement as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stmt</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">users</span><span class="o">.</span><span class="n">delete</span><span class="p">()</span>
    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">addresses</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
    <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">addresses</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">email_address</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;ed%&quot;</span><span class="p">))</span>
<span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
<p>The resulting SQL from the above statement on a PostgreSQL backend
would render as:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">DELETE</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">USING</span><span class="w"> </span><span class="n">addresses</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addresses</span><span class="p">.</span><span class="n">id</span>
<span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">addresses</span><span class="p">.</span><span class="n">email_address</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="o">%</span><span class="p">(</span><span class="n">email_address_1</span><span class="p">)</span><span class="n">s</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;%%&#39;</span><span class="p">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../tutorial/data_update.html#tutorial-multi-table-deletes"><span class="std std-ref">多表删除</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/959">#959</a></p>
</section>
<section id="new-autoescape-option-for-startswith-endswith">
<span id="change-2694"></span><h3>New “autoescape” option for startswith(), endswith()<a class="headerlink" href="#new-autoescape-option-for-startswith-endswith" title="Link to this heading">¶</a></h3>
<p>The “autoescape” parameter is added to <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnOperators.startswith" title="sqlalchemy.sql.expression.ColumnOperators.startswith"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.startswith()</span></code></a>,
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnOperators.endswith" title="sqlalchemy.sql.expression.ColumnOperators.endswith"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.endswith()</span></code></a>, <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnOperators.contains" title="sqlalchemy.sql.expression.ColumnOperators.contains"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.contains()</span></code></a>.
This parameter when set to <code class="docutils literal notranslate"><span class="pre">True</span></code> will automatically escape all occurrences
of <code class="docutils literal notranslate"><span class="pre">%</span></code>, <code class="docutils literal notranslate"><span class="pre">_</span></code> with an escape character, which defaults to a forwards slash <code class="docutils literal notranslate"><span class="pre">/</span></code>;
occurrences of the escape character itself are also escaped.  The forwards slash
is used to avoid conflicts with settings like PostgreSQL’s
<code class="docutils literal notranslate"><span class="pre">standard_confirming_strings</span></code>, whose default value changed as of PostgreSQL
9.1, and MySQL’s <code class="docutils literal notranslate"><span class="pre">NO_BACKSLASH_ESCAPES</span></code> settings.  The existing “escape” parameter
can now be used to change the autoescape character, if desired.</p>
<div class="admonition note">
<p class="admonition-title">备注</p>
<p>This feature has been changed as of 1.2.0 from its initial
implementation in 1.2.0b2 such that autoescape is now passed as a boolean
value, rather than a specific character to use as the escape character.</p>
</div>
<p>An expression such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;total</span><span class="si">%s</span><span class="s2">core&quot;</span><span class="p">,</span> <span class="n">autoescape</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
<p>Renders as:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="p">:</span><span class="n">x_1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="k">ESCAPE</span><span class="w"> </span><span class="s1">&#39;/&#39;</span></pre></div>
</div>
<p>Where the value of the parameter “x_1” is <code class="docutils literal notranslate"><span class="pre">'total/%score'</span></code>.</p>
<p>Similarly, an expression that has backslashes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;total/score&quot;</span><span class="p">,</span> <span class="n">autoescape</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
<p>Will render the same way, with the value of the parameter “x_1” as
<code class="docutils literal notranslate"><span class="pre">'total//score'</span></code>.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/2694">#2694</a></p>
</section>
<section id="stronger-typing-added-to-float-datatypes">
<span id="change-floats-12"></span><h3>Stronger typing added to “float” datatypes<a class="headerlink" href="#stronger-typing-added-to-float-datatypes" title="Link to this heading">¶</a></h3>
<p>A series of changes allow for use of the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Float" title="sqlalchemy.types.Float"><code class="xref py py-class docutils literal notranslate"><span class="pre">Float</span></code></a> datatype to more
strongly link itself to Python floating point values, instead of the more
generic <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Numeric" title="sqlalchemy.types.Numeric"><code class="xref py py-class docutils literal notranslate"><span class="pre">Numeric</span></code></a>.  The changes are mostly related to ensuring
that Python floating point values are not erroneously coerced to
<code class="docutils literal notranslate"><span class="pre">Decimal()</span></code>, and are coerced to <code class="docutils literal notranslate"><span class="pre">float</span></code> if needed, on the result side,
if the application is working with plain floats.</p>
<ul>
<li><p>A plain Python “float” value passed to a SQL expression will now be
pulled into a literal parameter with the type <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Float" title="sqlalchemy.types.Float"><code class="xref py py-class docutils literal notranslate"><span class="pre">Float</span></code></a>; previously,
the type was <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Numeric" title="sqlalchemy.types.Numeric"><code class="xref py py-class docutils literal notranslate"><span class="pre">Numeric</span></code></a>, with the default “asdecimal=True” flag, which
meant the result type would coerce to <code class="docutils literal notranslate"><span class="pre">Decimal()</span></code>.  In particular,
this would emit a confusing warning on SQLite:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">float_value</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">scalar</span><span class="p">(</span>
    <span class="n">select</span><span class="p">([</span><span class="n">literal</span><span class="p">(</span><span class="mf">4.56</span><span class="p">)])</span>  <span class="c1"># the &quot;BindParameter&quot; will now be</span>
    <span class="c1"># Float, not Numeric(asdecimal=True)</span>
<span class="p">)</span></pre></div>
</div>
</li>
<li><p>Math operations between <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Numeric" title="sqlalchemy.types.Numeric"><code class="xref py py-class docutils literal notranslate"><span class="pre">Numeric</span></code></a>, <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Float" title="sqlalchemy.types.Float"><code class="xref py py-class docutils literal notranslate"><span class="pre">Float</span></code></a>, and
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Integer" title="sqlalchemy.types.Integer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Integer</span></code></a> will now preserve the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Numeric" title="sqlalchemy.types.Numeric"><code class="xref py py-class docutils literal notranslate"><span class="pre">Numeric</span></code></a> or <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Float" title="sqlalchemy.types.Float"><code class="xref py py-class docutils literal notranslate"><span class="pre">Float</span></code></a>
type in the resulting expression’s type, including the <code class="docutils literal notranslate"><span class="pre">asdecimal</span></code> flag
as well as if the type should be <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Float" title="sqlalchemy.types.Float"><code class="xref py py-class docutils literal notranslate"><span class="pre">Float</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># asdecimal flag is maintained</span>
<span class="n">expr</span> <span class="o">=</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span> <span class="o">*</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">Numeric</span><span class="p">(</span><span class="n">asdecimal</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="k">assert</span> <span class="n">expr</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">asdecimal</span> <span class="o">==</span> <span class="kc">False</span>

<span class="c1"># Float subclass of Numeric is maintained</span>
<span class="n">expr</span> <span class="o">=</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">)</span> <span class="o">*</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">Float</span><span class="p">())</span>
<span class="k">assert</span> <span class="n">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="o">.</span><span class="n">type</span><span class="p">,</span> <span class="n">Float</span><span class="p">)</span></pre></div>
</div>
</li>
<li><p>The <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Float" title="sqlalchemy.types.Float"><code class="xref py py-class docutils literal notranslate"><span class="pre">Float</span></code></a> datatype will apply the <code class="docutils literal notranslate"><span class="pre">float()</span></code> processor to
result values unconditionally if the DBAPI is known to support native
<code class="docutils literal notranslate"><span class="pre">Decimal()</span></code> mode.  Some backends do not always guarantee that a floating
point number comes back as plain float and not precision numeric such
as MySQL.</p></li>
</ul>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4017">#4017</a></p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4018">#4018</a></p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4020">#4020</a></p>
</section>
<section id="support-for-grouping-sets-cube-rollup">
<h3>Support for GROUPING SETS, CUBE, ROLLUP<a class="headerlink" href="#support-for-grouping-sets-cube-rollup" title="Link to this heading">¶</a></h3>
<p>All three of GROUPING SETS, CUBE, ROLLUP are available via the
<code class="xref py py-attr docutils literal notranslate"><span class="pre">func</span></code> namespace.  In the case of CUBE and ROLLUP, these functions
already work in previous versions, however for GROUPING SETS, a placeholder
is added to the compiler to allow for the space.  All three functions
are named in the documentation now:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">tuple_</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t</span> <span class="o">=</span> <span class="n">table</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">),</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">),</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;y&quot;</span><span class="p">),</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;z&quot;</span><span class="p">),</span> <span class="n">column</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">))</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">value</span><span class="p">)])</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
<span class="go">...     func.grouping_sets(</span>
<span class="go">...         tuple_(t.c.x, t.c.y),</span>
<span class="go">...         tuple_(t.c.z, t.c.q),</span>
<span class="go">...     )</span>
<span class="go">... )</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span>
<div class='show_sql_print'><span class="k">SELECT</span><span class="w"> </span><span class="k">sum</span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">sum_1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">GROUP</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="k">GROUPING</span><span class="w"> </span><span class="k">SETS</span><span class="p">((</span><span class="n">t</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">y</span><span class="p">),</span><span class="w"> </span><span class="p">(</span><span class="n">t</span><span class="p">.</span><span class="n">z</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">q</span><span class="p">))</span>
</div></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3429">#3429</a></p>
</section>
<section id="parameter-helper-for-multi-valued-insert-with-contextual-default-generator">
<span id="change-4075"></span><h3>Parameter helper for multi-valued INSERT with contextual default generator<a class="headerlink" href="#parameter-helper-for-multi-valued-insert-with-contextual-default-generator" title="Link to this heading">¶</a></h3>
<p>A default generation function, e.g. that described at
<a class="reference internal" href="../core/defaults.html#context-default-functions"><span class="std std-ref">上下文敏感默认函数</span></a>, can look at the current parameters relevant
to the statement via the <a class="reference internal" href="../core/internals.html#sqlalchemy.engine.default.DefaultExecutionContext.current_parameters" title="sqlalchemy.engine.default.DefaultExecutionContext.current_parameters"><code class="xref py py-attr docutils literal notranslate"><span class="pre">DefaultExecutionContext.current_parameters</span></code></a>
attribute.  However, in the case of a <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> construct that specifies
multiple VALUES clauses via the <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert.values" title="sqlalchemy.sql.expression.Insert.values"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.values()</span></code></a> method, the user-defined
function is called multiple times, once for each parameter set, however there
was no way to know which subset of keys in
<a class="reference internal" href="../core/internals.html#sqlalchemy.engine.default.DefaultExecutionContext.current_parameters" title="sqlalchemy.engine.default.DefaultExecutionContext.current_parameters"><code class="xref py py-attr docutils literal notranslate"><span class="pre">DefaultExecutionContext.current_parameters</span></code></a> apply to that column.  A
new function <a class="reference internal" href="../core/internals.html#sqlalchemy.engine.default.DefaultExecutionContext.get_current_parameters" title="sqlalchemy.engine.default.DefaultExecutionContext.get_current_parameters"><code class="xref py py-meth docutils literal notranslate"><span class="pre">DefaultExecutionContext.get_current_parameters()</span></code></a> is added,
which includes a keyword argument
<a class="reference internal" href="../core/internals.html#sqlalchemy.engine.default.DefaultExecutionContext.get_current_parameters.params.isolate_multiinsert_groups" title="sqlalchemy.engine.default.DefaultExecutionContext.get_current_parameters"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">DefaultExecutionContext.get_current_parameters.isolate_multiinsert_groups</span></code></a>
defaulting to <code class="docutils literal notranslate"><span class="pre">True</span></code>, which performs the extra work of delivering a sub-dictionary of
<a class="reference internal" href="../core/internals.html#sqlalchemy.engine.default.DefaultExecutionContext.current_parameters" title="sqlalchemy.engine.default.DefaultExecutionContext.current_parameters"><code class="xref py py-attr docutils literal notranslate"><span class="pre">DefaultExecutionContext.current_parameters</span></code></a> which has the names
localized to the current VALUES clause being processed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">mydefault</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">get_current_parameters</span><span class="p">()[</span><span class="s2">&quot;counter&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">12</span>


<span class="n">mytable</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;mytable&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;counter&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;counter_plus_twelve&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">mydefault</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="n">mydefault</span><span class="p">),</span>
<span class="p">)</span>

<span class="n">stmt</span> <span class="o">=</span> <span class="n">mytable</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">([{</span><span class="s2">&quot;counter&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;counter&quot;</span><span class="p">:</span> <span class="mi">18</span><span class="p">},</span> <span class="p">{</span><span class="s2">&quot;counter&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}])</span>

<span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4075">#4075</a></p>
</section>
</section>
<section id="key-behavioral-changes-orm">
<h2>Key Behavioral Changes - ORM<a class="headerlink" href="#key-behavioral-changes-orm" title="Link to this heading">¶</a></h2>
<section id="the-after-rollback-session-event-now-emits-before-the-expiration-of-objects">
<span id="change-3934"></span><h3>The after_rollback() Session event now emits before the expiration of objects<a class="headerlink" href="#the-after-rollback-session-event-now-emits-before-the-expiration-of-objects" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.SessionEvents.after_rollback" title="sqlalchemy.orm.SessionEvents.after_rollback"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SessionEvents.after_rollback()</span></code></a> event now has access to the attribute
state of objects before their state has been expired (e.g. the “snapshot
removal”).  This allows the event to be consistent with the behavior
of the <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.SessionEvents.after_commit" title="sqlalchemy.orm.SessionEvents.after_commit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SessionEvents.after_commit()</span></code></a> event which also emits before the
“snapshot” has been removed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span>

<span class="n">user</span> <span class="o">=</span> <span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>


<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="s2">&quot;after_rollback&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">after_rollback</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="c1"># &#39;user.name&#39; is now present, assuming it was already</span>
    <span class="c1"># loaded.  previously this would raise upon trying</span>
    <span class="c1"># to emit a lazy load.</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&quot;user name: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">sess</span><span class="p">,</span> <span class="s2">&quot;after_commit&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">after_commit</span><span class="p">(</span><span class="n">session</span><span class="p">):</span>
    <span class="c1"># &#39;user.name&#39; is present, assuming it was already</span>
    <span class="c1"># loaded.  this is the existing behavior.</span>
    <span class="n">print</span><span class="p">(</span><span class="s2">&quot;user name: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>


<span class="k">if</span> <span class="n">should_rollback</span><span class="p">:</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">sess</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
</div>
<p>Note that the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> will still disallow SQL from being emitted
within this event; meaning that unloaded attributes will still not be
able to load within the scope of the event.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3934">#3934</a></p>
</section>
<section id="fixed-issue-involving-single-table-inheritance-with-select-from">
<span id="change-3891"></span><h3>Fixed issue involving single-table inheritance with <code class="docutils literal notranslate"><span class="pre">select_from()</span></code><a class="headerlink" href="#fixed-issue-involving-single-table-inheritance-with-select-from" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.select_from" title="sqlalchemy.orm.Query.select_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.select_from()</span></code></a> method now honors the single-table inheritance
column discriminator when generating SQL; previously, only the expressions
in the query column list would be taken into account.</p>
<p>Supposing <code class="docutils literal notranslate"><span class="pre">Manager</span></code> is a subclass of <code class="docutils literal notranslate"><span class="pre">Employee</span></code>.  A query like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Manager</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></pre></div>
</div>
<p>Would generate SQL as:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;manager&#39;</span><span class="p">)</span></pre></div>
</div>
<p>However, if <code class="docutils literal notranslate"><span class="pre">Manager</span></code> were only specified by <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.select_from" title="sqlalchemy.orm.Query.select_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.select_from()</span></code></a>
and not in the columns list, the discriminator would not be added:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sess</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">Manager</span><span class="p">)</span></pre></div>
</div>
<p>would generate:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employee</span></pre></div>
</div>
<p>With the fix, <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.select_from" title="sqlalchemy.orm.Query.select_from"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.select_from()</span></code></a> now works correctly and we get:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">employee</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">employee</span><span class="p">.</span><span class="k">type</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="s1">&#39;manager&#39;</span><span class="p">)</span></pre></div>
</div>
<p>Applications that may have been working around this by supplying the
WHERE clause manually may need to be adjusted.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3891">#3891</a></p>
</section>
<section id="previous-collection-is-no-longer-mutated-upon-replacement">
<span id="change-3913"></span><h3>Previous collection is no longer mutated upon replacement<a class="headerlink" href="#previous-collection-is-no-longer-mutated-upon-replacement" title="Link to this heading">¶</a></h3>
<p>The ORM emits events whenever the members of a mapped collection change.
In the case of assigning a collection to an attribute that would replace
the previous collection, a side effect of this was that the collection
being replaced would also be mutated, which is misleading and unnecessary:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">,</span> <span class="n">a3</span> <span class="o">=</span> <span class="n">Address</span><span class="p">(</span><span class="s2">&quot;a1&quot;</span><span class="p">),</span> <span class="n">Address</span><span class="p">(</span><span class="s2">&quot;a2&quot;</span><span class="p">),</span> <span class="n">Address</span><span class="p">(</span><span class="s2">&quot;a3&quot;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">addresses</span> <span class="o">=</span> <span class="p">[</span><span class="n">a1</span><span class="p">,</span> <span class="n">a2</span><span class="p">]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">previous_collection</span> <span class="o">=</span> <span class="n">user</span><span class="o">.</span><span class="n">addresses</span>

<span class="go"># replace the collection with a new one</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">user</span><span class="o">.</span><span class="n">addresses</span> <span class="o">=</span> <span class="p">[</span><span class="n">a2</span><span class="p">,</span> <span class="n">a3</span><span class="p">]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">previous_collection</span>
<span class="go">[Address(&#39;a1&#39;), Address(&#39;a2&#39;)]</span></pre></div>
</div>
<p>Above, prior to the change, the <code class="docutils literal notranslate"><span class="pre">previous_collection</span></code> would have had the
“a1” member removed, corresponding to the member that’s no longer in the
new collection.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3913">#3913</a></p>
</section>
<section id="a-validates-method-receives-all-values-on-bulk-collection-set-before-comparison">
<span id="change-3896-validates"></span><h3>A &#64;validates method receives all values on bulk-collection set before comparison<a class="headerlink" href="#a-validates-method-receives-all-values-on-bulk-collection-set-before-comparison" title="Link to this heading">¶</a></h3>
<p>A method that uses <code class="docutils literal notranslate"><span class="pre">&#64;validates</span></code> will now receive all members of a collection
during a “bulk set” operation, before comparison is applied against the
existing collection.</p>
<p>Given a mapping as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>

    <span class="nd">@validates</span><span class="p">(</span><span class="s2">&quot;bs&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">convert_dict_to_b</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">B</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">value</span><span class="p">[</span><span class="s2">&quot;data&quot;</span><span class="p">])</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, we could use the validator as follows, to convert from an incoming
dictionary to an instance of <code class="docutils literal notranslate"><span class="pre">B</span></code> upon collection append:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">a1</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;b1&quot;</span><span class="p">})</span></pre></div>
</div>
<p>However, a collection assignment would fail, since the ORM would assume
incoming objects are already instances of <code class="docutils literal notranslate"><span class="pre">B</span></code> as it attempts to compare  them
to the existing members of the collection, before doing collection appends
which actually invoke the validator.  This would make it impossible for bulk
set operations to accommodate non-ORM objects like dictionaries that needed
up-front modification:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">a1</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="s2">&quot;b1&quot;</span><span class="p">}]</span></pre></div>
</div>
<p>The new logic uses the new <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.AttributeEvents.bulk_replace" title="sqlalchemy.orm.AttributeEvents.bulk_replace"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AttributeEvents.bulk_replace()</span></code></a> event to ensure
that all values are sent to the <code class="docutils literal notranslate"><span class="pre">&#64;validates</span></code> function up front.</p>
<p>As part of this change, this means that validators will now receive
<strong>all</strong> members of a collection upon bulk set, not just the members that
are new.   Supposing a simple validator such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="nd">@validates</span><span class="p">(</span><span class="s2">&quot;bs&quot;</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate_b</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">assert</span> <span class="n">value</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">value</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, if we began with a collection as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>

<span class="n">b1</span><span class="p">,</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;one&quot;</span><span class="p">),</span> <span class="n">B</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;two&quot;</span><span class="p">)</span>
<span class="n">a1</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="p">[</span><span class="n">b1</span><span class="p">,</span> <span class="n">b2</span><span class="p">]</span></pre></div>
</div>
<p>And then, replaced the collection with one that overlaps the first:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">b3</span> <span class="o">=</span> <span class="n">B</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;three&quot;</span><span class="p">)</span>
<span class="n">a1</span><span class="o">.</span><span class="n">bs</span> <span class="o">=</span> <span class="p">[</span><span class="n">b2</span><span class="p">,</span> <span class="n">b3</span><span class="p">]</span></pre></div>
</div>
<p>Previously, the second assignment would trigger the <code class="docutils literal notranslate"><span class="pre">A.validate_b</span></code>
method only once, for the <code class="docutils literal notranslate"><span class="pre">b3</span></code> object.  The <code class="docutils literal notranslate"><span class="pre">b2</span></code> object would be seen
as being already present in the collection and not validated.  With the new
behavior, both <code class="docutils literal notranslate"><span class="pre">b2</span></code> and <code class="docutils literal notranslate"><span class="pre">b3</span></code> are passed to <code class="docutils literal notranslate"><span class="pre">A.validate_b</span></code> before passing
onto the collection.   It is thus important that validation methods employ
idempotent behavior to suit such a case.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#change-3896-event"><span class="std std-ref">New bulk_replace event</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3896">#3896</a></p>
</section>
<section id="use-flag-dirty-to-mark-an-object-as-dirty-without-any-attribute-changing">
<span id="change-3753"></span><h3>Use flag_dirty() to mark an object as “dirty” without any attribute changing<a class="headerlink" href="#use-flag-dirty-to-mark-an-object-as-dirty-without-any-attribute-changing" title="Link to this heading">¶</a></h3>
<p>An exception is now raised if the <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.attributes.flag_modified" title="sqlalchemy.orm.attributes.flag_modified"><code class="xref py py-func docutils literal notranslate"><span class="pre">flag_modified()</span></code></a> function
is used to mark an attribute as modified that isn’t actually loaded:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;adf&quot;</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>

<span class="n">s</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

<span class="c1"># expire, similarly as though we said s.commit()</span>
<span class="n">s</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>

<span class="c1"># will raise InvalidRequestError</span>
<span class="n">attributes</span><span class="o">.</span><span class="n">flag_modified</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span></pre></div>
</div>
<p>This because the flush process will most likely fail in any case if the
attribute remains un-present by the time flush occurs.    To mark an object
as “modified” without referring to any attribute specifically, so that it
is considered within the flush process for the purpose of custom event handlers
such as <a class="reference internal" href="../orm/events.html#sqlalchemy.orm.SessionEvents.before_flush" title="sqlalchemy.orm.SessionEvents.before_flush"><code class="xref py py-meth docutils literal notranslate"><span class="pre">SessionEvents.before_flush()</span></code></a>, use the new
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.attributes.flag_dirty" title="sqlalchemy.orm.attributes.flag_dirty"><code class="xref py py-func docutils literal notranslate"><span class="pre">flag_dirty()</span></code></a> function:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">attributes</span>

<span class="n">attributes</span><span class="o">.</span><span class="n">flag_dirty</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3753">#3753</a></p>
</section>
<section id="scope-keyword-removed-from-scoped-session">
<span id="change-3796"></span><h3>“scope” keyword removed from scoped_session<a class="headerlink" href="#scope-keyword-removed-from-scoped-session" title="Link to this heading">¶</a></h3>
<p>A very old and undocumented keyword argument <code class="docutils literal notranslate"><span class="pre">scope</span></code> has been removed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.orm</span><span class="w"> </span><span class="kn">import</span> <span class="n">scoped_session</span>

<span class="n">Session</span> <span class="o">=</span> <span class="n">scoped_session</span><span class="p">(</span><span class="n">sessionmaker</span><span class="p">())</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">scope</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></pre></div>
</div>
<p>The purpose of this keyword was an attempt to allow for variable
“scopes”, where <code class="docutils literal notranslate"><span class="pre">None</span></code> indicated “no scope” and would therefore return
a new <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a>.   The keyword has never been documented and will
now raise <code class="docutils literal notranslate"><span class="pre">TypeError</span></code> if encountered.   It is not anticipated that this
keyword is in use, however if users report issues related to this during
beta testing, it can be restored with a deprecation.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3796">#3796</a></p>
</section>
<section id="refinements-to-post-update-in-conjunction-with-onupdate">
<span id="change-3471"></span><h3>Refinements to post_update in conjunction with onupdate<a class="headerlink" href="#refinements-to-post-update-in-conjunction-with-onupdate" title="Link to this heading">¶</a></h3>
<p>A relationship that uses the <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship.params.post_update" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.post_update</span></code></a> feature
will now interact better with a column that has an <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.onupdate" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.onupdate</span></code></a>
value set.   If an object is inserted with an explicit value for the column,
it is re-stated during the UPDATE so that the “onupdate” rule does not
overwrite it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">favorite_b_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;b.id&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;favorite_b_fk&quot;</span><span class="p">))</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;A.id == B.a_id&quot;</span><span class="p">)</span>
    <span class="n">favorite_b</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="s2">&quot;A.favorite_b_id == B.id&quot;</span><span class="p">,</span> <span class="n">post_update</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">updated</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">onupdate</span><span class="o">=</span><span class="n">my_onupdate_function</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;a_fk&quot;</span><span class="p">))</span>


<span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="n">b1</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>

<span class="n">a1</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
<span class="n">a1</span><span class="o">.</span><span class="n">favorite_b</span> <span class="o">=</span> <span class="n">b1</span>
<span class="n">a1</span><span class="o">.</span><span class="n">updated</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, the previous behavior would be that an UPDATE would emit after the
INSERT, thus triggering the “onupdate” and overwriting the value
“5”.   The SQL now looks like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="p">(</span><span class="n">favorite_b_id</span><span class="p">,</span><span class="w"> </span><span class="n">updated</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span>
<span class="p">(</span><span class="k">None</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span>
<span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="p">(</span><span class="n">a_id</span><span class="p">)</span><span class="w"> </span><span class="k">VALUES</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">)</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,)</span>
<span class="k">UPDATE</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">SET</span><span class="w"> </span><span class="n">favorite_b_id</span><span class="o">=?</span><span class="p">,</span><span class="w"> </span><span class="n">updated</span><span class="o">=?</span><span class="w"> </span><span class="k">WHERE</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span></pre></div>
</div>
<p>Additionally, if the value of “updated” is <em>not</em> set, then we correctly
get back the newly generated value on <code class="docutils literal notranslate"><span class="pre">a1.updated</span></code>; previously, the logic
that refreshes or expires the attribute to allow the generated value
to be present would not fire off for a post-update.   The
<a class="reference internal" href="../orm/events.html#sqlalchemy.orm.InstanceEvents.refresh_flush" title="sqlalchemy.orm.InstanceEvents.refresh_flush"><code class="xref py py-meth docutils literal notranslate"><span class="pre">InstanceEvents.refresh_flush()</span></code></a> event is also emitted when a refresh
within flush occurs in this case.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3471">#3471</a></p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3472">#3472</a></p>
</section>
<section id="post-update-integrates-with-orm-versioning">
<span id="change-3496"></span><h3>post_update integrates with ORM versioning<a class="headerlink" href="#post-update-integrates-with-orm-versioning" title="Link to this heading">¶</a></h3>
<p>The post_update feature, documented at <a class="reference internal" href="../orm/relationship_persistence.html#post-update"><span class="std std-ref">指向自身的行/相互依赖的行</span></a>, involves that an
UPDATE statement is emitted in response to changes to a particular
relationship-bound foreign key, in addition to the INSERT/UPDATE/DELETE that
would normally be emitted for the target row.  This UPDATE statement
now participates in the versioning feature, documented at
<a class="reference internal" href="../orm/versioning.html#mapper-version-counter"><span class="std std-ref">配置版本计数器</span></a>.</p>
<p>Given a mapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Node</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;node&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">version_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">))</span>
    <span class="n">favorite_node_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;node.id&quot;</span><span class="p">))</span>

    <span class="n">nodes</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Node&quot;</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="n">remote</span><span class="p">(</span><span class="n">parent_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
    <span class="n">favorite_node</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Node&quot;</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="n">favorite_node_id</span> <span class="o">==</span> <span class="n">remote</span><span class="p">(</span><span class="n">id</span><span class="p">),</span> <span class="n">post_update</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">__mapper_args__</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;version_id_col&quot;</span><span class="p">:</span> <span class="n">version_id</span><span class="p">}</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>An UPDATE of a node that associates another node as “favorite” will
now increment the version counter as well as match the current version:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># node is now version #1</span>

<span class="n">node</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Node</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="n">node</span><span class="o">.</span><span class="n">favorite_node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">()</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># node is now version #2</span></pre></div>
</div>
<p>Note that this means an object that receives an UPDATE in response to
other attributes changing, and a second UPDATE due to a post_update
relationship change, will now receive
<strong>two version counter updates for one flush</strong>.   However, if the object
is subject to an INSERT within the current flush, the version counter
<strong>will not</strong> be incremented an additional time, unless a server-side
versioning scheme is in place.</p>
<p>The reason post_update emits an UPDATE even for an UPDATE is now discussed at
<a class="reference internal" href="../faq/sessions.html#faq-post-update-update"><span class="std std-ref">为什么 post_update 除了第一个 UPDATE 之外还会发出 UPDATE？</span></a>.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../orm/relationship_persistence.html#post-update"><span class="std std-ref">指向自身的行/相互依赖的行</span></a></p>
<p><a class="reference internal" href="../faq/sessions.html#faq-post-update-update"><span class="std std-ref">为什么 post_update 除了第一个 UPDATE 之外还会发出 UPDATE？</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3496">#3496</a></p>
</section>
</section>
<section id="key-behavioral-changes-core">
<h2>Key Behavioral Changes - Core<a class="headerlink" href="#key-behavioral-changes-core" title="Link to this heading">¶</a></h2>
<section id="the-typing-behavior-of-custom-operators-has-been-made-consistent">
<span id="change-4063"></span><h3>The typing behavior of custom operators has been made consistent<a class="headerlink" href="#the-typing-behavior-of-custom-operators-has-been-made-consistent" title="Link to this heading">¶</a></h3>
<p>User defined operators can be made on the fly using the
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.Operators.op" title="sqlalchemy.sql.expression.Operators.op"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.op()</span></code></a> function.   Previously, the typing behavior of
an expression against such an operator was inconsistent and also not
controllable.</p>
<p>Whereas in 1.1, an expression such as the following would produce
a result with no return type (assume <code class="docutils literal notranslate"><span class="pre">-%&gt;</span></code> is some special operator
supported by the database):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="s2">&quot;-%&gt;&quot;</span><span class="p">)(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
<span class="go">NullType()</span></pre></div>
</div>
<p>Other types would use the default behavior of using the left-hand type
as the return type:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="s2">&quot;-%&gt;&quot;</span><span class="p">)(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
<span class="go">String(length=50)</span></pre></div>
</div>
<p>These behaviors were mostly by accident, so the behavior has been made
consistent with the second form, that is the default return type is the
same as the left-hand expression:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="s2">&quot;-%&gt;&quot;</span><span class="p">)(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
<span class="go">DateTime()</span></pre></div>
</div>
<p>As most user-defined operators tend to be “comparison” operators, often
one of the many special operators defined by PostgreSQL, the
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.Operators.op.params.is_comparison" title="sqlalchemy.sql.expression.Operators.op"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Operators.op.is_comparison</span></code></a> flag has been repaired to follow
its documented behavior of allowing the return type to be <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Boolean" title="sqlalchemy.types.Boolean"><code class="xref py py-class docutils literal notranslate"><span class="pre">Boolean</span></code></a>
in all cases, including for <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.ARRAY" title="sqlalchemy.types.ARRAY"><code class="xref py py-class docutils literal notranslate"><span class="pre">ARRAY</span></code></a> and <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="s2">&quot;-%&gt;&quot;</span><span class="p">,</span> <span class="n">is_comparison</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
<span class="go">Boolean()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ARRAY</span><span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">))</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="s2">&quot;-%&gt;&quot;</span><span class="p">,</span> <span class="n">is_comparison</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
<span class="go">Boolean()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">JSON</span><span class="p">())</span><span class="o">.</span><span class="n">op</span><span class="p">(</span><span class="s2">&quot;-%&gt;&quot;</span><span class="p">,</span> <span class="n">is_comparison</span><span class="o">=</span><span class="kc">True</span><span class="p">)(</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">type</span>
<span class="go">Boolean()</span></pre></div>
</div>
<p>To assist with boolean comparison operators, a new shorthand method
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.Operators.bool_op" title="sqlalchemy.sql.expression.Operators.bool_op"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Operators.bool_op()</span></code></a> has been added.    This method should be preferred
for on-the-fly boolean operators:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span><span class="o">.</span><span class="n">bool_op</span><span class="p">(</span><span class="s2">&quot;-%&gt;&quot;</span><span class="p">)(</span><span class="mi">5</span><span class="p">))</span>
<div class='show_sql_print'><span class="n">x</span><span class="w"> </span><span class="o">-%&gt;</span><span class="w"> </span><span class="p">:</span><span class="n">x_1</span>
</div></pre></div>
</div>
</section>
<section id="percent-signs-in-literal-column-now-conditionally-escaped">
<span id="change-3740"></span><h3>Percent signs in literal_column() now conditionally escaped<a class="headerlink" href="#percent-signs-in-literal-column-now-conditionally-escaped" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.literal_column" title="sqlalchemy.sql.expression.literal_column"><code class="xref py py-obj docutils literal notranslate"><span class="pre">literal_column</span></code></a> construct now escapes percent sign characters
conditionally, based on whether or not the DBAPI in use makes use of a
percent-sign-sensitive paramstyle or not (e.g. ‘format’ or ‘pyformat’).</p>
<p>Previously, it was not possible to produce a <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.literal_column" title="sqlalchemy.sql.expression.literal_column"><code class="xref py py-obj docutils literal notranslate"><span class="pre">literal_column</span></code></a>
construct that stated a single percent sign:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">literal_column</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">literal_column</span><span class="p">(</span><span class="s2">&quot;some</span><span class="si">%s</span><span class="s2">ymbol&quot;</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">some</span><span class="o">%%</span><span class="n">symbol</span>
</div></pre></div>
</div>
<p>The percent sign is now unaffected for dialects that are not set to
use the ‘format’ or ‘pyformat’ paramstyles; dialects such most MySQL
dialects which do state one of these paramstyles will continue to escape
as is appropriate:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">literal_column</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">literal_column</span><span class="p">(</span><span class="s2">&quot;some</span><span class="si">%s</span><span class="s2">ymbol&quot;</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">some</span><span class="o">%</span><span class="n">symbol</span>
</div><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects</span><span class="w"> </span><span class="kn">import</span> <span class="n">mysql</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">literal_column</span><span class="p">(</span><span class="s2">&quot;some</span><span class="si">%s</span><span class="s2">ymbol&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">mysql</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span>
<div class='show_sql_print'><span class="k">some</span><span class="o">%%</span><span class="n">symbol</span>
</div></pre></div>
</div>
<p>As part of this change, the doubling that has been present when using
operators like <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnOperators.contains" title="sqlalchemy.sql.expression.ColumnOperators.contains"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.contains()</span></code></a>,
<a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnOperators.startswith" title="sqlalchemy.sql.expression.ColumnOperators.startswith"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.startswith()</span></code></a> and <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnOperators.endswith" title="sqlalchemy.sql.expression.ColumnOperators.endswith"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.endswith()</span></code></a>
is also refined to only occur when appropriate.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3740">#3740</a></p>
</section>
<section id="the-column-level-collate-keyword-now-quotes-the-collation-name">
<span id="change-3785"></span><h3>The column-level COLLATE keyword now quotes the collation name<a class="headerlink" href="#the-column-level-collate-keyword-now-quotes-the-collation-name" title="Link to this heading">¶</a></h3>
<p>A bug in the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.collate" title="sqlalchemy.sql.expression.collate"><code class="xref py py-func docutils literal notranslate"><span class="pre">collate()</span></code></a> and <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnOperators.collate" title="sqlalchemy.sql.expression.ColumnOperators.collate"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.collate()</span></code></a>
functions, used to supply ad-hoc column collations at the statement level,
is fixed, where a case sensitive name would not be quoted:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">stmt</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">mytable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">mytable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">y</span><span class="p">])</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
    <span class="n">mytable</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">somecolumn</span><span class="o">.</span><span class="n">collate</span><span class="p">(</span><span class="s2">&quot;fr_FR&quot;</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>now renders:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">mytable</span><span class="p">.</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">mytable</span><span class="p">.</span><span class="n">y</span><span class="p">,</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">mytable</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">mytable</span><span class="p">.</span><span class="n">somecolumn</span><span class="w"> </span><span class="k">COLLATE</span><span class="w"> </span><span class="ss">&quot;fr_FR&quot;</span></pre></div>
</div>
<p>Previously, the case sensitive name <cite>“fr_FR”</cite> would not be quoted.   Currently,
manual quoting of the “fr_FR” name is <strong>not</strong> detected, so applications that
are manually quoting the identifier should be adjusted.   Note that this change
does not impact the use of collations at the type level (e.g. specified
on the datatype like <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String" title="sqlalchemy.types.String"><code class="xref py py-class docutils literal notranslate"><span class="pre">String</span></code></a> at the table level), where quoting
is already applied.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3785">#3785</a></p>
</section>
</section>
<section id="dialect-improvements-and-changes-postgresql">
<h2>Dialect Improvements and Changes - PostgreSQL<a class="headerlink" href="#dialect-improvements-and-changes-postgresql" title="Link to this heading">¶</a></h2>
<section id="support-for-batch-mode-fast-execution-helpers">
<span id="change-4109"></span><h3>Support for Batch Mode / Fast Execution Helpers<a class="headerlink" href="#support-for-batch-mode-fast-execution-helpers" title="Link to this heading">¶</a></h3>
<p>The psycopg2 <code class="docutils literal notranslate"><span class="pre">cursor.executemany()</span></code> method has been identified as performing
poorly, particularly with INSERT statements.   To alleviate this, psycopg2
has added <a class="reference external" href="https://www.psycopg.org/docs/extras.html#fast-execution-helpers">Fast Execution Helpers</a>
which rework statements into fewer server round trips by sending multiple
DML statements in batch.   SQLAlchemy 1.2 now includes support for these
helpers to be used transparently whenever the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine" title="sqlalchemy.engine.Engine"><code class="xref py py-class docutils literal notranslate"><span class="pre">Engine</span></code></a> makes use
of <code class="docutils literal notranslate"><span class="pre">cursor.executemany()</span></code> to invoke a statement against multiple parameter
sets.   The feature is off by default and can be enabled using the
<code class="docutils literal notranslate"><span class="pre">use_batch_mode</span></code> argument on <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span>
    <span class="s2">&quot;postgresql+psycopg2://scott:tiger@host/dbname&quot;</span><span class="p">,</span> <span class="n">use_batch_mode</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span></pre></div>
</div>
<p>The feature is considered to be experimental for the moment but may become
on by default in a future release.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../dialects/postgresql.html#psycopg2-batch-mode"><span class="std std-ref">Psycopg2 Fast Execution Helpers</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4109">#4109</a></p>
</section>
<section id="support-for-fields-specification-in-interval-including-full-reflection">
<span id="change-3959"></span><h3>Support for fields specification in INTERVAL, including full reflection<a class="headerlink" href="#support-for-fields-specification-in-interval-including-full-reflection" title="Link to this heading">¶</a></h3>
<p>The “fields” specifier in PostgreSQL’s INTERVAL datatype allows specification
of which fields of the interval to store, including such values as “YEAR”,
“MONTH”, “YEAR TO MONTH”, etc.   The <a class="reference internal" href="../dialects/postgresql.html#sqlalchemy.dialects.postgresql.INTERVAL" title="sqlalchemy.dialects.postgresql.INTERVAL"><code class="xref py py-class docutils literal notranslate"><span class="pre">INTERVAL</span></code></a> datatype
now allows these values to be specified:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects.postgresql</span><span class="w"> </span><span class="kn">import</span> <span class="n">INTERVAL</span>

<span class="n">Table</span><span class="p">(</span><span class="s2">&quot;my_table&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;some_interval&quot;</span><span class="p">,</span> <span class="n">INTERVAL</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="s2">&quot;DAY TO SECOND&quot;</span><span class="p">)))</span></pre></div>
</div>
<p>Additionally, all INTERVAL datatypes can now be reflected independently
of the “fields” specifier present; the “fields” parameter in the datatype
itself will also be present:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">inspect</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span><span class="o">.</span><span class="n">get_columns</span><span class="p">(</span><span class="s2">&quot;my_table&quot;</span><span class="p">)</span>
<span class="go">[{&#39;comment&#39;: None,</span>
<span class="go">  &#39;name&#39;: u&#39;some_interval&#39;, &#39;nullable&#39;: True,</span>
<span class="go">  &#39;default&#39;: None, &#39;autoincrement&#39;: False,</span>
<span class="go">  &#39;type&#39;: INTERVAL(fields=u&#39;day to second&#39;)}]</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3959">#3959</a></p>
</section>
</section>
<section id="dialect-improvements-and-changes-mysql">
<h2>Dialect Improvements and Changes - MySQL<a class="headerlink" href="#dialect-improvements-and-changes-mysql" title="Link to this heading">¶</a></h2>
<section id="support-for-insert-on-duplicate-key-update">
<span id="change-4009"></span><h3>Support for INSERT..ON DUPLICATE KEY UPDATE<a class="headerlink" href="#support-for-insert-on-duplicate-key-update" title="Link to this heading">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">ON</span> <span class="pre">DUPLICATE</span> <span class="pre">KEY</span> <span class="pre">UPDATE</span></code> clause of <code class="docutils literal notranslate"><span class="pre">INSERT</span></code> supported by MySQL
is now supported using a MySQL-specific version of the
<a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> object, via <code class="xref py py-func docutils literal notranslate"><span class="pre">sqlalchemy.dialects.mysql.dml.insert()</span></code>.
This <a class="reference internal" href="../core/dml.html#sqlalchemy.sql.expression.Insert" title="sqlalchemy.sql.expression.Insert"><code class="xref py py-class docutils literal notranslate"><span class="pre">Insert</span></code></a> subclass adds a new method
<code class="xref py py-meth docutils literal notranslate"><span class="pre">Insert.on_duplicate_key_update()</span></code> that implements MySQL’s syntax:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects.mysql</span><span class="w"> </span><span class="kn">import</span> <span class="n">insert</span>

<span class="n">insert_stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">my_table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;some_id&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">&quot;some data to insert&quot;</span><span class="p">)</span>

<span class="n">on_conflict_stmt</span> <span class="o">=</span> <span class="n">insert_stmt</span><span class="o">.</span><span class="n">on_duplicate_key_update</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">insert_stmt</span><span class="o">.</span><span class="n">inserted</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">status</span><span class="o">=</span><span class="s2">&quot;U&quot;</span>
<span class="p">)</span>

<span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">on_conflict_stmt</span><span class="p">)</span></pre></div>
</div>
<p>The above will render:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">INSERT</span><span class="w"> </span><span class="k">INTO</span><span class="w"> </span><span class="n">my_table</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">)</span>
<span class="k">VALUES</span><span class="w"> </span><span class="p">(:</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="p">:</span><span class="k">data</span><span class="p">)</span>
<span class="k">ON</span><span class="w"> </span><span class="n">DUPLICATE</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">data</span><span class="o">=</span><span class="k">VALUES</span><span class="p">(</span><span class="k">data</span><span class="p">),</span><span class="w"> </span><span class="n">status</span><span class="o">=</span><span class="p">:</span><span class="n">status_1</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../dialects/mysql.html#mysql-insert-on-duplicate-key-update"><span class="std std-ref">INSERT…ON DUPLICATE KEY UPDATE (Upsert)</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4009">#4009</a></p>
</section>
</section>
<section id="dialect-improvements-and-changes-oracle">
<h2>Dialect Improvements and Changes - Oracle<a class="headerlink" href="#dialect-improvements-and-changes-oracle" title="Link to this heading">¶</a></h2>
<section id="major-refactor-to-cx-oracle-dialect-typing-system">
<span id="change-cxoracle-12"></span><h3>Major Refactor to cx_Oracle Dialect, Typing System<a class="headerlink" href="#major-refactor-to-cx-oracle-dialect-typing-system" title="Link to this heading">¶</a></h3>
<p>With the introduction of the 6.x series of the cx_Oracle DBAPI, SQLAlchemy’s
cx_Oracle dialect has been reworked and simplified to take advantage of recent
improvements in cx_Oracle as well as dropping support for patterns that were
more relevant before the 5.x series of cx_Oracle.</p>
<ul>
<li><p>The minimum cx_Oracle version supported is now 5.1.3; 5.3 or the most recent
6.x series are recommended.</p></li>
<li><p>The handling of datatypes has been refactored.  The <code class="docutils literal notranslate"><span class="pre">cursor.setinputsizes()</span></code>
method is no longer used for any datatype except LOB types, per advice from
cx_Oracle’s developers. As a result, the parameters <code class="docutils literal notranslate"><span class="pre">auto_setinputsizes</span></code>
and <code class="docutils literal notranslate"><span class="pre">exclude_setinputsizes</span></code> are deprecated and no longer have any effect.</p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">coerce_to_decimal</span></code> flag, when set to False to indicate that coercion
of numeric types with precision and scale to <code class="docutils literal notranslate"><span class="pre">Decimal</span></code> should not occur,
only impacts untyped (e.g. plain string with no <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine" title="sqlalchemy.types.TypeEngine"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeEngine</span></code></a> objects)
statements. A Core expression that includes a <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Numeric" title="sqlalchemy.types.Numeric"><code class="xref py py-class docutils literal notranslate"><span class="pre">Numeric</span></code></a> type or
subtype will now follow the decimal coercion rules of that type.</p></li>
<li><p>The “two phase” transaction support in the dialect, already dropped for the
6.x series of cx_Oracle, has now been removed entirely as this feature has
never worked correctly and is unlikely to have been in production use.
As a result, the <code class="docutils literal notranslate"><span class="pre">allow_twophase</span></code> dialect flag is deprecated and also has no
effect.</p></li>
<li><p>Fixed a bug involving the column keys present with RETURNING.  Given
a statement as follows:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">returning</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b</span><span class="p">))</span></pre></div>
</div>
<p>Previously, the keys in each row of the result would be <code class="docutils literal notranslate"><span class="pre">ret_0</span></code> and <code class="docutils literal notranslate"><span class="pre">ret_1</span></code>,
which are identifiers internal to the cx_Oracle RETURNING implementation.
The keys will now be <code class="docutils literal notranslate"><span class="pre">a</span></code> and <code class="docutils literal notranslate"><span class="pre">b</span></code> as is expected for other dialects.</p>
</li>
<li><p>cx_Oracle’s LOB datatype represents return values as a <code class="docutils literal notranslate"><span class="pre">cx_Oracle.LOB</span></code>
object, which is a cursor-associated proxy that returns the ultimate data
value via a <code class="docutils literal notranslate"><span class="pre">.read()</span></code> method.  Historically, if more rows were read before
these LOB objects were consumed (specifically, more rows than the value of
cursor.arraysize which causes a new batch of rows to be read), these LOB
objects would raise the error “LOB variable no longer valid after subsequent
fetch”. SQLAlchemy worked around this by both automatically calling
<code class="docutils literal notranslate"><span class="pre">.read()</span></code> upon these LOBs within its typing system, as well as using a
special <code class="docutils literal notranslate"><span class="pre">BufferedColumnResultSet</span></code> which would ensure this data was buffered
in case a call like <code class="docutils literal notranslate"><span class="pre">cursor.fetchmany()</span></code> or <code class="docutils literal notranslate"><span class="pre">cursor.fetchall()</span></code> were
used.</p>
<p>The dialect now makes use of a cx_Oracle outputtypehandler to handle these
<code class="docutils literal notranslate"><span class="pre">.read()</span></code> calls, so that they are always called up front regardless of how
many rows are being fetched, so that this error can no longer occur.  As a
result, the use of the <code class="docutils literal notranslate"><span class="pre">BufferedColumnResultSet</span></code>, as well as some other
internals to the Core <code class="docutils literal notranslate"><span class="pre">ResultSet</span></code> that were specific to this use case,
have been removed.   The type objects are also simplified as they no longer
need to process a binary column result.</p>
<p>Additionally, cx_Oracle 6.x has removed the conditions under which this error
occurs in any case, so the error is no longer possible.   The error
can occur on SQLAlchemy in the case that the seldom (if ever) used
<code class="docutils literal notranslate"><span class="pre">auto_convert_lobs=False</span></code> option is in use, in conjunction with the
previous 5.x series of cx_Oracle, and more rows are read before the LOB
objects can be consumed.  Upgrading to cx_Oracle 6.x will resolve that issue.</p>
</li>
</ul>
</section>
<section id="oracle-unique-check-constraints-now-reflected">
<span id="change-4003"></span><h3>Oracle Unique, Check constraints now reflected<a class="headerlink" href="#oracle-unique-check-constraints-now-reflected" title="Link to this heading">¶</a></h3>
<p>UNIQUE and CHECK constraints now reflect via
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_unique_constraints" title="sqlalchemy.engine.reflection.Inspector.get_unique_constraints"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_unique_constraints()</span></code></a> and
<a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_check_constraints" title="sqlalchemy.engine.reflection.Inspector.get_check_constraints"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_check_constraints()</span></code></a>.  A <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> object  that’s
reflected will now include <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.CheckConstraint" title="sqlalchemy.schema.CheckConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">CheckConstraint</span></code></a> objects as well.
See the notes at <a class="reference internal" href="../dialects/oracle.html#oracle-constraint-reflection"><span class="std std-ref">Constraint Reflection</span></a> for information
on behavioral quirks here, including that most <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> objects
will still not include any <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">UniqueConstraint</span></code></a> objects as these
usually represent via <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Index" title="sqlalchemy.schema.Index"><code class="xref py py-class docutils literal notranslate"><span class="pre">Index</span></code></a>.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../dialects/oracle.html#oracle-constraint-reflection"><span class="std std-ref">Constraint Reflection</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4003">#4003</a></p>
</section>
<section id="oracle-foreign-key-constraint-names-are-now-name-normalized">
<span id="change-3276"></span><h3>Oracle foreign key constraint names are now “name normalized”<a class="headerlink" href="#oracle-foreign-key-constraint-names-are-now-name-normalized" title="Link to this heading">¶</a></h3>
<p>The names of foreign key constraints as delivered to a
<a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.ForeignKeyConstraint" title="sqlalchemy.schema.ForeignKeyConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">ForeignKeyConstraint</span></code></a> object during table reflection as well as
within the <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_foreign_keys" title="sqlalchemy.engine.reflection.Inspector.get_foreign_keys"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_foreign_keys()</span></code></a> method will now be
“name normalized”, that is, expressed as lower case for a case insensitive
name, rather than the raw UPPERCASE format that Oracle uses:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">insp</span><span class="o">.</span><span class="n">get_indexes</span><span class="p">(</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span>
<span class="go">[{&#39;unique&#39;: False, &#39;column_names&#39;: [u&#39;user_id&#39;],</span>
<span class="go">  &#39;name&#39;: u&#39;address_idx&#39;, &#39;dialect_options&#39;: {}}]</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">insp</span><span class="o">.</span><span class="n">get_pk_constraint</span><span class="p">(</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span>
<span class="go">{&#39;name&#39;: u&#39;pk_cons&#39;, &#39;constrained_columns&#39;: [u&#39;id&#39;]}</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">insp</span><span class="o">.</span><span class="n">get_foreign_keys</span><span class="p">(</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span>
<span class="go">[{&#39;referred_table&#39;: u&#39;users&#39;, &#39;referred_columns&#39;: [u&#39;id&#39;],</span>
<span class="go">  &#39;referred_schema&#39;: None, &#39;name&#39;: u&#39;user_id_fk&#39;,</span>
<span class="go">  &#39;constrained_columns&#39;: [u&#39;user_id&#39;]}]</span></pre></div>
</div>
<p>Previously, the foreign keys result would look like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span>
    <span class="p">{</span>
        <span class="s2">&quot;referred_table&quot;</span><span class="p">:</span> <span class="s2">&quot;users&quot;</span><span class="p">,</span>
        <span class="s2">&quot;referred_columns&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">],</span>
        <span class="s2">&quot;referred_schema&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;USER_ID_FK&quot;</span><span class="p">,</span>
        <span class="s2">&quot;constrained_columns&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;user_id&quot;</span><span class="p">],</span>
    <span class="p">}</span>
<span class="p">]</span></pre></div>
</div>
<p>Where the above could create problems particularly with Alembic autogenerate.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3276">#3276</a></p>
</section>
</section>
<section id="dialect-improvements-and-changes-sql-server">
<h2>Dialect Improvements and Changes - SQL Server<a class="headerlink" href="#dialect-improvements-and-changes-sql-server" title="Link to this heading">¶</a></h2>
<section id="sql-server-schema-names-with-embedded-dots-supported">
<span id="change-2626"></span><h3>SQL Server schema names with embedded dots supported<a class="headerlink" href="#sql-server-schema-names-with-embedded-dots-supported" title="Link to this heading">¶</a></h3>
<p>The SQL Server dialect has a behavior such that a schema name with a dot inside
of it is assumed to be a “database”.”owner” identifier pair, which is
necessarily split up into these separate components during table and component
reflection operations, as well as when rendering quoting for the schema name so
that the two symbols are quoted separately.  The schema argument can
now be passed using brackets to manually specify where this split
occurs, allowing database and/or owner names that themselves contain one
or more dots:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Table</span><span class="p">(</span><span class="s2">&quot;some_table&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span> <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;[MyDataBase.dbo]&quot;</span><span class="p">)</span></pre></div>
</div>
<p>The above table will consider the “owner” to be <code class="docutils literal notranslate"><span class="pre">MyDataBase.dbo</span></code>, which
will also be quoted upon render, and the “database” as None.  To individually
refer to database name and owner, use two pairs of brackets:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;some_table&quot;</span><span class="p">,</span>
    <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">)),</span>
    <span class="n">schema</span><span class="o">=</span><span class="s2">&quot;[MyDataBase.SomeDB].[MyDB.owner]&quot;</span><span class="p">,</span>
<span class="p">)</span></pre></div>
</div>
<p>Additionally, the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.quoted_name" title="sqlalchemy.sql.expression.quoted_name"><code class="xref py py-class docutils literal notranslate"><span class="pre">quoted_name</span></code></a> construct is now honored when
passed to “schema” by the SQL Server dialect; the given symbol will
not be split on the dot if the quote flag is True and will be interpreted
as the “owner”.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../dialects/mssql.html#multipart-schema-names"><span class="std std-ref">Multipart Schema Names</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/2626">#2626</a></p>
</section>
<section id="autocommit-isolation-level-support">
<h3>AUTOCOMMIT isolation level support<a class="headerlink" href="#autocommit-isolation-level-support" title="Link to this heading">¶</a></h3>
<p>Both the PyODBC and pymssql dialects now support the “AUTOCOMMIT” isolation
level as set by <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection.execution_options" title="sqlalchemy.engine.Connection.execution_options"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Connection.execution_options()</span></code></a> which will establish
the correct flags on the DBAPI connection object.</p>
</section>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="migration_11.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">What’s New in SQLAlchemy 1.1?</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="migration_13.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">What’s New in SQLAlchemy 1.3?</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                <a href="../copyright.html">Copyright</a> &#169; 2007-2025, the SQLAlchemy authors and contributors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on 04/05/2025 04:00:26</div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">What’s New in SQLAlchemy 1.2?</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#platform-support">Platform Support</a><ul>
<li><a class="reference internal" href="#targeting-python-2-7-and-up">Targeting Python 2.7 and Up</a></li>
</ul>
</li>
<li><a class="reference internal" href="#new-features-and-improvements-orm">New Features and Improvements - ORM</a><ul>
<li><a class="reference internal" href="#baked-loading-now-the-default-for-lazy-loads">“Baked” loading now the default for lazy loads</a></li>
<li><a class="reference internal" href="#new-selectin-eager-loading-loads-all-collections-at-once-using-in">New “selectin” eager loading, loads all collections at once using IN</a></li>
<li><a class="reference internal" href="#selectin-polymorphic-loading-loads-subclasses-using-separate-in-queries">“selectin” polymorphic loading, loads subclasses using separate IN queries</a></li>
<li><a class="reference internal" href="#orm-attributes-that-can-receive-ad-hoc-sql-expressions">ORM attributes that can receive ad-hoc SQL expressions</a></li>
<li><a class="reference internal" href="#orm-support-of-multiple-table-deletes">ORM Support of multiple-table deletes</a></li>
<li><a class="reference internal" href="#support-for-bulk-updates-of-hybrids-composites">Support for bulk updates of hybrids, composites</a></li>
<li><a class="reference internal" href="#hybrid-attributes-support-reuse-among-subclasses-redefinition-of-getter">Hybrid attributes support reuse among subclasses, redefinition of &#64;getter</a></li>
<li><a class="reference internal" href="#new-bulk-replace-event">New bulk_replace event</a></li>
<li><a class="reference internal" href="#new-modified-event-handler-for-sqlalchemy-ext-mutable">New “modified” event handler for sqlalchemy.ext.mutable</a></li>
<li><a class="reference internal" href="#added-for-update-arguments-to-session-refresh">Added “for update” arguments to Session.refresh</a></li>
<li><a class="reference internal" href="#in-place-mutation-operators-work-for-mutableset-mutablelist">In-place mutation operators work for MutableSet, MutableList</a></li>
<li><a class="reference internal" href="#associationproxy-any-has-contains-work-with-chained-association-proxies">AssociationProxy any(), has(), contains() work with chained association proxies</a></li>
<li><a class="reference internal" href="#change-4137">Identity key enhancements to support sharding</a></li>
</ul>
</li>
<li><a class="reference internal" href="#new-features-and-improvements-core">New Features and Improvements - Core</a><ul>
<li><a class="reference internal" href="#boolean-datatype-now-enforces-strict-true-false-none-values">Boolean datatype now enforces strict True/False/None values</a></li>
<li><a class="reference internal" href="#pessimistic-disconnection-detection-added-to-the-connection-pool">Pessimistic disconnection detection added to the connection pool</a></li>
<li><a class="reference internal" href="#the-in-not-in-operator-s-empty-collection-behavior-is-now-configurable-default-expression-simplified">The IN / NOT IN operator’s empty collection behavior is now configurable; default expression simplified</a></li>
<li><a class="reference internal" href="#late-expanded-in-parameter-sets-allow-in-expressions-with-cached-statements">Late-expanded IN parameter sets allow IN expressions with cached statements</a></li>
<li><a class="reference internal" href="#flattened-operator-precedence-for-comparison-operators">Flattened operator precedence for comparison operators</a></li>
<li><a class="reference internal" href="#support-for-sql-comments-on-table-column-includes-ddl-reflection">Support for SQL Comments on Table, Column, includes DDL, reflection</a></li>
<li><a class="reference internal" href="#multiple-table-criteria-support-for-delete">Multiple-table criteria support for DELETE</a></li>
<li><a class="reference internal" href="#new-autoescape-option-for-startswith-endswith">New “autoescape” option for startswith(), endswith()</a></li>
<li><a class="reference internal" href="#stronger-typing-added-to-float-datatypes">Stronger typing added to “float” datatypes</a></li>
<li><a class="reference internal" href="#support-for-grouping-sets-cube-rollup">Support for GROUPING SETS, CUBE, ROLLUP</a></li>
<li><a class="reference internal" href="#parameter-helper-for-multi-valued-insert-with-contextual-default-generator">Parameter helper for multi-valued INSERT with contextual default generator</a></li>
</ul>
</li>
<li><a class="reference internal" href="#key-behavioral-changes-orm">Key Behavioral Changes - ORM</a><ul>
<li><a class="reference internal" href="#the-after-rollback-session-event-now-emits-before-the-expiration-of-objects">The after_rollback() Session event now emits before the expiration of objects</a></li>
<li><a class="reference internal" href="#fixed-issue-involving-single-table-inheritance-with-select-from">Fixed issue involving single-table inheritance with <code class="docutils literal notranslate"><span class="pre">select_from()</span></code></a></li>
<li><a class="reference internal" href="#previous-collection-is-no-longer-mutated-upon-replacement">Previous collection is no longer mutated upon replacement</a></li>
<li><a class="reference internal" href="#a-validates-method-receives-all-values-on-bulk-collection-set-before-comparison">A &#64;validates method receives all values on bulk-collection set before comparison</a></li>
<li><a class="reference internal" href="#use-flag-dirty-to-mark-an-object-as-dirty-without-any-attribute-changing">Use flag_dirty() to mark an object as “dirty” without any attribute changing</a></li>
<li><a class="reference internal" href="#scope-keyword-removed-from-scoped-session">“scope” keyword removed from scoped_session</a></li>
<li><a class="reference internal" href="#refinements-to-post-update-in-conjunction-with-onupdate">Refinements to post_update in conjunction with onupdate</a></li>
<li><a class="reference internal" href="#post-update-integrates-with-orm-versioning">post_update integrates with ORM versioning</a></li>
</ul>
</li>
<li><a class="reference internal" href="#key-behavioral-changes-core">Key Behavioral Changes - Core</a><ul>
<li><a class="reference internal" href="#the-typing-behavior-of-custom-operators-has-been-made-consistent">The typing behavior of custom operators has been made consistent</a></li>
<li><a class="reference internal" href="#percent-signs-in-literal-column-now-conditionally-escaped">Percent signs in literal_column() now conditionally escaped</a></li>
<li><a class="reference internal" href="#the-column-level-collate-keyword-now-quotes-the-collation-name">The column-level COLLATE keyword now quotes the collation name</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dialect-improvements-and-changes-postgresql">Dialect Improvements and Changes - PostgreSQL</a><ul>
<li><a class="reference internal" href="#support-for-batch-mode-fast-execution-helpers">Support for Batch Mode / Fast Execution Helpers</a></li>
<li><a class="reference internal" href="#support-for-fields-specification-in-interval-including-full-reflection">Support for fields specification in INTERVAL, including full reflection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dialect-improvements-and-changes-mysql">Dialect Improvements and Changes - MySQL</a><ul>
<li><a class="reference internal" href="#support-for-insert-on-duplicate-key-update">Support for INSERT..ON DUPLICATE KEY UPDATE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dialect-improvements-and-changes-oracle">Dialect Improvements and Changes - Oracle</a><ul>
<li><a class="reference internal" href="#major-refactor-to-cx-oracle-dialect-typing-system">Major Refactor to cx_Oracle Dialect, Typing System</a></li>
<li><a class="reference internal" href="#oracle-unique-check-constraints-now-reflected">Oracle Unique, Check constraints now reflected</a></li>
<li><a class="reference internal" href="#oracle-foreign-key-constraint-names-are-now-name-normalized">Oracle foreign key constraint names are now “name normalized”</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dialect-improvements-and-changes-sql-server">Dialect Improvements and Changes - SQL Server</a><ul>
<li><a class="reference internal" href="#sql-server-schema-names-with-embedded-dots-supported">SQL Server schema names with embedded dots supported</a></li>
<li><a class="reference internal" href="#autocommit-isolation-level-support">AUTOCOMMIT isolation level support</a></li>
</ul>
</li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=2d0eb83f"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/tabs.js?v=3ee01567"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=2f3e6152"></script>
    <script src="../_static/translations.js?v=beaddf03"></script>
    </body>
</html>