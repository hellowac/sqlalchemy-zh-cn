<!doctype html>
<html class="no-js" lang="zh-CN" data-content_root="../">
  <head><meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <meta name="color-scheme" content="light dark"><meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="index" title="索引" href="../genindex.html" /><link rel="search" title="搜索" href="../search.html" /><link rel="copyright" title="版权所有" href="../copyright.html" /><link rel="next" title="What’s New in SQLAlchemy 1.2?" href="migration_12.html" /><link rel="prev" title="What’s New in SQLAlchemy 1.4?" href="migration_14.html" />

    <!-- Generated with Sphinx 7.2.6 and Furo 2024.08.06 -->
        <title>What’s New in SQLAlchemy 1.3? - SQLAlchemy 2.1 Documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo.css?v=354aac6f" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=4c969af8" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/changelog.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx_paramlinks.css" />
    <link rel="stylesheet" type="text/css" href="../_static/docs.css" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/furo-extensions.css?v=302659d7" />
    
    


<style>
  body {
    --color-code-background: #eeffcc;
  --color-code-foreground: black;
  
  }
  @media not print {
    body[data-theme="dark"] {
      --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
    }
    @media (prefers-color-scheme: dark) {
      body:not([data-theme="light"]) {
        --color-code-background: #202020;
  --color-code-foreground: #d0d0d0;
  
      }
    }
  }
</style></head>
  <body>
    
    <script>
      document.body.dataset.theme = localStorage.getItem("theme") || "auto";
    </script>
    

<svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
  <symbol id="svg-toc" viewBox="0 0 24 24">
    <title>Contents</title>
    <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024">
      <path d="M408 442h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8zm-8 204c0 4.4 3.6 8 8 8h480c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8H408c-4.4 0-8 3.6-8 8v56zm504-486H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zm0 632H120c-4.4 0-8 3.6-8 8v56c0 4.4 3.6 8 8 8h784c4.4 0 8-3.6 8-8v-56c0-4.4-3.6-8-8-8zM115.4 518.9L271.7 642c5.8 4.6 14.4.5 14.4-6.9V388.9c0-7.4-8.5-11.5-14.4-6.9L115.4 505.1a8.74 8.74 0 0 0 0 13.8z"/>
    </svg>
  </symbol>
  <symbol id="svg-menu" viewBox="0 0 24 24">
    <title>Menu</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-menu">
      <line x1="3" y1="12" x2="21" y2="12"></line>
      <line x1="3" y1="6" x2="21" y2="6"></line>
      <line x1="3" y1="18" x2="21" y2="18"></line>
    </svg>
  </symbol>
  <symbol id="svg-arrow-right" viewBox="0 0 24 24">
    <title>Expand</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather-chevron-right">
      <polyline points="9 18 15 12 9 6"></polyline>
    </svg>
  </symbol>
  <symbol id="svg-sun" viewBox="0 0 24 24">
    <title>Light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="feather-sun">
      <circle cx="12" cy="12" r="5"></circle>
      <line x1="12" y1="1" x2="12" y2="3"></line>
      <line x1="12" y1="21" x2="12" y2="23"></line>
      <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
      <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
      <line x1="1" y1="12" x2="3" y2="12"></line>
      <line x1="21" y1="12" x2="23" y2="12"></line>
      <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
      <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
    </svg>
  </symbol>
  <symbol id="svg-moon" viewBox="0 0 24 24">
    <title>Dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-moon">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M12 3c.132 0 .263 0 .393 0a7.5 7.5 0 0 0 7.92 12.446a9 9 0 1 1 -8.313 -12.454z" />
    </svg>
  </symbol>
  <symbol id="svg-sun-with-moon" viewBox="0 0 24 24">
    <title>Auto light/dark, in light mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path style="opacity: 50%" d="M 5.411 14.504 C 5.471 14.504 5.532 14.504 5.591 14.504 C 3.639 16.319 4.383 19.569 6.931 20.352 C 7.693 20.586 8.512 20.551 9.25 20.252 C 8.023 23.207 4.056 23.725 2.11 21.184 C 0.166 18.642 1.702 14.949 4.874 14.536 C 5.051 14.512 5.231 14.5 5.411 14.5 L 5.411 14.504 Z"/>
      <line x1="14.5" y1="3.25" x2="14.5" y2="1.25"/>
      <line x1="14.5" y1="15.85" x2="14.5" y2="17.85"/>
      <line x1="10.044" y1="5.094" x2="8.63" y2="3.68"/>
      <line x1="19" y1="14.05" x2="20.414" y2="15.464"/>
      <line x1="8.2" y1="9.55" x2="6.2" y2="9.55"/>
      <line x1="20.8" y1="9.55" x2="22.8" y2="9.55"/>
      <line x1="10.044" y1="14.006" x2="8.63" y2="15.42"/>
      <line x1="19" y1="5.05" x2="20.414" y2="3.636"/>
      <circle cx="14.5" cy="9.55" r="3.6"/>
    </svg>
  </symbol>
  <symbol id="svg-moon-with-sun" viewBox="0 0 24 24">
    <title>Auto light/dark, in dark mode</title>
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round"
      class="icon-custom-derived-from-feather-sun-and-tabler-moon">
      <path d="M 8.282 7.007 C 8.385 7.007 8.494 7.007 8.595 7.007 C 5.18 10.184 6.481 15.869 10.942 17.24 C 12.275 17.648 13.706 17.589 15 17.066 C 12.851 22.236 5.91 23.143 2.505 18.696 C -0.897 14.249 1.791 7.786 7.342 7.063 C 7.652 7.021 7.965 7 8.282 7 L 8.282 7.007 Z"/>
      <line style="opacity: 50%" x1="18" y1="3.705" x2="18" y2="2.5"/>
      <line style="opacity: 50%" x1="18" y1="11.295" x2="18" y2="12.5"/>
      <line style="opacity: 50%" x1="15.316" y1="4.816" x2="14.464" y2="3.964"/>
      <line style="opacity: 50%" x1="20.711" y1="10.212" x2="21.563" y2="11.063"/>
      <line style="opacity: 50%" x1="14.205" y1="7.5" x2="13.001" y2="7.5"/>
      <line style="opacity: 50%" x1="21.795" y1="7.5" x2="23" y2="7.5"/>
      <line style="opacity: 50%" x1="15.316" y1="10.184" x2="14.464" y2="11.036"/>
      <line style="opacity: 50%" x1="20.711" y1="4.789" x2="21.563" y2="3.937"/>
      <circle style="opacity: 50%" cx="18" cy="7.5" r="2.169"/>
    </svg>
  </symbol>
  <symbol id="svg-pencil" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-pencil-code">
      <path d="M4 20h4l10.5 -10.5a2.828 2.828 0 1 0 -4 -4l-10.5 10.5v4" />
      <path d="M13.5 6.5l4 4" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
  <symbol id="svg-eye" viewBox="0 0 24 24">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
      stroke-width="1" stroke-linecap="round" stroke-linejoin="round" class="icon-tabler-eye-code">
      <path stroke="none" d="M0 0h24v24H0z" fill="none" />
      <path d="M10 12a2 2 0 1 0 4 0a2 2 0 0 0 -4 0" />
      <path
        d="M11.11 17.958c-3.209 -.307 -5.91 -2.293 -8.11 -5.958c2.4 -4 5.4 -6 9 -6c3.6 0 6.6 2 9 6c-.21 .352 -.427 .688 -.647 1.008" />
      <path d="M20 21l2 -2l-2 -2" />
      <path d="M17 17l-2 2l2 2" />
    </svg>
  </symbol>
</svg>

<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation">
<input type="checkbox" class="sidebar-toggle" name="__toc" id="__toc">
<label class="overlay sidebar-overlay" for="__navigation">
  <div class="visually-hidden">Hide navigation sidebar</div>
</label>
<label class="overlay toc-overlay" for="__toc">
  <div class="visually-hidden">Hide table of contents sidebar</div>
</label>

<a class="skip-to-content muted-link" href="#furo-main-content">Skip to content</a>



<div class="page">
  <header class="mobile-header">
    <div class="header-left">
      <label class="nav-overlay-icon" for="__navigation">
        <div class="visually-hidden">Toggle site navigation sidebar</div>
        <i class="icon"><svg><use href="#svg-menu"></use></svg></i>
      </label>
    </div>
    <div class="header-center">
      <a href="../index.html"><div class="brand">SQLAlchemy 2.1 Documentation</div></a>
    </div>
    <div class="header-right">
      <div class="theme-toggle-container theme-toggle-header">
        <button class="theme-toggle">
          <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
          <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
          <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
          <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
          <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
        </button>
      </div>
      <label class="toc-overlay-icon toc-header-icon" for="__toc">
        <div class="visually-hidden">Toggle table of contents sidebar</div>
        <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
      </label>
    </div>
  </header>
  <aside class="sidebar-drawer">
    <div class="sidebar-container">
      
      <div class="sidebar-sticky"><a class="sidebar-brand" href="../index.html">
  
  
  <span class="sidebar-brand-text">SQLAlchemy 2.1 Documentation</span>
  
</a><form class="sidebar-search-container" method="get" action="../search.html" role="search">
  <input class="sidebar-search" placeholder="搜索" name="q" aria-label="搜索">
  <input type="hidden" name="check_keywords" value="yes">
  <input type="hidden" name="area" value="default">
</form>
<div id="searchbox"></div><div class="sidebar-scroll"><div class="sidebar-tree">
  <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">概述</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../tutorial/index.html">SQLAlchemy 统一教程</a><input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" role="switch" type="checkbox"/><label for="toctree-checkbox-1"><div class="visually-hidden">Toggle navigation of SQLAlchemy 统一教程</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/engine.html">建立连接 - Engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/dbapi_transactions.html">使用事务和DBAPI</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/metadata.html">使用数据库元数据</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../tutorial/data.html">处理数据</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" role="switch" type="checkbox"/><label for="toctree-checkbox-2"><div class="visually-hidden">Toggle navigation of 处理数据</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/data_insert.html">使用 INSERT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/data_select.html">使用 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../tutorial/data_update.html">使用 UPDATE 和 DELETE 语句</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/orm_data_manipulation.html">使用 ORM 进行数据操作</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/orm_related_objects.html">使用 ORM 相关对象</a></li>
<li class="toctree-l2"><a class="reference internal" href="../tutorial/further_reading.html">进一步阅读</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../orm/index.html">SQLAlchemy ORM</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" role="switch" type="checkbox"/><label for="toctree-checkbox-3"><div class="visually-hidden">Toggle navigation of SQLAlchemy ORM</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../orm/quickstart.html">ORM 快速入门</a></li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../orm/mapper_config.html">ORM 映射类配置</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" role="switch" type="checkbox"/><label for="toctree-checkbox-4"><div class="visually-hidden">Toggle navigation of ORM 映射类配置</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../orm/mapping_styles.html">ORM 映射类概述</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../orm/declarative_mapping.html">使用声明式映射类</a><input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" role="switch" type="checkbox"/><label for="toctree-checkbox-5"><div class="visually-hidden">Toggle navigation of 使用声明式映射类</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../orm/declarative_styles.html">声明式映射风格</a></li>
<li class="toctree-l4"><a class="reference internal" href="../orm/declarative_tables.html">声明式的表配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../orm/declarative_config.html">使用声明式映射器配置</a></li>
<li class="toctree-l4"><a class="reference internal" href="../orm/declarative_mixins.html">使用 Mixins 组合映射层次结构</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../orm/dataclasses.html">与dataclass和attrs的集成</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/mapped_sql_expr.html">SQL 表达式作为映射属性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/mapped_attributes.html">更改Attribute的行为</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/composites.html">复合列类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/inheritance.html">映射类继承层次结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/nonstandard_mappings.html">非传统映射</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/versioning.html">配置版本计数器</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/mapping_api.html">类映射 API</a></li>
<li class="toctree-l3 has-children"><a class="reference internal" href="../orm/scalar_mapping.html">映射 SQL 表达式</a><input class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" role="switch" type="checkbox"/><label for="toctree-checkbox-6"><div class="visually-hidden">Toggle navigation of 映射 SQL 表达式</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l4"><a class="reference internal" href="../orm/mapping_columns.html">映射表格列</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../orm/relationships.html">关系配置</a><input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" role="switch" type="checkbox"/><label for="toctree-checkbox-7"><div class="visually-hidden">Toggle navigation of 关系配置</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../orm/basic_relationships.html">基本关系模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/self_referential.html">邻接表关系</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/join_conditions.html">配置关系连接方式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/large_collections.html">使用大型集合</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/collection_api.html">集合自定义和 API 详细信息</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/relationship_persistence.html">特殊关系的持久化模式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/backref.html">使用旧版“backref”关系参数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/relationship_api.html">关系 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../orm/queryguide/index.html">ORM 查询指南</a><input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" role="switch" type="checkbox"/><label for="toctree-checkbox-8"><div class="visually-hidden">Toggle navigation of ORM 查询指南</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/select.html">为 ORM 映射类编写 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/inheritance.html">为继承映射编写 SELECT 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/dml.html">启用 ORM 的 INSERT、UPDATE 和 DELETE 语句</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/columns.html">列加载选项</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/relationships.html">关系加载技术</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/api.html">用于查询的 ORM API 功能</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/queryguide/query.html">旧式查询 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../orm/session.html">使用会话</a><input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" role="switch" type="checkbox"/><label for="toctree-checkbox-9"><div class="visually-hidden">Toggle navigation of 使用会话</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../orm/session_basics.html">会话基础知识</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/session_state_management.html">状态管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/cascades.html">级联</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/session_transaction.html">事务和连接管理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/persistence_techniques.html">附加持久性技术</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/contextual.html">上下文/线程本地会话</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/session_events.html">使用事件跟踪查询、对象和会话更改</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/session_api.html">会话 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../orm/extending.html">事件和内部</a><input class="toctree-checkbox" id="toctree-checkbox-10" name="toctree-checkbox-10" role="switch" type="checkbox"/><label for="toctree-checkbox-10"><div class="visually-hidden">Toggle navigation of 事件和内部</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../orm/events.html">ORM 事件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/internals.html">ORM 内部</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/exceptions.html">ORM 异常</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../orm/extensions/index.html">ORM 扩展</a><input class="toctree-checkbox" id="toctree-checkbox-11" name="toctree-checkbox-11" role="switch" type="checkbox"/><label for="toctree-checkbox-11"><div class="visually-hidden">Toggle navigation of ORM 扩展</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/asyncio.html">异步 I/O (asyncio)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/associationproxy.html">关联代理</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/automap.html">自动映射</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/baked.html">烘焙查询</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/declarative/index.html">声明式扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/mutable.html">突变追踪</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/orderinglist.html">排序列表</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/horizontal_shard.html">水平分片</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/hybrid.html">混合属性</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/indexable.html">Indexable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../orm/extensions/instrumentation.html">替代类检测</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../orm/examples.html">核心和 ORM 示例</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../core/index.html">SQLAlchemy Core</a><input class="toctree-checkbox" id="toctree-checkbox-12" name="toctree-checkbox-12" role="switch" type="checkbox"/><label for="toctree-checkbox-12"><div class="visually-hidden">Toggle navigation of SQLAlchemy Core</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/expression_api.html">SQL 语句和表达式 API</a><input class="toctree-checkbox" id="toctree-checkbox-13" name="toctree-checkbox-13" role="switch" type="checkbox"/><label for="toctree-checkbox-13"><div class="visually-hidden">Toggle navigation of SQL 语句和表达式 API</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/sqlelement.html">列元素和表达式</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/operators.html">操作符参考</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/selectable.html">SELECT 和相关构造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/dml.html">插入,更新,删除</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/functions.html">SQL 和 范型函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/compiler.html">自定义 SQL 构造和编译扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/serializer.html">表达式序列化器扩展</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/foundation.html">SQL 表达式语言基础构造</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/visitors.html">访问者和遍历实用程序</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/schema.html">Schema 定义语言</a><input class="toctree-checkbox" id="toctree-checkbox-14" name="toctree-checkbox-14" role="switch" type="checkbox"/><label for="toctree-checkbox-14"><div class="visually-hidden">Toggle navigation of Schema 定义语言</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/metadata.html">使用元数据描述数据库</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/reflection.html">反映数据库对象</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/defaults.html">列 INSERT/UPDATE 默认值</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/constraints.html">定义约束和索引</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/ddl.html">自定义 DDL</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/types.html">SQL 数据类型对象</a><input class="toctree-checkbox" id="toctree-checkbox-15" name="toctree-checkbox-15" role="switch" type="checkbox"/><label for="toctree-checkbox-15"><div class="visually-hidden">Toggle navigation of SQL 数据类型对象</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/type_basics.html">类型层次结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/custom_types.html">自定义类型</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/type_api.html">基本类型 API</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/engines_connections.html">Engine和Connection的使用</a><input class="toctree-checkbox" id="toctree-checkbox-16" name="toctree-checkbox-16" role="switch" type="checkbox"/><label for="toctree-checkbox-16"><div class="visually-hidden">Toggle navigation of Engine和Connection的使用</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/engines.html">Engine 配置</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/connections.html">使用Engines和Connection</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/pooling.html">连接池</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/events.html">核心事件</a></li>
</ul>
</li>
<li class="toctree-l2 has-children"><a class="reference internal" href="../core/api_basics.html">Core API 基础</a><input class="toctree-checkbox" id="toctree-checkbox-17" name="toctree-checkbox-17" role="switch" type="checkbox"/><label for="toctree-checkbox-17"><div class="visually-hidden">Toggle navigation of Core API 基础</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l3"><a class="reference internal" href="../core/event.html">事件</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/inspection.html">运行时审查 API</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/exceptions.html">Core 异常</a></li>
<li class="toctree-l3"><a class="reference internal" href="../core/internals.html">Core 内部</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../dialects/index.html">Dialects</a><input class="toctree-checkbox" id="toctree-checkbox-18" name="toctree-checkbox-18" role="switch" type="checkbox"/><label for="toctree-checkbox-18"><div class="visually-hidden">Toggle navigation of Dialects</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../dialects/postgresql.html">PostgreSQL</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/mysql.html">MySQL 和 MariaDB</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/sqlite.html">SQLite</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/oracle.html">Oracle</a></li>
<li class="toctree-l2"><a class="reference internal" href="../dialects/mssql.html">Microsoft SQL Server</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../faq/index.html">常见问题</a><input class="toctree-checkbox" id="toctree-checkbox-19" name="toctree-checkbox-19" role="switch" type="checkbox"/><label for="toctree-checkbox-19"><div class="visually-hidden">Toggle navigation of 常见问题</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="../faq/installation.html">安装</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/connections.html">连接 / 引擎</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/metadata_schema.html">元数据 / Schema</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/sqlexpressions.html">SQL 表达式</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/ormconfiguration.html">ORM 配置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/performance.html">性能</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/sessions.html">会话 / 查询</a></li>
<li class="toctree-l2"><a class="reference internal" href="../faq/thirdparty.html">第三方包集成问题</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../errors.html">错误消息</a></li>
<li class="toctree-l1 current has-children"><a class="reference internal" href="index.html">变更和迁移</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-20" name="toctree-checkbox-20" role="switch" type="checkbox"/><label for="toctree-checkbox-20"><div class="visually-hidden">Toggle navigation of 变更和迁移</div><i class="icon"><svg><use href="#svg-arrow-right"></use></svg></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="migration_21.html">SQLAlchemy 2.1 有什么新功能？</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_21.html">2.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_20.html">2.0 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_14.html">1.4 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_13.html">1.3 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_12.html">1.2 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_11.html">1.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_10.html">1.0 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_09.html">0.9 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_08.html">0.8 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_07.html">0.7 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_06.html">0.6 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_05.html">0.5 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_04.html">0.4 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_03.html">0.3 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_02.html">0.2 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="changelog_01.html">0.1 Changelog</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_20.html">SQLAlchemy 2.0 - Major Migration Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="whatsnew_20.html">What’s New in SQLAlchemy 2.0?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_14.html">What’s New in SQLAlchemy 1.4?</a></li>
<li class="toctree-l2 current current-page"><a class="current reference internal" href="#">What’s New in SQLAlchemy 1.3?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_12.html">What’s New in SQLAlchemy 1.2?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_11.html">What’s New in SQLAlchemy 1.1?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_10.html">What’s New in SQLAlchemy 1.0?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_09.html">What’s New in SQLAlchemy 0.9?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_08.html">What’s New in SQLAlchemy 0.8?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_07.html">What’s New in SQLAlchemy 0.7?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_06.html">What’s New in SQLAlchemy 0.6?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_05.html">What’s new in SQLAlchemy 0.5?</a></li>
<li class="toctree-l2"><a class="reference internal" href="migration_04.html">What’s new in SQLAlchemy 0.4?</a></li>
</ul>
</li>
</ul>

</div>
</div>

      </div>
      
    </div>
  </aside>
  <div class="main">
    <div class="content">
      <div class="article-container">
        <a href="#" class="back-to-top muted-link">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12z"></path>
          </svg>
          <span>Back to top</span>
        </a>
        <div class="content-icon-container">
          

<div class="theme-toggle-container theme-toggle-content">
            <button class="theme-toggle">
              <div class="visually-hidden">Toggle Light / Dark / Auto color theme</div>
              <svg class="theme-icon-when-auto-light"><use href="#svg-sun-with-moon"></use></svg>
              <svg class="theme-icon-when-auto-dark"><use href="#svg-moon-with-sun"></use></svg>
              <svg class="theme-icon-when-dark"><use href="#svg-moon"></use></svg>
              <svg class="theme-icon-when-light"><use href="#svg-sun"></use></svg>
            </button>
          </div>
          <label class="toc-overlay-icon toc-content-icon" for="__toc">
            <div class="visually-hidden">Toggle table of contents sidebar</div>
            <i class="icon"><svg><use href="#svg-toc"></use></svg></i>
          </label>
        </div>
        <article role="main" id="furo-main-content">
          <section id="what-s-new-in-sqlalchemy-1-3">
<h1>What’s New in SQLAlchemy 1.3?<a class="headerlink" href="#what-s-new-in-sqlalchemy-1-3" title="Link to this heading">¶</a></h1>
<div class="admonition-about-this-document admonition">
<p class="admonition-title">About this Document</p>
<p>This document describes changes between SQLAlchemy version 1.2
and SQLAlchemy version 1.3.</p>
</div>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">¶</a></h2>
<p>This guide introduces what’s new in SQLAlchemy version 1.3
and also documents changes which affect users migrating
their applications from the 1.2 series of SQLAlchemy to 1.3.</p>
<p>Please carefully review the sections on behavioral changes for
potentially backwards-incompatible changes in behavior.</p>
</section>
<section id="general">
<h2>General<a class="headerlink" href="#general" title="Link to this heading">¶</a></h2>
<section id="deprecation-warnings-are-emitted-for-all-deprecated-elements-new-deprecations-added">
<span id="change-4393-general"></span><h3>Deprecation warnings are emitted for all deprecated elements; new deprecations added<a class="headerlink" href="#deprecation-warnings-are-emitted-for-all-deprecated-elements-new-deprecations-added" title="Link to this heading">¶</a></h3>
<p>Release 1.3 ensures that all behaviors and APIs that are deprecated, including
all those that have been long listed as “legacy” for years, are emitting
<code class="docutils literal notranslate"><span class="pre">DeprecationWarning</span></code> warnings. This includes when making use of parameters
such as <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session.params.weak_identity_map" title="sqlalchemy.orm.Session"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Session.weak_identity_map</span></code></a> and classes such as
<code class="xref py py-class docutils literal notranslate"><span class="pre">MapperExtension</span></code>.     While all deprecations have been noted in the
documentation, often they did not use a proper restructured text directive, or
include in what version they were deprecated.  Whether or not a particular API
feature actually emitted a deprecation warning was not consistent.  The general
attitude was that most or all of these deprecated features were treated as
long-term legacy features with no plans to remove them.</p>
<p>The change includes that all documented deprecations now use a proper
restructured text directive in the documentation with a version number, the
verbiage that the feature or use case will be removed in a future release is
made explicit (e.g., no more legacy forever use cases), and that use of any
such feature or use case will definitely emit a <code class="docutils literal notranslate"><span class="pre">DeprecationWarning</span></code>, which
in Python 3 as well as when using modern testing tools like Pytest are now made
more explicit in the standard error stream.  The goal is that these long
deprecated features, going back as far as version 0.7 or 0.6, should start
being removed entirely, rather than keeping them around as “legacy” features.
Additionally, some major new deprecations are being added as of version 1.3.
As SQLAlchemy has 14 years of real world use by thousands of developers, it’s
possible to point to a single stream of use cases that blend together well, and
to trim away features and patterns that work against this single way of
working.</p>
<p>The larger context is that SQLAlchemy seeks to adjust to the coming Python
3-only world, as well as a type-annotated world, and towards this goal there
are <strong>tentative</strong> plans for a major rework of  SQLAlchemy which would hopefully
greatly reduce the cognitive load of the API as well as perform a major pass
over the great many differences in implementation and use between Core and ORM.
As these two systems evolved dramatically after SQLAlchemy’s first release, in
particular the ORM still retains lots of “bolted on” behaviors that keep the
wall of separation between Core and  ORM too high.  By focusing the API
ahead of time on a single pattern for each supported use case, the eventual
job of migrating to a significantly altered API becomes simpler.</p>
<p>For the most major deprecations being added in 1.3, see the linked sections
below.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="#change-4393-threadlocal"><span class="std std-ref">“threadlocal” engine strategy deprecated</span></a></p>
<p><a class="reference internal" href="#change-4393-convertunicode"><span class="std std-ref">convert_unicode parameters deprecated</span></a></p>
<p><a class="reference internal" href="#change-4423"><span class="std std-ref">Relationship to AliasedClass replaces the need for non primary mappers</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4393">#4393</a></p>
</section>
</section>
<section id="new-features-and-improvements-orm">
<h2>New Features and Improvements - ORM<a class="headerlink" href="#new-features-and-improvements-orm" title="Link to this heading">¶</a></h2>
<section id="relationship-to-aliasedclass-replaces-the-need-for-non-primary-mappers">
<span id="change-4423"></span><h3>Relationship to AliasedClass replaces the need for non primary mappers<a class="headerlink" href="#relationship-to-aliasedclass-replaces-the-need-for-non-primary-mappers" title="Link to this heading">¶</a></h3>
<p>The “non primary mapper” is a <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> created in the
<a class="reference internal" href="../orm/mapping_styles.html#orm-imperative-mapping"><span class="std std-ref">命令式映射</span></a> style, which acts as an additional mapper against an
already mapped class against a different kind of selectable.  The non primary
mapper has its roots in the 0.1, 0.2 series of SQLAlchemy where it was
anticipated that the <a class="reference internal" href="../orm/mapping_api.html#sqlalchemy.orm.Mapper" title="sqlalchemy.orm.Mapper"><code class="xref py py-class docutils literal notranslate"><span class="pre">Mapper</span></code></a> object was to be the primary query
construction interface, before the <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object existed.</p>
<p>With the advent of <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> and later the <a class="reference internal" href="../orm/queryguide/api.html#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a>
construct, most use cases for the non primary mapper went away.  This was a
good thing since SQLAlchemy also moved away from “classical” mappings altogether
around the 0.5 series in favor of the declarative system.</p>
<p>One use case remained around for non primary mappers when it was realized that
some very hard-to-define <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> configurations could be made
possible when a non-primary mapper with an alternative selectable was made as
the mapping target, rather than trying to construct a
<a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> that encompassed all the complexity of a
particular inter-object relationship.</p>
<p>As this use case became more popular, its limitations became apparent,
including that the non primary mapper is difficult to configure against a
selectable that adds new columns, that the mapper does not inherit the
relationships of the original mapping, that relationships which are configured
explicitly on the non primary mapper do  not function well with loader options,
and that the non primary mapper also doesn’t provide a fully functional
namespace of column-based attributes which can be used in queries (which again,
in the old 0.1 - 0.4 days, one would use <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Table" title="sqlalchemy.schema.Table"><code class="xref py py-class docutils literal notranslate"><span class="pre">Table</span></code></a> objects directly with
the ORM).</p>
<p>The missing piece was to allow the <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> to refer directly
to the <a class="reference internal" href="../orm/queryguide/api.html#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a>.  The <a class="reference internal" href="../orm/queryguide/api.html#sqlalchemy.orm.util.AliasedClass" title="sqlalchemy.orm.util.AliasedClass"><code class="xref py py-class docutils literal notranslate"><span class="pre">AliasedClass</span></code></a> already does
everything we want the non primary mapper to do; it allows an existing mapped
class to be loaded from an alternative selectable, it inherits all the
attributes and relationships of the existing mapper, it works
extremely well with loader options, and it provides a class-like
object that can be mixed into queries just like the class itself.
With this change, the recipes that
were formerly for non primary mappers at <a class="reference internal" href="../orm/join_conditions.html#relationship-configure-joins"><span class="std std-ref">配置关系连接方式</span></a>
are changed to aliased class.</p>
<p>At <a class="reference internal" href="../orm/join_conditions.html#relationship-aliased-class"><span class="std std-ref">与别名类的关系</span></a>, the original non primary mapper looked
like:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">j</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">D</span><span class="o">.</span><span class="n">c_id</span><span class="p">)</span>

<span class="n">B_viacd</span> <span class="o">=</span> <span class="n">mapper</span><span class="p">(</span>
    <span class="n">B</span><span class="p">,</span>
    <span class="n">j</span><span class="p">,</span>
    <span class="n">non_primary</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">primary_key</span><span class="o">=</span><span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b_id</span><span class="p">],</span>
    <span class="n">properties</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b_id</span><span class="p">,</span>  <span class="c1"># so that &#39;id&#39; looks the same as before</span>
        <span class="s2">&quot;c_id&quot;</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">c_id</span><span class="p">,</span>  <span class="c1"># needed for disambiguation</span>
        <span class="s2">&quot;d_c_id&quot;</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">d_c_id</span><span class="p">,</span>  <span class="c1"># needed for disambiguation</span>
        <span class="s2">&quot;b_id&quot;</span><span class="p">:</span> <span class="p">[</span><span class="n">j</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b_id</span><span class="p">,</span> <span class="n">j</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">d_b_id</span><span class="p">],</span>
        <span class="s2">&quot;d_id&quot;</span><span class="p">:</span> <span class="n">j</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">d_id</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">)</span>

<span class="n">A</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">B_viacd</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">B_viacd</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b_id</span><span class="p">)</span></pre></div>
</div>
<p>The properties were necessary in order to re-map the additional columns
so that they did not conflict with the existing columns mapped to <code class="docutils literal notranslate"><span class="pre">B</span></code>, as
well as it was necessary to define a new primary key.</p>
<p>With the new approach, all of this verbosity goes away, and the additional
columns are referenced directly when making the relationship:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">j</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">D</span><span class="p">,</span> <span class="n">D</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">C</span><span class="p">,</span> <span class="n">C</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">D</span><span class="o">.</span><span class="n">c_id</span><span class="p">)</span>

<span class="n">B_viacd</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">A</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">B_viacd</span><span class="p">,</span> <span class="n">primaryjoin</span><span class="o">=</span><span class="n">A</span><span class="o">.</span><span class="n">b_id</span> <span class="o">==</span> <span class="n">j</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">b_id</span><span class="p">)</span></pre></div>
</div>
<p>The non primary mapper is now deprecated with the eventual goal to be that
classical mappings as a feature go away entirely.  The Declarative API would
become the single means of mapping which hopefully will allow internal
improvements and simplifications, as well as a clearer documentation story.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4423">#4423</a></p>
</section>
<section id="selectin-loading-no-longer-uses-join-for-simple-one-to-many">
<span id="change-4340"></span><h3>selectin loading no longer uses JOIN for simple one-to-many<a class="headerlink" href="#selectin-loading-no-longer-uses-join-for-simple-one-to-many" title="Link to this heading">¶</a></h3>
<p>The “selectin” loading feature added in 1.2 introduced an extremely
performant new way to eagerly load collections, in many cases much faster
than that of “subquery” eager loading, as it does not rely upon restating
the original SELECT query and instead uses a simple IN clause.  However,
the “selectin” load still relied upon rendering a JOIN between the
parent and related tables, since it needs the parent primary key values
in the row in order to match rows up.     In 1.3, a new optimization
is added which will omit this JOIN in the most common case of a simple
one-to-many load, where the related row already contains the primary key
of the parent row expressed in its foreign key columns.   This again provides
for a dramatic performance improvement as the ORM now can load large numbers
of collections all in one query without using JOIN or subqueries at all.</p>
<p>Given a mapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;selectin&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>In the 1.2 version of “selectin” loading, a load of A to B looks like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">a</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">a_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_1_id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b_id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b_a_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_1</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">a_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">a_id</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">a_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">a_1</span><span class="p">.</span><span class="n">id</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span></pre></div>
</div>
<p>With the new behavior, the load looks like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">a</span>
<span class="k">SELECT</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b_a_id</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">b_id</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">b</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">IN</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">,</span><span class="w"> </span><span class="o">?</span><span class="p">)</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">a_id</span>
<span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">4</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span></pre></div>
</div>
<p>The behavior is being released as automatic, using a similar heuristic that
lazy loading uses in order to determine if related entities can be fetched
directly from the identity map.   However, as with most querying features,
the feature’s implementation became more complex as a result of advanced
scenarios regarding polymorphic loading.   If problems are encountered,
users should report a bug, however the change also includes a flag
<a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship.params.omit_join" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.omit_join</span></code></a> which can be set to <code class="docutils literal notranslate"><span class="pre">False</span></code> on the
<a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> to disable the optimization.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4340">#4340</a></p>
</section>
<section id="improvement-to-the-behavior-of-many-to-one-query-expressions">
<span id="change-4359"></span><h3>Improvement to the behavior of many-to-one query expressions<a class="headerlink" href="#improvement-to-the-behavior-of-many-to-one-query-expressions" title="Link to this heading">¶</a></h3>
<p>When building a query that compares a many-to-one relationship to an
object value, such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">u1</span><span class="p">)</span></pre></div>
</div>
<p>The above expression <code class="docutils literal notranslate"><span class="pre">Address.user</span> <span class="pre">==</span> <span class="pre">u1</span></code>, which ultimately compiles to a SQL
expression normally based on the primary key columns of the <code class="docutils literal notranslate"><span class="pre">User</span></code> object
like <code class="docutils literal notranslate"><span class="pre">&quot;address.user_id</span> <span class="pre">=</span> <span class="pre">5&quot;</span></code>, uses a deferred callable in order to retrieve
the value <code class="docutils literal notranslate"><span class="pre">5</span></code> within the bound expression until  as late as possible.  This
is to suit both the use case where the <code class="docutils literal notranslate"><span class="pre">Address.user</span> <span class="pre">==</span> <span class="pre">u1</span></code> expression may be
against a <code class="docutils literal notranslate"><span class="pre">User</span></code> object that isn’t flushed yet which relies upon a server-
generated primary key value, as well as that the expression always returns the
correct result even if the primary key value of <code class="docutils literal notranslate"><span class="pre">u1</span></code> has been changed since
the expression was created.</p>
<p>However, a side effect of this behavior is that if <code class="docutils literal notranslate"><span class="pre">u1</span></code> ends up being expired
by the time the expression is evaluated, it results in an additional SELECT
statement, and in the case that <code class="docutils literal notranslate"><span class="pre">u1</span></code> was also detached from the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a>, it would raise an error:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">u1</span><span class="p">)</span>

<span class="n">session</span><span class="o">.</span><span class="n">expire</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">expunge</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>

<span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>  <span class="c1"># &lt;-- would raise DetachedInstanceError</span></pre></div>
</div>
<p>The expiration / expunging of the object can occur implicitly when the
<a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a> is committed and the <code class="docutils literal notranslate"><span class="pre">u1</span></code> instance falls out of scope,
as the <code class="docutils literal notranslate"><span class="pre">Address.user</span> <span class="pre">==</span> <span class="pre">u1</span></code> expression does not strongly reference the
object itself, only its <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.InstanceState" title="sqlalchemy.orm.InstanceState"><code class="xref py py-class docutils literal notranslate"><span class="pre">InstanceState</span></code></a>.</p>
<p>The fix is to allow the <code class="docutils literal notranslate"><span class="pre">Address.user</span> <span class="pre">==</span> <span class="pre">u1</span></code> expression to evaluate the value
<code class="docutils literal notranslate"><span class="pre">5</span></code> based on attempting to retrieve or load the value normally at expression
compilation time as it does now, but if the object is detached and has
been expired, it is retrieved from a new mechanism upon the
<a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.InstanceState" title="sqlalchemy.orm.InstanceState"><code class="xref py py-class docutils literal notranslate"><span class="pre">InstanceState</span></code></a> which will memoize the last known value for a
particular attribute on that state when that attribute is expired.  This
mechanism is only enabled for a specific attribute / <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.InstanceState" title="sqlalchemy.orm.InstanceState"><code class="xref py py-class docutils literal notranslate"><span class="pre">InstanceState</span></code></a>
when needed by the expression feature to conserve performance / memory
overhead.</p>
<p>Originally, simpler approaches such as evaluating the expression immediately
with various arrangements for trying to load the value later if not present
were attempted, however the difficult edge case is that of the value  of a
column attribute (typically a natural primary key) that is being changed.   In
order to ensure that an expression like <code class="docutils literal notranslate"><span class="pre">Address.user</span> <span class="pre">==</span> <span class="pre">u1</span></code> always returns
the correct answer for the current state of <code class="docutils literal notranslate"><span class="pre">u1</span></code>, it will return the current
database-persisted value for a persistent object, unexpiring via SELECT query
if necessary, and for a detached object it will return the most recent known
value, regardless of when the object was expired using a new feature within the
<a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.InstanceState" title="sqlalchemy.orm.InstanceState"><code class="xref py py-class docutils literal notranslate"><span class="pre">InstanceState</span></code></a> that tracks the last known value of a column attribute
whenever the attribute is to be expired.</p>
<p>Modern attribute API features are used to indicate specific error messages when
the value cannot be evaluated, the two cases of which are when the column
attributes have never been set, and when the object was already expired
when the first evaluation was made and is now detached. In all cases,
<a class="reference internal" href="../orm/exceptions.html#sqlalchemy.orm.exc.DetachedInstanceError" title="sqlalchemy.orm.exc.DetachedInstanceError"><code class="xref py py-class docutils literal notranslate"><span class="pre">DetachedInstanceError</span></code></a> is no longer raised.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4359">#4359</a></p>
</section>
<section id="many-to-one-replacement-won-t-raise-for-raiseload-or-detached-for-old-object">
<span id="change-4353"></span><h3>Many-to-one replacement won’t raise for “raiseload” or detached for “old” object<a class="headerlink" href="#many-to-one-replacement-won-t-raise-for-raiseload-or-detached-for-old-object" title="Link to this heading">¶</a></h3>
<p>Given the case where a lazy load would proceed on a many-to-one relationship
in order to load the “old” value, if the relationship does not specify
the <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship.params.active_history" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.active_history</span></code></a> flag, an assertion will not
be raised for a detached object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>

<span class="n">session</span><span class="o">.</span><span class="n">expunge</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>

<span class="n">a1</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">some_user</span></pre></div>
</div>
<p>Above, when the <code class="docutils literal notranslate"><span class="pre">.user</span></code> attribute is replaced on the detached <code class="docutils literal notranslate"><span class="pre">a1</span></code> object,
a <a class="reference internal" href="../orm/exceptions.html#sqlalchemy.orm.exc.DetachedInstanceError" title="sqlalchemy.orm.exc.DetachedInstanceError"><code class="xref py py-class docutils literal notranslate"><span class="pre">DetachedInstanceError</span></code></a> would be raised as the attribute is attempting
to retrieve the previous value of <code class="docutils literal notranslate"><span class="pre">.user</span></code> from the identity map.  The change
is that the operation now proceeds without the old value being loaded.</p>
<p>The same change is also made to the <code class="docutils literal notranslate"><span class="pre">lazy=&quot;raise&quot;</span></code> loader strategy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">user</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;raise&quot;</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Previously, the association of <code class="docutils literal notranslate"><span class="pre">a1.user</span></code> would invoke the “raiseload”
exception as a result of the attribute attempting to retrieve the previous
value.   This assertion is now skipped in the case of loading the “old” value.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4353">#4353</a></p>
</section>
<section id="del-implemented-for-orm-attributes">
<span id="change-4354"></span><h3>“del” implemented for ORM attributes<a class="headerlink" href="#del-implemented-for-orm-attributes" title="Link to this heading">¶</a></h3>
<p>The Python <code class="docutils literal notranslate"><span class="pre">del</span></code> operation was not really usable for mapped attributes, either
scalar columns or object references.   Support has been added for this to work correctly,
where the <code class="docutils literal notranslate"><span class="pre">del</span></code> operation is roughly equivalent to setting the attribute to the
<code class="docutils literal notranslate"><span class="pre">None</span></code> value:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">some_object</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">SomeObject</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>

<span class="k">del</span> <span class="n">some_object</span><span class="o">.</span><span class="n">some_attribute</span>  <span class="c1"># from a SQL perspective, works like &quot;= None&quot;</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4354">#4354</a></p>
</section>
<section id="info-dictionary-added-to-instancestate">
<span id="change-4257"></span><h3>info dictionary added to InstanceState<a class="headerlink" href="#info-dictionary-added-to-instancestate" title="Link to this heading">¶</a></h3>
<p>Added the <code class="docutils literal notranslate"><span class="pre">.info</span></code> dictionary to the <a class="reference internal" href="../orm/internals.html#sqlalchemy.orm.InstanceState" title="sqlalchemy.orm.InstanceState"><code class="xref py py-class docutils literal notranslate"><span class="pre">InstanceState</span></code></a> class, the object
that comes from calling <a class="reference internal" href="../core/inspection.html#sqlalchemy.inspect" title="sqlalchemy.inspect"><code class="xref py py-func docutils literal notranslate"><span class="pre">inspect()</span></code></a> on a mapped object.  This allows custom
recipes to add additional information about an object that will be carried
along with that object’s full lifecycle in memory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">inspect</span>

<span class="n">u1</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ed&quot;</span><span class="p">)</span>

<span class="n">inspect</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;user_info&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;7|ed&quot;</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4257">#4257</a></p>
</section>
<section id="horizontal-sharding-extension-supports-bulk-update-and-delete-methods">
<span id="change-4196"></span><h3>Horizontal Sharding extension supports bulk update and delete methods<a class="headerlink" href="#horizontal-sharding-extension-supports-bulk-update-and-delete-methods" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="../orm/extensions/horizontal_shard.html#sqlalchemy.ext.horizontal_shard.ShardedQuery" title="sqlalchemy.ext.horizontal_shard.ShardedQuery"><code class="xref py py-class docutils literal notranslate"><span class="pre">ShardedQuery</span></code></a> extension object supports the <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.update" title="sqlalchemy.orm.Query.update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.update()</span></code></a>
and <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.delete" title="sqlalchemy.orm.Query.delete"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.delete()</span></code></a> bulk update/delete methods.    The <code class="docutils literal notranslate"><span class="pre">query_chooser</span></code>
callable is consulted when they are called in order to run the update/delete
across multiple shards based on given criteria.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4196">#4196</a></p>
</section>
<section id="association-proxy-improvements">
<h3>Association Proxy Improvements<a class="headerlink" href="#association-proxy-improvements" title="Link to this heading">¶</a></h3>
<p>While not for any particular reason, the Association Proxy extension
had many improvements this cycle.</p>
<section id="association-proxy-has-new-cascade-scalar-deletes-flag">
<span id="change-4308"></span><h4>Association proxy has new cascade_scalar_deletes flag<a class="headerlink" href="#association-proxy-has-new-cascade-scalar-deletes-flag" title="Link to this heading">¶</a></h4>
<p>Given a mapping as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;test_a&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ab</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;AB&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">uselist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span>
        <span class="s2">&quot;ab&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="k">lambda</span> <span class="n">b</span><span class="p">:</span> <span class="n">AB</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">),</span> <span class="n">cascade_scalar_deletes</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;test_b&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ab</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;AB&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">AB</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;test_ab&quot;</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="n">B</span><span class="o">.</span><span class="n">id</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre><div class="code-annotations-key"></div></div>
</div>
<p>An assignment to <code class="docutils literal notranslate"><span class="pre">A.b</span></code> will generate an <code class="docutils literal notranslate"><span class="pre">AB</span></code> object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span></pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">A.b</span></code> association is scalar, and includes a new flag
<a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxy.params.cascade_scalar_deletes" title="sqlalchemy.ext.associationproxy.AssociationProxy"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">AssociationProxy.cascade_scalar_deletes</span></code></a>.  When set, setting <code class="docutils literal notranslate"><span class="pre">A.b</span></code>
to <code class="docutils literal notranslate"><span class="pre">None</span></code> will remove <code class="docutils literal notranslate"><span class="pre">A.ab</span></code> as well.   The default behavior remains
that it leaves <code class="docutils literal notranslate"><span class="pre">a.ab</span></code> in place:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">assert</span> <span class="n">a</span><span class="o">.</span><span class="n">ab</span> <span class="ow">is</span> <span class="kc">None</span></pre></div>
</div>
<p>While it at first seemed intuitive that this logic should just look at the
“cascade” attribute of the existing relationship, it’s not clear from that
alone if the proxied object should be removed, hence the behavior is
made available as an explicit option.</p>
<p>Additionally, <code class="docutils literal notranslate"><span class="pre">del</span></code> now works for scalars in a similar manner as setting
to <code class="docutils literal notranslate"><span class="pre">None</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">a</span><span class="o">.</span><span class="n">b</span>
<span class="k">assert</span> <span class="n">a</span><span class="o">.</span><span class="n">ab</span> <span class="ow">is</span> <span class="kc">None</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4308">#4308</a></p>
</section>
<section id="associationproxy-stores-class-specific-state-on-a-per-class-basis">
<span id="change-3423"></span><h4>AssociationProxy stores class-specific state on a per-class basis<a class="headerlink" href="#associationproxy-stores-class-specific-state-on-a-per-class-basis" title="Link to this heading">¶</a></h4>
<p>The <a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxy" title="sqlalchemy.ext.associationproxy.AssociationProxy"><code class="xref py py-class docutils literal notranslate"><span class="pre">AssociationProxy</span></code></a> object makes lots of decisions based on the
parent mapped class it is associated with.   While the
<a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxy" title="sqlalchemy.ext.associationproxy.AssociationProxy"><code class="xref py py-class docutils literal notranslate"><span class="pre">AssociationProxy</span></code></a> historically began as a relatively simple ‘getter,’
it became apparent early on that it also needed to make decisions regarding the
kind of attribute to which it refers—such as scalar or collection, mapped
object or simple value, and so on. To achieve this, it needs to inspect the
mapped attribute or other referring descriptor or attribute, as referenced from
its parent class. However in Python descriptor mechanics, a descriptor only
learns about its “parent” class when it is accessed in the context of that
class, such as calling <code class="docutils literal notranslate"><span class="pre">MyClass.some_descriptor</span></code>, which calls the
<code class="docutils literal notranslate"><span class="pre">__get__()</span></code> method which passes in the class.    The
<a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxy" title="sqlalchemy.ext.associationproxy.AssociationProxy"><code class="xref py py-class docutils literal notranslate"><span class="pre">AssociationProxy</span></code></a> object would therefore store state that is specific
to that class, but only once this method were called; trying to inspect this
state ahead of time without first accessing the <a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxy" title="sqlalchemy.ext.associationproxy.AssociationProxy"><code class="xref py py-class docutils literal notranslate"><span class="pre">AssociationProxy</span></code></a> as a
descriptor would raise an error.  Additionally, it would  assume that the first
class to be seen by <code class="docutils literal notranslate"><span class="pre">__get__()</span></code> would be  the only parent class it needed to
know about.  This is despite the fact that if a particular class has inheriting
subclasses, the association proxy is really working on behalf of more than one
parent class even though it was not explicitly re-used.  While even with this
shortcoming, the association proxy would still get pretty far with its current
behavior, it still leaves shortcomings in some cases as well as the complex
problem of determining the best “owner” class.</p>
<p>These problems are now solved in that <a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxy" title="sqlalchemy.ext.associationproxy.AssociationProxy"><code class="xref py py-class docutils literal notranslate"><span class="pre">AssociationProxy</span></code></a> no longer
modifies its own internal state when <code class="docutils literal notranslate"><span class="pre">__get__()</span></code> is called; instead, a new
object is generated per-class known as <a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxyInstance" title="sqlalchemy.ext.associationproxy.AssociationProxyInstance"><code class="xref py py-class docutils literal notranslate"><span class="pre">AssociationProxyInstance</span></code></a> which
handles all the state specific to a particular mapped parent class (when the
parent class is not mapped, no <a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxyInstance" title="sqlalchemy.ext.associationproxy.AssociationProxyInstance"><code class="xref py py-class docutils literal notranslate"><span class="pre">AssociationProxyInstance</span></code></a> is generated).
The concept of a single “owning class” for the association proxy, which was
nonetheless improved in 1.1, has essentially been replaced with an approach
where the AP now can treat any number of “owning” classes equally.</p>
<p>To accommodate for applications that want to inspect this state for an
<a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxy" title="sqlalchemy.ext.associationproxy.AssociationProxy"><code class="xref py py-class docutils literal notranslate"><span class="pre">AssociationProxy</span></code></a> without necessarily calling <code class="docutils literal notranslate"><span class="pre">__get__()</span></code>, a new
method <a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxy.for_class" title="sqlalchemy.ext.associationproxy.AssociationProxy.for_class"><code class="xref py py-meth docutils literal notranslate"><span class="pre">AssociationProxy.for_class()</span></code></a> is added that provides direct access
to a class-specific <a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxyInstance" title="sqlalchemy.ext.associationproxy.AssociationProxyInstance"><code class="xref py py-class docutils literal notranslate"><span class="pre">AssociationProxyInstance</span></code></a>, demonstrated as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">keywords</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s2">&quot;kws&quot;</span><span class="p">,</span> <span class="s2">&quot;keyword&quot;</span><span class="p">)</span>


<span class="n">proxy_state</span> <span class="o">=</span> <span class="n">inspect</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">all_orm_descriptors</span><span class="p">[</span><span class="s2">&quot;keywords&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">for_class</span><span class="p">(</span><span class="n">User</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Once we have the <a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxyInstance" title="sqlalchemy.ext.associationproxy.AssociationProxyInstance"><code class="xref py py-class docutils literal notranslate"><span class="pre">AssociationProxyInstance</span></code></a> object, in the above
example stored in the <code class="docutils literal notranslate"><span class="pre">proxy_state</span></code> variable, we can look at attributes
specific to the <code class="docutils literal notranslate"><span class="pre">User.keywords</span></code> proxy, such as <code class="docutils literal notranslate"><span class="pre">target_class</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">proxy_state</span><span class="o">.</span><span class="n">target_class</span>
<span class="go">Keyword</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3423">#3423</a></p>
</section>
<section id="associationproxy-now-provides-standard-column-operators-for-a-column-oriented-target">
<span id="change-4351"></span><h4>AssociationProxy now provides standard column operators for a column-oriented target<a class="headerlink" href="#associationproxy-now-provides-standard-column-operators-for-a-column-oriented-target" title="Link to this heading">¶</a></h4>
<p>Given an <a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxy" title="sqlalchemy.ext.associationproxy.AssociationProxy"><code class="xref py py-class docutils literal notranslate"><span class="pre">AssociationProxy</span></code></a> where the target is a database column,
and is <strong>not</strong> an object reference or another association proxy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">elements</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Element&quot;</span><span class="p">)</span>

    <span class="c1"># column-based association proxy</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s2">&quot;elements&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Element</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="c1"># ...</span>

    <span class="n">value</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">User.values</span></code> association proxy refers to the <code class="docutils literal notranslate"><span class="pre">Element.value</span></code> column.
Standard column operations are now available, such as <code class="docutils literal notranslate"><span class="pre">like</span></code>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%f</span><span class="s2">oo%&quot;</span><span class="p">)))</span>
<div class='show_sql_print'><span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">user_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;user&quot;</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">element</span>
<span class="k">WHERE</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="p">:</span><span class="n">value_1</span><span class="p">)</span>
</div></pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">equals</span></code>:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="s2">&quot;foo&quot;</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">user_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;user&quot;</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">element</span>
<span class="k">WHERE</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">:</span><span class="n">value_1</span><span class="p">)</span>
</div></pre></div>
</div>
<p>When comparing to <code class="docutils literal notranslate"><span class="pre">None</span></code>, the <code class="docutils literal notranslate"><span class="pre">IS</span> <span class="pre">NULL</span></code> expression is augmented with
a test that the related row does not exist at all; this is the same
behavior as before:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">values</span> <span class="o">==</span> <span class="kc">None</span><span class="p">))</span>
<div class='show_sql_print'><span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">user_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;user&quot;</span>
<span class="k">WHERE</span><span class="w"> </span><span class="p">(</span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">element</span>
<span class="k">WHERE</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="k">IS</span><span class="w"> </span><span class="k">NULL</span><span class="p">))</span><span class="w"> </span><span class="k">OR</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="p">(</span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">element</span>
<span class="k">WHERE</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">user_id</span><span class="p">))</span>
</div></pre></div>
</div>
<p>Note that the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnOperators.contains" title="sqlalchemy.sql.expression.ColumnOperators.contains"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.contains()</span></code></a> operator is in fact a string
comparison operator; <strong>this is a change in behavior</strong> in that previously,
the association proxy used <code class="docutils literal notranslate"><span class="pre">.contains</span></code> as a list containment operator only.
With a column-oriented comparison, it now behaves like a “like”:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;foo&quot;</span><span class="p">)))</span>
<div class='show_sql_print'><span class="k">SELECT</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">user_id</span>
<span class="k">FROM</span><span class="w"> </span><span class="ss">&quot;user&quot;</span>
<span class="k">WHERE</span><span class="w"> </span><span class="k">EXISTS</span><span class="w"> </span><span class="p">(</span><span class="k">SELECT</span><span class="w"> </span><span class="mi">1</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">element</span>
<span class="k">WHERE</span><span class="w"> </span><span class="ss">&quot;user&quot;</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">element</span><span class="p">.</span><span class="n">user_id</span><span class="w"> </span><span class="k">AND</span><span class="w"> </span><span class="p">(</span><span class="n">element</span><span class="p">.</span><span class="n">value</span><span class="w"> </span><span class="k">LIKE</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="p">:</span><span class="n">value_1</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="s1">&#39;%&#39;</span><span class="p">))</span>
</div></pre></div>
</div>
<p>In order to test the <code class="docutils literal notranslate"><span class="pre">User.values</span></code> collection for simple membership of the value
<code class="docutils literal notranslate"><span class="pre">&quot;foo&quot;</span></code>, the equals operator (e.g. <code class="docutils literal notranslate"><span class="pre">User.values</span> <span class="pre">==</span> <span class="pre">'foo'</span></code>) should be used;
this works in previous versions as well.</p>
<p>When using an object-based association proxy with a collection, the behavior is
as before, that of testing for collection membership, e.g. given a mapping:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">user_elements</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;UserElement&quot;</span><span class="p">)</span>

    <span class="c1"># object-based association proxy</span>
    <span class="n">elements</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s2">&quot;user_elements&quot;</span><span class="p">,</span> <span class="s2">&quot;element&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">UserElement</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;user_element&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;user.id&quot;</span><span class="p">))</span>
    <span class="n">element_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;element.id&quot;</span><span class="p">))</span>
    <span class="n">element</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Element&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Element</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;element&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">.contains()</span></code> method produces the same expression as before, testing
the list of <code class="docutils literal notranslate"><span class="pre">User.elements</span></code> for the presence of an <code class="docutils literal notranslate"><span class="pre">Element</span></code> object:</p>
<div class="highlight-pycon+sql notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">elements</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">Element</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">))))</span>
<span class="go">SELECT &quot;user&quot;.id AS user_id</span>
<span class="go">FROM &quot;user&quot;</span>
<span class="go">WHERE EXISTS (SELECT 1</span>
<span class="go">FROM user_element</span>
<span class="go">WHERE &quot;user&quot;.id = user_element.user_id AND :param_1 = user_element.element_id)</span></pre></div>
</div>
<p>Overall, the change is enabled based on the architectural change that is
part of <a class="reference internal" href="#change-3423"><span class="std std-ref">AssociationProxy stores class-specific state on a per-class basis</span></a>; as the proxy now spins off additional state when
an expression is generated, there is both an object-target and a column-target
version of the <a class="reference internal" href="../orm/extensions/associationproxy.html#sqlalchemy.ext.associationproxy.AssociationProxyInstance" title="sqlalchemy.ext.associationproxy.AssociationProxyInstance"><code class="xref py py-class docutils literal notranslate"><span class="pre">AssociationProxyInstance</span></code></a> class.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4351">#4351</a></p>
</section>
<section id="association-proxy-now-strong-references-the-parent-object">
<h4>Association Proxy now Strong References the Parent Object<a class="headerlink" href="#association-proxy-now-strong-references-the-parent-object" title="Link to this heading">¶</a></h4>
<p>The long-standing behavior of the association proxy collection maintaining
only a weak reference to the parent object is reverted; the proxy will now
maintain a strong reference to the parent for as long as the proxy
collection itself is also in memory, eliminating the “stale association
proxy” error. This change is being made on an experimental basis to see if
any use cases arise where it causes side effects.</p>
<p>As an example, given a mapping with association proxy:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">)</span>
    <span class="n">b_data</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s2">&quot;bs&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>


<span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="p">[</span><span class="n">B</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;b1&quot;</span><span class="p">),</span> <span class="n">B</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="s2">&quot;b2&quot;</span><span class="p">)])</span>

<span class="n">b_data</span> <span class="o">=</span> <span class="n">a1</span><span class="o">.</span><span class="n">b_data</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Previously, if <code class="docutils literal notranslate"><span class="pre">a1</span></code> were deleted out of scope:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">a1</span></pre></div>
</div>
<p>Trying to iterate the <code class="docutils literal notranslate"><span class="pre">b_data</span></code> collection after <code class="docutils literal notranslate"><span class="pre">a1</span></code> is deleted from scope
would raise the error <code class="docutils literal notranslate"><span class="pre">&quot;stale</span> <span class="pre">association</span> <span class="pre">proxy,</span> <span class="pre">parent</span> <span class="pre">object</span> <span class="pre">has</span> <span class="pre">gone</span> <span class="pre">out</span> <span class="pre">of</span>
<span class="pre">scope&quot;</span></code>.  This is because the association proxy needs to access the actual
<code class="docutils literal notranslate"><span class="pre">a1.bs</span></code> collection in order to produce a view, and prior to this change it
maintained only a weak reference to <code class="docutils literal notranslate"><span class="pre">a1</span></code>.   In particular, users would
frequently encounter this error when performing an inline operation
such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">collection</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">b_data</span></pre></div>
</div>
<p>Above, because the <code class="docutils literal notranslate"><span class="pre">A</span></code> object would be garbage collected before the
<code class="docutils literal notranslate"><span class="pre">b_data</span></code> collection were actually used.</p>
<p>The change is that the <code class="docutils literal notranslate"><span class="pre">b_data</span></code> collection is now maintaining a strong
reference to the <code class="docutils literal notranslate"><span class="pre">a1</span></code> object, so that it remains present:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">assert</span> <span class="n">b_data</span> <span class="o">==</span> <span class="p">[</span><span class="s2">&quot;b1&quot;</span><span class="p">,</span> <span class="s2">&quot;b2&quot;</span><span class="p">]</span></pre></div>
</div>
<p>This change introduces the side effect that if an application is passing around
the collection as above, <strong>the parent object won’t be garbage collected</strong> until
the collection is also discarded.   As always, if <code class="docutils literal notranslate"><span class="pre">a1</span></code> is persistent inside a
particular <a class="reference internal" href="../orm/session_api.html#sqlalchemy.orm.Session" title="sqlalchemy.orm.Session"><code class="xref py py-class docutils literal notranslate"><span class="pre">Session</span></code></a>, it will remain part of that session’s  state
until it is garbage collected.</p>
<p>Note that this change may be revised if it leads to problems.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4268">#4268</a></p>
</section>
<section id="implemented-bulk-replace-for-sets-dicts-with-associationproxy">
<span id="change-2642"></span><h4>Implemented bulk replace for sets, dicts with AssociationProxy<a class="headerlink" href="#implemented-bulk-replace-for-sets-dicts-with-associationproxy" title="Link to this heading">¶</a></h4>
<p>Assignment of a set or dictionary to an association proxy collection should
now work correctly, whereas before it would re-create association
proxy members for existing keys, leading to the issue of potential flush
failures due to the delete+insert of the same object it now should only create
new association objects where appropriate:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;test_a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">b_rel</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;B&quot;</span><span class="p">,</span>
        <span class="n">collection_class</span><span class="o">=</span><span class="n">set</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete-orphan&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">association_proxy</span><span class="p">(</span><span class="s2">&quot;b_rel&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="n">creator</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">B</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="n">x</span><span class="p">))</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;test_b&quot;</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;a_id&quot;</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">),)</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;test_a.id&quot;</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>


<span class="c1"># ...</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">Session</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">b</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">})</span>
<span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="n">s</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="c1"># re-assign where one B should be deleted, one B added, two</span>
<span class="c1"># B&#39;s maintained</span>
<span class="n">a</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="s2">&quot;q&quot;</span><span class="p">}</span>

<span class="c1"># only &#39;q&#39; was added, so only one new B object.  previously</span>
<span class="c1"># all three would have been re-created leading to flush conflicts</span>
<span class="c1"># against the deleted ones.</span>
<span class="k">assert</span> <span class="n">len</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">new</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span></pre><div class="code-annotations-key"></div></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/2642">#2642</a></p>
</section>
</section>
<section id="many-to-one-backref-checks-for-collection-duplicates-during-remove-operation">
<span id="change-1103"></span><h3>Many-to-one backref checks for collection duplicates during remove operation<a class="headerlink" href="#many-to-one-backref-checks-for-collection-duplicates-during-remove-operation" title="Link to this heading">¶</a></h3>
<p>When an ORM-mapped collection that existed as a Python sequence, typically a
Python <code class="docutils literal notranslate"><span class="pre">list</span></code> as is the default for <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>, contained
duplicates, and the object were removed from one of its positions but not the
other(s),  a many-to-one backref would set its attribute to <code class="docutils literal notranslate"><span class="pre">None</span></code> even
though the one-to-many side still represented the object as present.  Even
though one-to-many collections cannot have duplicates in the relational model,
an ORM-mapped <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a> that uses a sequence collection can have
duplicates inside of it in memory, with the restriction that this duplicate
state can neither be persisted nor retrieved from the database.   In particular,
having a duplicate temporarily present in the list is intrinsic to a Python
“swap” operation.  Given a standard one-to-many/many-to-one setup:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;a&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">bs</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">B</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;b&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">a_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;a.id&quot;</span><span class="p">))</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>If we have an <code class="docutils literal notranslate"><span class="pre">A</span></code> object with two <code class="docutils literal notranslate"><span class="pre">B</span></code> members, and perform a swap:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">(</span><span class="n">bs</span><span class="o">=</span><span class="p">[</span><span class="n">B</span><span class="p">(),</span> <span class="n">B</span><span class="p">()])</span>

<span class="n">a1</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">a1</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">a1</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">a1</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>
</div>
<p>During the above operation, interception of the standard Python <code class="docutils literal notranslate"><span class="pre">__setitem__</span></code>
<code class="docutils literal notranslate"><span class="pre">__delitem__</span></code> methods delivers an interim state where the second <code class="docutils literal notranslate"><span class="pre">B()</span></code>
object is present twice in the collection.  When the <code class="docutils literal notranslate"><span class="pre">B()</span></code> object is removed
from one of the positions, the <code class="docutils literal notranslate"><span class="pre">B.a</span></code> backref would set the reference to
<code class="docutils literal notranslate"><span class="pre">None</span></code>, causing the link between the <code class="docutils literal notranslate"><span class="pre">A</span></code> and <code class="docutils literal notranslate"><span class="pre">B</span></code> object to be removed
during the flush.   The same issue can be demonstrated using plain duplicates:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span> <span class="o">=</span> <span class="n">A</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b1</span> <span class="o">=</span> <span class="n">B</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">bs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">b1</span><span class="p">)</span>  <span class="c1"># append the same b1 object twice</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">del</span> <span class="n">a1</span><span class="o">.</span><span class="n">bs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">bs</span>  <span class="c1"># collection is unaffected so far...</span>
<span class="go">[&lt;__main__.B object at 0x7f047af5fb70&gt;]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b1</span><span class="o">.</span><span class="n">a</span>  <span class="c1"># however b1.a is None</span>
<span class="gp">&gt;&gt;&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>  <span class="c1"># so upon flush + expire....</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a1</span><span class="o">.</span><span class="n">bs</span>  <span class="c1"># the value is gone</span>
<span class="go">[]</span></pre></div>
</div>
<p>The fix ensures that when the backref fires off, which is before the collection
is mutated, the collection is checked for exactly one or zero instances of
the target item before unsetting the many-to-one side, using a linear search
which at the moment makes use of <code class="docutils literal notranslate"><span class="pre">list.search</span></code> and <code class="docutils literal notranslate"><span class="pre">list.__contains__</span></code>.</p>
<p>Originally it was thought that an event-based reference counting scheme would
need to be used within the collection internals so that all duplicate instances
could be tracked throughout the lifecycle of the collection, which would have
added a performance/memory/complexity impact to all collection operations,
including the very frequent operations of loading and appending.  The approach
that is taken instead limits the  additional expense  to the less common
operations of collection removal and bulk replacement, and the observed
overhead of the linear scan is negligible; linear scans of relationship-bound
collections are already used within the unit of work as well as when a
collection is bulk replaced.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/1103">#1103</a></p>
</section>
</section>
<section id="key-behavioral-changes-orm">
<h2>Key Behavioral Changes - ORM<a class="headerlink" href="#key-behavioral-changes-orm" title="Link to this heading">¶</a></h2>
<section id="query-join-handles-ambiguity-in-deciding-the-left-side-more-explicitly">
<span id="change-4365"></span><h3>Query.join() handles ambiguity in deciding the “left” side more explicitly<a class="headerlink" href="#query-join-handles-ambiguity-in-deciding-the-left-side-more-explicitly" title="Link to this heading">¶</a></h3>
<p>Historically, given a query like the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">u_alias</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span></pre></div>
</div>
<p>given the standard tutorial mappings, the query would produce a FROM clause
as:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="p">...</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_1</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">addresses</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addresses</span><span class="p">.</span><span class="n">user_id</span></pre></div>
</div>
<p>That is, the JOIN would implicitly be against the first entity that matches.
The new behavior is that an exception requests that this ambiguity be
resolved:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>sqlalchemy.exc.InvalidRequestError: Can&#39;t determine which FROM clause to
join from, there are multiple FROMS which can join to this entity.
Try adding an explicit ON clause to help resolve the ambiguity.</pre></div>
</div>
<p>The solution is to provide an ON clause, either as an expression:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># join to User</span>
<span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">u_alias</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">Address</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

<span class="c1"># join to u_alias</span>
<span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">u_alias</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">Address</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">u_alias</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></pre></div>
</div>
<p>Or to use the relationship attribute, if available:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># join to User</span>
<span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">u_alias</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span>

<span class="c1"># join to u_alias</span>
<span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">u_alias</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">u_alias</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span></pre></div>
</div>
<p>The change includes that a join can now correctly link to a FROM clause that
is not the first element in the list if the join is otherwise non-ambiguous:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">(),</span> <span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span></pre></div>
</div>
<p>Prior to this enhancement, the above query would raise:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>sqlalchemy.exc.InvalidRequestError: Don&#39;t know how to join from
CURRENT_TIMESTAMP; please use select_from() to establish the
left entity/selectable of this join</pre></div>
</div>
<p>Now the query works fine:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="k">CURRENT_TIMESTAMP</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">current_timestamp_1</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_id</span><span class="p">,</span>
<span class="n">users</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_name</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">fullname</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_fullname</span><span class="p">,</span>
<span class="n">users</span><span class="p">.</span><span class="n">password</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">users_password</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">users</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">addresses</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">users</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">addresses</span><span class="p">.</span><span class="n">user_id</span></pre></div>
</div>
<p>Overall the change is directly towards Python’s “explicit is better than
implicit” philosophy.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4365">#4365</a></p>
</section>
<section id="for-update-clause-is-rendered-within-the-joined-eager-load-subquery-as-well-as-outside">
<span id="change-4246"></span><h3>FOR UPDATE clause is rendered within the joined eager load subquery as well as outside<a class="headerlink" href="#for-update-clause-is-rendered-within-the-joined-eager-load-subquery-as-well-as-outside" title="Link to this heading">¶</a></h3>
<p>This change applies specifically to the use of the <a class="reference internal" href="../orm/queryguide/relationships.html#sqlalchemy.orm.joinedload" title="sqlalchemy.orm.joinedload"><code class="xref py py-func docutils literal notranslate"><span class="pre">joinedload()</span></code></a> loading
strategy in conjunction with a row limited query, e.g. using <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.first" title="sqlalchemy.orm.Query.first"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.first()</span></code></a>
or <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.limit" title="sqlalchemy.orm.Query.limit"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.limit()</span></code></a>, as well as with use of the <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.with_for_update" title="sqlalchemy.orm.Query.with_for_update"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.with_for_update()</span></code></a> method.</p>
<p>Given a query as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></pre></div>
</div>
<p>The <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query" title="sqlalchemy.orm.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> object renders a SELECT of the following form when joined
eager loading is combined with LIMIT:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">subq</span><span class="p">.</span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">subq</span><span class="p">.</span><span class="n">a_data</span><span class="p">,</span><span class="w"> </span><span class="n">b_alias</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">b_alias</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_data</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span>
<span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">subq</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">subq</span><span class="p">.</span><span class="n">a_id</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="n">a_id</span></pre></div>
</div>
<p>This is so that the limit of rows takes place for the primary entity without
affecting the joined eager load of related items.   When the above query is
combined with “SELECT..FOR UPDATE”, the behavior has been this:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">subq</span><span class="p">.</span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">subq</span><span class="p">.</span><span class="n">a_data</span><span class="p">,</span><span class="w"> </span><span class="n">b_alias</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">b_alias</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_data</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span>
<span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">subq</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">subq</span><span class="p">.</span><span class="n">a_id</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span></pre></div>
</div>
<p>However, MySQL due to <a class="reference external" href="https://bugs.mysql.com/bug.php?id=90693">https://bugs.mysql.com/bug.php?id=90693</a> does not lock
the rows inside the subquery, unlike that of PostgreSQL and other databases.
So the above query now renders as:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">subq</span><span class="p">.</span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">subq</span><span class="p">.</span><span class="n">a_data</span><span class="p">,</span><span class="w"> </span><span class="n">b_alias</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">b_alias</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_data</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span>
<span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">subq</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">subq</span><span class="p">.</span><span class="n">a_id</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="n">a_id</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span></pre></div>
</div>
<p>On the Oracle dialect, the inner “FOR UPDATE” is not rendered as Oracle does
not support this syntax and the dialect skips any “FOR UPDATE” that is against
a subquery; it isn’t necessary in any case since Oracle, like PostgreSQL,
correctly locks all elements of the returned row.</p>
<p>When using the <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.with_for_update.params.of" title="sqlalchemy.orm.Query.with_for_update"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Query.with_for_update.of</span></code></a> modifier, typically on
PostgreSQL, the outer “FOR UPDATE” is omitted, and the OF is now rendered
on the inside; previously, the OF target would not be converted to accommodate
for the subquery correctly.  So
given:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">A</span><span class="o">.</span><span class="n">b</span><span class="p">))</span><span class="o">.</span><span class="n">with_for_update</span><span class="p">(</span><span class="n">of</span><span class="o">=</span><span class="n">A</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span></pre></div>
</div>
<p>The query would now render as:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">subq</span><span class="p">.</span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">subq</span><span class="p">.</span><span class="n">a_data</span><span class="p">,</span><span class="w"> </span><span class="n">b_alias</span><span class="p">.</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">b_alias</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="k">SELECT</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_id</span><span class="p">,</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="k">data</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">a_data</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="k">LIMIT</span><span class="w"> </span><span class="mi">5</span><span class="w"> </span><span class="k">FOR</span><span class="w"> </span><span class="k">UPDATE</span><span class="w"> </span><span class="k">OF</span><span class="w"> </span><span class="n">a</span>
<span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">subq</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">b</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">subq</span><span class="p">.</span><span class="n">a_id</span><span class="o">=</span><span class="n">b</span><span class="p">.</span><span class="n">a_id</span></pre></div>
</div>
<p>The above form should be helpful on PostgreSQL additionally since PostgreSQL
will not allow the FOR UPDATE clause to be rendered after the LEFT OUTER JOIN
target.</p>
<p>Overall, FOR UPDATE remains highly specific to the target database in use
and can’t easily be generalized for more complex queries.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4246">#4246</a></p>
</section>
<section id="passive-deletes-all-will-leave-fk-unchanged-for-object-removed-from-collection">
<span id="change-3844"></span><h3>passive_deletes=’all’ will leave FK unchanged for object removed from collection<a class="headerlink" href="#passive-deletes-all-will-leave-fk-unchanged-for-object-removed-from-collection" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship.params.passive_deletes" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.passive_deletes</span></code></a> option accepts the value
<code class="docutils literal notranslate"><span class="pre">&quot;all&quot;</span></code> to indicate that no foreign key attributes should be modified when
the object is flushed, even if the relationship’s collection / reference has
been removed.   Previously, this did not take place for one-to-many, or
one-to-one relationships, in the following situation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;users&quot;</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">addresses</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">passive_deletes</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">)</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;addresses&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s2">&quot;users.id&quot;</span><span class="p">))</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">)</span>


<span class="n">u1</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<span class="n">address</span> <span class="o">=</span> <span class="n">u1</span><span class="o">.</span><span class="n">addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">u1</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

<span class="c1"># would fail and be set to None</span>
<span class="k">assert</span> <span class="n">address</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">u1</span><span class="o">.</span><span class="n">id</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The fix now includes that <code class="docutils literal notranslate"><span class="pre">address.user_id</span></code> is left unchanged as per
<code class="docutils literal notranslate"><span class="pre">passive_deletes=&quot;all&quot;</span></code>. This kind of thing is useful for building custom
“version table” schemes and such where rows are archived instead of deleted.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3844">#3844</a></p>
</section>
</section>
<section id="new-features-and-improvements-core">
<span id="change-4268"></span><h2>New Features and Improvements - Core<a class="headerlink" href="#new-features-and-improvements-core" title="Link to this heading">¶</a></h2>
<section id="new-multi-column-naming-convention-tokens-long-name-truncation">
<span id="change-3989"></span><h3>New multi-column naming convention tokens, long name truncation<a class="headerlink" href="#new-multi-column-naming-convention-tokens-long-name-truncation" title="Link to this heading">¶</a></h3>
<p>To suit the case where a <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData" title="sqlalchemy.schema.MetaData"><code class="xref py py-class docutils literal notranslate"><span class="pre">MetaData</span></code></a> naming convention needs to
disambiguate between multiple-column constraints and wishes to use all the
columns within the generated constraint name, a new series of
naming convention tokens are added, including
<code class="docutils literal notranslate"><span class="pre">column_0N_name</span></code>, <code class="docutils literal notranslate"><span class="pre">column_0_N_name</span></code>, <code class="docutils literal notranslate"><span class="pre">column_0N_key</span></code>, <code class="docutils literal notranslate"><span class="pre">column_0_N_key</span></code>,
<code class="docutils literal notranslate"><span class="pre">referred_column_0N_name</span></code>, <code class="docutils literal notranslate"><span class="pre">referred_column_0_N_name</span></code>, etc., which render
the column name (or key or label) for all columns in the constraint,
joined together either with no separator or with an underscore
separator.  Below we define a convention that will name <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">UniqueConstraint</span></code></a>
constraints with a name that joins together the names of all columns:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">metadata_obj</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">(</span>
    <span class="n">naming_convention</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;uq&quot;</span><span class="p">:</span> <span class="s2">&quot;uq_</span><span class="si">%(table_name)s</span><span class="s2">_</span><span class="si">%(column_0_N_name)s</span><span class="s2">&quot;</span><span class="p">}</span>
<span class="p">)</span>

<span class="n">table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;info&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;c&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
    <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">),</span>
<span class="p">)</span></pre></div>
</div>
<p>The CREATE TABLE for the above table will render as:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">a</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">b</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="k">c</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">uq_info_a_b_c</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="n">b</span><span class="p">,</span><span class="w"> </span><span class="k">c</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>In addition, long-name truncation logic is now applied to the names generated
by naming conventions, in particular to accommodate for multi-column labels
that can produce very long names.  This logic, which is the same as that used
for truncating long label names in a SELECT statement, replaces excess
characters that go over the identifier-length limit for the target database
with a deterministically generated 4-character hash.  For example, on
PostgreSQL where identifiers cannot be longer than 63 characters, a long
constraint name would normally be generated from the table definition below:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">long_names</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;long_names&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;information_channel_code&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;billing_convention_name&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;b&quot;</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;product_identifier&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;c&quot;</span><span class="p">),</span>
    <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;b&quot;</span><span class="p">,</span> <span class="s2">&quot;c&quot;</span><span class="p">),</span>
<span class="p">)</span></pre></div>
</div>
<p>The truncation logic will ensure a too-long name isn’t generated for the
UNIQUE constraint:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">long_names</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">information_channel_code</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">billing_convention_name</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="n">product_identifier</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">uq_long_names_information_channel_code_billing_conventi_a79e</span>
<span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">information_channel_code</span><span class="p">,</span><span class="w"> </span><span class="n">billing_convention_name</span><span class="p">,</span><span class="w"> </span><span class="n">product_identifier</span><span class="p">)</span>
<span class="p">)</span></pre></div>
</div>
<p>The above suffix <code class="docutils literal notranslate"><span class="pre">a79e</span></code> is based on the md5 hash of the long name and will
generate the same value every time to produce consistent names for a given
schema.</p>
<p>Note that the truncation logic also raises <a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.IdentifierError" title="sqlalchemy.exc.IdentifierError"><code class="xref py py-class docutils literal notranslate"><span class="pre">IdentifierError</span></code></a> when a
constraint name is explicitly too large for a given dialect.  This has been
the behavior for an <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Index" title="sqlalchemy.schema.Index"><code class="xref py py-class docutils literal notranslate"><span class="pre">Index</span></code></a> object for a long time, but is now applied
to other kinds of constraints as well:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Integer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">MetaData</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">Table</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">UniqueConstraint</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects</span><span class="w"> </span><span class="kn">import</span> <span class="n">postgresql</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.schema</span><span class="w"> </span><span class="kn">import</span> <span class="n">AddConstraint</span>

<span class="n">m</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">t</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;t&quot;</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">))</span>
<span class="n">uq</span> <span class="o">=</span> <span class="n">UniqueConstraint</span><span class="p">(</span>
    <span class="n">t</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s2">&quot;this_is_too_long_of_a_name_for_any_database_backend_even_postgresql&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">print</span><span class="p">(</span><span class="n">AddConstraint</span><span class="p">(</span><span class="n">uq</span><span class="p">)</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">postgresql</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span></pre></div>
</div>
<p>will output:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>sqlalchemy.exc.IdentifierError: Identifier
&#39;this_is_too_long_of_a_name_for_any_database_backend_even_postgresql&#39;
exceeds maximum length of 63 characters</pre></div>
</div>
<p>The exception raise prevents the production of non-deterministic constraint
names truncated by the database backend which are then not compatible with
database migrations later on.</p>
<p>To apply SQLAlchemy-side truncation rules to the above identifier, use the
<a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.conv" title="sqlalchemy.schema.conv"><code class="xref py py-func docutils literal notranslate"><span class="pre">conv()</span></code></a> construct:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">uq</span> <span class="o">=</span> <span class="n">UniqueConstraint</span><span class="p">(</span>
    <span class="n">t</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="n">conv</span><span class="p">(</span><span class="s2">&quot;this_is_too_long_of_a_name_for_any_database_backend_even_postgresql&quot;</span><span class="p">),</span>
<span class="p">)</span></pre></div>
</div>
<p>This will again output deterministically truncated SQL as in:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">ALTER</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="k">ADD</span><span class="w"> </span><span class="k">CONSTRAINT</span><span class="w"> </span><span class="n">this_is_too_long_of_a_name_for_any_database_backend_eve_ac05</span><span class="w"> </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">x</span><span class="p">)</span></pre></div>
</div>
<p>There is not at the moment an option to have the names pass through to allow
database-side truncation.  This has already been the case for <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.Index" title="sqlalchemy.schema.Index"><code class="xref py py-class docutils literal notranslate"><span class="pre">Index</span></code></a>
names for some time and issues have not been raised.</p>
<p>The change also repairs two other issues.  One is that the  <code class="docutils literal notranslate"><span class="pre">column_0_key</span></code>
token wasn’t available even though this token was documented, the other was
that the <code class="docutils literal notranslate"><span class="pre">referred_column_0_name</span></code> token would  inadvertently render the
<code class="docutils literal notranslate"><span class="pre">.key</span></code> and not the <code class="docutils literal notranslate"><span class="pre">.name</span></code> of the column if these two values were
different.</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../core/constraints.html#constraint-naming-conventions"><span class="std std-ref">配置约束命名约定</span></a></p>
<p><a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.MetaData.params.naming_convention" title="sqlalchemy.schema.MetaData"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">MetaData.naming_convention</span></code></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3989">#3989</a></p>
</section>
<section id="binary-comparison-interpretation-for-sql-functions">
<span id="change-3831"></span><h3>Binary comparison interpretation for SQL functions<a class="headerlink" href="#binary-comparison-interpretation-for-sql-functions" title="Link to this heading">¶</a></h3>
<p>This enhancement is implemented at the Core level, however is applicable
primarily to the ORM.</p>
<p>A SQL function that compares two elements can now be used as a “comparison”
object, suitable for usage in an ORM <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship" title="sqlalchemy.orm.relationship"><code class="xref py py-func docutils literal notranslate"><span class="pre">relationship()</span></code></a>, by first
creating the function as usual using the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.func" title="sqlalchemy.sql.expression.func"><code class="xref py py-data docutils literal notranslate"><span class="pre">func</span></code></a> factory, then
when the function is complete calling upon the <a class="reference internal" href="../core/functions.html#sqlalchemy.sql.functions.FunctionElement.as_comparison" title="sqlalchemy.sql.functions.FunctionElement.as_comparison"><code class="xref py py-meth docutils literal notranslate"><span class="pre">FunctionElement.as_comparison()</span></code></a>
modifier to produce a <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.BinaryExpression" title="sqlalchemy.sql.expression.BinaryExpression"><code class="xref py py-class docutils literal notranslate"><span class="pre">BinaryExpression</span></code></a> that has a “left” and a “right”
side:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Venue</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;venue&quot;</span>
    <span class="n">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

    <span class="n">descendants</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Venue&quot;</span><span class="p">,</span>
        <span class="n">primaryjoin</span><span class="o">=</span><span class="n">func</span><span class="o">.</span><span class="n">instr</span><span class="p">(</span><span class="n">remote</span><span class="p">(</span><span class="n">foreign</span><span class="p">(</span><span class="n">name</span><span class="p">)),</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot;/&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">as_comparison</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">viewonly</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
    <span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>Above, the <a class="reference internal" href="../orm/relationship_api.html#sqlalchemy.orm.relationship.params.primaryjoin" title="sqlalchemy.orm.relationship"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">relationship.primaryjoin</span></code></a> of the “descendants” relationship
will produce a “left” and a “right” expression based on the first and second
arguments passed to <code class="docutils literal notranslate"><span class="pre">instr()</span></code>.   This allows features like the ORM
lazyload to produce SQL like:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">venue</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">venue_id</span><span class="p">,</span><span class="w"> </span><span class="n">venue</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">venue_name</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">venue</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">instr</span><span class="p">(</span><span class="n">venue</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="o">?</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">?</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">venue</span><span class="p">.</span><span class="n">name</span>
<span class="p">(</span><span class="s1">&#39;parent1&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span></pre></div>
</div>
<p>and a joinedload, such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">v1</span> <span class="o">=</span> <span class="p">(</span>
    <span class="n">s</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Venue</span><span class="p">)</span>
    <span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;parent1&quot;</span><span class="p">)</span>
    <span class="o">.</span><span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">Venue</span><span class="o">.</span><span class="n">descendants</span><span class="p">))</span>
    <span class="o">.</span><span class="n">one</span><span class="p">()</span>
<span class="p">)</span></pre></div>
</div>
<p>to work as:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">venue</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">venue_id</span><span class="p">,</span><span class="w"> </span><span class="n">venue</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">venue_name</span><span class="p">,</span>
<span class="w">  </span><span class="n">venue_1</span><span class="p">.</span><span class="n">id</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">venue_1_id</span><span class="p">,</span><span class="w"> </span><span class="n">venue_1</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">venue_1_name</span>
<span class="k">FROM</span><span class="w"> </span><span class="n">venue</span><span class="w"> </span><span class="k">LEFT</span><span class="w"> </span><span class="k">OUTER</span><span class="w"> </span><span class="k">JOIN</span><span class="w"> </span><span class="n">venue</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">venue_1</span>
<span class="w">  </span><span class="k">ON</span><span class="w"> </span><span class="n">instr</span><span class="p">(</span><span class="n">venue_1</span><span class="p">.</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">venue</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="o">?</span><span class="p">))</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span>
<span class="k">WHERE</span><span class="w"> </span><span class="n">venue</span><span class="p">.</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="k">ORDER</span><span class="w"> </span><span class="k">BY</span><span class="w"> </span><span class="n">venue_1</span><span class="p">.</span><span class="n">name</span>
<span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;parent1&#39;</span><span class="p">)</span></pre></div>
</div>
<p>This feature is expected to help with situations such as making use of
geometric functions in relationship join conditions, or any case where
the ON clause of the SQL join is expressed in terms of a SQL function.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3831">#3831</a></p>
</section>
<section id="expanding-in-feature-now-supports-empty-lists">
<span id="change-4271"></span><h3>Expanding IN feature now supports empty lists<a class="headerlink" href="#expanding-in-feature-now-supports-empty-lists" title="Link to this heading">¶</a></h3>
<p>The “expanding IN” feature introduced in version 1.2 at <a class="reference internal" href="migration_12.html#change-3953"><span class="std std-ref">Late-expanded IN parameter sets allow IN expressions with cached statements</span></a> now
supports empty lists passed to the <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.ColumnOperators.in_" title="sqlalchemy.sql.expression.ColumnOperators.in_"><code class="xref py py-meth docutils literal notranslate"><span class="pre">ColumnOperators.in_()</span></code></a> operator.   The implementation
for an empty list will produce an “empty set” expression that is specific to a target
backend, such as “SELECT CAST(NULL AS INTEGER) WHERE 1!=1” for PostgreSQL,
“SELECT 1 FROM (SELECT 1) as _empty_set WHERE 1!=1” for MySQL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">literal_column</span><span class="p">,</span> <span class="n">bindparam</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql://scott:tiger@localhost/test&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">e</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">select</span><span class="p">([</span><span class="n">literal_column</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<span class="gp">... </span>            <span class="n">literal_column</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bindparam</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">expanding</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="gp">... </span>        <span class="p">),</span>
<span class="gp">... </span>        <span class="n">q</span><span class="o">=</span><span class="p">[],</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="go">{exexsql}SELECT 1 WHERE 1 IN (SELECT CAST(NULL AS INTEGER) WHERE 1!=1)</span></pre></div>
</div>
<p>The feature also works for tuple-oriented IN statements, where the “empty IN”
expression will be expanded to support the elements given inside the tuple,
such as on PostgreSQL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">create_engine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">literal_column</span><span class="p">,</span> <span class="n">tuple_</span><span class="p">,</span> <span class="n">bindparam</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">e</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s2">&quot;postgresql://scott:tiger@localhost/test&quot;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="n">e</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
<span class="gp">... </span>    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="gp">... </span>        <span class="n">select</span><span class="p">([</span><span class="n">literal_column</span><span class="p">(</span><span class="s2">&quot;1&quot;</span><span class="p">)])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
<span class="gp">... </span>            <span class="n">tuple_</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="s2">&quot;somestring&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">bindparam</span><span class="p">(</span><span class="s2">&quot;q&quot;</span><span class="p">,</span> <span class="n">expanding</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
<span class="gp">... </span>        <span class="p">),</span>
<span class="gp">... </span>        <span class="n">q</span><span class="o">=</span><span class="p">[],</span>
<span class="gp">... </span>    <span class="p">)</span>
<span class="go">{exexsql}SELECT 1 WHERE (%(param_1)s, %(param_2)s)</span>
<span class="go">IN (SELECT CAST(NULL AS INTEGER), CAST(NULL AS VARCHAR) WHERE 1!=1)</span></pre></div>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4271">#4271</a></p>
</section>
<section id="typeengine-methods-bind-expression-column-expression-work-with-variant-type-specific-types">
<span id="change-3981"></span><h3>TypeEngine methods bind_expression, column_expression work with Variant, type-specific types<a class="headerlink" href="#typeengine-methods-bind-expression-column-expression-work-with-variant-type-specific-types" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine.bind_expression" title="sqlalchemy.types.TypeEngine.bind_expression"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.bind_expression()</span></code></a> and <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine.column_expression" title="sqlalchemy.types.TypeEngine.column_expression"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.column_expression()</span></code></a> methods
now work when they are present on the “impl” of a particular datatype, allowing these methods
to be used by dialects as well as for <a class="reference internal" href="../core/custom_types.html#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> and <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.Variant" title="sqlalchemy.types.Variant"><code class="xref py py-class docutils literal notranslate"><span class="pre">Variant</span></code></a> use cases.</p>
<p>The following example illustrates a <a class="reference internal" href="../core/custom_types.html#sqlalchemy.types.TypeDecorator" title="sqlalchemy.types.TypeDecorator"><code class="xref py py-class docutils literal notranslate"><span class="pre">TypeDecorator</span></code></a> that applies SQL-time conversion
functions to a <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.LargeBinary" title="sqlalchemy.types.LargeBinary"><code class="xref py py-class docutils literal notranslate"><span class="pre">LargeBinary</span></code></a>.   In order for this type to work in the
context of a <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.Variant" title="sqlalchemy.types.Variant"><code class="xref py py-class docutils literal notranslate"><span class="pre">Variant</span></code></a>, the compiler needs to drill into the “impl” of the
variant expression in order to locate these methods:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">TypeDecorator</span><span class="p">,</span> <span class="n">LargeBinary</span><span class="p">,</span> <span class="n">func</span>


<span class="k">class</span><span class="w"> </span><span class="nc">CompressedLargeBinary</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">LargeBinary</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">bind_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bindvalue</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">compress</span><span class="p">(</span><span class="n">bindvalue</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">column_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">col</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">func</span><span class="o">.</span><span class="n">uncompress</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">type_</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>


<span class="n">MyLargeBinary</span> <span class="o">=</span> <span class="n">LargeBinary</span><span class="p">()</span><span class="o">.</span><span class="n">with_variant</span><span class="p">(</span><span class="n">CompressedLargeBinary</span><span class="p">(),</span> <span class="s2">&quot;sqlite&quot;</span><span class="p">)</span></pre><div class="code-non-annotations-key"></div></div>
</div>
<p>The above expression will render a function within SQL when used on SQLite only:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy</span><span class="w"> </span><span class="kn">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">column</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects</span><span class="w"> </span><span class="kn">import</span> <span class="n">sqlite</span>

<span class="n">print</span><span class="p">(</span><span class="n">select</span><span class="p">([</span><span class="n">column</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">CompressedLargeBinary</span><span class="p">)])</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">dialect</span><span class="o">=</span><span class="n">sqlite</span><span class="o">.</span><span class="n">dialect</span><span class="p">()))</span></pre></div>
</div>
<p>will render:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span><span class="w"> </span><span class="n">uncompress</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="n">x</span></pre></div>
</div>
<p>The change also includes that dialects can implement
<a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine.bind_expression" title="sqlalchemy.types.TypeEngine.bind_expression"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.bind_expression()</span></code></a> and <a class="reference internal" href="../core/type_api.html#sqlalchemy.types.TypeEngine.column_expression" title="sqlalchemy.types.TypeEngine.column_expression"><code class="xref py py-meth docutils literal notranslate"><span class="pre">TypeEngine.column_expression()</span></code></a>
on dialect-level implementation types where they will now be used; in
particular this will be used for MySQL’s new “binary prefix” requirement as
well as for casting decimal bind values for MySQL.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3981">#3981</a></p>
</section>
<section id="new-last-in-first-out-strategy-for-queuepool">
<span id="change-pr467"></span><h3>New last-in-first-out strategy for QueuePool<a class="headerlink" href="#new-last-in-first-out-strategy-for-queuepool" title="Link to this heading">¶</a></h3>
<p>The connection pool usually used by <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code></a> is known
as <a class="reference internal" href="../core/pooling.html#sqlalchemy.pool.QueuePool" title="sqlalchemy.pool.QueuePool"><code class="xref py py-class docutils literal notranslate"><span class="pre">QueuePool</span></code></a>.  This pool uses an object equivalent to Python’s
built-in <code class="docutils literal notranslate"><span class="pre">Queue</span></code> class in order to store database connections waiting
to be used.   The <code class="docutils literal notranslate"><span class="pre">Queue</span></code> features first-in-first-out behavior, which is
intended to provide a round-robin use of the database connections that are
persistently in the pool.   However, a potential downside of this is that
when the utilization of the pool is low, the re-use of each connection in series
means that a server-side timeout strategy that attempts to reduce unused
connections is prevented from shutting down these connections.   To suit
this use case, a new flag <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.pool_use_lifo" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.pool_use_lifo</span></code></a> is added
which reverses the <code class="docutils literal notranslate"><span class="pre">.get()</span></code> method of the <code class="docutils literal notranslate"><span class="pre">Queue</span></code> to pull the connection
from the beginning of the queue instead of the end, essentially turning the
“queue” into a “stack” (adding a whole new pool called <code class="docutils literal notranslate"><span class="pre">StackPool</span></code> was
considered, however this was too much verbosity).</p>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../core/pooling.html#pool-use-lifo"><span class="std std-ref">使用 FIFO 与 LIFO</span></a></p>
</div>
</section>
</section>
<section id="key-changes-core">
<h2>Key Changes - Core<a class="headerlink" href="#key-changes-core" title="Link to this heading">¶</a></h2>
<section id="coercion-of-string-sql-fragments-to-text-fully-removed">
<span id="change-4481"></span><h3>Coercion of string SQL fragments to text() fully removed<a class="headerlink" href="#coercion-of-string-sql-fragments-to-text-fully-removed" title="Link to this heading">¶</a></h3>
<p>The warnings that were first added in version 1.0, described at
<a class="reference internal" href="migration_10.html#migration-2992"><span class="std std-ref">Warnings emitted when coercing full SQL fragments into text()</span></a>, have now been converted into exceptions.    Continued
concerns have been raised regarding the automatic coercion of string fragments
passed to methods like <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.filter" title="sqlalchemy.orm.Query.filter"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.filter()</span></code></a> and <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.order_by" title="sqlalchemy.sql.expression.Select.order_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.order_by()</span></code></a> being
converted to <a class="reference internal" href="../core/sqlelement.html#sqlalchemy.sql.expression.text" title="sqlalchemy.sql.expression.text"><code class="xref py py-func docutils literal notranslate"><span class="pre">text()</span></code></a> constructs, even though this has emitted a warning.
In the case of <a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.order_by" title="sqlalchemy.sql.expression.Select.order_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.order_by()</span></code></a>, <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.order_by" title="sqlalchemy.orm.Query.order_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.order_by()</span></code></a>,
<a class="reference internal" href="../core/selectable.html#sqlalchemy.sql.expression.Select.group_by" title="sqlalchemy.sql.expression.Select.group_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Select.group_by()</span></code></a>, and <a class="reference internal" href="../orm/queryguide/query.html#sqlalchemy.orm.Query.group_by" title="sqlalchemy.orm.Query.group_by"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Query.group_by()</span></code></a>, a string label or column
name is still resolved into the corresponding expression construct, however if
the resolution fails, a <a class="reference internal" href="../core/exceptions.html#sqlalchemy.exc.CompileError" title="sqlalchemy.exc.CompileError"><code class="xref py py-class docutils literal notranslate"><span class="pre">CompileError</span></code></a> is raised, thus preventing raw
SQL text from being rendered directly.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4481">#4481</a></p>
</section>
<section id="threadlocal-engine-strategy-deprecated">
<span id="change-4393-threadlocal"></span><h3>“threadlocal” engine strategy deprecated<a class="headerlink" href="#threadlocal-engine-strategy-deprecated" title="Link to this heading">¶</a></h3>
<p>The “threadlocal engine strategy” was added around SQLAlchemy 0.2, as a
solution to the problem that the standard way of operating in SQLAlchemy 0.1,
which can be summed up as “threadlocal everything”,  was found to be lacking.
In retrospect, it seems fairly absurd that by SQLAlchemy’s first releases which
were in every regard “alpha”, that there was concern that too many users had
already settled on the existing API to simply change it.</p>
<p>The original usage model for SQLAlchemy looked like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>

<span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">select</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

<span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">()</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

<span class="n">engine</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></pre></div>
</div>
<p>After a few months of real world use, it was clear that trying to pretend a
“connection” or a “transaction” was a hidden implementation detail was a bad
idea, particularly the moment someone needed to deal with more than one
database connection at a time.   So the usage paradigm we see today was
introduced, minus the context managers since they didn’t yet exist in Python:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">conn</span> <span class="o">=</span> <span class="n">engine</span><span class="o">.</span><span class="n">connect</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">trans</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span> <span class="n">parameters</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">(),</span> <span class="n">parameters</span><span class="p">)</span>

    <span class="n">trans</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
    <span class="n">trans</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
    <span class="k">raise</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></pre></div>
</div>
<p>The above paradigm was what people needed, but since it was still kind of
verbose (because no context managers), the old way of working was kept around
as well and it became the threadlocal engine strategy.</p>
<p>Today, working with Core is much more succinct, and even more succinct than
the original pattern, thanks to context managers:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">engine</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span> <span class="k">as</span> <span class="n">conn</span><span class="p">:</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span> <span class="n">parameters</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">select</span><span class="p">())</span>

    <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">update</span><span class="p">(),</span> <span class="n">parameters</span><span class="p">)</span></pre></div>
</div>
<p>At this point, any remaining code that is still relying upon the “threadlocal”
style will be encouraged via this deprecation to modernize - the feature should
be removed totally by the next major series of SQLAlchemy, e.g. 1.4.  The
connection pool parameter <a class="reference internal" href="../core/pooling.html#sqlalchemy.pool.Pool.params.use_threadlocal" title="sqlalchemy.pool.Pool"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Pool.use_threadlocal</span></code></a> is also deprecated
as it does not actually have any effect in most cases, as is the
<code class="xref py py-meth docutils literal notranslate"><span class="pre">Engine.contextual_connect()</span></code> method, which is normally synonymous with
the <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Engine.connect" title="sqlalchemy.engine.Engine.connect"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Engine.connect()</span></code></a> method except in the case where the threadlocal
engine is in use.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4393">#4393</a></p>
</section>
<section id="convert-unicode-parameters-deprecated">
<span id="change-4393-convertunicode"></span><h3>convert_unicode parameters deprecated<a class="headerlink" href="#convert-unicode-parameters-deprecated" title="Link to this heading">¶</a></h3>
<p>The parameters <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.String.params.convert_unicode" title="sqlalchemy.types.String"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">String.convert_unicode</span></code></a> and
<a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.convert_unicode" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.convert_unicode</span></code></a> are deprecated.    The purpose of
these parameters was to instruct SQLAlchemy to ensure that incoming Python
Unicode objects under Python 2 were encoded to bytestrings before passing to
the database, and to expect bytestrings from the database to be converted back
to Python Unicode objects.   In the pre-Python 3 era, this was an enormous
ordeal to get right, as virtually all Python DBAPIs had no Unicode support
enabled by default, and most had major issues with the Unicode extensions that
they did provide.    Eventually, SQLAlchemy added C extensions, one of the
primary purposes of these extensions was to speed up the Unicode decode process
within result sets.</p>
<p>Once Python 3 was introduced, DBAPIs began to start supporting Unicode more
fully, and more importantly, by default.  However, the conditions under which a
particular DBAPI would or would not return Unicode data from a result, as well
as accept Python Unicode values as parameters, remained extremely complicated.
This was the beginning of the obsolescence of the “convert_unicode” flags,
because they were no longer sufficient as a means of ensuring that
encode/decode was occurring only where needed and not where it wasn’t needed.
Instead, “convert_unicode” started to be automatically detected by dialects.
Part of this can be seen in the “SELECT ‘test plain returns’” and “SELECT
‘test_unicode_returns’” SQL emitted by an engine the first time it connects;
the dialect is testing that the current DBAPI with its current settings and
backend database connection is returning Unicode by default or not.</p>
<p>The end result is that end-user use of the “convert_unicode” flags should no
longer be needed in any circumstances, and if they are, the SQLAlchemy project
needs to know what those cases are and why.   Currently, hundreds of Unicode
round trip tests pass across all major databases without the use of this flag
so there is a fairly high level of confidence that they are no longer needed
except in arguable non use cases such as accessing mis-encoded data from a
legacy database, which would be better suited using custom types.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4393">#4393</a></p>
</section>
</section>
<section id="dialect-improvements-and-changes-postgresql">
<h2>Dialect Improvements and Changes - PostgreSQL<a class="headerlink" href="#dialect-improvements-and-changes-postgresql" title="Link to this heading">¶</a></h2>
<section id="added-basic-reflection-support-for-postgresql-partitioned-tables">
<span id="change-4237"></span><h3>Added basic reflection support for PostgreSQL partitioned tables<a class="headerlink" href="#added-basic-reflection-support-for-postgresql-partitioned-tables" title="Link to this heading">¶</a></h3>
<p>SQLAlchemy can render the “PARTITION BY” sequence within a PostgreSQL
CREATE TABLE statement using the flag <code class="docutils literal notranslate"><span class="pre">postgresql_partition_by</span></code>, added in
version 1.2.6.    However, the <code class="docutils literal notranslate"><span class="pre">'p'</span></code> type was not part of the reflection
queries used until now.</p>
<p>Given a schema such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dv</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;data_values&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;modulus&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">30</span><span class="p">)),</span>
    <span class="n">postgresql_partition_by</span><span class="o">=</span><span class="s2">&quot;range(modulus)&quot;</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">sa</span><span class="o">.</span><span class="n">event</span><span class="o">.</span><span class="n">listen</span><span class="p">(</span>
    <span class="n">dv</span><span class="p">,</span>
    <span class="s2">&quot;after_create&quot;</span><span class="p">,</span>
    <span class="n">sa</span><span class="o">.</span><span class="n">DDL</span><span class="p">(</span>
        <span class="s2">&quot;CREATE TABLE data_values_4_10 PARTITION OF data_values &quot;</span>
        <span class="s2">&quot;FOR VALUES FROM (4) TO (10)&quot;</span>
    <span class="p">),</span>
<span class="p">)</span></pre></div>
</div>
<p>The two table names <code class="docutils literal notranslate"><span class="pre">'data_values'</span></code> and <code class="docutils literal notranslate"><span class="pre">'data_values_4_10'</span></code> will come
back from <a class="reference internal" href="../core/reflection.html#sqlalchemy.engine.reflection.Inspector.get_table_names" title="sqlalchemy.engine.reflection.Inspector.get_table_names"><code class="xref py py-meth docutils literal notranslate"><span class="pre">Inspector.get_table_names()</span></code></a> and additionally the columns
will come back from <code class="docutils literal notranslate"><span class="pre">Inspector.get_columns('data_values')</span></code> as well
as <code class="docutils literal notranslate"><span class="pre">Inspector.get_columns('data_values_4_10')</span></code>.   This also extends to the
use of <code class="docutils literal notranslate"><span class="pre">Table(...,</span> <span class="pre">autoload=True)</span></code> with these tables.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4237">#4237</a></p>
</section>
</section>
<section id="dialect-improvements-and-changes-mysql">
<h2>Dialect Improvements and Changes - MySQL<a class="headerlink" href="#dialect-improvements-and-changes-mysql" title="Link to this heading">¶</a></h2>
<section id="protocol-level-ping-now-used-for-pre-ping">
<span id="change-mysql-ping"></span><h3>Protocol-level ping now used for pre-ping<a class="headerlink" href="#protocol-level-ping-now-used-for-pre-ping" title="Link to this heading">¶</a></h3>
<p>The MySQL dialects including mysqlclient, python-mysql, PyMySQL and
mysql-connector-python now use the <code class="docutils literal notranslate"><span class="pre">connection.ping()</span></code> method for the
pool pre-ping feature, described at <a class="reference internal" href="../core/pooling.html#pool-disconnects-pessimistic"><span class="std std-ref">断开连接处理 - 悲观</span></a>.
This is a much more lightweight ping than the previous method of emitting
“SELECT 1” on the connection.</p>
</section>
<section id="control-of-parameter-ordering-within-on-duplicate-key-update">
<span id="change-mysql-ondupordering"></span><h3>Control of parameter ordering within ON DUPLICATE KEY UPDATE<a class="headerlink" href="#control-of-parameter-ordering-within-on-duplicate-key-update" title="Link to this heading">¶</a></h3>
<p>The order of UPDATE parameters in the <code class="docutils literal notranslate"><span class="pre">ON</span> <span class="pre">DUPLICATE</span> <span class="pre">KEY</span> <span class="pre">UPDATE</span></code> clause
can now be explicitly ordered by passing a list of 2-tuples:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">sqlalchemy.dialects.mysql</span><span class="w"> </span><span class="kn">import</span> <span class="n">insert</span>

<span class="n">insert_stmt</span> <span class="o">=</span> <span class="n">insert</span><span class="p">(</span><span class="n">my_table</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="n">id</span><span class="o">=</span><span class="s2">&quot;some_existing_id&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">&quot;inserted value&quot;</span><span class="p">)</span>

<span class="n">on_duplicate_key_stmt</span> <span class="o">=</span> <span class="n">insert_stmt</span><span class="o">.</span><span class="n">on_duplicate_key_update</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="s2">&quot;some data&quot;</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;updated_at&quot;</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">()),</span>
    <span class="p">],</span>
<span class="p">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../dialects/mysql.html#mysql-insert-on-duplicate-key-update"><span class="std std-ref">INSERT…ON DUPLICATE KEY UPDATE (Upsert)</span></a></p>
</div>
</section>
</section>
<section id="dialect-improvements-and-changes-sqlite">
<h2>Dialect Improvements and Changes - SQLite<a class="headerlink" href="#dialect-improvements-and-changes-sqlite" title="Link to this heading">¶</a></h2>
<section id="support-for-sqlite-json-added">
<span id="change-3850"></span><h3>Support for SQLite JSON Added<a class="headerlink" href="#support-for-sqlite-json-added" title="Link to this heading">¶</a></h3>
<p>A new datatype <a class="reference internal" href="../dialects/sqlite.html#sqlalchemy.dialects.sqlite.JSON" title="sqlalchemy.dialects.sqlite.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a> is added which implements SQLite’s json
member access functions on behalf of the <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.JSON" title="sqlalchemy.types.JSON"><code class="xref py py-class docutils literal notranslate"><span class="pre">JSON</span></code></a>
base datatype.  The SQLite <code class="docutils literal notranslate"><span class="pre">JSON_EXTRACT</span></code> and <code class="docutils literal notranslate"><span class="pre">JSON_QUOTE</span></code> functions
are used by the implementation to provide basic JSON support.</p>
<p>Note that the name of the datatype itself as rendered in the database is
the name “JSON”.   This will create a SQLite datatype with “numeric” affinity,
which normally should not be an issue except in the case of a JSON value that
consists of single integer value.  Nevertheless, following an example
in SQLite’s own documentation at <a class="reference external" href="https://www.sqlite.org/json1.html">https://www.sqlite.org/json1.html</a> the name
JSON is being used for its familiarity.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/3850">#3850</a></p>
</section>
<section id="support-for-sqlite-on-conflict-in-constraints-added">
<span id="change-4360"></span><h3>Support for SQLite ON CONFLICT in constraints added<a class="headerlink" href="#support-for-sqlite-on-conflict-in-constraints-added" title="Link to this heading">¶</a></h3>
<p>SQLite supports a non-standard ON CONFLICT clause that may be specified
for standalone constraints as well as some column-inline constraints such as
NOT NULL. Support has been added for these clauses via the <code class="docutils literal notranslate"><span class="pre">sqlite_on_conflict</span></code>
keyword added to objects like <a class="reference internal" href="../core/constraints.html#sqlalchemy.schema.UniqueConstraint" title="sqlalchemy.schema.UniqueConstraint"><code class="xref py py-class docutils literal notranslate"><span class="pre">UniqueConstraint</span></code></a>  as well
as several <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a> -specific variants:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">some_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;some_table&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sqlite_on_conflict_primary_key</span><span class="o">=</span><span class="s2">&quot;FAIL&quot;</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">),</span>
    <span class="n">UniqueConstraint</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;data&quot;</span><span class="p">,</span> <span class="n">sqlite_on_conflict</span><span class="o">=</span><span class="s2">&quot;IGNORE&quot;</span><span class="p">),</span>
<span class="p">)</span></pre></div>
</div>
<p>The above table would render in a CREATE TABLE statement as:</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span><span class="w"> </span><span class="k">TABLE</span><span class="w"> </span><span class="n">some_table</span><span class="w"> </span><span class="p">(</span>
<span class="w">    </span><span class="n">id</span><span class="w"> </span><span class="nb">INTEGER</span><span class="w"> </span><span class="k">NOT</span><span class="w"> </span><span class="k">NULL</span><span class="p">,</span>
<span class="w">    </span><span class="k">data</span><span class="w"> </span><span class="nb">INTEGER</span><span class="p">,</span>
<span class="w">    </span><span class="k">PRIMARY</span><span class="w"> </span><span class="k">KEY</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">CONFLICT</span><span class="w"> </span><span class="n">FAIL</span><span class="p">,</span>
<span class="w">    </span><span class="k">UNIQUE</span><span class="w"> </span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="k">data</span><span class="p">)</span><span class="w"> </span><span class="k">ON</span><span class="w"> </span><span class="n">CONFLICT</span><span class="w"> </span><span class="k">IGNORE</span>
<span class="p">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../dialects/sqlite.html#sqlite-on-conflict-ddl"><span class="std std-ref">ON CONFLICT support for constraints</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4360">#4360</a></p>
</section>
</section>
<section id="dialect-improvements-and-changes-oracle">
<h2>Dialect Improvements and Changes - Oracle<a class="headerlink" href="#dialect-improvements-and-changes-oracle" title="Link to this heading">¶</a></h2>
<section id="national-char-datatypes-de-emphasized-for-generic-unicode-re-enabled-with-option">
<span id="change-4242"></span><h3>National char datatypes de-emphasized for generic unicode, re-enabled with option<a class="headerlink" href="#national-char-datatypes-de-emphasized-for-generic-unicode-re-enabled-with-option" title="Link to this heading">¶</a></h3>
<p>The <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Unicode" title="sqlalchemy.types.Unicode"><code class="xref py py-class docutils literal notranslate"><span class="pre">Unicode</span></code></a> and <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.UnicodeText" title="sqlalchemy.types.UnicodeText"><code class="xref py py-class docutils literal notranslate"><span class="pre">UnicodeText</span></code></a> datatypes by default now
correspond to the <code class="docutils literal notranslate"><span class="pre">VARCHAR2</span></code> and <code class="docutils literal notranslate"><span class="pre">CLOB</span></code> datatypes on Oracle, rather than
<code class="docutils literal notranslate"><span class="pre">NVARCHAR2</span></code> and <code class="docutils literal notranslate"><span class="pre">NCLOB</span></code> (otherwise known as “national” character set
types).  This will be seen in behaviors such  as that of how they render in
<code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">TABLE</span></code> statements, as well as that no type object will be passed to
<code class="docutils literal notranslate"><span class="pre">setinputsizes()</span></code> when bound parameters using <a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Unicode" title="sqlalchemy.types.Unicode"><code class="xref py py-class docutils literal notranslate"><span class="pre">Unicode</span></code></a> or
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.UnicodeText" title="sqlalchemy.types.UnicodeText"><code class="xref py py-class docutils literal notranslate"><span class="pre">UnicodeText</span></code></a> are used; cx_Oracle handles the string value natively.
This change is based on advice from cx_Oracle’s maintainer that the “national”
datatypes in Oracle are largely obsolete and are not performant.   They also
interfere in some situations such as when applied to the format specifier for
functions like <code class="docutils literal notranslate"><span class="pre">trunc()</span></code>.</p>
<p>The one case where <code class="docutils literal notranslate"><span class="pre">NVARCHAR2</span></code> and related types may be needed is for a
database that is not using a Unicode-compliant character set.  In this case,
the flag <code class="docutils literal notranslate"><span class="pre">use_nchar_for_unicode</span></code> can be passed to <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code></a> to
re-enable the old behavior.</p>
<p>As always, using the <a class="reference internal" href="../dialects/oracle.html#sqlalchemy.dialects.oracle.NVARCHAR2" title="sqlalchemy.dialects.oracle.NVARCHAR2"><code class="xref py py-class docutils literal notranslate"><span class="pre">NVARCHAR2</span></code></a> and <a class="reference internal" href="../dialects/oracle.html#sqlalchemy.dialects.oracle.NCLOB" title="sqlalchemy.dialects.oracle.NCLOB"><code class="xref py py-class docutils literal notranslate"><span class="pre">NCLOB</span></code></a>
datatypes explicitly will continue to make use of <code class="docutils literal notranslate"><span class="pre">NVARCHAR2</span></code> and <code class="docutils literal notranslate"><span class="pre">NCLOB</span></code>,
including within DDL as well as when handling bound parameters with cx_Oracle’s
<code class="docutils literal notranslate"><span class="pre">setinputsizes()</span></code>.</p>
<p>On the read side, automatic Unicode conversion under Python 2 has been added to
CHAR/VARCHAR/CLOB result rows, to match the behavior of cx_Oracle under Python
3.  In order to mitigate the performance hit that the cx_Oracle dialect  had
previously with this behavior under Python 2, SQLAlchemy’s very performant
(when C extensions are built) native Unicode handlers are used under Python 2.
The automatic unicode coercion can be disabled by setting the
<code class="docutils literal notranslate"><span class="pre">coerce_to_unicode</span></code> flag to False. This flag now defaults to True and applies
to all string data returned in a result set that isn’t explicitly under
<a class="reference internal" href="../core/type_basics.html#sqlalchemy.types.Unicode" title="sqlalchemy.types.Unicode"><code class="xref py py-class docutils literal notranslate"><span class="pre">Unicode</span></code></a> or Oracle’s NVARCHAR2/NCHAR/NCLOB datatypes.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4242">#4242</a></p>
</section>
<section id="cx-oracle-connect-arguments-modernized-deprecated-parameters-removed">
<span id="change-4369"></span><h3>cx_Oracle connect arguments modernized, deprecated parameters removed<a class="headerlink" href="#cx-oracle-connect-arguments-modernized-deprecated-parameters-removed" title="Link to this heading">¶</a></h3>
<p>A series of modernizations to the parameters accepted by the cx_oracle
dialect as well as the URL string:</p>
<ul class="simple">
<li><p>The deprecated parameters <code class="docutils literal notranslate"><span class="pre">auto_setinputsizes</span></code>, <code class="docutils literal notranslate"><span class="pre">allow_twophase</span></code>,
<code class="docutils literal notranslate"><span class="pre">exclude_setinputsizes</span></code> are removed.</p></li>
<li><p>The value of the <code class="docutils literal notranslate"><span class="pre">threaded</span></code> parameter, which has always been defaulted
to True for the SQLAlchemy dialect, is no longer generated by default.
The SQLAlchemy <a class="reference internal" href="../core/connections.html#sqlalchemy.engine.Connection" title="sqlalchemy.engine.Connection"><code class="xref py py-class docutils literal notranslate"><span class="pre">Connection</span></code></a> object is not considered to be thread-safe
itself so there’s no need for this flag to be passed.</p></li>
<li><p>It’s deprecated to pass <code class="docutils literal notranslate"><span class="pre">threaded</span></code> to <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code></a> itself.
To set the value of <code class="docutils literal notranslate"><span class="pre">threaded</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code>, pass it to either the
<a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.connect_args" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.connect_args</span></code></a> dictionary or use the query
string e.g. <code class="docutils literal notranslate"><span class="pre">oracle+cx_oracle://...?threaded=true</span></code>.</p></li>
<li><p>All parameters passed on the URL query string that are not otherwise
specially consumed are now passed to the cx_Oracle.connect() function.
A selection of these are also coerced either into cx_Oracle constants
or booleans including <code class="docutils literal notranslate"><span class="pre">mode</span></code>, <code class="docutils literal notranslate"><span class="pre">purity</span></code>, <code class="docutils literal notranslate"><span class="pre">events</span></code>, and <code class="docutils literal notranslate"><span class="pre">threaded</span></code>.</p></li>
<li><p>As was the case earlier, all cx_Oracle <code class="docutils literal notranslate"><span class="pre">.connect()</span></code> arguments are accepted
via the <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine.params.connect_args" title="sqlalchemy.create_engine"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">create_engine.connect_args</span></code></a> dictionary, the documentation
was inaccurate regarding this.</p></li>
</ul>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4369">#4369</a></p>
</section>
</section>
<section id="dialect-improvements-and-changes-sql-server">
<h2>Dialect Improvements and Changes - SQL Server<a class="headerlink" href="#dialect-improvements-and-changes-sql-server" title="Link to this heading">¶</a></h2>
<section id="support-for-pyodbc-fast-executemany">
<span id="change-4158"></span><h3>Support for pyodbc fast_executemany<a class="headerlink" href="#support-for-pyodbc-fast-executemany" title="Link to this heading">¶</a></h3>
<p>Pyodbc’s recently added “fast_executemany” mode, available when using the
Microsoft ODBC driver, is now an option for the pyodbc / mssql dialect.
Pass it via <a class="reference internal" href="../core/engines.html#sqlalchemy.create_engine" title="sqlalchemy.create_engine"><code class="xref py py-func docutils literal notranslate"><span class="pre">create_engine()</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span>
    <span class="s2">&quot;mssql+pyodbc://scott:tiger@mssql2017:1433/test?driver=ODBC+Driver+13+for+SQL+Server&quot;</span><span class="p">,</span>
    <span class="n">fast_executemany</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
<span class="p">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../dialects/mssql.html#mssql-pyodbc-fastexecutemany"><span class="std std-ref">Fast Executemany Mode</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4158">#4158</a></p>
</section>
<section id="new-parameters-to-affect-identity-start-and-increment-use-of-sequence-deprecated">
<span id="change-4362"></span><h3>New parameters to affect IDENTITY start and increment, use of Sequence deprecated<a class="headerlink" href="#new-parameters-to-affect-identity-start-and-increment-use-of-sequence-deprecated" title="Link to this heading">¶</a></h3>
<p>SQL Server as of SQL Server 2012 now supports sequences with real
<code class="docutils literal notranslate"><span class="pre">CREATE</span> <span class="pre">SEQUENCE</span></code> syntax.  In <a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4235">#4235</a>, SQLAlchemy will add support for
these using <a class="reference internal" href="../core/defaults.html#sqlalchemy.schema.Sequence" title="sqlalchemy.schema.Sequence"><code class="xref py py-class docutils literal notranslate"><span class="pre">Sequence</span></code></a> in the same way as for any other dialect.
However, the current situation is that <a class="reference internal" href="../core/defaults.html#sqlalchemy.schema.Sequence" title="sqlalchemy.schema.Sequence"><code class="xref py py-class docutils literal notranslate"><span class="pre">Sequence</span></code></a> has been repurposed
on SQL Server specifically in order to affect the “start” and “increment”
parameters for the <code class="docutils literal notranslate"><span class="pre">IDENTITY</span></code> specification on a primary key column.  In order
to make the transition towards normal sequences being available as well,
using <a class="reference internal" href="../core/defaults.html#sqlalchemy.schema.Sequence" title="sqlalchemy.schema.Sequence"><code class="xref py py-class docutils literal notranslate"><span class="pre">Sequence</span></code></a> will emit a deprecation warning throughout the
1.3 series.  In order to affect “start” and “increment”, use the
new <code class="docutils literal notranslate"><span class="pre">mssql_identity_start</span></code> and <code class="docutils literal notranslate"><span class="pre">mssql_identity_increment</span></code> parameters
on <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column" title="sqlalchemy.schema.Column"><code class="xref py py-class docutils literal notranslate"><span class="pre">Column</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;test&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span>
        <span class="s2">&quot;id&quot;</span><span class="p">,</span>
        <span class="n">Integer</span><span class="p">,</span>
        <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">mssql_identity_start</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
        <span class="n">mssql_identity_increment</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
    <span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">20</span><span class="p">)),</span>
<span class="p">)</span></pre></div>
</div>
<p>In order to emit <code class="docutils literal notranslate"><span class="pre">IDENTITY</span></code> on a non-primary key column, which is a little-used
but valid SQL Server use case, use the <a class="reference internal" href="../core/metadata.html#sqlalchemy.schema.Column.params.autoincrement" title="sqlalchemy.schema.Column"><code class="xref py py-paramref docutils literal notranslate"><span class="pre">Column.autoincrement</span></code></a> flag,
setting it to <code class="docutils literal notranslate"><span class="pre">True</span></code> on the target column, <code class="docutils literal notranslate"><span class="pre">False</span></code> on any integer
primary key column:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">test</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span>
    <span class="s2">&quot;test&quot;</span><span class="p">,</span>
    <span class="n">metadata_obj</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">autoincrement</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="p">)</span></pre></div>
</div>
<div class="admonition seealso">
<p class="admonition-title">参见</p>
<p><a class="reference internal" href="../dialects/mssql.html#mssql-identity"><span class="std std-ref">Auto Increment Behavior / IDENTITY Columns</span></a></p>
</div>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4362">#4362</a></p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4235">#4235</a></p>
</section>
</section>
<section id="changed-statementerror-formatting-newlines-and-s">
<span id="change-4500"></span><h2>Changed StatementError formatting (newlines and %s)<a class="headerlink" href="#changed-statementerror-formatting-newlines-and-s" title="Link to this heading">¶</a></h2>
<p>Two changes are introduced to the string representation for <code class="docutils literal notranslate"><span class="pre">StatementError</span></code>.
The “detail” and “SQL” portions of the string representation are now
separated by newlines, and newlines that are present in the original SQL
statement are maintained.   The goal is to improve readability while still
keeping the original error message on one line for logging purposes.</p>
<p>This means that an error message that previously looked like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>sqlalchemy.exc.StatementError: (sqlalchemy.exc.InvalidRequestError) A value is
required for bind parameter &#39;id&#39; [SQL: &#39;select * from reviews\nwhere id = ?&#39;]
(Background on this error at: https://sqlalche.me/e/cd3x)</pre></div>
</div>
<p>Will now look like this:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>sqlalchemy.exc.StatementError: (sqlalchemy.exc.InvalidRequestError) A value is required for bind parameter &#39;id&#39;
[SQL: select * from reviews
where id = ?]
(Background on this error at: https://sqlalche.me/e/cd3x)</pre></div>
</div>
<p>The primary impact of this change is that consumers can no longer assume that
a complete exception message is on a single line, however the original
“error” portion that is generated from the DBAPI driver or SQLAlchemy internals
will still be on the first line.</p>
<p><a class="reference external" href="https://www.sqlalchemy.org/trac/ticket/4500">#4500</a></p>
</section>
</section>

        </article>
      </div>
      <footer>
        
        <div class="related-pages">
          <a class="next-page" href="migration_12.html">
              <div class="page-info">
                <div class="context">
                  <span>Next</span>
                </div>
                <div class="title">What’s New in SQLAlchemy 1.2?</div>
              </div>
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
            </a>
          <a class="prev-page" href="migration_14.html">
              <svg class="furo-related-icon"><use href="#svg-arrow-right"></use></svg>
              <div class="page-info">
                <div class="context">
                  <span>Previous</span>
                </div>
                
                <div class="title">What’s New in SQLAlchemy 1.4?</div>
                
              </div>
            </a>
        </div>
        <div class="bottom-of-page">
          <div class="left-details">
            <div class="copyright">
                <a href="../copyright.html">Copyright</a> &#169; 2007-2025, the SQLAlchemy authors and contributors
            </div>
            Made with <a href="https://www.sphinx-doc.org/">Sphinx</a> and <a class="muted-link" href="https://pradyunsg.me">@pradyunsg</a>'s
            
            <a href="https://github.com/pradyunsg/furo">Furo</a>
            <div class="last-updated">
              Last updated on 04/05/2025 04:00:26</div>
          </div>
          <div class="right-details">
            
          </div>
        </div>
        
      </footer>
    </div>
    <aside class="toc-drawer">
      
      
      <div class="toc-sticky toc-scroll">
        <div class="toc-title-container">
          <span class="toc-title">
            On this page
          </span>
        </div>
        <div class="toc-tree-container">
          <div class="toc-tree">
            <ul>
<li><a class="reference internal" href="#">What’s New in SQLAlchemy 1.3?</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#general">General</a><ul>
<li><a class="reference internal" href="#deprecation-warnings-are-emitted-for-all-deprecated-elements-new-deprecations-added">Deprecation warnings are emitted for all deprecated elements; new deprecations added</a></li>
</ul>
</li>
<li><a class="reference internal" href="#new-features-and-improvements-orm">New Features and Improvements - ORM</a><ul>
<li><a class="reference internal" href="#relationship-to-aliasedclass-replaces-the-need-for-non-primary-mappers">Relationship to AliasedClass replaces the need for non primary mappers</a></li>
<li><a class="reference internal" href="#selectin-loading-no-longer-uses-join-for-simple-one-to-many">selectin loading no longer uses JOIN for simple one-to-many</a></li>
<li><a class="reference internal" href="#improvement-to-the-behavior-of-many-to-one-query-expressions">Improvement to the behavior of many-to-one query expressions</a></li>
<li><a class="reference internal" href="#many-to-one-replacement-won-t-raise-for-raiseload-or-detached-for-old-object">Many-to-one replacement won’t raise for “raiseload” or detached for “old” object</a></li>
<li><a class="reference internal" href="#del-implemented-for-orm-attributes">“del” implemented for ORM attributes</a></li>
<li><a class="reference internal" href="#info-dictionary-added-to-instancestate">info dictionary added to InstanceState</a></li>
<li><a class="reference internal" href="#horizontal-sharding-extension-supports-bulk-update-and-delete-methods">Horizontal Sharding extension supports bulk update and delete methods</a></li>
<li><a class="reference internal" href="#association-proxy-improvements">Association Proxy Improvements</a><ul>
<li><a class="reference internal" href="#association-proxy-has-new-cascade-scalar-deletes-flag">Association proxy has new cascade_scalar_deletes flag</a></li>
<li><a class="reference internal" href="#associationproxy-stores-class-specific-state-on-a-per-class-basis">AssociationProxy stores class-specific state on a per-class basis</a></li>
<li><a class="reference internal" href="#associationproxy-now-provides-standard-column-operators-for-a-column-oriented-target">AssociationProxy now provides standard column operators for a column-oriented target</a></li>
<li><a class="reference internal" href="#association-proxy-now-strong-references-the-parent-object">Association Proxy now Strong References the Parent Object</a></li>
<li><a class="reference internal" href="#implemented-bulk-replace-for-sets-dicts-with-associationproxy">Implemented bulk replace for sets, dicts with AssociationProxy</a></li>
</ul>
</li>
<li><a class="reference internal" href="#many-to-one-backref-checks-for-collection-duplicates-during-remove-operation">Many-to-one backref checks for collection duplicates during remove operation</a></li>
</ul>
</li>
<li><a class="reference internal" href="#key-behavioral-changes-orm">Key Behavioral Changes - ORM</a><ul>
<li><a class="reference internal" href="#query-join-handles-ambiguity-in-deciding-the-left-side-more-explicitly">Query.join() handles ambiguity in deciding the “left” side more explicitly</a></li>
<li><a class="reference internal" href="#for-update-clause-is-rendered-within-the-joined-eager-load-subquery-as-well-as-outside">FOR UPDATE clause is rendered within the joined eager load subquery as well as outside</a></li>
<li><a class="reference internal" href="#passive-deletes-all-will-leave-fk-unchanged-for-object-removed-from-collection">passive_deletes=’all’ will leave FK unchanged for object removed from collection</a></li>
</ul>
</li>
<li><a class="reference internal" href="#new-features-and-improvements-core">New Features and Improvements - Core</a><ul>
<li><a class="reference internal" href="#new-multi-column-naming-convention-tokens-long-name-truncation">New multi-column naming convention tokens, long name truncation</a></li>
<li><a class="reference internal" href="#binary-comparison-interpretation-for-sql-functions">Binary comparison interpretation for SQL functions</a></li>
<li><a class="reference internal" href="#expanding-in-feature-now-supports-empty-lists">Expanding IN feature now supports empty lists</a></li>
<li><a class="reference internal" href="#typeengine-methods-bind-expression-column-expression-work-with-variant-type-specific-types">TypeEngine methods bind_expression, column_expression work with Variant, type-specific types</a></li>
<li><a class="reference internal" href="#new-last-in-first-out-strategy-for-queuepool">New last-in-first-out strategy for QueuePool</a></li>
</ul>
</li>
<li><a class="reference internal" href="#key-changes-core">Key Changes - Core</a><ul>
<li><a class="reference internal" href="#coercion-of-string-sql-fragments-to-text-fully-removed">Coercion of string SQL fragments to text() fully removed</a></li>
<li><a class="reference internal" href="#threadlocal-engine-strategy-deprecated">“threadlocal” engine strategy deprecated</a></li>
<li><a class="reference internal" href="#convert-unicode-parameters-deprecated">convert_unicode parameters deprecated</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dialect-improvements-and-changes-postgresql">Dialect Improvements and Changes - PostgreSQL</a><ul>
<li><a class="reference internal" href="#added-basic-reflection-support-for-postgresql-partitioned-tables">Added basic reflection support for PostgreSQL partitioned tables</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dialect-improvements-and-changes-mysql">Dialect Improvements and Changes - MySQL</a><ul>
<li><a class="reference internal" href="#protocol-level-ping-now-used-for-pre-ping">Protocol-level ping now used for pre-ping</a></li>
<li><a class="reference internal" href="#control-of-parameter-ordering-within-on-duplicate-key-update">Control of parameter ordering within ON DUPLICATE KEY UPDATE</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dialect-improvements-and-changes-sqlite">Dialect Improvements and Changes - SQLite</a><ul>
<li><a class="reference internal" href="#support-for-sqlite-json-added">Support for SQLite JSON Added</a></li>
<li><a class="reference internal" href="#support-for-sqlite-on-conflict-in-constraints-added">Support for SQLite ON CONFLICT in constraints added</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dialect-improvements-and-changes-oracle">Dialect Improvements and Changes - Oracle</a><ul>
<li><a class="reference internal" href="#national-char-datatypes-de-emphasized-for-generic-unicode-re-enabled-with-option">National char datatypes de-emphasized for generic unicode, re-enabled with option</a></li>
<li><a class="reference internal" href="#cx-oracle-connect-arguments-modernized-deprecated-parameters-removed">cx_Oracle connect arguments modernized, deprecated parameters removed</a></li>
</ul>
</li>
<li><a class="reference internal" href="#dialect-improvements-and-changes-sql-server">Dialect Improvements and Changes - SQL Server</a><ul>
<li><a class="reference internal" href="#support-for-pyodbc-fast-executemany">Support for pyodbc fast_executemany</a></li>
<li><a class="reference internal" href="#new-parameters-to-affect-identity-start-and-increment-use-of-sequence-deprecated">New parameters to affect IDENTITY start and increment, use of Sequence deprecated</a></li>
</ul>
</li>
<li><a class="reference internal" href="#changed-statementerror-formatting-newlines-and-s">Changed StatementError formatting (newlines and %s)</a></li>
</ul>
</li>
</ul>

          </div>
        </div>
      </div>
      
      
    </aside>
  </div>
</div><script src="../_static/jquery.js?v=5d32c60e"></script>
    <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
    <script src="../_static/documentation_options.js?v=2d0eb83f"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/scripts/furo.js?v=5fa4622c"></script>
    <script src="../_static/tabs.js?v=3ee01567"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=2f3e6152"></script>
    <script src="../_static/translations.js?v=beaddf03"></script>
    </body>
</html>